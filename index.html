<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙˆØ¬ 77 Ø§Ù„Ø¨Ø­Ø±ÙŠ</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
<style>
    /* ========================================= */
    /* 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«ÙŠÙ… ÙˆØ§Ù„ØªØµÙ…ÙŠÙ… (CSS) */
    /* ========================================= */
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');

    :root {
        --primary-color: #1a237e;    /* Ø£Ø²Ø±Ù‚ ÙƒØ­Ù„ÙŠ */
        --accent-color: #ffca28;     /* Ø°Ù‡Ø¨ÙŠ */
        --text-light: #ffffff;
        --glass-bg: rgba(255, 255, 255, 0.1);
        --glass-border: 1px solid rgba(255, 255, 255, 0.2);
        --input-bg: rgba(0, 0, 0, 0.2);
        --btn-gradient: linear-gradient(45deg, #1a237e, #304ffe);
    }

    body {
        font-family: 'Cairo', sans-serif;
        margin: 0; padding: 0;
        min-height: 100vh;
        color: var(--text-light);
        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ¯Ø±Ø¬Ø© Ø²Ø±Ù‚Ø§Ø¡ ÙØ®Ù…Ø© */
        background: radial-gradient(circle at center, #283593, #0d47a1, #002171);
        background-attachment: fixed;
        overflow-x: hidden;
    }

    /* Ø´Ø¹Ø§Ø± Ø®Ù„ÙÙŠ Ø´ÙØ§Ù (Watermark) */
    body::before {
        content: "";
        position: fixed;
        top: 50%; left: 50%;
        transform: translate(-50%, -50%);
        width: 80vw; height: 80vh;
        background: url('Screenshot__25_-removebg-preview.png') no-repeat center center;
        background-size: contain;
        opacity: 0.05;
        z-index: -1;
        pointer-events: none;
    }

    /* === Ø§Ù„Ù‡ÙŠØ¯Ø± === */
    header {
        background: rgba(26, 35, 126, 0.8);
        backdrop-filter: blur(10px);
        padding: 15px;
        text-align: center;
        font-size: 20px;
        font-weight: 700;
        border-bottom: 2px solid var(--accent-color);
        box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        margin-bottom: 30px;
    }

    /* === Ø§Ù„ØªØµØ§Ù…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ÙŠØ© (Cards) === */
    
    /* 1. Ø§Ù„ÙƒØ±Øª Ø§Ù„ØµØºÙŠØ± (Ù„Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø©) */
    .glass-card {
        background: var(--glass-bg);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: var(--glass-border);
        border-radius: 20px;
        padding: 40px 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        max-width: 400px;
        margin: 20px auto;
        text-align: center;
    }

    /* 2. Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø±ÙŠØ¶Ø© (Ù„Ù„ÙÙˆØ±Ù… ÙˆÙ„ÙˆØ­Ø§Øª Ø§Ù„ØªØ­ÙƒÙ…) */
    .glass-panel {
        background: rgba(255, 255, 255, 0.95); /* Ø®Ù„ÙÙŠØ© ÙØ§ØªØ­Ø© Ù„Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø³Ù‡Ù„Ø© */
        color: #333; /* Ù†Øµ ØºØ§Ù…Ù‚ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ */
        border-radius: 15px;
        padding: 30px;
        margin: 20px auto;
        max-width: 900px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        border: 1px solid rgba(255,255,255,0.5);
    }
    
    /* ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù†ØµÙˆØµ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ */
    .glass-panel h2, .glass-panel label { color: #1a237e; }
    .glass-panel input, .glass-panel select { 
        background: white; 
        color: #333; 
        border: 1px solid #ccc;
    }

    /* === Ø§Ù„Ø¹Ù†Ø§ØµØ± (Inputs & Buttons) === */
    
    /* Ø­Ù‚ÙˆÙ„ Ø´ÙØ§ÙØ© (Ù„Ù„Ø®Ù„ÙÙŠØ§Øª Ø§Ù„ØºØ§Ù…Ù‚Ø©) */
    .glass-input {
        width: 100% !important;
        padding: 12px 15px !important;
        margin-bottom: 15px !important;
        background: var(--input-bg) !important;
        border: var(--glass-border) !important;
        border-radius: 10px !important;
        color: white !important;
        font-family: 'Cairo', sans-serif !important;
        box-sizing: border-box !important;
        transition: 0.3s !important;
    }
    .glass-input::placeholder { color: #ccc !important; }
    .glass-input:focus {
        outline: none !important;
        background: rgba(0,0,0,0.4) !important;
        border-color: var(--accent-color) !important;
    }

    /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± */
    button {
        width: 100%;
        padding: 12px;
        background: var(--btn-gradient);
        color: white;
        border: none;
        border-radius: 10px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: 0.3s;
        font-family: 'Cairo', sans-serif;
        margin-top: 10px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.4); }
    
    .btn-danger { background: linear-gradient(45deg, #c62828, #e53935); }

    /* === ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø¹Ø§Ù…Ø© === */
    .hidden { display: none !important; }
    .two-cols { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; text-align: right;}
    .info-box { background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 14px; border-right: 3px solid var(--accent-color); text-align: right;}
    label { display: block; margin-bottom: 5px; font-weight: bold; text-align: right;}
    
    /* Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù„ÙˆÙŠ */
    #userTopbar {
        background: rgba(255,255,255,0.1);
        backdrop-filter: blur(5px);
        padding: 10px 20px;
        border-radius: 10px;
        margin: 0 auto 20px;
        max-width: 900px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid rgba(255,255,255,0.2);
    }
    .tag { background: var(--accent-color); color: #000; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold;}

    /* Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„ */
    #loadingScreen { 
        position: fixed; top:0; left:0; width:100%; height:100%; 
        background: white; z-index:9999;
        display:flex; justify-content:center; align-items:center; flex-direction: column;
    }
    .drawing-loader { width: 200px; }
    .drawing-loader img { width: 100%; animation: wipe 2.5s infinite; }
    @keyframes wipe {
        0% { clip-path: polygon(0 0, 0 0, 0 100%, 0 100%); opacity: 0.5; }
        50% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); opacity: 1; }
        100% { clip-path: polygon(100% 0, 100% 0, 100% 100%, 100% 100%); opacity: 0.5; }
    }
    
    /* Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; color: #333;}
    thead { background: var(--primary-color); color: white; }
    th, td { padding: 12px; border-bottom: 1px solid #ddd; text-align: center; }
    
    /* Ù†ØµÙˆØµ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© */
    .small { font-size: 12px; opacity: 0.8; margin-top: 5px; }
    .error { color: #ff5252; background: rgba(255,0,0,0.1); padding: 10px; border-radius: 5px; margin-top: 10px; }
    .success { color: #4caf50; background: rgba(0,255,0,0.1); padding: 10px; border-radius: 5px; margin-top: 10px; }

    /* ØªÙ†Ø³ÙŠÙ‚ Ù…ÙˆØ­Ø¯ Ù„ÙƒÙ„ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù… ÙÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ */
.container input[type="text"], 
.container input[type="date"], 
.container input[type="number"], 
.container input[type="email"], 
.container select {

    width: 100%;
    padding: 12px 15px;      /* Ù…Ø³Ø§Ø­Ø© Ù…Ø±ÙŠØ­Ø© Ù„Ù„ÙƒØªØ§Ø¨Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…Ø±Ø¨Ø¹ */
    margin: 8px 0;           /* Ù…Ø³Ø§ÙØ© Ø¨ÙŠÙ† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø§Ù„ØªØµØ§Ù‚ */
    display: block;
    border: 2px solid #ddd;  /* Ø¥Ø·Ø§Ø± Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ ÙƒØ§Ù…Ù„ (Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ±ØªÙ‡) */
    border-radius: 10px;     /* Ø²ÙˆØ§ÙŠØ§ Ø¯Ø§Ø¦Ø±ÙŠØ© Ø¹ØµØ±ÙŠØ© */
    box-sizing: border-box;  /* Ù„Ø¶Ù…Ø§Ù† ØªÙ†Ø§Ø³Ù‚ Ø§Ù„Ø¹Ø±Ø¶ Ù…Ø¹ Ø§Ù„Ø­ÙˆØ§Ù */
    font-family: 'Cairo', sans-serif;
    font-size: 14px;
    background-color: #fdfdfd;
    color: #333;             /* Ù„ÙˆÙ† Ù†Øµ ÙˆØ§Ø¶Ø­ */
    transition: all 0.3s ease; /* ØªÙ†Ø¹ÙŠÙ… Ø§Ù„Ø­Ø±ÙƒØ© Ø¹Ù†Ø¯ Ø§Ù„ØªÙØ§Ø¹Ù„ */
    outline: none;           /* Ø¥Ù„ØºØ§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØµÙØ­ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ */
}

/* Ø§Ù„ØªØ£Ø«ÙŠØ± Ø§Ù„Ø¬Ù…Ø§Ù„ÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù‚Ù„ Ù„Ù„Ø¨Ø¯Ø¡ Ø¨Ø§Ù„ÙƒØªØ§Ø¨Ø© */
.container input:focus, 
.container select:focus {
    border-color: #1a237e;   /* ÙŠØªØ­ÙˆÙ„ Ø§Ù„Ø¥Ø·Ø§Ø± Ù„Ù„ÙˆÙ† Ø§Ù„ÙƒØ­Ù„ÙŠ Ø§Ù„ÙƒØ´ÙÙŠ */
    box-shadow: 0 0 8px rgba(26, 35, 126, 0.15); /* ÙˆÙ‡Ø¬ Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹ Ø£Ø²Ø±Ù‚ */
    background-color: #ffffff;
}

/* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Labels) Ù„ØªÙƒÙˆÙ† ÙˆØ§Ø¶Ø­Ø© ÙÙˆÙ‚ Ø§Ù„Ù…Ø±Ø¨Ø¹Ø§Øª */
.container label {
    display: block;
    margin-top: 10px;
    margin-bottom: 5px;
    font-weight: bold;
    color: #1a237e;
    font-size: 13px;
    text-align: right;
}

/* ØªØ­Ø³ÙŠÙ† Ø´ÙƒÙ„ Ø­Ù‚Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„ÙŠØªÙ†Ø§Ø³Ø¨ Ù…Ø¹ Ø§Ù„Ø¨Ù‚ÙŠØ© */
input[type="date"] {
    cursor: pointer;
    height: 46px; /* ØªÙˆØ­ÙŠØ¯ Ø§Ù„Ø·ÙˆÙ„ Ù…Ø¹ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†Øµ */
}
  /* ØªÙ†Ø³ÙŠÙ‚ Ø´Ø¨ÙƒØ© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù„Ù„Ù‚Ø§Ø¦Ø¯ */
.leader-controls-grid {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap; /* Ù„Ù„Ø³Ù…Ø§Ø­ Ø¨Ù†Ø²ÙˆÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ­Øª Ø¨Ø¹Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
}

.btn-control {
    flex: 1;
    min-width: 150px; /* Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… ØµØºØ± Ø­Ø¬Ù… Ø§Ù„Ø²Ø± Ø¬Ø¯Ø§Ù‹ */
    padding: 15px 10px;
    border: none;
    border-radius: 10px;
    color: white;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 5px;
}

.btn-green { background-color: #2e7d32; }
.btn-navy { background-color: #1a237e; }
.btn-blue { background-color: #2962ff; }

.btn-control:hover { transform: translateY(-3px); opacity: 0.9; }

/* ØªØµØºÙŠØ± Ø§Ù„Ø®Ø· Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ù†Øµ Ø·ÙˆÙŠÙ„ */
.text-sm { font-size: 13px; }

@media (max-width: 600px) {
    .btn-control { min-width: 100%; } /* Ø§Ù„Ø£Ø²Ø±Ø§Ø± ØªØ£Ø®Ø° Ø§Ù„Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */

}

/* ========================================= */
/* ğŸ¨ ØªØ­Ø³ÙŠÙ†Ø§Øª Ù†ÙˆØ§ÙØ° Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
/* ========================================= */

/* 1. ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ­Ø³ÙŠÙ† Ø§Ù„Ø®Ù„ÙÙŠØ© */
#modalLoanItem .glass-panel,
#modalReturnItem .glass-panel {
    width: 500px !important; /* Ø¹Ø±Ø¶ Ø£ÙƒØ¨Ø± Ù„Ù„Ø±Ø§Ø­Ø© */
    max-width: 95vw;
    background: #fdfdfd !important; /* Ø®Ù„ÙÙŠØ© Ø¨ÙŠØ¶Ø§Ø¡ ØµØ§ÙÙŠØ© */
    border: 1px solid #ccc;
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
}

/* 2. ØªÙ†Ø³ÙŠÙ‚ ØµÙÙˆÙ Ø§Ù„ÙƒÙ…ÙŠØ§Øª (Ù…Ù…ØªØ§Ø²/ÙˆØ³Ø·/ØµÙŠØ§Ù†Ø©) */
.qty-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: #f8f9fa; /* Ø±Ù…Ø§Ø¯ÙŠ ÙØ§ØªØ­ Ø¬Ø¯Ø§Ù‹ */
    padding: 12px 15px;
    margin-bottom: 10px;
    border-radius: 12px;
    border: 1px solid #e9ecef;
    transition: 0.2s;
}

.qty-row:hover {
    background: #fff;
    border-color: #1a237e; /* Ù„ÙˆÙ† Ø§Ù„Ø¥Ø·Ø§Ø± Ø¹Ù†Ø¯ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
}

.qty-label {
    font-weight: bold;
    color: #2c3e50;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    gap: 8px;
}

/* 3. ØªÙƒØ¨ÙŠØ± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… */
.qty-input {
    width: 100px !important;
    text-align: center;
    font-size: 1.2rem !important;
    font-weight: bold;
    padding: 8px !important;
    border: 2px solid #ddd !important;
    border-radius: 8px !important;
    color: #1a237e !important;
    margin: 0 !important;
}

.qty-input:focus {
    border-color: #1a237e !important;
    background: #fff !important;
}

/* 4. ØªÙ†Ø³ÙŠÙ‚ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ */
.total-summary-box {
    background: linear-gradient(135deg, #e3f2fd, #bbdefb);
    padding: 15px;
    border-radius: 12px;
    margin-top: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #90caf9;
}

.total-label {
    font-weight: bold;
    color: #0d47a1;
    font-size: 1rem;
}

.total-number {
    font-size: 1.5rem;
    font-weight: 800;
    color: #d32f2f; /* Ù„ÙˆÙ† Ø£Ø­Ù…Ø± Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹ */
    background: white;
    padding: 2px 15px;
    border-radius: 20px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* 5. ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® Ø¨Ø¬Ø§Ù†Ø¨ Ø¨Ø¹Ø¶ */
.date-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-top: 20px;
}
:root {
        /* Ø¥Ø¶Ø§ÙØ© Ù…ØªØºÙŠØ±Ø§Øª Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù†Ø­Ø§Ø³ÙŠ */
        --band-color: #d35400; /* Ù„ÙˆÙ† Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ Ù†Ø­Ø§Ø³ÙŠ */
        --band-bg-light: #fdf2e9;
    }

    /* ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Tabs) */
    .band-tab-btn {
        background: none;
        border: none;
        padding: 10px 20px;
        font-family: 'Cairo', sans-serif;
        font-weight: bold;
        color: #7f8c8d;
        cursor: pointer;
        border-bottom: 3px solid transparent;
        transition: 0.3s;
        white-space: nowrap;
        flex: 1; /* Ù„ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³Ø§Ø­Ø© Ø¨Ø§Ù„ØªØ³Ø§ÙˆÙŠ ÙÙŠ Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
        font-size: 14px;
    }

    .band-tab-btn:hover {
        background: var(--band-bg-light);
        color: var(--band-color);
    }

    .band-tab-btn.active-band-tab {
        color: var(--band-color);
        border-bottom: 3px solid var(--band-color);
        background: white;
    }

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„ØµØºÙŠØ±Ø© (Ù…Ø«Ù„ Ø§Ù„Ù‚Ø¨ÙˆÙ„ ÙˆØ§Ù„Ø±ÙØ¶) */
    .btn-action-small {
        width: auto !important; /* Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ù…Ù„ */
        display: inline-block !important;
        padding: 5px 12px !important;
        font-size: 12px !important;
        margin: 0 3px !important;
        border-radius: 6px !important;
    }

    /* ØªØ­Ø³ÙŠÙ† Ø¸Ù‡ÙˆØ± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª */
    .band-tab-content {
        animation: fadeIn 0.5s ease-in-out;
    }
    /* ===== Music Modal UI (Improved) ===== */
#musicModal.music-modal-overlay{
  position: fixed;
  inset: 0;
  background: rgba(17, 24, 39, 0.55);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

#musicModal .music-modal-card{
  width: min(520px, 95vw);
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.25);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.06);
}

#musicModal .music-modal-header{
  padding: 16px 18px;
  background: linear-gradient(135deg, #6a1b9a, #7c3aed);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

#musicModal .music-modal-header h3{
  margin: 0;
  font-size: 1.05rem;
  font-weight: 800;
  letter-spacing: .2px;
}

#musicModal .music-modal-body{
  padding: 16px 18px 18px;
  direction: rtl;
}

#musicModal .music-grid{
  display: grid;
  grid-template-columns: 1fr;
  gap: 12px;
}

#musicModal .music-row-2{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

#musicModal label.music-label{
  display: block;
  font-weight: 800;
  color: #1f2937;
  margin: 0 0 6px;
  font-size: .9rem;
}

#musicModal .music-input,
#musicModal .music-select,
#musicModal .music-textarea{
  width: 100%;
  border: 1px solid #e5e7eb;
  border-radius: 12px;
  padding: 10px 12px;
  font-size: .95rem;
  outline: none;
  transition: .15s;
  background: #fff;
}

#musicModal .music-textarea{
  min-height: 96px;
  resize: vertical;
}

#musicModal .music-input:focus,
#musicModal .music-select:focus,
#musicModal .music-textarea:focus{
  border-color: #a78bfa;
  box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.25);
}

#musicModal .music-hint{
  margin-top: 6px;
  font-size: .82rem;
  color: #6b7280;
}

#musicModal .music-actions{
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-top: 14px;
}

#musicModal .btn-primary{
  background: #6d28d9;
  color: #fff;
  border: none;
  border-radius: 14px;
  padding: 12px 14px;
  font-weight: 900;
  cursor: pointer;
  transition: .15s;
}

#musicModal .btn-primary:hover{ filter: brightness(0.96); }

#musicModal .btn-secondary{
  background: #f3f4f6;
  color: #111827;
  border: 1px solid #e5e7eb;
  border-radius: 14px;
  padding: 12px 14px;
  font-weight: 800;
  cursor: pointer;
  transition: .15s;
}

#musicModal .btn-secondary:hover{ background: #eef2ff; }

#musicModal .icon-close{
  background: rgba(255,255,255,.18);
  border: 1px solid rgba(255,255,255,.25);
  color: #fff;
  width: 34px;
  height: 34px;
  border-radius: 10px;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-weight: 900;
}
/* ===== Fix modal sizing & scroll (add-on ÙÙ‚Ø·) ===== */

/* 1) Ø®Ù„ÙŠ Ø§Ù„ÙƒØ§Ø±Ø¯ Ø¶Ù…Ù† Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ø´Ø§Ø´Ø© */
#musicModal .music-modal-card{
  max-height: 92vh;
  display: flex;
  flex-direction: column;
}

/* 2) Ø®Ù„ÙŠ Ø§Ù„ØªÙ…Ø±ÙŠØ± Ø¯Ø§Ø®Ù„ Ø¬Ø³Ù… Ø§Ù„Ù†Ø§ÙØ°Ø© */
#musicModal .music-modal-body{
  overflow-y: auto;
  overflow-x: hidden;
  flex: 1 1 auto;
}

/* 3) Ø®Ù„ÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø«Ø§Ø¨ØªØ© ØªØ­Øª Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙ…Ø±ÙŠØ± */
#musicModal .music-actions{
  position: sticky;
  bottom: 0;
  background: #fff;
  padding-top: 10px;
  padding-bottom: 8px;
  border-top: 1px solid #f0f0f0;
}

/* ===== Music Details Modal (same style family) ===== */
#musicDetailsModal.music-modal-overlay { /* Ù†ÙØ³ overlay */
  position: fixed;
  inset: 0;
  background: rgba(17, 24, 39, 0.55);
  backdrop-filter: blur(4px);
  -webkit-backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 99999;
  padding: 20px;
}

#musicDetailsModal .music-modal-card {
  width: min(560px, 96vw);
  background: #fff;
  border-radius: 18px;
  box-shadow: 0 22px 60px rgba(0,0,0,.25);
  overflow: hidden;
  border: 1px solid rgba(0,0,0,.06);

  max-height: 92vh;
  display: flex;
  flex-direction: column;
}

#musicDetailsModal .music-modal-header{
  padding: 16px 18px;
  background: linear-gradient(135deg, #6a1b9a, #7c3aed);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex: 0 0 auto;
}

#musicDetailsModal .music-modal-body{
  padding: 16px 18px 18px;
  direction: rtl;
  overflow-y: auto;
  overflow-x: hidden;
  flex: 1 1 auto;
}

#musicDetailsModal .details-cover{
  width: 100%;
  height: 180px;
  border-radius: 14px;
  overflow: hidden;
  background: #f3f4f6;
  border: 1px solid #eee;
  margin-bottom: 12px;
}

#musicDetailsModal .details-cover img{
  width: 100%;
  height: 100%;
  object-fit: cover;
}

#musicDetailsModal .badge{
  display: inline-block;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: .85rem;
  font-weight: 800;
  background: #ede7f6;
  color: #5e35b1;
  margin-bottom: 10px;
}

#musicDetailsModal .details-title{
  margin: 0 0 10px;
  font-size: 1.2rem;
  font-weight: 900;
  color: #1f2937;
}

#musicDetailsModal .details-actions{
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  margin-top: 10px;
}

#musicDetailsModal .link-btn{
  flex: 1;
  min-width: 120px;
  text-align: center;
  padding: 10px 12px;
  border-radius: 12px;
  text-decoration: none;
  font-weight: 900;
  border: 1px solid #e5e7eb;
  background: #f9fafb;
  color: #111827;
}

#musicDetailsModal .link-btn.sheet{ background:#fff3e0; border-color:#ffe0b2; color:#ef6c00; }
#musicDetailsModal .link-btn.video{ background:#ede7f6; border-color:#d1c4e9; color:#5e35b1; }
#musicDetailsModal .link-btn.audio{ background:#e3f2fd; border-color:#bbdefb; color:#1565c0; }

#musicDetailsModal .danger-btn{
  width: 100%;
  margin-top: 14px;
  padding: 12px 14px;
  border-radius: 14px;
  border: 1px solid #ffcdd2;
  background: #ffebee;
  color: #c62828;
  font-weight: 900;
  cursor: pointer;
}

/* Overlay Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ */
.att-modal-overlay {
  position: fixed;
  inset: 0;                 /* top:0 right:0 bottom:0 left:0 */
  background: rgba(0,0,0,0.55);
  backdrop-filter: blur(4px);
  z-index: 9999;

  display: none;            /* Ù†Ø®ÙÙŠÙ‡ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ */
  align-items: center;
  justify-content: center;

  padding: 16px;            /* Ù…Ù‡Ù… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
}

/* Ù„Ù…Ø§ Ù†ÙØªØ­Ù‡ */
.att-modal-overlay.show {
  display: flex;
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
.att-modal {
  width: min(900px, 96vw);
  max-height: 90vh;
  background: #fff;
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 15px 40px rgba(0,0,0,0.35);
  direction: rtl;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± */
.att-modal-header {
  background: linear-gradient(135deg, #1a237e, #283593);
  color: #fff;
  padding: 14px 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ (Ù‚Ø§Ø¨Ù„ Ù„Ù„Ø³ÙƒØ±ÙˆÙ„) */
.att-modal-body {
  padding: 16px;
  overflow: auto;
  max-height: calc(90vh - 56px); /* ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù‡ÙŠØ¯Ø± */
}

/* ØªÙ‚Ø³ÙŠÙ… Ø¯Ø§Ø®Ù„ÙŠ Ù„Ù‚Ø³Ù…ÙŠÙ† */
.att-split {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

@media (max-width: 800px) {
  .att-split { grid-template-columns: 1fr; }
}

/* ÙƒØ±Øª Ù„ÙƒÙ„ Ù‚Ø³Ù… */
.att-card {
  border: 1px solid #e6e6e6;
  border-radius: 14px;
  padding: 12px;
  background: #fafafa;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… */
.att-card-title {
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-weight: 800;
  color: #1a237e;
  margin-bottom: 10px;
  padding-bottom: 8px;
  border-bottom: 1px dashed #d9d9d9;
}

/* Ù…Ù†Ø¹ ØªÙØ§Ø¹Ù„ Ø§Ù„Ø®Ù„ÙÙŠØ© Ù„Ù…Ø§ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù…ÙØªÙˆØ­ */
body.modal-lock {
  overflow: hidden;
}

.att-disabled {
  opacity: 0.35;
  filter: grayscale(1);
  pointer-events: none;
}

* { box-sizing: border-box; }

.section-box { max-width: 100%; }

.table-wrap{
  width: 100%;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  border-radius: 12px;
}

#adminTable{
  width: 100%;
  border-collapse: collapse;
  min-width: 780px; /* ÙŠØ®Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ø§ ÙŠÙ†Ø¶ØºØ· Ø¨Ø´ÙƒÙ„ Ø¨Ø´Ø¹ */
}

#adminTable th, #adminTable td{
  white-space: nowrap;  /* ÙŠÙ…Ù†Ø¹ Ø§Ù„ØªÙØ§Ù Ø§Ù„Ù†Øµ ÙˆÙŠØ®Ù„ÙŠ Ø§Ù„Ø³ÙƒØ±ÙˆÙ„ Ù†Ø¸ÙŠÙ */
}

.admin-actions{
  margin-top: 15px;
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.admin-actions button{
  flex: 1;
  min-width: 200px;
}

@media (max-width: 600px){
  #adminTable{ min-width: 720px; }
  .admin-actions button{
    width: 100%;
    flex: 1 1 100%;
  }
}


  
  </style>
</head>
<body>
<div id="loadingScreen">
    <div class="drawing-loader">
        <img src="Screenshot__25_-removebg-preview.png" alt="Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„">
    </div>
</div>

<header> ÙƒØ´Ø§Ù Ø³ÙˆØ±ÙŠØ© _ Ù…ÙÙˆØ¶ÙŠØ© Ø§Ù„Ù„Ø§Ø°Ù‚ÙŠØ©  </header>

<div class="container">

  <div id="userTopbar" class="hidden">
    <div>
      ğŸ‘¤ Ø§Ù„Ø­Ø³Ø§Ø¨: <span id="currentUserTag" class="tag"></span>
      <span id="currentRoleTag" class="tag" style="background:#fff; color:#333"></span>
    </div>
    <div>
      <button class="btn-danger" onclick="logout()" style="width: auto; padding: 5px 15px; font-size: 12px; margin:0;">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>

  <div id="screenLogin" class="glass-card">
    <img src="Ø¯Ø±Ø¹77-removebg-preview.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„ÙÙˆØ¬" style="width:100px; drop-shadow:0 5px 5px rgba(0,0,0,0.3); margin-bottom:10px;">
    
    <h2 style="margin-top:0; color: white;">Ø§Ù„ÙÙˆØ¬ 77 Ø§Ù„Ø¨Ø­Ø±ÙŠ</h2>
    <div class="subtitle" style="color: #ddd; margin-bottom: 20px;">Ø¨ÙˆØ§Ø¨ØªÙƒ Ø§Ù„Ø±Ù‚Ù…ÙŠØ© Ù„Ù„Ø¹Ø§Ù„Ù… Ø§Ù„ÙƒØ´ÙÙŠ</div>

    <input type="email" id="loginEmail" class="glass-input" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="loginPassword" class="glass-input" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">

    <div id="loginError" class="error hidden"></div>

    <button onclick="handleLogin()" class="glass-btn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    
    <div style="margin-top: 15px; font-size: 14px;">
        <span style="color: #ccc;">Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ØŸ</span>
        <a href="#" onclick="showScreen('screenSignUp')" style="color: var(--accent-color); font-weight: bold;">ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</a>
    </div>
</div>

<div id="screenSignUp" class="glass-card hidden">
    <h2>Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</h2>
    <div class="info-box">Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø³Ø± Ù‚ÙˆÙŠØ© Ù„Ù„Ø¨Ø¯Ø¡</div>
    
    <input type="email" id="newEmail" class="glass-input" placeholder="ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="newPassword" class="glass-input" placeholder="ğŸ”’ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©">
    <input type="password" id="confirmPassword" class="glass-input" placeholder="ğŸ”’ ØªØ£ÙƒÙŠØ¯ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±">
    
    <div id="signUpError" class="error hidden"></div>
    
    <button onclick="handleSignUpStep1()">Ø§Ù„ØªØ§Ù„ÙŠ: Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø©</button>
    
    <div style="margin-top: 15px;">
        <a href="#" onclick="showScreen('screenLogin')" style="color: #ccc; text-decoration: none;">Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ Ø¯Ø®ÙˆÙ„</a>
    </div>
  </div>

  <div id="screenRank" class="glass-card hidden">
    <h2>Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø©</h2>
    <div class="info-box">
      Ø§Ø®ØªØ± Ø±ØªØ¨ØªÙƒ Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ø§ ÙŠØ­ØªØ§Ø¬ÙˆÙ† ÙƒÙˆØ¯.
    </div>

    <label>Ø§Ù„Ø±ØªØ¨Ø©</label>
    <select id="rankSelect" class="glass-input" style="background:#1a237e; color:white;" onchange="onRankChange()">
      <option value="">Ø§Ø®ØªØ±...</option>
      <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
      <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
      <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯</option>
      <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
    </select>

    <div id="rankCodeBox" class="hidden">
      <label>ÙƒÙˆØ¯ Ø§Ù„Ø±ØªØ¨Ø©</label>
      <input type="password" id="rankCodeInput" class="glass-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø®Ø§Øµ">
    </div>

    <div id="rankError" class="error hidden"></div>
    <button onclick="goToForm()">Ù…ØªØ§Ø¨Ø¹Ø©</button>
    
    <button onclick="showScreen('screenLogin')" style="background:transparent; border:1px solid #ccc; margin-top:5px;">Ø±Ø¬ÙˆØ¹</button>
  </div>

  <div id="screenForm" class="glass-panel hidden">
    <h2>Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨</h2>
    <div class="info-box" style="background:#e3f2fd; color:#0d47a1;">
      Ø³ÙŠØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±Ù‚Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹. ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¯Ù‚Ø©.
    </div>

    <div class="small" id="summaryLogin" style="margin-bottom:15px; font-weight:bold; color:#1a237e;"></div>

    <div class="two-cols">
      <div>
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input type="text" id="fullName">

        <label>Ø§Ø³Ù… Ø§Ù„Ø£Ø¨</label>
        <input type="text" id="fatherName">

        <label>Ø§Ø³Ù… Ø§Ù„Ø£Ù…</label>
        <input type="text" id="motherName">

        <label>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label>
        <input type="text" id="birthPlace">

        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯</label>
        <input type="date" id="birthDate">
      </div>

      <div>
        <label>Ø±Ù‚Ù… Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <input type="text" id="nationalId">

        <label>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©</label>
        <input type="text" id="nationality">

        <label>Ø§Ù„Ù…Ø¯Ø±Ø³Ø© / Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label>
        <input type="text" id="school">

        <label>Ø§Ù„ØµÙ / Ø§Ù„Ù…Ù‡Ù†Ø©</label>
        <input type="text" id="gradeJob">

        <label>Ø§Ù„Ø¬Ù†Ø³</label>
        <select id="gender">
          <option value="">Ø§Ø®ØªØ±...</option>
          <option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option>
          <option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option>
        </select>

        <label>Ø§Ù„Ø±ØªØ¨Ø© (Ø«Ø§Ø¨ØªØ©)</label>
        <input type="text" id="finalRank" disabled style="background:#eee;">

        <div id="leaderOptionsBox" class="hidden" style="background:#fff3e0; padding:10px; border-radius:8px; border:1px solid orange;">
          <label style="color:#e65100">Ù‡Ù„ Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ÙØ±Ù‚Ø©ØŸ</label>
          <select id="isLeaderOfTeam">
            <option value="">â€” Ø§Ø®ØªØ± â€”</option>
            <option value="yes">Ù†Ø¹Ù…</option>
            <option value="no">Ù„Ø§</option>
          </select>

          <div id="leaderTeamBox" class="hidden">
            <label>Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„ØªÙŠ ØªÙ‚ÙˆØ¯Ù‡Ø§</label>
            <select id="leaderTeamSelect">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ù‚Ø©</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
              <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
              <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
              <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
            </select>
          </div>
        </div>

      </div>
    </div>

    <div id="formError" class="error hidden"></div>
    <button onclick="submitEnrollment()">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
    <div id="resultBox" class="success hidden"></div>
  </div>

  <div id="screenMember" class="glass-panel hidden"></div>
  <div id="screenLeader" class="glass-panel hidden"></div>
  <div id="screenAccountant" class="glass-panel hidden"></div>
  <div id="screenAdmin" class="glass-panel hidden"></div>

  <div id="screenWarehouse" class="glass-panel hidden">
    <div id="warehouseContent"></div>
</div>
    <div id="screenBand" class="glass-panel hidden" style="max-width: 1200px;"></div>



<div id="detailsModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:15px; width:90%; max-width:500px; position:relative; max-height:90vh; overflow-y:auto; border: 1px solid #ccc; box-shadow: 0 10px 25px rgba(0,0,0,0.5); direction:rtl;">
        <span onclick="closeDetailsModal()" style="position:absolute; left:20px; top:15px; font-size:30px; cursor:pointer; color:#d32f2f; font-weight:bold;">&times;</span>
        <h3 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:15px; margin-top:0; color: #1a237e;">ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
        <div id="modalContent" style="line-height:1.8; color:#333;"></div>
        <button onclick="closeDetailsModal()" style="background:#555; width:100%; margin-top:15px; color:white;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="detailsModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:15px; width:95%; max-width:600px; position:relative; max-height:90vh; overflow-y:auto; direction:rtl; box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
        <span onclick="closeDetailsModal()" style="position:absolute; left:20px; top:15px; font-size:30px; cursor:pointer; color:#d32f2f; font-weight:bold;">&times;</span>
        <h3 style="text-align:center; color:#1a237e; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</h3>
        <div id="modalContent" style="color:#333; line-height:1.8; font-size:15px;"></div>
        <button onclick="closeDetailsModal()" style="background:#555; width:100%; margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>

<div id="editFullModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:15px; width:95%; max-width:700px; position:relative; max-height:95vh; overflow-y:auto; direction:rtl;">
        <h3 style="text-align:center; color:#1a237e; margin-top:0;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø´Ø§Ù…Ù„Ø©</h3>
        
        <div class="two-cols" style="text-align:right;">
            <div>
                <label style="color: black !important;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label><input type="text" id="ed_fullName">
                <label style="color: black !important;">Ø§Ø³Ù… Ø§Ù„Ø£Ø¨</label><input type="text" id="ed_father">
                <label style="color: black !important;">Ø§Ø³Ù… Ø§Ù„Ø£Ù…</label><input type="text" id="ed_mother">
                <label style="color: black !important;">Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯</label><input type="date" id="ed_birthDate">
                <label style="color: black !important;">Ù…ÙƒØ§Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©</label><input type="text" id="ed_birthPlace">
                <label style="color: black !important;">Ø§Ù„Ø¬Ù†Ø³</label>
                <select id="ed_gender"><option value="Ø°ÙƒØ±">Ø°ÙƒØ±</option><option value="Ø£Ù†Ø«Ù‰">Ø£Ù†Ø«Ù‰</option></select>
            </div>
            <div>
                <label style="color: black !important;">Ø§Ù„Ù‡Ø§ØªÙ</label><input type="text" id="ed_phone">
                <label style="color: black !important;">Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</label><input type="text" id="ed_address">
                <label style="color: black !important;">Ø§Ù„Ù…Ø¯Ø±Ø³Ø©/Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©</label><input type="text" id="ed_school">
                <label style="color: black !important;">Ø§Ù„Ù…Ù‡Ù†Ø©/Ø§Ù„ØµÙ</label><input type="text" id="ed_grade">
                <label style="color: black !important;">Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ</label><input type="text" id="ed_nationalId">
            </div>
        </div>

        <div style="background:#e3f2fd; padding:15px; border-radius:10px; margin-top:15px; border:1px solid #90caf9;">
            <label style="color:#0d47a1; font-weight:bold;">âšœï¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ´ÙÙŠØ©</label>
            <div class="two-cols">
                <div>
                    <label style="color: black !important;">Ø§Ù„Ø±ØªØ¨Ø©</label>
                    <select id="ed_rank">
                        <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
                        <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
                        <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯</option>
                        <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
                    </select>
                </div>
                <div>
                    <label style="color: black !important;">Ø§Ù„ÙØ±Ù‚Ø© (Ù„Ù„Ø¹Ø¶Ùˆ)</label>
                    <select id="ed_team">
                         <option value="">(Ø¨Ø¯ÙˆÙ†)</option>
                         <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                         <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                         <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                         <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:10px; border-top:1px solid #ccc; padding-top:10px;">
                <label style="color: black !important;">Ù‡Ù„ Ù‡Ùˆ Ù‚Ø§Ø¦Ø¯ ÙØ±Ù‚Ø©ØŸ</label>
                <select id="ed_isLeader" style="background:#fff3e0;">
                    <option value="no">Ù„Ø§</option>
                    <option value="yes">Ù†Ø¹Ù… (Ù„Ù‡ ØµÙ„Ø§Ø­ÙŠØ© Ù‚ÙŠØ§Ø¯Ø©)</option>
                </select>
                
                <label style="color: black !important;">Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„ØªÙŠ ÙŠÙ‚ÙˆØ¯Ù‡Ø§:</label>
                <select id="ed_leaderTeam">
                     <option value="">(Ù„Ø§ ÙŠÙˆØ¬Ø¯)</option>
                     <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                     <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                     <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                     <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                </select>
            </div>
        </div>

        <button onclick="saveFullEdit()" style="background:#2e7d32; margin-top:15px;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø©</button>
        <button onclick="closeEditModal()" style="background:#d32f2f; margin-top:5px;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
</div>
<div id="detailsModal" class="hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; display:none; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:15px; width:95%; max-width:600px; max-height:90vh; overflow-y:auto; direction:rtl; text-align:right;">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; margin-bottom:15px;">
             <h3 style="color:#1a237e; margin:0;">ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
             <span onclick="closeDetailsModal()" style="font-size:24px; cursor:pointer; color:red;">&times;</span>
        </div>
        <div id="modalContent" style="color:#333; line-height:1.8; font-size:15px;"></div>
        <button onclick="closeDetailsModal()" style="background:#555; width:100%; margin-top:15px;">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
</div>


</div>
<div id="modalAddItem" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1001; backdrop-filter: blur(5px);">
    <div class="glass-panel" style="width:450px; padding:0; overflow:hidden; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: #fff;">
        <div style="background: #27ae60; padding: 15px; text-align: center; color: white;">
            <h3 style="margin:0; font-size: 1.2rem;">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹</h3>
        </div>

        <div style="padding: 25px; color: #333; direction: rtl;">
            <div style="margin-bottom: 12px;">
                <label style="display:block; margin-bottom: 5px; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶:</label>
                <input type="text" id="add_itemName" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø®ÙŠÙ…Ø© Ø¹Ø³ÙƒØ±ÙŠØ©" style="width:100%; padding:10px; border-radius: 10px; border: 1px solid #ddd;">
            </div>

            <div style="margin-bottom: 12px;">
                <label style="display:block; margin-bottom: 5px; font-weight: bold;">Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
                <select id="add_itemCategory" style="width:100%; padding:10px; border-radius: 10px; border: 1px solid #ddd;">
                    <option value=" ØªØ®ÙŠÙŠÙ…"> ØªØ®ÙŠÙŠÙ…</option>
                    <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                    <option value="Ù…Ø·Ø¨Ø®">Ù…Ø·Ø¨Ø®</option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                </select>
            </div>

            <div style="background: #f9f9f9; padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #eee;">
                <label style="display:block; margin-bottom: 10px; font-weight: bold; color: #27ae60;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</label>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span>ğŸŒŸ Ù…Ù…ØªØ§Ø²:</span>
                    <input type="number" id="add_qtyEx" oninput="calculateAddTotal()" value="0" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span>âš–ï¸ ÙˆØ³Ø·:</span>
                    <input type="number" id="add_qtyGood" oninput="calculateAddTotal()" value="0" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span>ğŸ› ï¸ Ø¨Ø­Ø§Ø¬Ø© ØµÙŠØ§Ù†Ø©:</span>
                    <input type="number" id="add_qtyBroken" oninput="calculateAddTotal()" value="0" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>
                
                <hr style="border: 0; border-top: 1px solid #eee; margin: 10px 0;">
                
                <div style="display:flex; justify-content:space-between; font-weight:bold; color: #2c3e50;">
                    <span>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© (ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):</span>
                    <span id="add_totalDisplay" style="font-size: 1.2rem; color: #27ae60;">0</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom: 5px; font-weight: bold;">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†:</label>
                <input type="text" id="add_itemLoc" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙƒØ¨ÙŠØ± - Ø±Ù 4" style="width:100%; padding:10px; border-radius: 10px; border: 1px solid #ddd;">
            </div>

            <div style="display:flex; gap:15px;">
                <button onclick="saveNewItem()" style="background:#27ae60; color:white; flex:1; padding:12px; border:none; cursor:pointer; border-radius: 15px; font-weight: bold;">Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù</button>
                <button onclick="closeModal('modalAddItem')" style="background:#7f8c8d; color:white; flex:1; padding:12px; border:none; cursor:pointer; border-radius: 15px; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>
<div id="modalLoanItem" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1001; backdrop-filter: blur(5px);">
    <div class="glass-panel" style="width:500px; max-width:95%; max-height:90vh; display:flex; flex-direction:column; padding:0; overflow:hidden; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: #fdfdfd;">
        
        <div style="background: linear-gradient(135deg, #1a237e, #283593); padding: 15px; text-align: center; color: white; flex-shrink: 0;">
            <h3 style="margin:0; font-size: 1.2rem;">ğŸ“¤ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <p id="loanItemName" style="margin:5px 0 0; opacity:0.8; font-size:0.9rem;">(Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù Ù‡Ù†Ø§)</p>
        </div>

        <div style="padding: 20px; color: #333; direction: rtl; overflow-y: auto; flex-grow: 1;">
            
            <div id="itemSelectContainer" class="hidden" style="margin-bottom: 15px;">
                <label style="font-weight:bold; color:#1a237e;">Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹:</label>
                <select id="loanItemSelect" onchange="updateAvailableHint()" class="glass-input" style="background:white !important; color:#333 !important; border:1px solid #ccc !important; width: 100%; padding: 10px; border-radius: 8px;"></select>
            </div>

            <input type="hidden" id="loanItemId">

            <div style="margin-bottom: 15px;">
                <label style="font-weight:bold; color:#1a237e; margin-bottom:5px; display:block;">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù…:</label>
                <input type="text" id="loanPersonName" class="glass-input" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ù…Ø­Ù…Ø¯" style="background:white !important; color:#333 !important; border:1px solid #ccc !important; width: 100%; padding: 10px; border-radius: 8px;">
            </div>

            <label style="font-weight:bold; color:#1a237e; margin-bottom:10px; display:block;">ğŸ“¦ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            
            <div class="qty-row">
                <span class="qty-label">ğŸŒŸ Ù…Ù…ØªØ§Ø² <small style="color:#777; font-weight:normal;">(Ù…ØªÙˆÙØ±: <b id="availEx">0</b>)</small></span>
                <input type="number" id="loanQtyEx" class="qty-input" oninput="calcLoanTotal()" value="0" min="0">
            </div>

            <div class="qty-row">
                <span class="qty-label">âš–ï¸ ÙˆØ³Ø· <small style="color:#777; font-weight:normal;">(Ù…ØªÙˆÙØ±: <b id="availGood">0</b>)</small></span>
                <input type="number" id="loanQtyGood" class="qty-input" oninput="calcLoanTotal()" value="0" min="0">
            </div>

            <div class="qty-row">
                <span class="qty-label">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© <small style="color:#777; font-weight:normal;">(Ù…ØªÙˆÙØ±: <b id="availBroken">0</b>)</small></span>
                <input type="number" id="loanQtyBroken" class="qty-input" oninput="calcLoanTotal()" value="0" min="0">
            </div>
            
            <div class="total-summary-box" style="margin: 15px 0;">
                <span class="total-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©:</span>
                <span id="loanTotalDisplay" class="total-number">0</span>
            </div>

            <div class="date-row">
                <div>
                    <label style="font-weight:bold; font-size:0.9rem; display:block; margin-bottom:5px;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</label>
                    <input type="date" id="loanDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-family: 'Cairo', sans-serif;">
                </div>
                <div>
                    <label style="font-weight:bold; font-size:0.9rem; display:block; margin-bottom:5px;">Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹</label>
                    <input type="date" id="returnExpectedDate" style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; font-family: 'Cairo', sans-serif;">
                </div>
            </div>

            <div style="display:flex; gap:15px; margin-top: 25px;">
                <button onclick="confirmLoan()" style="background: linear-gradient(135deg, #1a237e, #283593); flex:2; padding: 12px; border-radius: 10px; font-weight: bold; color: white;">âœ… ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©</button>
                <button onclick="closeModal('modalLoanItem')" style="background:#e0e0e0; color:#333; flex:1; padding: 12px; border-radius: 10px; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>

<div id="screenWarehouseArchive" class="glass-panel hidden" style="max-width: 1000px;">
    <div style="padding: 20px; direction: rtl;">
        
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 2px solid #eee; padding-bottom: 10px;">
            <h2 style="color: #1a237e; margin: 0; font-weight: bold;">ğŸ“œ Ø³Ø¬Ù„ Ø­Ø±ÙƒØ© Ø§Ù„Ø¹Ù‡Ø¯Ø© (Ø§Ù„Ø£Ø±Ø´ÙŠÙ)</h2>
            
            <span onclick="document.getElementById('screenWarehouseArchive').classList.add('hidden'); showScreen('screenWarehouse');" 
                  style="cursor: pointer; font-size: 30px; color: #c62828; font-weight: bold; line-height: 1; padding: 0 10px;"
                  title="Ø¥ØºÙ„Ø§Ù‚">
                &times;
            </span>
        </div>

        <div style="overflow-x: auto; background: white; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee;">
            <table style="width: 100%; border-collapse: collapse; color: #333;">
                <thead style="background: linear-gradient(135deg, #1a237e, #283593); color: white;">
                    <tr>
                        <th style="padding: 15px; text-align: right;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th style="padding: 15px; text-align: right;">Ø§Ù„ØµÙ†Ù</th>
                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                        <th style="padding: 15px; text-align: right;">Ø§Ù„ÙƒÙ…ÙŠØ©</th>
                        <th style="padding: 15px; text-align: right;">Ø§Ù„Ù…Ø³ØªÙ„Ù…</th>
                        <th style="padding: 15px; text-align: right;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                    </tr>
                </thead>
                <tbody id="archiveTableBody">
                    </tbody>
            </table>
        </div>
    </div>
</div>
<div id="modalEditItem" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1001; backdrop-filter: blur(5px);">
    <div class="glass-panel" style="width:450px; padding:0; overflow:hidden; border-radius: 20px; border: 1px solid rgba(255,255,255,0.2); background: white;">
        <div style="background: #f39c12; padding: 15px; text-align: center; color: white;">
            <h3 style="margin:0; font-size: 1.2rem;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù</h3>
        </div>

        <div style="padding: 25px; color: #333; direction: rtl;">
            <input type="hidden" id="edit_itemId">

            <div style="margin-bottom: 12px;">
                <label style="display:block; margin-bottom: 5px; font-weight: bold;">Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶:</label>
                <input type="text" id="edit_itemName" style="width:100%; padding:10px; border-radius: 10px; border: 1px solid #ddd;">
            </div>

            <div style="background: #fff9f0; padding: 15px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #fce4bd;">
                <label style="display:block; margin-bottom: 10px; font-weight: bold; color: #e67e22;">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª (Ø§Ù„ÙƒÙ…ÙŠØ©):</label>
                
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span>ğŸŒŸ Ù…Ù…ØªØ§Ø²:</span>
                    <input type="number" id="edit_qtyEx" oninput="calculateEditTotal()" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                    <span>âš–ï¸ ÙˆØ³Ø·:</span>
                    <input type="number" id="edit_qtyGood" oninput="calculateEditTotal()" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>

                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:5px;">
                    <span>ğŸ› ï¸ ØµÙŠØ§Ù†Ø©:</span>
                    <input type="number" id="edit_qtyBroken" oninput="calculateEditTotal()" min="0" style="width:80px; padding:5px; border-radius:8px; border:1px solid #ccc; text-align:center;">
                </div>
                
                <hr style="border: 0; border-top: 1px solid #fce4bd; margin: 10px 0;">
                
                <div style="display:flex; justify-content:space-between; font-weight:bold;">
                    <span>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„ÙƒÙ„ÙŠØ© (ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹):</span>
                    <span id="edit_totalDisplay" style="font-size: 1.2rem; color: #e67e22;">0</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display:block; margin-bottom: 5px; font-weight: bold;">Ù…ÙƒØ§Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†:</label>
                <input type="text" id="edit_itemLoc" style="width:100%; padding:10px; border-radius: 10px; border: 1px solid #ddd;">
            </div>

            <div style="display:flex; gap:15px;">
                <button onclick="saveEditItem()" style="background:#27ae60; color:white; flex:1; padding:12px; border:none; cursor:pointer; border-radius: 15px; font-weight: bold;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button onclick="closeModal('modalEditItem')" style="background:#7f8c8d; color:white; flex:1; padding:12px; border:none; cursor:pointer; border-radius: 15px; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>
<div id="modalReturnItem" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:1001; backdrop-filter: blur(5px);">
    <div class="glass-panel" style="width: 500px; max-width: 95%; max-height: 90vh; display: flex; flex-direction: column; padding: 0; overflow: hidden; background: #fdfdfd; border-radius: 15px;">
        
        <div style="background: linear-gradient(135deg, #2e7d32, #43a047); padding: 15px; text-align: center; color: white; flex-shrink: 0;">
            <h3 style="margin:0; font-size: 1.2rem;">ğŸ“¥ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹</h3>
        </div>

        <div style="padding: 20px; direction: rtl; overflow-y: auto; flex-grow: 1;">
            
            <div style="background:#e8f5e9; padding:12px; border-radius:10px; margin-bottom:15px; border:1px solid #c8e6c9; color:#1b5e20;">
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size: 0.9rem;">
                    <span>ğŸ‘¤ Ø§Ù„Ù…Ø³ØªÙ„Ù…: <b id="ret_personName">---</b></span>
                    <span>ğŸ“¦ Ø§Ù„ØµÙ†Ù: <b id="ret_itemName">---</b></span>
                </div>
                <div style="text-align:center; margin-top:5px; font-weight:bold; font-size:1rem; background: rgba(255,255,255,0.6); padding: 5px; border-radius: 8px;">
                    Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ø¥Ø±Ø¬Ø§Ø¹Ù‡: <span id="ret_totalQty" style="color:#d32f2f; font-size: 1.2rem;">0</span>
                </div>
                <input type="hidden" id="ret_logId">
                <input type="hidden" id="ret_itemId">
            </div>

            <label style="font-weight:bold; color:#2e7d32; margin-bottom:10px; display:block;">ğŸ” Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ø§Ø¦Ø¯Ø©:</label>
            
            <div class="qty-row">
                <span class="qty-label">ğŸŒŸ Ù…Ù…ØªØ§Ø² (Ø³Ù„ÙŠÙ…)</span>
                <input type="number" id="ret_qtyEx" class="qty-input" oninput="calculateRetTotal()" value="0" min="0">
            </div>

            <div class="qty-row">
                <span class="qty-label">âš–ï¸ ÙˆØ³Ø· (Ù…Ù‚Ø¨ÙˆÙ„)</span>
                <input type="number" id="ret_qtyGood" class="qty-input" oninput="calculateRetTotal()" value="0" min="0">
            </div>

            <div class="qty-row">
                <span class="qty-label">ğŸ› ï¸ ØµÙŠØ§Ù†Ø© (Ù…ØªØ¶Ø±Ø±)</span>
                <input type="number" id="ret_qtyBroken" class="qty-input" oninput="calculateRetTotal()" value="0" min="0">
            </div>
            
            <div class="total-summary-box" style="margin: 15px 0;">
                <span class="total-label">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ÙˆØ²Ø¹:</span>
                <span id="ret_totalDisplay" class="total-number">0</span>
            </div>

            <div style="margin-top: 15px;">
                <label style="font-weight:bold; margin-bottom:5px; display:block; color: #1a237e;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª:</label>
                <textarea id="ret_notes" placeholder="Ø³Ø¬Ù„ Ø£ÙŠ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù‡Ù†Ø§..." style="width:100%; padding:10px; border-radius: 8px; border: 1px solid #ccc; height: 60px; font-family: 'Cairo', sans-serif; resize: none;"></textarea>
            </div>

            <div style="display:flex; gap:10px; margin-top: 20px;">
                <button onclick="confirmReturn()" style="background: linear-gradient(135deg, #2e7d32, #43a047); flex:2; padding: 12px; border-radius: 10px; font-weight: bold; color: white;">ğŸ“¥ ØªØ£ÙƒÙŠØ¯</button>
                <button onclick="closeModal('modalReturnItem')" style="background:#e0e0e0; color:#333; flex:1; padding: 12px; border-radius: 10px; font-weight: bold;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
</div>
<script>
  // ==========================================
  // âš ï¸âš ï¸âš ï¸ Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‡Ù†Ø§ Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ âš ï¸âš ï¸âš ï¸
  const SUPABASE_URL = "https://cmdtvmncgewlhvjsyzsl.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNtZHR2bW5jZ2V3bGh2anN5enNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNjAxOTIsImV4cCI6MjA4MTYzNjE5Mn0.VIM-YoYvtcpzuPx_pFGQTee9UX75UhzjPdOFcEFo_s4";

  // âš ï¸âš ï¸âš ï¸ Ù‡Ù†Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: Ø³Ù…ÙŠÙ†Ø§Ù‡Ø§ supabaseClient Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† supabase âš ï¸âš ï¸âš ï¸
 const supabaseClient = window.supabase.createClient(
  SUPABASE_URL,
  SUPABASE_ANON_KEY,
  {
    auth: {
      persistSession: true,
      autoRefreshToken: true,
      detectSessionInUrl: true,
      storageKey: 'fouj77-auth'
    }
  }
);

// âœ… Ø§Ø¬Ø¹Ù„ currentUser Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ù…Ù† Supabase
window.currentUser = null;

// âœ… Ø£ÙˆÙ„ Ù…Ø§ Ø§Ù„ØµÙØ­Ø© ØªÙØªØ­: Ø§Ù‚Ø±Ø£ session ÙˆÙ‚Ø±Ø± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
async function bootstrapAuth() {
  const { data, error } = await supabaseClient.auth.getSession();

  // Ø­ØªÙ‰ Ù„Ùˆ errorØŒ Ø®Ù„ÙŠÙ‡ null Ù„ØªØ¬Ù†Ø¨ "Ù…Ø¨ÙŠÙ† Ù…Ø³Ø¬Ù„" ÙˆÙ‡Ùˆ Ù…Ùˆ Ù…Ø³Ø¬Ù„
  window.currentUser = data?.session?.user || null;

  if (window.currentUser) {
    if (typeof window.renderLoggedInUI === 'function') {
      window.renderLoggedInUI(window.currentUser);
    }
  } else {
    if (typeof window.resetUIToLogin === 'function') {
      window.resetUIToLogin();
    }
  }
}

// âœ… Listener ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø±)
supabaseClient.auth.onAuthStateChange((event, session) => {
  // Ø­Ø§ÙØ¸Ù†Ø§ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…
  if (event === 'SIGNED_OUT') {
    window.currentUser = null;

    if (typeof window.resetUIToLogin === 'function') {
      window.resetUIToLogin();
    } else if (typeof resetUIToLogin === 'function') {
      resetUIToLogin();
    }
    return;
  }

  // Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡: Ø®Ø° Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† session (Ø§Ù„Ø£Ø¶Ù…Ù†)
  if (event === 'SIGNED_IN' || event === 'TOKEN_REFRESHED' || event === 'USER_UPDATED') {
    window.currentUser = session?.user || null;
  } else {
    // Ù„Ø£ÙŠ Ø£Ø­Ø¯Ø§Ø« Ø£Ø®Ø±Ù‰: Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„ØªØ²Ø§Ù…Ù† Ø£ÙŠØ¶Ø§Ù‹
    window.currentUser = session?.user || null;
  }

  // Ø­Ø¯Ù‘Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  if (window.currentUser) {
    if (typeof window.renderLoggedInUI === 'function') {
      window.renderLoggedInUI(window.currentUser);
    }
  } else {
    if (typeof window.resetUIToLogin === 'function') {
      window.resetUIToLogin();
    }
  }
});

// Ø´ØºÙ‘Ù„Ù‡Ø§ Ø£ÙˆÙ„ Ù…Ø§ ØªÙØªØ­ Ø§Ù„ØµÙØ­Ø©
bootstrapAuth();


  // ====== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø³Ø§Ø¨Ø§Øª Ø®Ø§ØµØ© ======
  const ADMIN_EMAIL = "admin@fouj77.com";
  const ADMIN_PASSWORD = "admin123";
  const ACCOUNTANT_EMAIL = "acc@fouj77.com";
  const ACCOUNTANT_PASSWORD = "acc123";
const WAREHOUSE_EMAIL = "store@fouj77.com";
const WAREHOUSE_PASSWORD = "store123";
const BAND_EMAIL = "band@fouj77.com";
const BAND_PASSWORD = "band123";
  // Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø±ØªØ¨ Ø§Ù„Ø¹Ø§Ù„ÙŠØ©
  const RANK_CODES = {
    "Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„": "ARIFA77",
    "Ù…Ø³Ø§Ø¹Ø¯": "ASSIST77",
    "Ù‚Ø§Ø¦Ø¯": "F77LEADERS"
  };

  
// ====== Ù…ØªØ­ÙˆÙ„Ø§Øª Ø¹Ø§Ù…Ø© (Local Storage Ø§Ù„Ø¨Ø¯ÙŠÙ„) ======
  let globalRegistrations = [];
  let globalPayments = [];
  let globalExpenses = [];
  let globalExtraIncomes = [];
  // Ù…ØªØºÙŠØ± Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ ÙˆØ§Ù„Ø±ØªØ¨Ø© Ù…Ø¤Ù‚ØªØ§Ù‹ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
let pendingUser = { email: "", password: "", rank: "" };
  
  // ğŸ”´ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ù…ØªØ­ÙˆÙ„ Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¯ÙŠÙˆÙ†) ğŸ”´
  let globalLiabilities = [];
// ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (Ø§Ù†Ø³Ø®Ù‡Ø§ ÙˆØ¶Ø¹Ù‡Ø§ Ù‚Ø¨Ù„ initApp) ======
  function loadRegistrations(){ return globalRegistrations; }
  function loadPayments(){ return globalPayments; }
  function loadExpenses(){ return globalExpenses; }
  function loadExtraIncomes(){ return globalExtraIncomes; }
  // ====== Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‡ÙŠØ¦Ø© (Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­) ======
  async function initApp() {
    try {
        console.log("Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...");
        
        // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
        let { data: regs, error: e1 } = await supabaseClient.from('registrations').select('*');
        if(e1) throw e1;
        globalRegistrations = regs || [];

        // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙØ¹Ø§Øª
        let { data: pays, error: e2 } = await supabaseClient.from('payments').select('*');
        if(e2) throw e2;
        globalPayments = pays || [];

        // 3. Ø¬Ù„Ø¨ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
        let { data: exps, error: e3 } = await supabaseClient.from('expenses').select('*');
        if(e3) throw e3;
        globalExpenses = exps || [];

        // 4. Ø¬Ù„Ø¨ Ø§Ù„Ø¯Ø®Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ
        let { data: extra, error: e4 } = await supabaseClient.from('extra_incomes').select('*');
        if(e4) throw e4;
        globalExtraIncomes = extra || [];

        // 5. ğŸ”´ Ø§Ù„Ø¬Ø¯ÙŠØ¯: Ø¬Ù„Ø¨ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¯ÙŠÙˆÙ†) ğŸ”´
        // ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø£Ù†Ø´Ø£Øª Ø¬Ø¯ÙˆÙ„ liabilities ÙÙŠ Supabase
        let { data: liabs, error: e5 } = await supabaseClient.from('liabilities').select('*');
        if(e5) throw e5;
        globalLiabilities = liabs || [];

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ­Ù…ÙŠÙ„
        document.getElementById("loadingScreen").style.display = "none";
        
    } catch (err) {
        // Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø·Ø£
        document.getElementById("loadingScreen").innerHTML = `<h3 style='color:red; text-align:center; direction:ltr'>${err.message}</h3><p style='text-align:center'>ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ø£Ùˆ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ ÙÙŠ Supabase</p>`;
    }
  }
  // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
  window.onload = initApp;

  let currentUser = { email:null, password:null, rank:null, role:"user" }; 

  // ====== Ø£Ø¯ÙˆØ§Øª ======
  function calculateAge(birthDateStr){
    if(!birthDateStr) return null;
    const today = new Date();
    const bd = new Date(birthDateStr);
    let age = today.getFullYear() - bd.getFullYear();
    const m = today.getMonth() - bd.getMonth();
    if(m < 0 || (m === 0 && today.getDate() < bd.getDate())) age--;
    return age;
  }

  function getTeam(age, gender, rank){
    if(age === null) return "";
    if(rank === "Ù‚Ø§Ø¦Ø¯") return "";
    if(age >= 6 && age < 12)  return gender === "Ø°ÙƒØ±" ? "ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„" : "ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª";
    if(age >= 12 && age < 15) return gender === "Ø°ÙƒØ±" ? "ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†" : "ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª";
    if(age >= 15 && age < 18) return gender === "Ø°ÙƒØ±" ? "ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…" : "ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª";
    if(age >= 18)             return gender === "Ø°ÙƒØ±" ? "Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©" : "Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª";
    return "";
  }

  function countLeadersForTeam(team, excludeEmail=null){
    const regs = loadRegistrations();
    return regs.filter(r =>
      r.rank === "Ù‚Ø§Ø¦Ø¯" &&
      r.isLeaderOfTeam === "yes" &&
      r.leaderTeam === team &&
      (!excludeEmail || r.email !== excludeEmail)
    ).length;
  }

function showScreen(id) {
  const screens = [
    "screenLogin",
    "screenSignUp",
    "screenRank",
    "screenForm",
    "screenMember",
    "screenLeader",
    "screenAccountant",
    "screenAdmin",
    "screenWarehouse",
    "screenWarehouseArchive",
    "screenBand"
  ];

  // âœ…âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ø³ÙƒÙ‘Ø± Ø£ÙŠ Ù…ÙˆØ¯Ø§Ù„Ø§Øª/overlays Ù…ÙØªÙˆØ­Ø© + ÙÙƒ Ø§Ù„ØªØºØ¨ÙŠØ´/Ø§Ù„Ù‚ÙÙ„
  // 1) Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª: hidden + Ø¥Ø²Ø§Ù„Ø© display override
  document.querySelectorAll('.modal').forEach(m => {
    m.classList.add('hidden');
    m.style.removeProperty('display');
  });

  // 2) overlays: display none
  document.querySelectorAll(
    '.music-modal-overlay, .modal-overlay, .overlay, #modalOverlay, #overlay, .backdrop'
  ).forEach(o => {
    o.style.display = 'none';
    o.classList.add('hidden');
  });

  // 3) ÙÙƒ Ø£ÙŠ Ù‚ÙÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ù†ÙØ³Ù‡Ø§
  document.body.classList.remove(
    'modal-open', 'blur', 'blurred', 'no-scroll', 'stop-scroll', 'lock-scroll'
  );
  document.documentElement.classList.remove(
    'no-scroll', 'stop-scroll', 'lock-scroll'
  );
  document.body.style.removeProperty('overflow');
  document.body.style.removeProperty('pointer-events');
  document.documentElement.style.removeProperty('overflow');

  // âœ… ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ ÙƒÙ…Ø§ Ù‡Ùˆ
  screens.forEach(s => {
    const el = document.getElementById(s);
    if (el) el.classList.add("hidden");
  });

  const target = document.getElementById(id);
  if (target) target.classList.remove("hidden");
  else console.warn("showScreen: screen not found:", id);

  // âœ…âœ… (Ø­Ù…Ø§ÙŠØ© Ù…Ù‡Ù…Ù‘Ø© Ù„Ù„Ù€ Warehouse) Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰ warehouseContent Ø§Ø¹Ù…Ù„Ù‡ Ø­ØªÙ‰ Ù…Ø§ ÙŠØµÙŠØ± innerHTML Ø¹Ù„Ù‰ null
  if (id === "screenWarehouse") {
    let wc = document.getElementById("warehouseContent");
    if (!wc && target) {
      wc = document.createElement("div");
      wc.id = "warehouseContent";
      target.prepend(wc); // Ø£Ùˆ append Ø­Ø³Ø¨ Ù…Ø§ Ø¨ØªØ­Ø¨
      console.warn("showScreen: created #warehouseContent Ù„Ø£Ù†Ù‡ ÙƒØ§Ù† Ù…ÙÙ‚ÙˆØ¯");
    }
  }
}




  function updateTopbar(){
    const bar = document.getElementById("userTopbar");
    if(currentUser.email){
      bar.classList.remove("hidden");
      document.getElementById("currentUserTag").textContent = currentUser.email;
      let roleText = "Ù…Ø³ØªØ®Ø¯Ù…";
      if(currentUser.role === "admin") roleText = "Ù…Ø´Ø±Ù";
      else if(currentUser.role === "accountant") roleText = "Ù…Ø­Ø§Ø³Ø¨";
      else if(currentUser.role === "leader") roleText = "Ù‚Ø§Ø¦Ø¯";
      else if(currentUser.role === "member") roleText = "Ø¹Ø¶Ùˆ";
      document.getElementById("currentRoleTag").textContent = roleText;
    } else {
      bar.classList.add("hidden");
    }
  }

  function logout(){
    currentUser = { email:null, password:null, rank:null, role:"user" };
    updateTopbar();
    showScreen("screenLogin");
  }

 async function ensureSupabaseAuthSession(email, password) {
  // Ù†ÙØ³ Ø§Ù„Ø´ÙŠ Ø¨Ø³ ØªÙ†Ø¸ÙŠÙ Ø¨Ø³ÙŠØ· (Ù…Ø§ Ø¨ÙŠØ£Ø«Ø± Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚Ùƒ)
  email = (email || '').trim();
  password = (password || '').trim();

  // Ø¬Ø±Ù‘Ø¨ ÙŠØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø¹Ù„Ù‰ Supabase Auth
  let { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

  // Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø³Ø± ØºÙ„Ø·) => invalid login credentials
  if (error && (error.message || '').toLowerCase().includes('invalid login credentials')) {

    // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ù…ÙŠÙ‘Ø² Ø¨ÙŠÙ†:
    // 1) Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·  vs  2) Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯
    // Ù†Ø¹Ù…Ù„ lookup Ø³Ø±ÙŠØ¹ Ø¨Ø§Ù„Ù€ Auth Ø¹Ø¨Ø± signInWithOtp (Ù…Ø§ Ø±Ø­ ÙŠØ¨Ø¹Ø« Ø¥ÙŠÙ…ÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ø·Ù‘Ù„ØŸ)
    // Ø§Ù„Ø£ÙØ¶Ù„ ÙˆØ§Ù„Ø£Ø¶Ù…Ù†: Ù†Ø³ØªØ®Ø¯Ù… Admin API Ø¨Ø³ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ. ÙÙ†Ø¹Ù…Ù„ check Ø¹Ø¨Ø± signUp ÙˆÙ†Ù‚Ø±Ø£ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
    // Ù„Ø°Ù„Ùƒ: Ù†Ø­Ø§ÙˆÙ„ signUpØŒ ÙˆØ¥Ø°Ø§ Ù‚Ø§Ù„ already registered => Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ => ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·.
    const res = await supabaseClient.auth.signUp({ email, password });

    // âœ… Ø¥Ø°Ø§ signUp ÙØ´Ù„ Ù„Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹ â†’ Ù‡Ø°Ø§ ÙŠØ¹Ù†ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙˆØ¬ÙˆØ¯ Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙ„Ø·/Ù…Ø®ØªÙ„ÙØ©
    if (res.error) {
      const msg = (res.error.message || '').toLowerCase();

      // Ù…ÙˆØ¬ÙˆØ¯ Ø£ØµÙ„Ø§Ù‹
      if (msg.includes('already') || msg.includes('registered') || msg.includes('exists')) {

        // âœ… Ù‡ÙˆÙ† Ø®ÙŠØ§Ø±ÙŠÙ†:
        // A) ØªØ±Ø¬Ø¹ null ÙˆØ®Ù„ÙŠ handleLogin ÙŠØ·Ù„Ø¹ "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
        // B) Ø£Ùˆ ØªØ¨Ø¹Øª Reset Password (Ù…Ø«Ù„ Ù…Ø§ ÙƒÙ†Øª Ø¹Ø§Ù…Ù„)
        //
        // Ø¨Ù…Ø§ Ø¥Ù†Ùƒ Ø¨Ø¯Ùƒ ØªØ±Ø¬Ø¹ Ø±Ø³Ø§Ù„Ø© "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©" Ù…ØªÙ„ Ù‚Ø¨Ù„:
        // Ø±Ø­ Ù†Ø±Ø¬Ù‘Ø¹ null *Ø¨Ø¯ÙˆÙ†* alerts Ù…Ø²Ø¹Ø¬Ø©ØŒ ÙˆÙ†ØªØ±Ùƒ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ØªÙ‚Ø±Ø± Ø§Ù„Ø±Ø³Ø§Ù„Ø©.
        //
        // Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ ØªØªØ±Ùƒ Ø§Ù„Ù€ reset Ø´ØºØ§Ù„ Ù„Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ© ÙÙ‚Ø·ØŒ Ø®Ù„ÙŠÙ‡ Ø¨Ø´Ø±Ø· Ø®Ø§Ø±Ø¬ÙŠ Ø¨Ù€ handleLogin.

        // (Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„Ù‰ reset Ø­Ø³Ø¨ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠØŒ Ø®Ù„ÙŠÙ†Ø§ Ù†Ø¹Ù…Ù„Ù‡ "Ø§Ø®ØªÙŠØ§Ø±ÙŠ" Ø¨Ø´Ø±Ø·)
        // Ø­Ø§Ù„ÙŠØ§Ù‹: Ù†Ø®Ù„ÙŠ reset Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø³ Ø¨Ø¯ÙˆÙ† Ù…Ø§ ÙŠØ®Ø¨Ù‘Øµ ØªØ¬Ø±Ø¨Ø© "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
        // ÙŠØ¹Ù†ÙŠ: Ø§Ø¨Ø¹ØªÙ‡ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø¨ØªØ­Ø¨ØŒ Ø¨Ø³ Ù„Ø§ ØªØ¹ØªØ¨Ø±Ù‡ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„
        const { error: resetErr } = await supabaseClient.auth.resetPasswordForEmail(email, {
          redirectTo: window.location.origin + "/scout77.html"
        });

        if (resetErr) {
          console.error('Auth resetPasswordForEmail error:', resetErr);
          // Ù„Ø§ Ù†Ø¹Ù…Ù„ alert Ù‡ÙˆÙ† Ø­ØªÙ‰ Ù…Ø§ Ù†Ø³ØªØ¨Ø¯Ù„ Ø±Ø³Ø§Ù„Ø© "ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
          // Ø®Ù„ÙŠ handleLogin ÙŠØ¹Ø§Ù„Ø¬Ù‡Ø§
        } else {
          // Ù†ÙØ³ Ø§Ù„Ø´ÙŠ: Ø¨Ù„Ø§ alert Ø­ØªÙ‰ Ù…Ø§ ÙŠØ·Ù„Ø¹ Ø¨Ø¯Ù„ "ÙƒÙ„Ù…Ø© Ø³Ø± Ø®Ø§Ø·Ø¦Ø©"
          // Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ Ø±Ø³Ø§Ù„Ø©ØŒ Ø§Ø¹Ø±Ø¶Ù‡Ø§ Ù…Ù† handleLogin Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø³Ø§Ø¨
        }

        return null;
      }

      console.error('Auth signUp error:', res.error);
      return null;
    }

    // Ø¨Ø¹Ø¯ signUp Ø¬Ø±Ù‘Ø¨ signIn Ù…Ø¨Ø§Ø´Ø±Ø©
    const res2 = await supabaseClient.auth.signInWithPassword({ email, password });
    if (res2.error) {
      console.error('Auth signIn after signUp error:', res2.error);
      return null;
    }
    data = res2.data;

  } else if (error) {
    console.error('Auth signIn error:', error);
    return null;
  }

  return data?.user || data?.session?.user || null;
}


// ====== ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¹Ø¯Ù„ (Ù…Ø¹ ÙØ­Øµ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©) ======
// ===========================================
  // ğŸ”´ğŸ”´ Ø¯Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø§Ù„ØµØ§Ø±Ù…Ø© ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„Ø©) ğŸ”´ğŸ”´
  // ===========================================
 async function handleLogin() {

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª
    const email = document.getElementById("loginEmail").value.trim();
    const pass = document.getElementById("loginPassword").value.trim(); 
    const err = document.getElementById("loginError");

    // ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ Ø®Ø·Ø£ Ø³Ø§Ø¨Ù‚
    err.classList.add("hidden");

    if(!email || !pass){
      err.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±.";
      err.classList.remove("hidden");
      return;
    }

    // 1. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…
    if(email === ADMIN_EMAIL && pass === ADMIN_PASSWORD){

      // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ø£Ù†Ø´Ø¦ Ø¬Ù„Ø³Ø© Supabase Auth Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
      const authUser = await ensureSupabaseAuthSession(email, pass);
      if (!authUser?.id) {
        err.textContent = "âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Supabase Auth";
        err.classList.remove("hidden");
        return;
      }

      currentUser = { email, password:pass, rank:null, role:"admin" };
      err.classList.add("hidden");
      updateTopbar();
      buildAdminUI(); 
      showScreen("screenAdmin");
      return;
    }

    // 2. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
    if(email === ACCOUNTANT_EMAIL && pass === ACCOUNTANT_PASSWORD){

      // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡)
      const authUser = await ensureSupabaseAuthSession(email, pass);
      if (!authUser?.id) {
        err.textContent = "âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Supabase Auth";
        err.classList.remove("hidden");
        return;
      }

      currentUser = { email, password:pass, rank:null, role:"accountant" };
      err.classList.add("hidden");
      updateTopbar();
      buildAccountantUI(); 
      prepareAccountantScreen();
      showScreen("screenAccountant");
      return;
    }

    // 3. Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø£Ù…ÙŠÙ† Ø§Ù„Ø¹Ù‡Ø¯Ø©) - Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    if(email === WAREHOUSE_EMAIL && pass === WAREHOUSE_PASSWORD){

      // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡)
      const authUser = await ensureSupabaseAuthSession(email, pass);
      if (!authUser?.id) {
        err.textContent = "âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Supabase Auth";
        err.classList.remove("hidden");
        return;
      }

      currentUser = { email, password:pass, rank:null, role:"warehouse" };
      err.classList.add("hidden");
      updateTopbar();
       showScreen("screenWarehouse");
      buildWarehouseUI(); // Ø³Ù†Ù‚ÙˆÙ… Ø¨ØªØ¹Ø±ÙŠÙÙ‡Ø§ Ø§Ù„Ø¢Ù†
      return;
    }

    // âœ… 4. Ø¯Ø®ÙˆÙ„ Ù‚Ø§Ø¦Ø¯ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ© (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    if(email === BAND_EMAIL && pass === BAND_PASSWORD){

        // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡)
        const authUser = await ensureSupabaseAuthSession(email, pass);
        if (!authUser?.id) {
          err.textContent = "âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Supabase Auth";
          err.classList.remove("hidden");
          return;
        }

        currentUser = { email, password:pass, rank:null, role:"band_leader" };
        err.classList.add("hidden");
        updateTopbar();
        
        // ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ Ø£Ø¶ÙØª Ø¯Ø§Ù„Ø© buildBandUI ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø³Ø§Ø¨Ù‚Ø§Ù‹
        if (typeof buildBandUI === "function") {
            buildBandUI(); 
            showScreen("screenBand");
        } else {
            console.error("Ø¯Ø§Ù„Ø© buildBandUI ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©!");
            alert("Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©.");
        }
        return;
    }

    // 5. Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† (Ù‚Ø§Ø¯Ø© ÙˆØ¹Ù†Ø§ØµØ±) Ù…Ù† Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    const regs = loadRegistrations();
    const existing = regs.find(r => r.email === email);

    if(existing){
      // Ø£. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø±
      if (existing.password !== pass) {
          err.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!";
          err.classList.remove("hidden");
          return;
      }
      
      // Ø¨. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©
      if(existing.status === "pending") {
          err.textContent = "âœ‹ Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø³Ø§Ø¨Ùƒ Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.\nÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©.";
          err.style.whiteSpace = "pre-line";
          err.classList.remove("hidden");
          return;
      }

      // âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ø£Ù†Ø´Ø¦ Ø¬Ù„Ø³Ø© Supabase Auth Ø¨Ø¹Ø¯ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± + Ø§Ù„Ø­Ø§Ù„Ø©
      const authUser = await ensureSupabaseAuthSession(email, pass);
      if (!authUser?.id) {
        err.textContent = "âŒ ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ù„Ø³Ø© Supabase Auth";
        err.classList.remove("hidden");
        return;
      }

      // Ø¬. ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø© (Ù‚Ø§Ø¦Ø¯ Ø£Ùˆ Ø¹Ø¶Ùˆ)
      if(existing.rank === "Ù‚Ø§Ø¦Ø¯"){
        currentUser = { email, password:pass, rank:existing.rank, role:"leader" };
        err.classList.add("hidden");
        updateTopbar();
        buildLeaderUI(); 
        renderLeaderScreen();
        showScreen("screenLeader");
        return;
      } else {
        currentUser = { email, password:pass, rank:existing.rank, role:"member" };
        err.classList.add("hidden");
        updateTopbar();
        buildMemberUI(); 
        renderMemberScreen();
        showScreen("screenMember");
        return;
      }

    } else {
        // 5. ÙÙŠ Ø­Ø§Ù„ Ù„Ù… ÙŠØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ø¹ Ø£ÙŠ Ø­Ø³Ø§Ø¨ (Ù…Ø´Ø±ÙØŒ Ù…Ø­Ø§Ø³Ø¨ØŒ Ù…Ø³ØªÙˆØ¯Ø¹ØŒ Ø£Ùˆ Ø¹Ø¶Ùˆ)
        err.textContent = "âŒ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± Ù…Ø³Ø¬Ù„ Ø£Ùˆ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©.";
        err.classList.remove("hidden");
    }
}
  // ====== Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø© ======
  function onRankChange(){
    const rank = document.getElementById("rankSelect").value;
    const codeBox = document.getElementById("rankCodeBox");
    document.getElementById("rankError").classList.add("hidden");

    if(rank === "Ø¹Ù†ØµØ±" || rank === ""){
      codeBox.classList.add("hidden");
    } else {
      codeBox.classList.remove("hidden");
    }
  }

  function goToForm(){
    const rank = document.getElementById("rankSelect").value;
    const rankErr = document.getElementById("rankError");
    const codeInput = document.getElementById("rankCodeInput");

    if(!rank){
      rankErr.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø±ØªØ¨ØªÙƒ.";
      rankErr.classList.remove("hidden");
      return;
    }

    if(rank !== "Ø¹Ù†ØµØ±"){
      const neededCode = RANK_CODES[rank];
      const givenCode = codeInput.value.trim();
      if(!givenCode){
        rankErr.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø±ØªØ¨Ø©.";
        rankErr.classList.remove("hidden");
        return;
      }
      if(givenCode !== neededCode){
        rankErr.textContent = "ÙƒÙˆØ¯ Ø§Ù„Ø±ØªØ¨Ø© ØºÙŠØ± ØµØ­ÙŠØ­.";
        rankErr.classList.remove("hidden");
        return;
      }
    }

    rankErr.classList.add("hidden");
    currentUser.rank = rank;

    document.getElementById("finalRank").value = currentUser.rank;
    document.getElementById("summaryLogin").textContent =
      "Ø£Ù†Øª Ù…Ø³Ø¬Ù„ Ø¨Ø­Ø³Ø§Ø¨: " + currentUser.email + " | Ø§Ù„Ø±ØªØ¨Ø©: " + currentUser.rank;

    const leaderBox = document.getElementById("leaderOptionsBox");
    const leaderTeamBox = document.getElementById("leaderTeamBox");
    const isLeaderSel = document.getElementById("isLeaderOfTeam");
    const leaderTeamSel = document.getElementById("leaderTeamSelect");

    document.getElementById("resultBox").classList.add("hidden");
    document.getElementById("formError").classList.add("hidden");

    if(currentUser.rank === "Ù‚Ø§Ø¦Ø¯"){
      leaderBox.classList.remove("hidden");
      isLeaderSel.value = "";
      leaderTeamSel.value = "";
      leaderTeamBox.classList.add("hidden");
    } else {
      leaderBox.classList.add("hidden");
      isLeaderSel.value = "";
      leaderTeamSel.value = "";
      leaderTeamBox.classList.add("hidden");
    }
pendingUser.rank = rank;
    showScreen("screenForm");
  }

  document.addEventListener("change", function(e){
    if(e.target && e.target.id === "isLeaderOfTeam"){
      const val = e.target.value;
      const leaderTeamBox = document.getElementById("leaderTeamBox");
      if(val === "yes") leaderTeamBox.classList.remove("hidden");
      else leaderTeamBox.classList.add("hidden");
    }
  });

 // ===========================================
  // ğŸ”´ğŸ”´ Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ (Ø§Ù„Ù…Ø¹Ø¯Ù„Ø© Ù„Ù„Ø¹Ù…Ù„ Ù…Ø¹ pendingUser) ğŸ”´ğŸ”´
  // ===========================================
  async function submitEnrollment(){
    const fullName  = document.getElementById("fullName").value.trim();
    const father    = document.getElementById("fatherName").value.trim();
    const mother    = document.getElementById("motherName").value.trim();
    const birthPlace= document.getElementById("birthPlace").value.trim();
    const birthDate = document.getElementById("birthDate").value;
    const nationalId= document.getElementById("nationalId").value.trim();
    const nationality = document.getElementById("nationality").value.trim();
    const school    = document.getElementById("school").value.trim();
    const gradeJob  = document.getElementById("gradeJob").value.trim();
    const gender    = document.getElementById("gender").value;

    const formErr   = document.getElementById("formError");
    const resultBox = document.getElementById("resultBox");

    let isLeaderOfTeam = "";
    let leaderTeam     = "";

    // ğŸ”´ ØªØ¹Ø¯ÙŠÙ„ 1: ÙØ­Øµ Ø§Ù„Ø±ØªØ¨Ø© Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª pendingUser Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† currentUser
    if(pendingUser.rank === "Ù‚Ø§Ø¦Ø¯"){
      isLeaderOfTeam = document.getElementById("isLeaderOfTeam").value;
      if(!isLeaderOfTeam){
        formErr.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø­Ø¯Ø¯ Ù‡Ù„ Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ù…Ø³Ø¤ÙˆÙ„ Ø¹Ù† ÙØ±Ù‚Ø© Ø£Ù… Ù„Ø§.";
        formErr.classList.remove("hidden"); return;
      }
      if(isLeaderOfTeam === "yes"){
        leaderTeam = document.getElementById("leaderTeamSelect").value;
        if(!leaderTeam){
          formErr.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„ØªÙŠ ØªÙ‚ÙˆØ¯Ù‡Ø§.";
          formErr.classList.remove("hidden"); return;
        }
        // ğŸ”´ ØªØ¹Ø¯ÙŠÙ„ 2: ØªÙ…Ø±ÙŠØ± Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„ÙØ­Øµ
        const leadersCount = countLeadersForTeam(leaderTeam, pendingUser.email);
        if(leadersCount >= 2){
          formErr.textContent = "Ù‡Ø°Ù‡ Ø§Ù„ÙØ±Ù‚Ø© Ù„Ø¯ÙŠÙ‡Ø§ Ø¨Ø§Ù„ÙØ¹Ù„ Ù‚Ø§Ø¦Ø¯ÙŠÙ†.";
          formErr.classList.remove("hidden"); return;
        }
      }
    }

    if(!fullName || !birthDate || !gender){
      formErr.textContent = "Ø±Ø¬Ø§Ø¡Ù‹ Ø§Ù…Ù„Ø£ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©.";
      formErr.classList.remove("hidden"); return;
    }
    formErr.classList.add("hidden");
    resultBox.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸... Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±";
    resultBox.classList.remove("hidden");

    const age = calculateAge(birthDate);
    // ğŸ”´ ØªØ¹Ø¯ÙŠÙ„ 3: Ø­Ø³Ø§Ø¨ Ø§Ù„ÙØ±Ù‚Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
    const team = getTeam(age, gender, pendingUser.rank);

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const newMember = {
      id: Date.now(),
      // ğŸ”´ ØªØ¹Ø¯ÙŠÙ„ 4 (Ø§Ù„Ø¬ÙˆÙ‡Ø±ÙŠ): Ø£Ø®Ø° Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª
      email: pendingUser.email,
      password: pendingUser.password,
      rank: pendingUser.rank,
      
      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙƒÙ…Ø§ Ù‡ÙŠ ØªÙ…Ø§Ù…Ø§Ù‹
      fullName, fatherName: father, motherName: mother,
      birthPlace, birthDate, age, nationalId, nationality,
      school, gradeJob, gender, team, isLeaderOfTeam, leaderTeam,
      
      status: "pending"
    };

    // Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù€ Supabase (ÙƒÙ…Ø§ Ù‡Ùˆ)
    const { error } = await supabaseClient.from('registrations').insert([newMember]);

    if(error){
        console.error(error);
        formErr.textContent = "Ø®Ø·Ø£: " + error.message;
        formErr.classList.remove("hidden");
        resultBox.classList.add("hidden");
        return;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    globalRegistrations.push(newMember);

    // Ø±Ø³Ø§Ù„Ø© Ø§Ù„Ù†Ø¬Ø§Ø­ (ÙƒÙ…Ø§ Ù‡ÙŠ)
    let msg = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!\n";
    msg += "Ø­Ø³Ø§Ø¨Ùƒ Ø§Ù„Ø¢Ù† Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´Ø±Ù.\n";
    msg += "Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø­ØªÙ‰ ØªØªÙ… Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ.";
    
    resultBox.style.whiteSpace = "pre-line";
    resultBox.textContent = msg;

    // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø£Ù…Ø§Ù†
    pendingUser = {};

    // Ø¨Ø¹Ø¯ 4 Ø«ÙˆØ§Ù†ÙŠØŒ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø´Ø§Ø´Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    setTimeout(() => {
        logout(); 
    }, 4000);
  }

  // ====== 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø±Ù (ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù†ÙˆÙŠ) ======
async function buildAdminUI() {
    // 1. Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù‡ÙŠÙƒÙ„ (Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ ÙƒÙ„ Ø£Ù‚Ø³Ø§Ù…Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙˆØ¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)
    document.getElementById("screenAdmin").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù Ø§Ù„Ø¹Ø§Ù…</h2>
      
      <div class="section-box" style="background:#f0f4f8; border-right: 5px solid #1a237e;">
          <h3 style="margin-top:0;">ğŸ“Š Ù…Ù„Ø®Øµ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙØ±Ù‚ ÙˆÙ†Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ±</h3>
          <div style="overflow-x:auto;">
              <table style="width:100%; border-collapse: collapse; background: white; font-size: 14px;">
                  <thead style="background:#1a237e; color:white;">
                        <tr>
                          <th style="padding:10px; border:1px solid #ddd;">Ø§Ù„ÙØ±Ù‚Ø©</th>
                          <th style="border:1px solid #ddd;">Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±</th>
                          <th style="border:1px solid #ddd;">Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</th>
                          <th style="border:1px solid #ddd;">Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¹Ø§Ù…Ø©</th>
                      </tr>
                  </thead>
                  <tbody id="adminTeamsStatsBody">
                      <tr><td colspan="4" style="text-align:center; padding:10px;">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª...</td></tr>
                  </tbody>
              </table>
          </div>
      </div>

      <div class="section-box" style="background:#fff3e0; border:1px solid #ffb74d; padding:15px; border-radius:8px; margin-bottom:15px;">
        <h3 style="color:#ef6c00; margin-top:0;">ğŸ“… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ù†ÙˆÙŠ (Ø§Ù„ØªØ±ÙÙŠØ¹)</h3>
        <p class="small" style="color:#555;">Ø§Ø¶ØºØ· Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø¨Ø¯Ø§ÙŠØ© ÙƒÙ„ Ø¹Ø§Ù… ÙƒØ´ÙÙŠ. Ø³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£Ø¹Ù…Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆÙ†Ù‚Ù„ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ÙØ±Ù‚ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹.</p>
        <button onclick="updateAllAgesAndTeams()" style="background:#f57c00; font-weight:bold;">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø§Ø± ÙˆØ§Ù„ÙØ±Ù‚ Ø§Ù„Ø¢Ù†</button>
      </div>

      <div class="section-box" style="background:#e0f7fa; padding:15px; border-radius:8px;">
        <h3>ğŸ” Ø¨Ø­Ø« ÙˆÙÙ„ØªØ±Ø© Ù…ØªÙ‚Ø¯Ù…Ø©</h3>
        <div class="two-cols">
            <div>
                <label>Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…</label>
                <input type="text" id="filterName" oninput="renderAdminTable()" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ...">
            </div>
            <div>
                <label>ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚Ø©</label>
                <select id="filterTeam" onchange="renderAdminTable()">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                    <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
                    <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                </select>
            </div>
            <div>
    <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨</label>
    <select id="filterStatus" onchange="renderAdminTable()">
        <option value="">Ø§Ù„ÙƒÙ„</option>
        <option value="active">âœ… Ù†Ø´Ø· (Ù…Ù‚Ø¨ÙˆÙ„)</option>
        <option value="pending">â³ Ù…Ø¹Ù„Ù‚ (Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯)</option>
    </select>
</div>
            <div>
                <label>ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø©</label>
                <select id="filterRank" onchange="renderAdminTable()">
                    <option value="">Ø§Ù„ÙƒÙ„</option>
                    <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
                    <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
                    <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
                    <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯</option>
                </select>
            </div>
            <div>
                <label>ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø¹Ù…Ø±</label>
                <input type="number" id="filterAge" oninput="renderAdminTable()" placeholder="Ø§Ù„Ø¹Ù…Ø±">
            </div>
        </div>
      </div>

     <div class="section-box">
  <h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø«: <span id="countDisplay" style="color:#c62828">0</span> Ø¹Ø¶Ùˆ</h3>

  <div class="table-wrap">
    <table id="adminTable">
      <thead>
        <tr>
          <th>#</th>
          <th>Ø§Ù„Ø§Ø³Ù…</th>
          <th>Ø§Ù„ÙØ±Ù‚Ø©</th>
          <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
          <th>Ø§Ù„Ø¹Ù…Ø±</th>
          <th>Ù‚Ø§Ø¦Ø¯ØŸ</th>
          <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          <th>Ø§Ù„ØªÙØ§ØµÙŠÙ„</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="admin-actions">
    <button class="btn-danger" onclick="initApp()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±</button>
    <button class="btn-primary" onclick="exportAllMembersCSV()">ØªØµØ¯ÙŠØ± Excel</button>
  </div>
</div>

      <div id="detailsModal" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; position:relative; max-height:90vh; overflow-y:auto;">
            <span onclick="closeDetailsModal()" style="position:absolute; left:15px; top:10px; font-size:24px; cursor:pointer; font-weight:bold;">&times;</span>
            <h3 style="text-align:center; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</h3>
            <div id="modalContent" style="line-height:1.8;"></div>
            <button onclick="closeDetailsModal()" style="background:#555; width:100%; margin-top:15px; color:white;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    `;

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ù„ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    renderAdminTable(); // Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
    fetchAndRenderTeamsStats(); // Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±Ù‚
}

// ====== Ø¯Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±Ù‚ Ù„Ù„Ù…Ø´Ø±Ù ======
async function fetchAndRenderTeamsStats() {
    const statsBody = document.getElementById("adminTeamsStatsBody");
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª ÙˆØ³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù…Ù† Supabase
    const { data: activities } = await supabaseClient.from('activities').select('*');
    const { data: logs } = await supabaseClient.from('attendance_logs').select('status, is_excused, member_email');
    
    const regs = globalRegistrations; // Ù…ØµÙÙˆÙØªÙƒ Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ ÙƒÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡
    const teamNames = [
        "ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„", "ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª", "ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†", "ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª", 
        "ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…", "ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª", "Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©", "Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª"
    ];

    let html = "";

    teamNames.forEach(team => {
        const teamMembers = regs.filter(r => r.team === team && r.rank === "Ø¹Ù†ØµØ±");
        const teamActivities = activities ? activities.filter(a => a.team_name === team) : [];
        
        // Ø­Ø³Ø§Ø¨ Ù†Ø³Ø¨Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù„ÙØ±Ù‚Ø©
        const memberEmails = teamMembers.map(m => m.email);
        const teamLogs = logs ? logs.filter(l => memberEmails.includes(l.member_email)) : [];
        
        let attended = 0, total = 0;
        teamLogs.forEach(l => {
            if (l.status === "Ø­Ø§Ø¶Ø±") { attended++; total++; }
            else if (l.status === "ØºØ§Ø¦Ø¨" && !l.is_excused) { total++; }
        });

        const rate = total > 0 ? Math.round((attended / total) * 100) : 0;
        const color = rate >= 75 ? "#2e7d32" : (rate >= 50 ? "#f57c00" : "#d32f2f");

        html += `
            <tr>
                <td style="padding:8px; border:1px solid #ddd;"><b>${team}</b></td>
                <td style="text-align:center; border:1px solid #ddd;">${teamMembers.length}</td>
                <td style="text-align:center; border:1px solid #ddd;">${teamActivities.length}</td>
                <td style="text-align:center; border:1px solid #ddd; color:${color}; font-weight:bold;">${rate}%</td>
            </tr>`;
    });

    statsBody.innerHTML = html;
}

// ====== 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ (Ù…Ø¹ ÙÙ„Ø§ØªØ± Ø§Ù„ÙØ±Ù‚Ø© ÙˆØ§Ù„Ø±ØªØ¨Ø©) ======
 function buildAccountantUI(){
    document.getElementById("screenAccountant").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2>
      <div class="info-box">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª + Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</div>

      <div class="section-box" style="background:#fff3e0; padding:15px; border-radius:8px;">
        <h3>ğŸ’° ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        
        <div class="two-cols" style="margin-bottom:10px;">
          <div>
            <label>1. Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
            <select id="accQuarterSelect" onchange="renderAccountantMembersStatus()">
              <option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option>
              <option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option>
              <option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option>
              <option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option>
              <option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option>
            </select>
          </div>
          <div>
            <label>2. Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="accPayStatus" onchange="renderAccountantMembersStatus()">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="paid">Ù…Ø¯ÙÙˆØ¹ (Ø®Ø§Ù„Øµ)</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†)</option>
            </select>
          </div>
        </div>

        <div class="two-cols">
          <div>
            <label>3. Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚Ø©</label>
            <select id="accFilterTeam" onchange="renderAccountantMembersStatus()">
                <option value="">ÙƒÙ„ Ø§Ù„ÙØ±Ù‚</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
                <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
                <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
            </select>
          </div>
          <div>
            <label>4. Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø© </label>
            <select id="accFilterRank" onchange="renderAccountantMembersStatus()">
                <option value="">ÙƒÙ„ Ø§Ù„Ø±ØªØ¨</option>
                <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
                <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
                <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯</option>
                <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
            </select>
          </div>
        </div>

        <table id="accMembersStatusTable">
          <thead>
            <tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section-box" style="border: 2px solid #e57373;">
        <h3 style="color:#c62828;">ğŸ“‰ Ø°Ù…Ù… Ù…Ø§Ù„ÙŠØ© (Ø¯ÙŠÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡)</h3>
        <p class="small">Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆÙ„ÙƒÙ† Ù„Ù… ÙŠØªÙ… Ø¯ÙØ¹Ù‡Ø§ Ø¨Ø¹Ø¯ (Ù„Ø§ ØªØ¯Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ù„Ø§ Ø¹Ù†Ø¯ Ø§Ù„ØªØ³Ø¯ÙŠØ¯).</p>
        
        <div class="two-cols" style="background:#ffebee; padding:15px; border-radius:8px; margin-bottom:15px;">
             <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="liabMemberSelect"></select></div>
             <div><label>Ø§Ù„ØºØ±Ø¶ (Ù…Ø«Ù„Ø§Ù‹: Ø«Ù…Ù† ÙÙˆÙ„Ø§Ø±)</label><input type="text" id="liabDesc"></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø·Ù„ÙˆØ¨</label><input type="number" id="liabAmount"></div>
        </div>
        <button onclick="addLiability()" style="background:#c62828;">ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ø© (Ø¯ÙŠÙ†)</button>

        <hr style="margin: 20px 0; border-color:#ef9a9a;">
        
        <h4>Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ (ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹Ø©)</h4>
        <table id="liabilitiesTable">
            <thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„ØºØ±Ø¶</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
            <tbody></tbody>
        </table>
      </div>
      <div class="section-box">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© (Ù…Ø¨Ø§Ø´Ø±Ø© Ù„Ù„ØµÙ†Ø¯ÙˆÙ‚)</h3>
        <div class="two-cols">
          <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="payMemberSelect"></select></div>
          <div>
            <label>Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©</label>
            <select id="payType">
              <option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option>
              <option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option>
              <option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option>
              <option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option>
              <option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option>
              <option value="Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ">Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ</option>
            </select>
          </div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="payAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="payDate"></div>
        </div>
        <button onclick="addPayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
      </div>

      <div class="section-box">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ø§Ù…</h3>
        <div class="two-cols">
          <div><label>ÙˆØµÙ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„</label><input type="text" id="extraDesc"></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="extraAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="extraDate"></div>
        </div>
        <button onclick="addExtraIncome()">Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</button>
      </div>

      <div class="section-box">
        <h3>Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</h3>
        <div class="two-cols">
          <div><label>ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input type="text" id="expDesc"></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="expAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="expDate"></div>
        </div>
        <button onclick="addExpense()">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
      </div>

      <div class="section-box">
        <h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª Ø§Ù„Ø£Ø®ÙŠØ±</h3>
        <table id="paymentsTable">
          <thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="section-box">
        <h3>Ù…Ù„Ø®Øµ Ù…Ø§Ù„ÙŠ</h3>
        <div id="totalAmountBox" class="success"></div>
      </div>

      <div class="section-box">
        <h3>ØªØµØ¯ÙŠØ±</h3>
        <button onclick="exportFinancialCSV()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button>
      </div>
    `;
  }
  // ====== 2. Ù…Ù†Ø·Ù‚ Ø§Ù„ÙÙ„ØªØ±Ø© (Ù…Ø¹ Ø§Ù„Ø±ØªØ¨Ø© ÙˆØ§Ù„ÙØ±Ù‚Ø©) ======
  function renderAccountantMembersStatus(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const qSel = document.getElementById("accQuarterSelect");
    const sSel = document.getElementById("accPayStatus");
    const tSel = document.getElementById("accFilterTeam"); 
    const rSel = document.getElementById("accFilterRank"); // Ø¹Ù†ØµØ± Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const tbody = document.querySelector("#accMembersStatusTable tbody");

    if(!qSel || !sSel || !tbody) return;

    const quarter = qSel.value;
    const status = sSel.value;
    const filterTeam = tSel ? tSel.value : ""; 
    const filterRank = rSel ? rSel.value : ""; // Ù‚ÙŠÙ…Ø© Ø§Ù„Ø±ØªØ¨Ø©

    tbody.innerHTML = "";

    // 1. Ø§Ù„Ø­Ø³Ø§Ø¨
    const rows = regs.map(r => {
      const sum = pays
        .filter(p => p.memberEmail === r.email && p.type === quarter)
        .reduce((a,p) => a + Number(p.amount||0), 0);
      
      return { r, sum, paid: sum > 0 };
    });

    // 2. Ø§Ù„ÙÙ„ØªØ±Ø©
    const filteredRows = rows.filter(x => {
        // Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹
        const statusOk = status === "all" ? true : (status === "paid" ? x.paid : !x.paid);
        
        // Ø§Ù„ÙØ±Ù‚Ø©
        const teamOk = filterTeam === "" || x.r.team === filterTeam || x.r.leaderTeam === filterTeam;

        // Ø§Ù„Ø±ØªØ¨Ø© (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
        const rankOk = filterRank === "" || x.r.rank === filterRank;

        return statusOk && teamOk && rankOk;
    });

    // 3. Ø§Ù„Ø±Ø³Ù…
    if(filteredRows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:red;padding:10px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>";
        return;
    }

    filteredRows.forEach((x, idx) => {
      const color = x.paid ? "green" : "red";
      const icon  = x.paid ? "âœ”" : "âœ–";
      const statusText = x.paid ? "Ù…Ø¯ÙÙˆØ¹" : "ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹";
      
      tbody.innerHTML += `
        <tr>
          <td>${idx+1}</td>
          <td>${(x.r.fullName || x.r.name || (x.r.email ? x.r.email.split('@')[0] : 'â€”'))}</td>
          <td>${x.r.team || x.r.leaderTeam || "-"}</td>
          <td>${x.r.rank || ""}</td>
          <td style="font-weight:bold; color:${color}">${x.sum}</td>
          <td style="color:${color}">${icon} ${statusText}</td>
        </tr>
      `;
    });
  }

  // ====== 1. Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø·Ù„Ø¨Ùƒ) ======
 function prepareAccountantScreen(){
    // 1. ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¯ÙØ¹ (Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    fillPayMemberSelect();
    
    // 2. ØªØ¹Ø¨Ø¦Ø© Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø°Ù…Ù… (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) - Ù†Ù†Ø³Ø® Ù†ÙØ³ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
    // Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù†Ø§Ù‚Øµ Ø¹Ù†Ø¯Ùƒ
    const payList = document.getElementById("payMemberSelect");
    const liabList = document.getElementById("liabMemberSelect");
    
    if(payList && liabList){
        liabList.innerHTML = payList.innerHTML;
    }

    // 3. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    renderLiabilitiesTable();
    renderAccountantMembersStatus();
    renderPaymentsTable();
    
    // 4. Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® Ù„Ù„ÙŠÙˆÙ…
    document.getElementById("payDate").value = new Date().toISOString().slice(0,10);
  }
  function fillPayMemberSelect(){
    const regs = loadRegistrations();
    const sel = document.getElementById("payMemberSelect");
    if(!sel) return;
    sel.innerHTML = "";
    regs.forEach(r => {
sel.innerHTML += `<option value="${r.email}">${(r.fullName || r.name || (r.email ? r.email.split('@')[0] : 'â€”'))}${r.team ? (" - " + r.team) : ""}</option>`;
    });
  }

  async function addPayment(){
    const memberEmail = document.getElementById("payMemberSelect").value;
    const type = document.getElementById("payType").value;
    const amount = parseFloat(document.getElementById("payAmount").value || "0");
    const date = document.getElementById("payDate").value || new Date().toISOString().slice(0,10);
    if(!memberEmail || !amount){ alert("Ø§Ø®ØªØ§Ø±ÙŠ Ø¹Ø¶Ùˆ ÙˆØ£Ø¯Ø®Ù„ÙŠ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return; }

    const newPay = { id: Date.now(), memberEmail, type, amount, date };
    
    // Ø­ÙØ¸ ÙÙŠ Supabase
    const { error } = await supabaseClient.from('payments').insert([newPay]);
    if(error){ alert("Ø®Ø·Ø£: " + error.message); return; }

    globalPayments.push(newPay);
    renderPaymentsTable(); renderAccountantMembersStatus();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©.");
    document.getElementById("payAmount").value = "";
  }

  async function addExtraIncome(){
    const desc = document.getElementById("extraDesc").value.trim();
    const amount = parseFloat(document.getElementById("extraAmount").value || "0");
    const date = document.getElementById("extraDate").value || new Date().toISOString().slice(0,10);
    if(!desc || !amount){ alert("Ø£Ø¯Ø®Ù„ÙŠ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return; }

    const newExtra = { id: Date.now(), desc, amount, date };

    const { error } = await supabaseClient.from('extra_incomes').insert([newExtra]);
    if(error){ alert("Ø®Ø·Ø£: " + error.message); return; }

    globalExtraIncomes.push(newExtra);
    renderExtraIncomesTable(); renderPaymentsTable();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ.");
    document.getElementById("extraDesc").value = "";
    document.getElementById("extraAmount").value = "";
  }

  async function addExpense(){
    const desc = document.getElementById("expDesc").value.trim();
    const amount = parseFloat(document.getElementById("expAmount").value || "0");
    const date = document.getElementById("expDate").value || new Date().toISOString().slice(0,10);
    if(!desc || !amount){ alert("Ø£Ø¯Ø®Ù„ÙŠ ÙˆØµÙ ÙˆÙ…Ø¨Ù„Øº ØµØ­ÙŠØ­."); return; }

    const newExp = { id: Date.now(), desc, amount, date };
    
    const { error } = await supabaseClient.from('expenses').insert([newExp]);
    if(error){ alert("Ø®Ø·Ø£: " + error.message); return; }

    globalExpenses.push(newExp);
    renderExpensesTable(); renderPaymentsTable();
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ.");
    document.getElementById("expDesc").value = "";
    document.getElementById("expAmount").value = "";
  }

  function renderPaymentsTable(){
    const pays = loadPayments();
    const regs = loadRegistrations();
    const tbody = document.querySelector("#paymentsTable tbody");
    const box = document.getElementById("totalAmountBox");
    if(!tbody || !box) return;
    tbody.innerHTML = "";

    let subsTotal = 0, extraFromPays = 0;
    pays.forEach((p, idx) => {
      const member = regs.find(r => r.email === p.memberEmail);
      if(["Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨","Ø±Ø¨Ø¹ 1","Ø±Ø¨Ø¹ 2","Ø±Ø¨Ø¹ 3","Ø±Ø¨Ø¹ 4"].includes(p.type)) subsTotal += Number(p.amount||0);
      else extraFromPays += Number(p.amount||0);

const memberLabel = member
  ? (member.fullName || member.name || (member.email ? member.email.split('@')[0] : 'â€”'))
  : (p.memberEmail ? p.memberEmail.split('@')[0] : 'â€”');

tbody.innerHTML += `<tr><td>${idx+1}</td><td>${memberLabel}</td><td>${p.type}</td><td>${p.amount}</td><td>${p.date}</td></tr>`;
    });

    const extras = loadExtraIncomes();
    const extraFromExtras = extras.reduce((a,e)=>a+Number(e.amount||0),0);
    const exps = loadExpenses();
    const expTotal = exps.reduce((a,e)=>a+Number(e.amount||0),0);
    const extraTotal = extraFromPays + extraFromExtras;
    const net = subsTotal + extraTotal - expTotal;

    box.textContent =
      "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª: " + subsTotal + "\n" +
      "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯Ø®ÙˆÙ„Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©: " + extraTotal + "\n" +
      "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª: " + expTotal + "\n" +
      "Ø§Ù„ØµØ§ÙÙŠ: " + net;
  }

  function renderExpensesTable(){
    const exps = loadExpenses();
    const tbody = document.querySelector("#expensesTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    exps.forEach((e, idx) => tbody.innerHTML += `<tr><td>${idx+1}</td><td>${e.desc}</td><td>${e.amount}</td><td>${e.date}</td></tr>`);
  }

  function renderExtraIncomesTable(){
    const extras = loadExtraIncomes();
    const tbody = document.querySelector("#extraIncomesTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    extras.forEach((e, idx) => tbody.innerHTML += `<tr><td>${idx+1}</td><td>${e.desc}</td><td>${e.amount}</td><td>${e.date}</td></tr>`);
  }

  // ====== CSV (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…) ======
  function downloadCSV(filename, rows){
    const processRow = row => row.map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",");
    const csvContent = rows.map(processRow).join("\n");
    const blob = new Blob(["\uFEFF" + csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }

  function exportFinancialCSV(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    const exps = loadExpenses();
    const extras = loadExtraIncomes();
    const today = new Date().toISOString().slice(0,10);

    const rows = [["Ø§Ù„Ù†ÙˆØ¹","Ø§Ù„Ø§Ø³Ù…/Ø§Ù„ÙˆØµÙ","Ø§Ù„ØªÙØ§ØµÙŠÙ„","Ø§Ù„Ù…Ø¨Ù„Øº","Ø§Ù„ØªØ§Ø±ÙŠØ®"]];

    pays.forEach(p => {
      const member = regs.find(r => r.email === p.memberEmail);
      rows.push(["Ø¥ÙŠØ±Ø§Ø¯ (Ø¹Ø¶Ùˆ)", member ? (member.fullName||member.email) : p.memberEmail, p.type, p.amount, p.date]);
    });

    extras.forEach(e => rows.push(["Ø¥ÙŠØ±Ø§Ø¯ (Ø¹Ø§Ù…)", e.desc, "Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ Ø¹Ø§Ù…", e.amount, e.date]));
    exps.forEach(e => rows.push(["Ù…ØµØ±ÙˆÙ", e.desc, "", e.amount, e.date]));

    downloadCSV(`fouj77_financial_report_${today}.csv`, rows);
  }

  function exportAllMembersCSV(){
    const regs = loadRegistrations();
    const today = new Date().toISOString().slice(0,10);
    const rows = [["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„","Ø§Ù„Ø±ØªØ¨Ø©","Ø§Ù„ÙØ±Ù‚Ø©","Ø§Ù„Ø¹Ù…Ø±","Ø§Ù„Ø¬Ù†Ø³","Ù‚Ø§Ø¦Ø¯ ÙØ±Ù‚Ø©ØŸ","ÙØ±Ù‚Ø© ÙŠÙ‚ÙˆØ¯Ù‡Ø§"]];
    regs.forEach(r => rows.push([r.fullName||"", r.email||"", r.rank||"", r.team||"", r.age??"", r.gender||"", r.isLeaderOfTeam||"", r.leaderTeam||""]));
    downloadCSV(`fouj77_all_members_${today}.csv`, rows);
  }

  function exportLeaderTeamCSV(){
    const regs = loadRegistrations();
    const me = regs.find(r => r.email === currentUser.email && r.rank === "Ù‚Ø§Ø¦Ø¯");
    const today = new Date().toISOString().slice(0,10);
    if(!me){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ ØªØ³Ø¬ÙŠÙ„ Ù‚Ø§Ø¦Ø¯."); return; }

    const myTeam = (me.isLeaderOfTeam === "yes") ? me.leaderTeam : "";
    if(!myTeam){
      alert("Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø¨Ø¯ÙˆÙ† ÙØ±Ù‚Ø© Ù„Ø§ ÙŠÙ…Ù„Ùƒ ØµÙ„Ø§Ø­ÙŠØ© Ø¹Ø±Ø¶/ØªØµØ¯ÙŠØ± Ø¹Ù†Ø§ØµØ±.");
      return;
    }

    const members = regs.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    const rows = [["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„","Ø§Ù„Ø±ØªØ¨Ø©","Ø§Ù„ÙØ±Ù‚Ø©","Ø§Ù„Ø¹Ù…Ø±","Ø§Ù„Ø¬Ù†Ø³"]];
    members.forEach(r => rows.push([r.fullName||"", r.email||"", r.rank||"", r.team||"", r.age??"", r.gender||""]));
    downloadCSV(`fouj77_team_${myTeam}_${today}.csv`, rows);
  }
// ============================================================
  // ğŸ”´ğŸ”´ğŸ”´ Ø§Ù„ØµÙ‚ Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù‚Ø§Ø¦Ø¯ ÙˆØ§Ù„Ø¹Ø¶Ùˆ ğŸ”´ğŸ”´ğŸ”´
  // ============================================================

  // ====== 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© renderLeaderScreen) ======
  function buildLeaderUI(){
    document.getElementById("screenLeader").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
      <div class="info-box" id="leaderInfoBox"></div>

      <div class="section-box">
        <h3>ØªØµØ¯ÙŠØ±</h3>
        <button onclick="exportLeaderTeamCSV()">ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© ÙØ±Ù‚ØªÙŠ (Excel)</button>
      </div>

      <div class="section-box">
        <h3>ÙÙ„ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ø± (Ù„ÙØ±Ù‚ØªÙŠ)</h3>
        <select id="leaderAgeFilter" onchange="renderLeaderScreen()">
          <option value="">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
        </select>
      </div>

      <div class="section-box">
        <h3>Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ù‚Ø©</h3>
        <table id="leaderMembersTable">
          <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
  }

  function renderLeaderScreen(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    const me = regs.find(r => r.email === currentUser.email && r.rank === "Ù‚Ø§Ø¦Ø¯");
    const info = document.getElementById("leaderInfoBox");
    const tbody = document.querySelector("#leaderMembersTable tbody");
    if(!tbody || !info) return;
    tbody.innerHTML = "";

    if(!me){ info.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¦Ø¯."; return; }
    const myTeam = (me.isLeaderOfTeam === "yes") ? me.leaderTeam : "";
    if(!myTeam){ info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† ÙØ±Ù‚Ø©)."; return; }

    info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¹Ù„Ù‰: " + myTeam;

    // ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù…Ø± Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
    const sel = document.getElementById("leaderAgeFilter");
    if(sel && sel.options.length === 1){
         for(let i=6;i<30;i++) sel.innerHTML += `<option value="${i}">${i} Ø³Ù†Ø©</option>`;
    }
    const ageFilter = document.getElementById("leaderAgeFilter")?.value;

    let members = regs.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    if(ageFilter) members = members.filter(m => m.age == ageFilter);

    members.forEach((m, idx) => {
      const sum = pays.filter(p => p.memberEmail === m.email).reduce((a,p)=>a+Number(p.amount||0),0);
      tbody.innerHTML += `<tr><td>${idx+1}</td><td>${m.fullName}</td><td>${m.age}</td><td>${m.gender}</td><td>${m.rank}</td><td>${m.team}</td><td>${sum}</td></tr>`;
    });
  }

  // ====== 2. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø¶Ùˆ (Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© renderMemberScreen) ======
 

function renderMemberScreen(){
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const regs = loadRegistrations();
    // ğŸ”´ 1. ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø°Ù…Ù… (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    const liabs = globalLiabilities || []; 

    const member = regs.find(r => r.email === currentUser.email);
    
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù…Ù† HTML
    const infoBox = document.getElementById("memberWelcome");
    const tbodyInfo = document.querySelector("#memberInfoTable tbody");
    const tbodyPay  = document.querySelector("#memberPaymentsTable tbody");
    const tbodyStatus = document.querySelector("#memberStatusTable tbody");
    const totalsBox = document.getElementById("memberTotalsBox");

    // ğŸ”´ 2. Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ (Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    const alertBox = document.getElementById("memberDebtsAlert");
    const debtList = document.getElementById("memberDebtsList");

    if(!tbodyInfo || !tbodyPay) return;
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    tbodyInfo.innerHTML = ""; tbodyPay.innerHTML = ""; tbodyStatus.innerHTML = ""; totalsBox.textContent = "";

    if(!member){ infoBox.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."; return; }
    infoBox.textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + (member.fullName || "") + "ØŒ Ù‡Ø°Ù‡ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ.";

    // ============================================================
    // ğŸ”´ğŸ”´ğŸ”´ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø¯Ù„: Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠÙˆÙ† + Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ğŸ”´ğŸ”´ğŸ”´
    // ============================================================
    
    // 1. ØªÙ†Ø¸ÙŠÙ Ø¥ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ø¥Ø²Ø§Ù„Ø© ÙØ±Ø§ØºØ§Øª + Ø£Ø­Ø±Ù ØµØºÙŠØ±Ø©)
    const myEmailClean = currentUser.email.trim().toLowerCase();

    // (Ù„Ù„ÙØ­Øµ) Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¯ÙŠÙˆÙ† ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„
    console.log("Checking debts for:", myEmailClean);
    console.log("All liabilities:", liabs);

    // 2. ØªØµÙÙŠØ© Ø§Ù„Ø¯ÙŠÙˆÙ† (Ù…Ø¹ ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ø£Ø­Ø±Ù Ø§Ù„ÙƒØ¨ÙŠØ±Ø© ÙˆØ§Ù„ØµØºÙŠØ±Ø©)
    const myDebts = liabs.filter(l => {
        const debtEmail = (l.memberEmail || "").trim().toLowerCase();
        return debtEmail === myEmailClean;
    });
    
    console.log("Found debts:", myDebts);

    // 3. Ø¥Ø°Ø§ ÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†ØŒ Ù†Ø¸Ù‡Ø± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø£Ø­Ù…Ø± ÙˆÙ†Ø¹Ø¨Ø¦Ù‡
    if(myDebts.length > 0 && alertBox && debtList){
        alertBox.classList.remove("hidden"); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
        debtList.innerHTML = "";
        let totalDebt = 0;
        
        myDebts.forEach(d => {
            debtList.innerHTML += `<li>${d.desc}: ${d.amount} <span style="font-size:12px; color:#555">(${d.date})</span></li>`;
            totalDebt += Number(d.amount);
        });
        
        // Ø¥Ø¶Ø§ÙØ© Ø®Ø· ÙˆÙ…Ø¬Ù…ÙˆØ¹
        debtList.innerHTML += `<hr style="border-color:#ef9a9a; margin:5px 0;"><li><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${totalDebt}</strong></li>`;
    } else if (alertBox) {
        // Ø¥Ø°Ø§ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¯ÙŠÙˆÙ†ØŒ Ù†Ø®ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
        alertBox.classList.add("hidden");
    }
    // ============================================================
    // ğŸ”´ğŸ”´ğŸ”´ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…Ø¹Ø¯Ù„ ğŸ”´ğŸ”´ğŸ”´
    // ============================================================


    // --- (Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙƒÙ…Ø§ Ù‡Ùˆ ØªÙ…Ø§Ù…Ø§Ù‹) ---

    // 1. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ©
    tbodyInfo.innerHTML = `<tr><td>${member.fullName}</td><td>${member.age}</td><td>${member.gender}</td><td>${member.rank}</td><td>${member.team||""}</td></tr>`;

    // 2. ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª
    // (Ø£ÙŠØ¶Ø§Ù‹ Ù†Ø·Ø¨Ù‚ Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø°ÙƒÙŠØ© Ù‡Ù†Ø§ Ù„Ø¶Ù…Ø§Ù† Ø¸Ù‡ÙˆØ± Ø§Ù„Ø¯ÙØ¹Ø§Øª)
    const pays = loadPayments().filter(p => (p.memberEmail||"").trim().toLowerCase() === myEmailClean);
    let totalPaid = 0;
    pays.forEach((p, idx) => {
      totalPaid += Number(p.amount || 0);
      tbodyPay.innerHTML += `<tr><td>${idx+1}</td><td>${p.type}</td><td>${p.amount}</td><td>${p.date}</td></tr>`;
    });

    // 3. ØªØ¹Ø¨Ø¦Ø© Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª (Ø§Ù„Ø£Ø±Ø¨Ø§Ø¹)
    ["Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨","Ø±Ø¨Ø¹ 1","Ø±Ø¨Ø¹ 2","Ø±Ø¨Ø¹ 3","Ø±Ø¨Ø¹ 4"].forEach(item => {
      const sum = pays.filter(p => p.type === item).reduce((acc, p) => acc + Number(p.amount || 0), 0);
      const isPaid = sum > 0;
      tbodyStatus.innerHTML += `<tr><td>${item}</td><td>${isPaid ? "âœ… Ø®Ø§Ù„Øµ" : "âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"}</td><td>${sum}</td></tr>`;
    });

    totalsBox.textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: " + totalPaid;
  }
  // Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
  function exportLeaderTeamCSV(){ 
     const rows=[["Ø§Ù„Ø§Ø³Ù…","Ø§Ù„ÙØ±Ù‚Ø©","Ø§Ù„Ø±ØªØ¨Ø©"]];
     loadRegistrations().forEach(r=>rows.push([r.fullName,r.team,r.rank]));
     downloadCSV("leader_team.csv", rows);
  }
  // ============================================================
  // ğŸ”´ Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø© ğŸ”´
  // ============================================================

  // 1. Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø´Ø±Ù (Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
 
  
  // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù„Ù„Ù…Ø´Ø±Ù (Ù…Ø¹ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„)


  // 2. Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ±ÙÙŠØ¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ù…Ø§Ø± (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
  async function updateAllAgesAndTeams() {
    if (!confirm("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡ Ù‡Ø§Ù…:\nÙ‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† ØªØ­Ø¯ÙŠØ« Ø£Ø¹Ù…Ø§Ø± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØªØ±ÙÙŠØ¹Ù‡Ù… Ù„Ù„ÙØ±Ù‚ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŸ\n(Ù„Ù† ØªØªØ£Ø«Ø± Ø±ØªØ¨ Ø§Ù„Ù‚Ø§Ø¯Ø©)")) return;

    document.getElementById("loadingScreen").style.display = "flex";
    
    let updatedCount = 0;
    const updates = [];

    for (let member of globalRegistrations) {
        if (!member.birthDate) continue;

        const newAge = calculateAge(member.birthDate);
        let newTeam = member.team;
        
        // ØªØºÙŠÙŠØ± Ø§Ù„ÙØ±Ù‚Ø© ÙÙ‚Ø· Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‚Ø§Ø¦Ø¯Ø§Ù‹
        if (member.rank !== "Ù‚Ø§Ø¦Ø¯") {
             newTeam = getTeam(newAge, member.gender, member.rank);
        }

        if (newAge !== member.age || newTeam !== member.team) {
            const promise = supabaseClient
                .from('registrations')
                .update({ age: newAge, team: newTeam })
                .eq('id', member.id);
            updates.push(promise);
            
            member.age = newAge;
            member.team = newTeam;
            updatedCount++;
        }
    }

    await Promise.all(updates);
    document.getElementById("loadingScreen").style.display = "none";
    renderAdminTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    alert(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª ${updatedCount} Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­.`);
  }

  // 3. Ø¯Ø§Ù„Ø© Ù‚Ø¨ÙˆÙ„ Ø§Ù„Ø¹Ø¶Ùˆ (Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯Ù‡Ø§)
  async function approveMember(id){
      if(!confirm("ØªÙØ¹ÙŠÙ„ Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ")) return;
      const { error } = await supabaseClient.from('registrations').update({ status: 'active' }).eq('id', id);
      if(error){ alert(error.message); return; }
      
      const member = globalRegistrations.find(r => r.id === id);
      if(member) member.status = 'active';
      renderAdminTable();
  }
  // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø°Ù…Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© (Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ======

  // 1. Ø¥Ø¶Ø§ÙØ© Ø¯ÙŠÙ† Ø¹Ù„Ù‰ Ø¹Ø¶Ùˆ
  async function addLiability(){
    const memberEmail = document.getElementById("liabMemberSelect").value;
    const desc = document.getElementById("liabDesc").value;
    const amount = document.getElementById("liabAmount").value;
    
    if(!memberEmail || !desc || !amount) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

    const newLiab = { 
        // Ù„Ø§ Ù†Ø±Ø³Ù„ ID Ù„Ø£Ù† Supabase ÙŠÙ†Ø´Ø¦Ù‡ØŒ Ù„ÙƒÙ† Ù…Ø­Ù„ÙŠØ§Ù‹ Ø³Ù†Ø­ØªØ§Ø¬ ÙˆØ§Ø­Ø¯Ø§Ù‹ Ù…Ø¤Ù‚ØªØ§Ù‹
        memberEmail, 
        desc, 
        amount, 
        date: new Date().toISOString().slice(0,10) 
    };

    const { data, error } = await supabaseClient.from('liabilities').insert([newLiab]).select();
    if(error){ alert(error.message); return; }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„Ù‘ÙŠ (data[0] ØªØ­ØªÙˆÙŠ Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Ø§Ù„Ù€ ID ØªØ¨Ø¹Ù‡)
    if(data) globalLiabilities.push(data[0]);
    
    renderLiabilitiesTable(); // ØªØ­Ø¯ÙŠØ« Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°Ù…Ù…
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­ (Ù„Ù… ØªØ¯Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¨Ø¹Ø¯).");
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById("liabDesc").value = "";
    document.getElementById("liabAmount").value = "";
  }

 // 2. ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ø°Ù…Ø© (Ø§Ù„ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ Ø¯ÙØ¹Ø§Øª) - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø¹Ø¯Ù„Ø©
  async function settleLiability(id){
    if(!confirm("Ù‡Ù„ Ù‚Ø§Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø¯ÙØ¹ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¨Ù„Øº ÙØ¹Ù„Ø§Ù‹ØŸ\nØ³ÙŠØªÙ… ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø°Ù…Ø© Ø¥Ù„Ù‰ 'Ø¯ÙØ¹Ø© Ù…Ù‚Ø¨ÙˆØ¶Ø©' ÙˆØªØ¯Ø®Ù„ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.")) return;

    // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø°Ù…Ø©
    const liabIndex = globalLiabilities.findIndex(l => l.id === id);
    if(liabIndex === -1) return;
    const liab = globalLiabilities[liabIndex];

    // Ø£. Ø¥Ù†Ø´Ø§Ø¡ Ø¯ÙØ¹Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª
    const newPay = {
        id: Date.now(),  // ğŸ‘ˆğŸ‘ˆğŸ‘ˆ Ù‡Ø°Ø§ Ù‡Ùˆ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø°ÙŠ Ø£Ø¶ÙŠÙ Ù„Ø­Ù„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
        memberEmail: liab.memberEmail,
        type: "ØªØ³Ø¯ÙŠØ¯: " + liab.desc, 
        amount: liab.amount,
        date: new Date().toISOString().slice(0,10)
    };

    // Ø¹Ù…Ù„ÙŠØ© Ù…Ø²Ø¯ÙˆØ¬Ø©: Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© + Ø­Ø°Ù Ø°Ù…Ø©
    
    // 1. Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙØ¹Ø©
    const { error: payErr } = await supabaseClient.from('payments').insert([newPay]);
    if(payErr){ 
        console.error(payErr); // Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù…Ø¹Ø±ÙØªÙ‡
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹: " + payErr.message); 
        return; 
    }

    // 2. Ø­Ø°Ù Ø§Ù„Ø°Ù…Ø©
    const { error: delErr } = await supabaseClient.from('liabilities').delete().eq('id', id);
    if(delErr){ alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹ Ù„ÙƒÙ† ÙØ´Ù„ Ø­Ø°Ù Ø§Ù„Ø°Ù…Ø©: " + delErr.message); return; }

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø­Ù„Ù‘ÙŠ
    globalPayments.push(newPay);
    globalLiabilities.splice(liabIndex, 1);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    renderLiabilitiesTable();
    renderPaymentsTable();
    
    alert("ØªÙ… Ø§Ù„ØªØ³Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­! ØªØ­ÙˆÙ„ Ø§Ù„Ù…Ø¨Ù„Øº Ø¥Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚.");
  }
  // 3. Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø°Ù…Ù… Ù„Ù„Ù…Ø­Ø§Ø³Ø¨
  function renderLiabilitiesTable(){
    const tbody = document.querySelector("#liabilitiesTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    
    if(globalLiabilities.length === 0){
        tbody.innerHTML = "<tr><td colspan='5' style='color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø°Ù…Ù… Ù…Ø¹Ù„Ù‚Ø©. Ø§Ù„ÙƒÙ„ Ø®Ø§Ù„Øµ!</td></tr>";
        return;
    }

    globalLiabilities.forEach((l, idx) => {
        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ù„Ù„Ø¹Ø±Ø¶
        const memberName = globalRegistrations.find(r => r.email === l.memberEmail)?.fullName || l.memberEmail;
        
        tbody.innerHTML += `
            <tr>
                <td>${idx+1}</td>
                <td>${memberName}</td>
                <td>${l.desc}</td>
                <td style="color:red; font-weight:bold;">${l.amount}</td>
                <td>
                    <button onclick="settleLiability(${l.id})" style="background:var(--success-color);color: black !important; font-weight: bold; padding:5px 10px; font-size:12px;">
                       ğŸ’° Ø§Ø³ØªÙ„Ø§Ù… ÙˆØªØ³Ø¯ÙŠØ¯
                    </button>
                </td>
            </tr>
        `;
    });
  }
  // ============================================================
// ğŸ”´ Ø¯ÙˆØ§Ù„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ø¶Ùˆ (Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©) - ØªÙˆØ¶Ø¹ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù
// ============================================================


 // ===========================================
// ğŸ”´ğŸ”´ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙØ§ØµÙŠÙ„ ÙˆØ§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ ğŸ”´ğŸ”´
// ===========================================

// 1. ØªØ´ØºÙŠÙ„ Ø²Ø± Ø§Ù„ØªÙØ§ØµÙŠÙ„


function closeDetailsModal(){
    document.getElementById("detailsModal").style.display = "none";
}

// 2. ØªØ´ØºÙŠÙ„ Ø²Ø± Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„



    

function closeEditModal(){
    document.getElementById("editFullModal").style.display = "none";
}

// 3. Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© ÙÙŠ Supabase
async function saveFullEdit(){
    if(!currentEditingId) return;

    // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const updates = {
        fullName: document.getElementById("ed_fullName").value,
        fatherName: document.getElementById("ed_father").value,
        motherName: document.getElementById("ed_mother").value,
        birthDate: document.getElementById("ed_birthDate").value,
        birthPlace: document.getElementById("ed_birthPlace").value,
        gender: document.getElementById("ed_gender").value,
        
        phone: document.getElementById("ed_phone").value,
        address: document.getElementById("ed_address").value,
        school: document.getElementById("ed_school").value,
        gradeJob: document.getElementById("ed_grade").value,
        nationalId: document.getElementById("ed_nationalId").value,

        rank: document.getElementById("ed_rank").value,
        team: document.getElementById("ed_team").value,
        isLeaderOfTeam: document.getElementById("ed_isLeader").value,
        leaderTeam: document.getElementById("ed_leaderTeam").value
    };

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    if(updates.birthDate) {
        updates.age = calculateAge(updates.birthDate);
    }

    // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
    const { error } = await supabaseClient
        .from('registrations')
        .update(updates)
        .eq('id', currentEditingId);

    if(error){
        alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
    } else {
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­Ù„ÙŠØ§Ù‹
        const index = globalRegistrations.findIndex(r => r.id == currentEditingId);
        if(index !== -1) {
            globalRegistrations[index] = { ...globalRegistrations[index], ...updates };
        }
        
        closeEditModal();
        renderAdminTable(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹
    }
}
// ============================================================
// ğŸ”´ Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± (Ø§Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) ğŸ”´
// ============================================================

// 1. Ø¯Ø§Ù„Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ
async function editMember(id){
    // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¹Ø¶Ùˆ
    const index = globalRegistrations.findIndex(r => r.id === id);
    if(index === -1) return;
    const m = globalRegistrations[index];

    // Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ù†Ø³ØªØ®Ø¯Ù… Prompt Ù„Ù„Ø³Ù‡ÙˆÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹)
    const newName = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„:", m.fullName);
    if(newName === null) return; // Ø¥Ø°Ø§ Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡

    const newTeam = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙØ±Ù‚Ø©:", m.team || m.leaderTeam || "");
    const newRank = prompt("ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø©:", m.rank);
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
    const updates = {
        fullName: newName.trim(),
        team: newTeam ? newTeam.trim() : null,
        rank: newRank ? newRank.trim() : m.rank
    };

    // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
    const { error } = await supabaseClient.from('registrations').update(updates).eq('id', id);
    
    if(error){
        alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
    } else {
        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ Ø³Ø±ÙŠØ¹
        m.fullName = updates.fullName;
        m.team = updates.team;
        m.rank = updates.rank;
        renderAdminTable(); // Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
        alert("ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ âœ…");
    }
}

// 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØµØ¯ÙŠØ± (Excel / CSV)
function downloadCSV(filename, rows){
    const csvContent = "\uFEFF" + rows.map(r => r.map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",")).join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
}

function exportAllMembersCSV(){
    const regs = loadRegistrations();
    if(regs.length === 0) { alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØµØ¯ÙŠØ±"); return; }
    
    const today = new Date().toISOString().slice(0,10);
    
    // 1. Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© (ØªØ´Ù…Ù„ ÙƒÙ„ Ø´ÙŠØ¡ ÙÙŠ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨)
    const rows = [[
        "Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„", 
        "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ", 
        "Ø§Ø³Ù… Ø§Ù„Ø£Ø¨", 
        "Ø§Ø³Ù… Ø§Ù„Ø£Ù…", 
        "Ù…ÙƒØ§Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©", 
        "ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯", 
        "Ø§Ù„Ø¹Ù…Ø±", 
        "Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ/Ø§Ù„Ù‡ÙˆÙŠØ©", 
        "Ø§Ù„Ø¬Ù†Ø³ÙŠØ©", 
        "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©/Ø§Ù„Ø¬Ø§Ù…Ø¹Ø©", 
        "Ø§Ù„Ù…Ù‡Ù†Ø©/Ø§Ù„ØµÙ", 
        "Ø§Ù„Ø¬Ù†Ø³", 
        "Ø§Ù„Ø±ØªØ¨Ø©", 
        "Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©", 
        "Ø§Ù„Ø­Ø§Ù„Ø©", 
        "Ù‚Ø§Ø¦Ø¯ ÙØ±Ù‚Ø©ØŸ", 
        "Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„ØªÙŠ ÙŠÙ‚ÙˆØ¯Ù‡Ø§",
        "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ",
        "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†"
    ]];
    
    // 2. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    regs.forEach(r => {
        rows.push([
            r.fullName || "",
            r.email || "",
            r.fatherName || "-",
            r.motherName || "-",
            r.birthPlace || "-",
            r.birthDate || "-",
            r.age || "",
            r.nationalId || "-",
            r.nationality || "-",
            r.school || "-",
            r.gradeJob || "-",
            r.gender || "",
            r.rank || "",
            r.team || r.leaderTeam || "",
            r.status === "active" || r.status === "approved" ? "Ù†Ø´Ø·" : "Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©",
            r.isLeaderOfTeam === "yes" ? "Ù†Ø¹Ù…" : "Ù„Ø§",
            r.leaderTeam || "",
            r.phone || "-",   // Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„ ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡
            r.address || "-"  // Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ ÙÙŠ Ø­Ø§Ù„ ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡
        ]);
    });

    downloadCSV(`Fouj77_Full_Members_${today}.csv`, rows);
}

// Ø¯Ø§Ù„Ø© ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ (Ù„Ù„Ù…Ø­Ø§Ø³Ø¨)
function exportFinancialCSV(){
    const pays = loadPayments();
    const regs = loadRegistrations();
    const today = new Date().toISOString().slice(0,10);

    const rows = [["Ø±Ù‚Ù… Ø§Ù„ÙˆØµÙ„", "Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ", "Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø©", "Ø§Ù„Ù…Ø¨Ù„Øº", "Ø§Ù„ØªØ§Ø±ÙŠØ®"]];

    pays.forEach((p, idx) => {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¥ÙŠØ¬Ø§Ø¯ Ø§Ù„Ø§Ø³Ù…
        const memberName = regs.find(r => r.email === p.memberEmail)?.fullName || p.memberEmail;
        rows.push([idx+1, memberName, p.type, p.amount, p.date]);
    });

    downloadCSV(`Fouj77_Financial_${today}.csv`, rows);
}

// ============================================================
// ğŸ”´ğŸ”´ğŸ”´ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ø£Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) ğŸ”´ğŸ”´ğŸ”´
// ============================================================

// 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
function buildAccountantUI(){
    document.getElementById("screenAccountant").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2>
      <div class="info-box">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª + Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</div>

      <div class="section-box" style="background:#fff3e0; padding:15px; border-radius:8px;">
        <h3>ğŸ’° ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        <div class="two-cols">
          <div>
            <label>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
            <select id="accQuarterSelect" onchange="renderAccountantMembersStatus()">
              <option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option>
              <option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option>
              <option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option>
              <option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option>
              <option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option>
            </select>
          </div>
          <div>
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="accPayStatus" onchange="renderAccountantMembersStatus()">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="paid">Ù…Ø¯ÙÙˆØ¹ (Ø®Ø§Ù„Øµ)</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†)</option>
            </select>
          </div>
        </div>
        <div class="two-cols">
            <div><label>Ø§Ù„ÙØ±Ù‚Ø©</label><select id="accFilterTeam" onchange="renderAccountantMembersStatus()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option></select></div>
            <div><label>Ø§Ù„Ø±ØªØ¨Ø©</label><select id="accFilterRank" onchange="renderAccountantMembersStatus()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option><option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option></select></div>
        </div>
        <table id="accMembersStatusTable"><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box" style="border: 2px solid #e57373;">
        <h3 style="color:#c62828;">ğŸ“‰ Ø°Ù…Ù… Ù…Ø§Ù„ÙŠØ© (Ø¯ÙŠÙˆÙ†)</h3>
        <div class="two-cols" style="background:#ffebee; padding:10px;">
             <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="liabMemberSelect"></select></div>
             <div><label>Ø§Ù„ØºØ±Ø¶</label><input type="text" id="liabDesc"></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="liabAmount"></div>
        </div>
        <button onclick="addLiability()" style="background:#c62828;">ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ø©</button>
        <hr>
        <table id="liabilitiesTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„ØºØ±Ø¶</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© (Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚)</h3>
        <div class="two-cols">
          <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="payMemberSelect"></select></div>
          <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="payType"><option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option><option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option><option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option><option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option><option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option><option value="Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ">Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ</option></select></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="payAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="payDate"></div>
        </div>
        <button onclick="addPayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
      </div>

      <div class="section-box"><h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3><table id="paymentsTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table></div>
      <div class="section-box"><h3>Ø§Ù„Ù…Ù„Ø®Øµ</h3><div id="totalAmountBox" class="success"></div></div>
      <div class="section-box"><button onclick="exportFinancialCSV()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button></div>
    `;
}

// 2. ØªØ´ØºÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
function prepareAccountantScreen(){
    const regs = loadRegistrations();
    const paySel = document.getElementById("payMemberSelect");
    const liabSel = document.getElementById("liabMemberSelect");
    
    if(paySel) paySel.innerHTML = ""; 
    if(liabSel) liabSel.innerHTML = "";
    
    regs.forEach(r => {
        const opt = `<option value="${r.email}">${r.fullName}</option>`;
        if(paySel) paySel.innerHTML += opt; 
        if(liabSel) liabSel.innerHTML += opt;
    });
    
    const dateInput = document.getElementById("payDate");
    if(dateInput) dateInput.value = new Date().toISOString().slice(0,10);
    
    renderLiabilitiesTable(); 
    renderAccountantMembersStatus(); 
    renderPaymentsTable();
}

// 3. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ø¶Ùˆ (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù†Ø§Ù‚ØµØ© Ø£ÙŠØ¶Ø§Ù‹)
function buildMemberUI(){
    document.getElementById("screenMember").innerHTML = `
      <div style="text-align: center; margin-bottom: 20px;">
        <h2 style="color: #1a237e;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¹Ø¶Ùˆ</h2>
        <div class="info-box" id="memberWelcome"></div>
      </div>

      <div id="memberDebtsAlert" class="hidden" style="background:#ffebee; border:2px solid #ef5350; padding:15px; border-radius:8px; margin-bottom:20px;">
        <h3 style="color:#c62828; margin-top:0;">âš ï¸ Ø¹Ù„ÙŠÙƒ Ø°Ù…Ù… Ù…Ø§Ù„ÙŠØ© (Ø¯ÙŠÙˆÙ†)</h3>
        <p style="color:#d32f2f;">ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
        <ul id="memberDebtsList" style="padding-right:20px; color:#b71c1c; font-weight:bold; list-style-type: disc;"></ul>
      </div>

      <div class="section-box" style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
          <div style="flex: 1; min-width: 140px; background: #e3f2fd; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #2196F3;">
              <h4 style="margin:0; color: #0d47a1;">Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹Ø§Øª</h4>
              <div id="meetingRate" style="font-size: 24px; font-weight: bold; color: #1a237e;">--%</div>
              <small>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</small>
          </div>
          <div style="flex: 1; min-width: 140px; background: #f1f8e9; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #4caf50;">
              <h4 style="margin:0; color: #1b5e20;">Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h4>
              <div id="activityRate" style="font-size: 24px; font-weight: bold; color: #1b5e20;">--%</div>
              <small>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</small>
          </div>
      </div>

      <div id="bandStatsSection" class="hidden" style="margin-top: 15px;">
          <h3 style="color: #e65100; border-right: 4px solid #e65100; padding-right: 10px; margin-bottom: 10px;">
             ğŸº Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©
          </h3>
          <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
              <div style="flex: 1; min-width: 140px; background: #fff3e0; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #ffb74d;">
                  <h4 style="margin:0; color: #e65100;">ØªØ¯Ø±ÙŠØ¨ ğŸ»</h4>
                  <div id="myBandTrainRate" style="font-size: 24px; font-weight: bold; color: #ef6c00;">--%</div>
                  <small>Ù†Ø³Ø¨Ø© Ø§Ù„Ø§Ù„ØªØ²Ø§Ù…</small>
              </div>
              <div style="flex: 1; min-width: 140px; background: #ffebee; padding: 15px; border-radius: 12px; text-align: center; border: 1px solid #ef5350;">
                  <h4 style="margin:0; color: #c62828;">Ø¹Ø±ÙˆØ¶ ğŸº</h4>
                  <div id="myBandShowRate" style="font-size: 24px; font-weight: bold; color: #c62828;">--%</div>
                  <small>Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©</small>
              </div>
          </div>
      </div>

      <div class="section-box">
          <h3 style="border-right: 4px solid #1a237e; padding-right: 10px;">ğŸ•’ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ù†Ø´Ø§Ø·Ø§Øª</h3>
          <div id="memberAttendanceTimeline" style="max-height: 250px; overflow-y: auto; padding: 10px; background: #fafafa; border-radius: 8px;">
              Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...
          </div>
      </div>

      <div class="section-box">
        <h3>Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</h3>
        <table id="memberInfoTable"><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th></tr></thead><tbody></tbody></table>
        
        <div style="margin-top: 15px; text-align: center;">
            <button onclick="showMemberDetails(currentUser.email)" style="background:#2196F3; width: 100%; border:none; color:white; padding:10px; border-radius:5px; cursor:pointer;">ğŸ“„ Ø¹Ø±Ø¶ Ù…Ù„ÙÙŠ Ø§Ù„ÙƒØ§Ù…Ù„</button>
            <button onclick="openBandJoinSafely()" style="background: linear-gradient(45deg, #d35400, #e67e22); margin-top: 10px; width: 100%; border:none; color:white; padding:10px; border-radius:5px; cursor:pointer; font-weight: bold;">
                ğŸº ØªÙ‚Ø¯ÙŠÙ… Ø·Ù„Ø¨ Ø§Ù†ØªØ³Ø§Ø¨ Ù„Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©
            </button>
        </div>
      </div>

      <div class="section-box">
        <h3>Ø¯ÙØ¹Ø§ØªÙŠ</h3>
        <table id="memberPaymentsTable"><thead><tr><th>#</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
        <h3>Ø­Ø§Ù„Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ</h3>
        <table id="memberStatusTable"><thead><tr><th>Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead><tbody></tbody></table>
        <div id="memberTotalsBox" class="success"></div>
      </div>
      
      <div id="detailsModal" class="modal hidden" style="position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; display:none; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; max-height:90vh; overflow-y:auto; position:relative;">
            <span onclick="closeDetailsModal()" style="position:absolute; left:15px; top:10px; font-size:24px; cursor:pointer;">&times;</span>
            <h3>ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h3>
            <div id="modalContent"></div>
            <button onclick="closeDetailsModal()" style="width:100%; margin-top:10px;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>
    `;
    
    fetchMemberAttendanceStats();
    fetchMyBandStats(); 
}
function renderMemberScreen(){
    const regs = loadRegistrations();
    const liabs = globalLiabilities || [];
    const member = regs.find(r => r.email === currentUser.email);
    const alertBox = document.getElementById("memberDebtsAlert");
    const debtList = document.getElementById("memberDebtsList");

    if(!member) return;
    document.getElementById("memberWelcome").textContent = "Ù…Ø±Ø­Ø¨Ø§Ù‹ " + member.fullName;
    document.querySelector("#memberInfoTable tbody").innerHTML = `<tr><td>${member.fullName}</td><td>${member.age}</td><td>${member.gender}</td><td>${member.rank}</td><td>${member.team||""}</td></tr>`;

    const myEmailClean = currentUser.email.trim().toLowerCase();
    const myDebts = liabs.filter(l => (l.memberEmail||"").trim().toLowerCase() === myEmailClean);
    
    if(myDebts.length > 0 && alertBox){
        alertBox.classList.remove("hidden");
        debtList.innerHTML = "";
        let totalDebt = 0;
        myDebts.forEach(d => {
            debtList.innerHTML += `<li>${d.desc}: ${d.amount}</li>`;
            totalDebt += Number(d.amount);
        });
        debtList.innerHTML += `<hr><li><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹: ${totalDebt}</strong></li>`;
    } else if(alertBox) { alertBox.classList.add("hidden"); }

    const pays = loadPayments().filter(p => (p.memberEmail||"").trim().toLowerCase() === myEmailClean);
    const tbodyPay = document.querySelector("#memberPaymentsTable tbody");
    const tbodyStatus = document.querySelector("#memberStatusTable tbody");
    tbodyPay.innerHTML = ""; tbodyStatus.innerHTML = "";
    
    let totalPaid = 0;
    pays.forEach((p, idx) => {
        totalPaid += Number(p.amount);
        tbodyPay.innerHTML += `<tr><td>${idx+1}</td><td>${p.type}</td><td>${p.amount}</td><td>${p.date}</td></tr>`;
    });

    ["Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨","Ø±Ø¨Ø¹ 1","Ø±Ø¨Ø¹ 2","Ø±Ø¨Ø¹ 3","Ø±Ø¨Ø¹ 4"].forEach(item => {
        const sum = pays.filter(p => p.type === item).reduce((a,p) => a + Number(p.amount||0), 0);
        tbodyStatus.innerHTML += `<tr><td>${item}</td><td>${sum > 0 ? "âœ… Ø®Ø§Ù„Øµ" : "âŒ ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹"}</td><td>${sum}</td></tr>`;
    });
    document.getElementById("memberTotalsBox").textContent = "Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯ÙÙˆØ¹: " + totalPaid;
}
// ============================================================
// ğŸ”´ğŸ”´ğŸ”´ Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø© (Ø£Ù„ØµÙ‚Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) ğŸ”´ğŸ”´ğŸ”´
// ============================================================

// 1. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
function buildAccountantUI(){
    document.getElementById("screenAccountant").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2>
      <div class="info-box">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯ÙØ¹Ø§Øª + Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª ÙˆØ§Ù„Ø¯ÙŠÙˆÙ†</div>

      <div class="section-box" style="background:#fff3e0; padding:15px; border-radius:8px;">
        <h3>ğŸ’° ÙÙ„Ø§ØªØ± Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3>
        <div class="two-cols">
          <div>
            <label>Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
            <select id="accQuarterSelect" onchange="renderAccountantMembersStatus()">
              <option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option>
              <option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option>
              <option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option>
              <option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option>
              <option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option>
            </select>
          </div>
          <div>
            <label>Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="accPayStatus" onchange="renderAccountantMembersStatus()">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="paid">Ù…Ø¯ÙÙˆØ¹ (Ø®Ø§Ù„Øµ)</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†)</option>
            </select>
          </div>
        </div>
        <div class="two-cols">
            <div><label>Ø§Ù„ÙØ±Ù‚Ø©</label><select id="accFilterTeam" onchange="renderAccountantMembersStatus()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option><option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option><option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option><option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option></select></div>
            <div><label>Ø§Ù„Ø±ØªØ¨Ø©</label><select id="accFilterRank" onchange="renderAccountantMembersStatus()"><option value="">Ø§Ù„ÙƒÙ„</option><option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option><option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option></select></div>
        </div>
        <table id="accMembersStatusTable"><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box" style="border: 2px solid #e57373;">
        <h3 style="color:#c62828;">ğŸ“‰ Ø°Ù…Ù… Ù…Ø§Ù„ÙŠØ© (Ø¯ÙŠÙˆÙ†)</h3>
        <div class="two-cols" style="background:#ffebee; padding:10px;">
             <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="liabMemberSelect"></select></div>
             <div><label>Ø§Ù„ØºØ±Ø¶</label><input type="text" id="liabDesc"></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="liabAmount"></div>
        </div>
        <button onclick="addLiability()" style="background:#c62828;">ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ø©</button>
        <hr>
        <table id="liabilitiesTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„ØºØ±Ø¶</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box">
        <h3>Ø¥Ø¶Ø§ÙØ© Ø¯ÙØ¹Ø© (Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚)</h3>
        <div class="two-cols">
          <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="payMemberSelect"></select></div>
          <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="payType"><option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option><option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option><option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option><option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option><option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option><option value="Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ">Ù…Ø¯Ø®ÙˆÙ„ Ø¥Ø¶Ø§ÙÙŠ</option></select></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="payAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="payDate"></div>
        </div>
        <button onclick="addPayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
      </div>

      <div class="section-box"><h3>Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙØ¹Ø§Øª</h3><table id="paymentsTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table></div>
      <div class="section-box"><h3>Ø§Ù„Ù…Ù„Ø®Øµ</h3><div id="totalAmountBox" class="success"></div></div>
      <div class="section-box"><button onclick="exportFinancialCSV()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ</button></div>
    `;
}

// 2. ØªØ´ØºÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function prepareAccountantScreen(){
    const regs = loadRegistrations();
    const paySel = document.getElementById("payMemberSelect");
    const liabSel = document.getElementById("liabMemberSelect");
    
    if(paySel) paySel.innerHTML = ""; 
    if(liabSel) liabSel.innerHTML = "";
    
    regs.forEach(r => {
        const opt = `<option value="${r.email}">${r.fullName}</option>`;
        if(paySel) paySel.innerHTML += opt; 
        if(liabSel) liabSel.innerHTML += opt;
    });
    
    const dateInput = document.getElementById("payDate");
    if(dateInput) dateInput.value = new Date().toISOString().slice(0,10);
    
    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø¯ÙˆØ§Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø©)
    if(typeof renderLiabilitiesTable === 'function') renderLiabilitiesTable(); 
    if(typeof renderAccountantMembersStatus === 'function') renderAccountantMembersStatus(); 
    if(typeof renderPaymentsTable === 'function') renderPaymentsTable();
}

// 3. Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù„Ù„Ù…Ø­Ø§Ø³Ø¨
function renderAccountantMembersStatus(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    
    const qSel = document.getElementById("accQuarterSelect");
    const sSel = document.getElementById("accPayStatus");
    const tSel = document.getElementById("accFilterTeam"); 
    const rSel = document.getElementById("accFilterRank");
    const tbody = document.querySelector("#accMembersStatusTable tbody");

    if(!qSel || !sSel || !tbody) return;

    const quarter = qSel.value;
    const status = sSel.value;
    const filterTeam = tSel ? tSel.value : ""; 
    const filterRank = rSel ? rSel.value : "";

    tbody.innerHTML = "";

    const rows = regs.map(r => {
      const sum = pays
        .filter(p => p.memberEmail === r.email && p.type === quarter)
        .reduce((a,p) => a + Number(p.amount||0), 0);
      return { r, sum, paid: sum > 0 };
    });

    const filteredRows = rows.filter(x => {
        const statusOk = status === "all" ? true : (status === "paid" ? x.paid : !x.paid);
        const teamOk = filterTeam === "" || x.r.team === filterTeam || x.r.leaderTeam === filterTeam;
        const rankOk = filterRank === "" || x.r.rank === filterRank;
        return statusOk && teamOk && rankOk;
    });

    if(filteredRows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center;color:red;padding:10px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>";
        return;
    }

    filteredRows.forEach((x, idx) => {
      const color = x.paid ? "green" : "red";
      const icon  = x.paid ? "âœ”" : "âœ–";
      tbody.innerHTML += `<tr><td>${idx+1}</td><td>${x.r.fullName}</td><td>${x.r.team||""}</td><td style="color:${color}">${x.sum}</td><td style="color:${color}">${icon}</td></tr>`;
    });
}

// 4. ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯
function buildLeaderUI(){
    document.getElementById("screenLeader").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
      <div class="info-box" id="leaderInfoBox"></div>
      <div class="section-box">
        <h3>ØªØµØ¯ÙŠØ±</h3>
        <button onclick="exportLeaderTeamCSV()">ØªØµØ¯ÙŠØ± Ø£Ø¹Ø¶Ø§Ø¡ ÙØ±Ù‚ØªÙŠ</button>
      </div>
      <div class="section-box">
        <h3>ÙÙ„ØªØ± Ø§Ù„Ø¹Ù…Ø±</h3>
        <select id="leaderAgeFilter" onchange="renderLeaderScreen()"><option value="">Ø§Ù„ÙƒÙ„</option></select>
      </div>
      <div class="section-box">
        <h3>Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ù‚Ø©</h3>
        <table id="leaderMembersTable">
          <thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¹Ù…Ø±</th><th>Ø§Ù„Ø¬Ù†Ø³</th><th>Ø§Ù„Ø±ØªØ¨Ø©</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    `;
}

// 5. ØªØ´ØºÙŠÙ„ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯
function renderLeaderScreen(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    const me = regs.find(r => r.email === currentUser.email);
    const info = document.getElementById("leaderInfoBox");
    const tbody = document.querySelector("#leaderMembersTable tbody");
    
    if(!tbody || !info) return;
    tbody.innerHTML = "";

    if(!me){ info.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."; return; }
    const myTeam = (me.isLeaderOfTeam === "yes") ? me.leaderTeam : "";
    if(!myTeam){ info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† ÙØ±Ù‚Ø©)."; return; }

    info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¹Ù„Ù‰: " + myTeam;

    const sel = document.getElementById("leaderAgeFilter");
    if(sel && sel.options.length === 1){
         for(let i=6;i<30;i++) sel.innerHTML += `<option value="${i}">${i} Ø³Ù†Ø©</option>`;
    }
    const ageFilter = document.getElementById("leaderAgeFilter")?.value;

    let members = regs.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    if(ageFilter) members = members.filter(m => m.age == ageFilter);

    members.forEach((m, idx) => {
      const sum = pays.filter(p => p.memberEmail === m.email).reduce((a,p)=>a+Number(p.amount||0),0);
      tbody.innerHTML += `<tr><td>${idx+1}</td><td>${m.fullName}</td><td>${m.age}</td><td>${m.gender}</td><td>${m.rank}</td><td>${m.team}</td><td>${sum}</td></tr>`;
    });
}
function buildLeaderUI(){
    document.getElementById("screenLeader").innerHTML = `
      <div style="text-align: center;">
        <h2 style="color: #1a237e;">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯</h2>
        <div class="info-box" id="leaderInfoBox"></div>
      </div>

      <div id="leaderDebtsAlert" class="hidden" style="background:#ffebee; border:2px solid #ef5350; padding:15px; border-radius:8px; margin-bottom:20px; clear: both;">
        <h3 style="color:#c62828; margin-top:0;">âš ï¸ Ø¹Ù„ÙŠÙƒ Ø°Ù…Ù… Ù…Ø§Ù„ÙŠØ© (Ø¯ÙŠÙˆÙ†)</h3>
        <p style="color:#d32f2f;">ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ù„ØªØ³Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ø§Ù„Øº Ø§Ù„ØªØ§Ù„ÙŠØ©:</p>
        <ul id="leaderDebtsList" style="padding-right:20px; color:#b71c1c; font-weight:bold; list-style-type: disc;"></ul>
      </div>

      <div style="display:flex; gap:10px; margin-bottom:20px; flex-wrap: wrap; clear: both;">
        <button onclick="showAttendanceForm()" style="background:#2e7d32; color:white; padding:15px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; flex:1; min-width:140px;">
            â• ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯
        </button>
        <button onclick="showActivitiesArchive()" style="background:#1a237e; color:white; padding:15px; border-radius:10px; border:none; font-weight:bold; cursor:pointer; flex:1; min-width:140px;">
            ğŸ“‚ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª
        </button>
      </div>

      <div id="attendanceFormArea" class="glass-panel hidden" style="background:white; color:#333; padding:20px; border-radius:15px; margin-bottom:30px; border: 2px solid #1a237e; clear: both; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
        <h3 id="formAreaTitle" style="color:#1a237e; border-bottom:2px solid #eee; padding-bottom:10px;">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</h3>
        
        <div id="activityInputs">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom:15px;">
                <div>
                    <label style="display:block; font-weight:bold;">Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù†Ø´Ø§Ø·</label>
                    <input type="text" id="att_title" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØªØ¯Ø±ÙŠØ¨ Ø¹Ù‚Ø¯ ÙˆØ±Ø¨Ø·Ø§Øª" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
                </div>
                <div>
                    <label style="display:block; font-weight:bold;">Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                    <select id="att_type" style="width:100%; padding:8px; border-radius:5px; border:1px solid #ccc;">
                        <option value="Ø§Ø¬ØªÙ…Ø§Ø¹">Ø§Ø¬ØªÙ…Ø§Ø¹ Ø¯ÙˆØ±ÙŠ</option>
                        <option value="Ù†Ø´Ø§Ø·">Ù†Ø´Ø§Ø· Ø®Ø§Ø±Ø¬ÙŠ / Ø±Ø­Ù„Ø©</option>
                    </select>
                </div>
            </div>
            <label style="display:block; font-weight:bold;">Ø´Ø±Ø­ Ù…Ø¨Ø³Ø·</label>
            <textarea id="att_desc" style="width:100%; border-radius:10px; padding:10px; border:1px solid #ddd; font-family:Cairo;" rows="2" placeholder="Ù…Ø§Ø°Ø§ ÙØ¹Ù„ØªÙ… Ø§Ù„ÙŠÙˆÙ…ØŸ"></textarea>
        </div>

        <hr style="margin:20px 0;">
        <h4 style="color:#1a237e;">ğŸ‘¥ Ø§Ù„ØªÙØ§ØµÙŠÙ„ / Ø§Ù„Ø£Ø³Ù…Ø§Ø¡:</h4>
        <div id="attendanceListTable" style="max-height: 400px; overflow-y: auto; background: #f9f9f9; padding: 10px; border-radius: 8px;"></div>
        
        <div style="display:flex; gap:10px; margin-top:20px;" id="formActionButtons">
            <button id="btnSaveRecord" onclick="submitAttendanceToDB()" style="background:#2e7d32; color:white; padding:10px 20px; border-radius:8px; border:none; flex:2; font-weight:bold;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            <button onclick="document.getElementById('attendanceFormArea').classList.add('hidden')" style="background:#555; color:white; padding:10px 20px; border-radius:8px; border:none; flex:1;">Ø¥ØºÙ„Ø§Ù‚</button>
        </div>
      </div>

      <div style="clear: both; margin-top: 20px;">
          <div class="section-box">
            <h3>ØªØµØ¯ÙŠØ±</h3>
            <button onclick="exportLeaderTeamCSV()" style="background:#2962ff; color:white; padding:10px 20px; border-radius:8px; border:none; width:100%;">ØªØµØ¯ÙŠØ± Ù‚Ø§Ø¦Ù…Ø© ÙØ±Ù‚ØªÙŠ (Excel)</button>
          </div>

          <div class="section-box">
            <h3>ÙÙ„ØªØ± Ø§Ù„Ø£Ø¹Ù…Ø§Ø± (Ù„ÙØ±Ù‚ØªÙŠ)</h3>
            <select id="leaderAgeFilter" onchange="renderLeaderScreen()" style="width:100%; padding:10px; border-radius:8px;">
              <option value="">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
            </select>
          </div>

          <div class="section-box">
            <h3>Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙØ±Ù‚Ø©</h3>
            <div style="overflow-x: auto;">
                <table id="leaderMembersTable" style="width: 100%; border-collapse: collapse;">
                  <thead>
                    <tr style="background: #1a237e; color: white;">
                        <th style="padding: 12px;">#</th>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø¹Ù…Ø±</th>
                        <th>Ø§Ù„Ø¬Ù†Ø³</th>
                        <th>Ø§Ù„Ø±ØªØ¨Ø©</th>
                        <th>Ø§Ù„ÙØ±Ù‚Ø©</th>
                        <th>Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹Ø§Øª</th>
                    </tr>
                  </thead>
                  <tbody></tbody>
                </table>
            </div>
          </div>
      </div>
    `;
}
function renderLeaderScreen(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    // ğŸ”´ Ø¬Ù„Ø¨ Ø§Ù„Ø¯ÙŠÙˆÙ†
    const liabs = globalLiabilities || [];
    
    const me = regs.find(r => r.email === currentUser.email);
    const info = document.getElementById("leaderInfoBox");
    const tbody = document.querySelector("#leaderMembersTable tbody");
    
    // ğŸ”´ Ø¹Ù†Ø§ØµØ± ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ø¯ÙŠÙˆÙ†
    const alertBox = document.getElementById("leaderDebtsAlert");
    const debtList = document.getElementById("leaderDebtsList");
    
    if(!tbody || !info) return;
    tbody.innerHTML = "";

    if(!me){ info.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª."; return; }
    
    // Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ÙØ±Ù‚Ø©
    const myTeam = (me.isLeaderOfTeam === "yes") ? me.leaderTeam : "";
    if(!myTeam){ 
        info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¥Ø¯Ø§Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† ÙØ±Ù‚Ø©)."; 
    } else {
        info.textContent = "Ø£Ù†Øª Ù‚Ø§Ø¦Ø¯ Ø¹Ù„Ù‰: " + myTeam;
    }

    // ============================================
    // ğŸ”´ Ù…Ù†Ø·Ù‚ Ø¹Ø±Ø¶ Ø§Ù„Ø¯ÙŠÙˆÙ† Ù„Ù„Ù‚Ø§Ø¦Ø¯ (Ù†ÙØ³ ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø¶Ùˆ) ğŸ”´
    // ============================================
    const myEmailClean = currentUser.email.trim().toLowerCase();
    const myDebts = liabs.filter(l => (l.memberEmail||"").trim().toLowerCase() === myEmailClean);
    
    if(myDebts.length > 0 && alertBox){
        alertBox.classList.remove("hidden"); // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
        debtList.innerHTML = "";
        let totalDebt = 0;
        myDebts.forEach(d => {
            debtList.innerHTML += `<li>${d.desc}: ${d.amount}</li>`;
            totalDebt += Number(d.amount);
        });
        debtList.innerHTML += `<hr style="border-color:#ef9a9a;"><li><strong>Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${totalDebt}</strong></li>`;
    } else if(alertBox) { 
        alertBox.classList.add("hidden"); // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø¥Ø°Ø§ Ù…Ø§ Ø¹Ù„ÙŠÙ‡ Ø´ÙŠ
    }
    // ============================================

    // ØªØ¹Ø¨Ø¦Ø© ÙÙ„ØªØ± Ø§Ù„Ø¹Ù…Ø±
    const sel = document.getElementById("leaderAgeFilter");
    if(sel && sel.options.length === 1){
         for(let i=6;i<30;i++) sel.innerHTML += `<option value="${i}">${i} Ø³Ù†Ø©</option>`;
    }
    const ageFilter = document.getElementById("leaderAgeFilter")?.value;

    // ØªØ¹Ø¨Ø¦Ø© Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    let members = regs.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    if(ageFilter) members = members.filter(m => m.age == ageFilter);

    if(myTeam) {
        members.forEach((m, idx) => {
          const sum = pays.filter(p => p.memberEmail === m.email).reduce((a,p)=>a+Number(p.amount||0),0);
          tbody.innerHTML += `<tr><td>${idx+1}</td><td>${m.fullName}</td><td>${m.age}</td><td>${m.gender}</td><td>${m.rank}</td><td>${m.team}</td><td>${sum}</td></tr>`;
        });
    }
}
// ============================================================
// ğŸ”´ğŸ”´ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…ØµØ§Ø±ÙŠÙ + Ø¥ÙŠØ±Ø§Ø¯Ø§Øª + Ù…Ù„Ø®Øµ) ğŸ”´ğŸ”´ğŸ”´
// ============================================================

// 1. Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ÙˆØ§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª)
// ============================================================
// ğŸ”´ğŸ”´ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ø´Ø§Ù…Ù„ (ÙÙ„Ø§ØªØ± + Ù…ØµØ§Ø±ÙŠÙ + Ø¥ÙŠØ±Ø§Ø¯Ø§Øª) ğŸ”´ğŸ”´ğŸ”´
// ============================================================

// ============================================================
// ğŸ”´ğŸ”´ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ (ØªÙ… Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø­ÙØ¸ ID) ğŸ”´ğŸ”´ğŸ”´
// ============================================================

// 1. Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨
function buildAccountantUI(){
    document.getElementById("screenAccountant").innerHTML = `
      <h2>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨</h2>
      
      <div class="section-box" style="background:#e8f5e9; border:2px solid #4caf50;">
        <h3>ğŸ“Š Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…</h3>
        <div id="totalAmountBox" style="font-weight:bold; line-height:1.8; white-space:pre-line; font-size:16px;">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨...</div>
      </div>

      <div class="section-box" style="background:#fff3e0;">
        <h3>ğŸ‘¥ Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</h3>
        <div class="two-cols" style="margin-bottom: 10px;">
          <div>
            <label>1. Ø§Ù„Ø¨Ù†Ø¯ Ø§Ù„Ù…Ø§Ù„ÙŠ</label>
            <select id="accQuarterSelect" onchange="renderAccountantMembersStatus()">
              <option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option>
              <option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option>
              <option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option>
              <option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option>
              <option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option>
            </select>
          </div>
          <div>
            <label>2. Ø­Ø§Ù„Ø© Ø§Ù„Ø¯ÙØ¹</label>
            <select id="accPayStatus" onchange="renderAccountantMembersStatus()">
              <option value="all">Ø§Ù„ÙƒÙ„</option>
              <option value="paid">Ù…Ø¯ÙÙˆØ¹ (Ø®Ø§Ù„Øµ)</option>
              <option value="unpaid">ØºÙŠØ± Ù…Ø¯ÙÙˆØ¹ (Ø¹Ù„ÙŠÙ‡ Ø¯ÙŠÙ†)</option>
            </select>
          </div>
        </div>
        <div class="two-cols">
            <div>
                <label>3. ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚Ø©</label>
                <select id="accFilterTeam" onchange="renderAccountantMembersStatus()">
                    <option value="">ÙƒÙ„ Ø§Ù„ÙØ±Ù‚</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
                    <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                    <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
                    <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                </select>
            </div>
            <div>
                <label>4. ÙÙ„ØªØ± Ø­Ø³Ø¨ Ø§Ù„Ø±ØªØ¨Ø©</label>
                <select id="accFilterRank" onchange="renderAccountantMembersStatus()">
                    <option value="">ÙƒÙ„ Ø§Ù„Ø±ØªØ¨</option>
                    <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
                    <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
                    <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
                    <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯</option>
                </select>
            </div>
        </div>
        <table id="accMembersStatusTable"><thead><tr><th>#</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„ÙØ±Ù‚Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box" style="border: 2px solid #e57373;">
        <h3 style="color:#c62828;">ğŸ“‰ ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ù… (Ø¯ÙŠÙˆÙ† Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡)</h3>
        <div class="two-cols" style="background:#ffebee; padding:10px;">
             <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="liabMemberSelect"></select></div>
             <div><label>Ø§Ù„ØºØ±Ø¶</label><input type="text" id="liabDesc" placeholder="Ù…Ø«Ø§Ù„: Ø«Ù…Ù† Ù„Ø¨Ø§Ø³"></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="liabAmount"></div>
        </div>
        <button onclick="addLiability()" style="background:#c62828;">ØªØ³Ø¬ÙŠÙ„ Ø°Ù…Ø©</button>
        <hr>
        <table id="liabilitiesTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„ØºØ±Ø¶</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box">
        <h3>ğŸ’° ØªØ³Ø¬ÙŠÙ„ Ø¯ÙØ¹Ø© / Ø§Ø´ØªØ±Ø§Ùƒ (ÙˆØ§Ø±Ø¯Ø§Øª Ù…Ù† Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡)</h3>
        <div class="two-cols">
          <div><label>Ø§Ù„Ø¹Ø¶Ùˆ</label><select id="payMemberSelect"></select></div>
          <div><label>Ø§Ù„Ù†ÙˆØ¹</label><select id="payType"><option value="Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨">Ø±Ø³Ù… Ø§Ù†ØªØ³Ø§Ø¨</option><option value="Ø±Ø¨Ø¹ 1">Ø±Ø¨Ø¹ 1</option><option value="Ø±Ø¨Ø¹ 2">Ø±Ø¨Ø¹ 2</option><option value="Ø±Ø¨Ø¹ 3">Ø±Ø¨Ø¹ 3</option><option value="Ø±Ø¨Ø¹ 4">Ø±Ø¨Ø¹ 4</option><option value="ØªØ¨Ø±Ø¹">ØªØ¨Ø±Ø¹ / Ø£Ø®Ø±Ù‰</option></select></div>
          <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="payAmount"></div>
          <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="payDate"></div>
        </div>
        <button onclick="addPayment()">Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø©</button>
        <hr>
        <h4>Ø³Ø¬Ù„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø§Øª (Ø¢Ø®Ø± 10 Ø¯ÙØ¹Ø§Øª)</h4>
        <table id="paymentsTable"><thead><tr><th>#</th><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box" style="border: 2px solid #ff9800;">
        <h3 style="color:#e65100;">ğŸ’¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ§Ø±ÙŠÙ (Ø®Ø±Ø¬ Ù…Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚)</h3>
        <div class="two-cols" style="background:#fff3e0; padding:10px;">
             <div><label>ÙˆØµÙ Ø§Ù„Ù…ØµØ±ÙˆÙ</label><input type="text" id="expDesc" placeholder="Ù…Ø«Ø§Ù„: Ø¶ÙŠØ§ÙØ©ØŒ Ù‚Ø±Ø·Ø§Ø³ÙŠØ©..."></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="expAmount"></div>
             <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="expDate"></div>
        </div>
        <button onclick="addExpense()" style="background:#ff9800;">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ</button>
        <hr>
        <table id="expensesTable"><thead><tr><th>#</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box" style="border: 2px solid #2196F3;">
        <h3 style="color:#0d47a1;">ğŸ“ˆ Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© (Ø¯Ø¹Ù… Ø®Ø§Ø±Ø¬ÙŠ/Ù†Ø´Ø§Ø·Ø§Øª)</h3>
        <div class="two-cols" style="background:#e3f2fd; padding:10px;">
             <div><label>Ø§Ù„Ù…ØµØ¯Ø±/Ø§Ù„ÙˆØµÙ</label><input type="text" id="extraDesc" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø¹Ù…ØŒ Ø±ÙŠØ¹ Ù†Ø´Ø§Ø·..."></div>
             <div><label>Ø§Ù„Ù…Ø¨Ù„Øº</label><input type="number" id="extraAmount"></div>
             <div><label>Ø§Ù„ØªØ§Ø±ÙŠØ®</label><input type="date" id="extraDate"></div>
        </div>
        <button onclick="addExtraIncome()" style="background:#2196F3;">ØªØ³Ø¬ÙŠÙ„ Ø¥ÙŠØ±Ø§Ø¯ Ø¥Ø¶Ø§ÙÙŠ</button>
        <hr>
        <table id="extraIncomeTable"><thead><tr><th>#</th><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th></tr></thead><tbody></tbody></table>
      </div>

      <div class="section-box"><button onclick="exportFinancialCSV()">ØªØµØ¯ÙŠØ± Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„ (Excel)</button></div>
    `;
}

// 2. Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ´ØºÙŠÙ„
function prepareAccountantScreen(){
    const regs = loadRegistrations();
    const paySel = document.getElementById("payMemberSelect");
    const liabSel = document.getElementById("liabMemberSelect");
    
    if(paySel) paySel.innerHTML = ""; 
    if(liabSel) liabSel.innerHTML = "";
    
    regs.forEach(r => {
        const opt = `<option value="${r.email}">${r.fullName}</option>`;
        if(paySel) paySel.innerHTML += opt; 
        if(liabSel) liabSel.innerHTML += opt;
    });
    
    const today = new Date().toISOString().slice(0,10);
    ["payDate", "expDate", "extraDate"].forEach(id => {
       if(document.getElementById(id)) document.getElementById(id).value = today;
    });
    
    renderAllFinancialTables();
}

function renderAllFinancialTables(){
    if(typeof renderLiabilitiesTable === 'function') renderLiabilitiesTable(); 
    if(typeof renderAccountantMembersStatus === 'function') renderAccountantMembersStatus(); 
    if(typeof renderPaymentsTable === 'function') renderPaymentsTable();
    if(typeof renderExpensesTable === 'function') renderExpensesTable();      
    if(typeof renderExtraIncomesTable === 'function') renderExtraIncomesTable();  
    if(typeof updateTotalSummary === 'function') updateTotalSummary();       
}

function renderAccountantMembersStatus(){
    const regs = loadRegistrations();
    const pays = loadPayments();
    
    const quarter = document.getElementById("accQuarterSelect")?.value;
    const status = document.getElementById("accPayStatus")?.value;
    const filterTeam = document.getElementById("accFilterTeam")?.value || "";
    const filterRank = document.getElementById("accFilterRank")?.value || "";
    
    const tbody = document.querySelector("#accMembersStatusTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";

    const rows = regs.map(r => {
      const sum = pays
        .filter(p => p.memberEmail === r.email && p.type === quarter)
        .reduce((a,p) => a + Number(p.amount||0), 0);
      return { r, sum, paid: sum > 0 };
    });

    const filteredRows = rows.filter(x => {
        const statusOk = status === "all" ? true : (status === "paid" ? x.paid : !x.paid);
        const teamOk = filterTeam === "" || x.r.team === filterTeam || x.r.leaderTeam === filterTeam;
        const rankOk = filterRank === "" || x.r.rank === filterRank;
        return statusOk && teamOk && rankOk;
    });

    if(filteredRows.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;color:red;padding:10px;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬</td></tr>";
        return;
    }

    filteredRows.forEach((x, idx) => {
      const color = x.paid ? "green" : "red";
      const icon  = x.paid ? "âœ”" : "âœ–";
      tbody.innerHTML += `<tr><td>${idx+1}</td><td>${x.r.fullName}</td><td>${x.r.team||""}</td><td style="font-weight:bold; color:${color}">${x.sum}</td><td style="color:${color}">${icon}</td></tr>`;
    });
}

// ------------------------------------------
// ğŸ”´ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù‡Ù†Ø§: Ø¥Ø¶Ø§ÙØ© ID Ù„ÙƒÙ„ Ø¹Ù…Ù„ÙŠØ© ğŸ”´
// ------------------------------------------

// Ø£. Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ
async function addExpense(){
    const desc = document.getElementById("expDesc").value;
    const amount = document.getElementById("expAmount").value;
    const date = document.getElementById("expDate").value;
    if(!desc || !amount) return;

    // âœ… Ø£Ø¶ÙÙ†Ø§ id: Date.now() Ù„ÙŠÙ‚Ø¨Ù„Ù‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const newExp = { id: Date.now(), desc, amount, date };
    
    const { error } = await supabaseClient.from('expenses').insert([newExp]);
    
    if(error){
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message);
    } else {
        globalExpenses.push(newExp);
        document.getElementById("expDesc").value = "";
        document.getElementById("expAmount").value = "";
        renderAllFinancialTables();
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ âœ…");
    }
}

// Ø¨. Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ©
async function addExtraIncome(){
    const desc = document.getElementById("extraDesc").value;
    const amount = document.getElementById("extraAmount").value;
    const date = document.getElementById("extraDate").value;
    if(!desc || !amount) return;

    // âœ… Ø£Ø¶ÙÙ†Ø§ id: Date.now() Ù„ÙŠÙ‚Ø¨Ù„Ù‡Ø§ Ø§Ù„Ø³ÙŠØ±ÙØ±
    const newInc = { id: Date.now(), desc, amount, date };
    
    const { error } = await supabaseClient.from('extra_incomes').insert([newInc]);
    
    if(error){
        alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ¸: " + error.message);
    } else {
        globalExtraIncomes.push(newInc);
        document.getElementById("extraDesc").value = "";
        document.getElementById("extraAmount").value = "";
        renderAllFinancialTables();
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥ÙŠØ±Ø§Ø¯ âœ…");
    }
}

// Ø¬. Ø§Ù„Ø¯ÙŠÙˆÙ† (ØªØ¹Ø¯ÙŠÙ„ Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø¹Ù…Ù„Ù‡Ø§ Ø£ÙŠØ¶Ø§Ù‹)
async function addLiability(){
    const memberEmail = document.getElementById("liabMemberSelect").value;
    const desc = document.getElementById("liabDesc").value;
    const amount = document.getElementById("liabAmount").value;
    
    if(!memberEmail || !desc || !amount) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ¹Ø¨Ø¦Ø© ÙƒÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„"); return; }

    const newLiab = { 
        id: Date.now(), // âœ… ØªØ£ÙƒØ¯Ù†Ø§ Ù…Ù† ÙˆØ¬ÙˆØ¯ ID Ù‡Ù†Ø§ Ø£ÙŠØ¶Ø§Ù‹
        memberEmail, 
        desc, 
        amount, 
        date: new Date().toISOString().slice(0,10) 
    };

    const { error } = await supabaseClient.from('liabilities').insert([newLiab]);
    if(error){ alert(error.message); return; }

    globalLiabilities.push(newLiab);
    renderLiabilitiesTable();
    alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø°Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­.");
    document.getElementById("liabDesc").value = "";
    document.getElementById("liabAmount").value = "";
}

// Ø¯. Ø¯ÙˆØ§Ù„ Ø§Ù„Ø¹Ø±Ø¶ (Ù„Ø§ ØªØºÙŠÙŠØ± Ø¹Ù„ÙŠÙ‡Ø§)
function renderExpensesTable(){
    const tbody = document.querySelector("#expensesTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    globalExpenses.forEach((e, i) => {
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${e.desc}</td><td style="color:red">-${e.amount}</td><td>${e.date}</td></tr>`;
    });
}

function renderExtraIncomesTable(){
    const tbody = document.querySelector("#extraIncomeTable tbody");
    if(!tbody) return;
    tbody.innerHTML = "";
    globalExtraIncomes.forEach((e, i) => {
        tbody.innerHTML += `<tr><td>${i+1}</td><td>${e.desc}</td><td style="color:green">+${e.amount}</td><td>${e.date}</td></tr>`;
    });
}
function getMemberNameByEmail(email, regs) {
  const e = (email || "").trim().toLowerCase();
  const m = (regs || []).find(r => ((r.email || "").trim().toLowerCase() === e));

  // Ø¬Ø±Ù‘Ø¨ Ø£ÙƒØ«Ø± Ù…Ù† Ø§Ø³Ù… Ù…Ø­ØªÙ…Ù„ Ù„Ù„Ø­Ù‚Ù„
  return (
    m?.fullName ||
    m?.full_name ||
    m?.name ||
    m?.username ||
    m?.display_name ||
    email
  );
}

// Ù…Ø³Ø§Ø¹Ø¯: ÙŠØ±Ø¬Ù‘Ø¹ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø¯Ù„ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
function getMemberNameByEmail(email, regs) {
  const m = (regs || []).find(r => (r.email || '').trim() === (email || '').trim());
  return m ? (m.fullName || m.email) : (email || "-");
}

function renderPaymentsTable(){
  const pays = loadPayments();
  const regs = loadRegistrations(); // âœ… Ù„Ø§Ø²Ù… Ø­ØªÙ‰ Ù†Ø¹Ø±Ù Ø§Ù„Ø§Ø³Ù…
  const tbody = document.querySelector("#paymentsTable tbody");
  if(!tbody) return;

  tbody.innerHTML = ""; // âœ… Ù†Ù…Ø³Ø­ Ø§Ù„Ù‚Ø¯ÙŠÙ… ÙˆÙ†Ø±Ø³Ù… Ù…Ù† Ø¬Ø¯ÙŠØ¯

  (pays || []).forEach((p, idx) => {
    tbody.innerHTML += `
      <tr>
        <td>${idx + 1}</td>
        <td>${getMemberNameByEmail(p.memberEmail, regs)}</td>
        <td>${p.type || ""}</td>
        <td>${p.amount || ""}</td>
        <td>${p.date || ""}</td>
      </tr>
    `;
  });
}



function updateTotalSummary(){
    const pays = loadPayments();
    
    const totalMembers = pays.reduce((sum, p) => sum + Number(p.amount || 0), 0);
    const totalExtra = globalExtraIncomes.reduce((sum, e) => sum + Number(e.amount || 0), 0);
    const totalExpenses = globalExpenses.reduce((sum, e) => sum + Number(e.amount || 0), 0);
    const netIncome = (totalMembers + totalExtra) - totalExpenses;
    
    const box = document.getElementById("totalAmountBox");
    if(box){
        box.innerHTML = `
        <span style="color:green">â• Ù…Ø¬Ù…ÙˆØ¹ Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${totalMembers.toLocaleString()}</span><br>
        <span style="color:blue">â• Ø¥ÙŠØ±Ø§Ø¯Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©: ${totalExtra.toLocaleString()}</span><br>
        <span style="color:red">â– Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ: ${totalExpenses.toLocaleString()}</span>
        <hr style="margin:5px 0">
        <span style="font-size:20px; color:${netIncome >= 0 ? 'green' : 'red'}">ğŸ’° Ø§Ù„ØµØ§ÙÙŠ ÙÙŠ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚: ${netIncome.toLocaleString()}</span>
        `;
    }
}
// ============================================================
// ğŸ”´ğŸ”´ Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø§Øª (Ø§Ù†Ø³Ø®Ù‡Ø§ ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) ğŸ”´ğŸ”´
// ============================================================
async function addPayment(){
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ…
    const memberEmail = document.getElementById("payMemberSelect")?.value;
    const type = document.getElementById("payType")?.value;
    const amountRaw = document.getElementById("payAmount")?.value;
    const date = document.getElementById("payDate")?.value;

    // âœ… Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ù†Øµ Ø§Ù„Ù€ option (Ù‚Ø¨Ù„ - Ø§Ù„ÙØ±ÙŠÙ‚ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯)
    const sel = document.getElementById("payMemberSelect");
    const selectedText = sel?.options?.[sel.selectedIndex]?.textContent || "";
    const memberName = (selectedText.split(" - ")[0] || "").trim(); // "Ø§Ù„Ø§Ø³Ù… - Ø§Ù„ÙØ±Ù‚Ø©"

    if(!memberEmail || !amountRaw || !date) { 
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"); 
        return; 
    }

    const amount = parseFloat(amountRaw || "0");
    if(!isFinite(amount) || amount <= 0){
        alert("Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­");
        return;
    }

    const newPay = {
        id: Date.now(),
        memberEmail: memberEmail,
        memberName: memberName, // âœ… Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ)
        type: type,
        amount: amount,         // âœ… Ø±Ù‚Ù…
        date: date
    };

    // 2. Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ±
    const { error } = await supabaseClient.from('payments').insert([newPay]);

    if(error){
        alert("Ø®Ø·Ø£: " + error.message);
    } else {
        // âœ…âœ…âœ… Ù†Ø¶ÙŠÙ Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ© ÙÙˆØ±Ø§Ù‹ Ø¹Ø´Ø§Ù† ØªØ·Ù„Ø¹ Ø¨Ø§Ù„Ø¬Ø¯ÙˆÙ„
        if(typeof globalPayments === 'undefined') window.globalPayments = [];
        globalPayments.push(newPay); 

        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¯ÙØ¹Ø© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        
        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
        renderPaymentsTable();            
        renderAccountantMembersStatus();  
        if(typeof updateTotalSummary === 'function') updateTotalSummary();

        // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚Ù„
        const amtEl = document.getElementById("payAmount");
        if(amtEl) amtEl.value = "";
    }
}

// ============================================================
// ğŸ”´ğŸ”´ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„ (Form) - Ø§Ù„ØµÙ‚Ù‡ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù ğŸ”´ğŸ”´
// ============================================================
// ============================================================
// ğŸ”´ğŸ”´ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„Ø© (ØªØ­ÙƒÙ… ÙŠØ¯ÙˆÙŠ Ø¨ÙƒÙ„ Ø§Ù„Ø±ØªØ¨ ÙˆØ§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª) ğŸ”´ğŸ”´
// ============================================================

// ===============================================
// ğŸ”´ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø´Ø±Ù (Ø¬Ø¯ÙˆÙ„Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… + Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ğŸ”´
// ===============================================

// 1. ØªØ¹Ø±ÙŠÙ Ù…ØªØºÙŠØ± Ø¹Ø§Ù„Ù…ÙŠ Ù„ØªØ®Ø²ÙŠÙ† Ù‡ÙˆÙŠØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹)
let currentEditingId = null;

// 2. Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ØªÙ…Ø§Ù…Ø§Ù‹)
function renderAdminTable(){
    const tbody = document.querySelector("#adminTable tbody");
    const countDisplay = document.getElementById("countDisplay");
    
    const regs = loadRegistrations(); 

    // 1. Ø¬Ù„Ø¨ Ø§Ù„ÙÙ„Ø§ØªØ± (Ø£Ø¶ÙÙ†Ø§ ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„Ø© Ù‡Ù†Ø§)
    const sName   = (document.getElementById("filterName")?.value || "").toLowerCase();
    const sTeam   = document.getElementById("filterTeam")?.value || "";
    const sRank   = document.getElementById("filterRank")?.value || "";
    const sAge    = document.getElementById("filterAge")?.value || "";
    const sStatus = document.getElementById("filterStatus")?.value || ""; // Ø§Ù„Ø¬Ø¯ÙŠØ¯

    if(!tbody) return;
    tbody.innerHTML = "";

    // 2. Ø§Ù„ÙÙ„ØªØ±Ø© (ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…Ù†Ø·Ù‚ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø­Ø§Ù„Ø©)
    const filtered = regs.filter(r => {
        if(sName && !r.fullName.toLowerCase().includes(sName)) return false;
        if(sTeam && r.team !== sTeam && r.leaderTeam !== sTeam) return false;
        if(sRank && r.rank !== sRank) return false;
        if(sAge && r.age != sAge) return false;
        if(sStatus && r.status !== sStatus) return false; // Ø§Ù„Ø¬Ø¯ÙŠØ¯
        return true;
    });

    if(countDisplay) countDisplay.textContent = filtered.length;

    filtered.forEach((r, idx) => {
      const isPending = r.status === "pending";
      
      // 3. ØªÙ…ÙŠÙŠØ² Ø§Ù„ØµÙ Ù„ÙˆÙ†ÙŠÙ‹Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø¹Ù„Ù‚Ù‹Ø§ (Ø®Ù„ÙÙŠØ© ØµÙØ±Ø§Ø¡ Ø®ÙÙŠÙØ© Ø¬Ø¯Ù‹Ø§)
      const rowStyle = isPending ? `style="background-color: #fffde7;"` : "";

      const statusBadge = isPending 
        ? `<span style="background:orange; color:white; padding:2px 5px; border-radius:4px; font-size:10px;">â³ Ù…Ø±Ø§Ø¬Ø¹Ø©</span>`
        : `<span style="font-size:10px; color:green;">âœ… Ù†Ø´Ø·</span>`;

      const approveBtn = isPending 
        ? `<button class="small-btn" onclick="approveMember(${r.id})" style="background:green; margin-left:5px;">âœ… Ù‚Ø¨ÙˆÙ„</button>` 
        : ``;

      tbody.innerHTML += `
        <tr ${rowStyle}>
          <td>${idx + 1}</td>
          <td>${r.fullName} <br> ${statusBadge}</td>
          <td>${r.team || r.leaderTeam || "-"}</td>
          <td>${r.rank}</td>
          <td>${r.age}</td>
          <td>${r.isLeaderOfTeam === "yes" ? "âœ…" : "âŒ"}</td>
          <td>
             ${approveBtn}
             <button class="small-btn" onclick="editMember(${r.id})" style="background:#ff9800; color:white;" title="ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
             <button class="small-btn danger" onclick="deleteMember('${r.id}')" title="Ø­Ø°Ù">ğŸ—‘ï¸</button>
          </td>
          <td>
             <button class="small-btn info" onclick="showMemberDetails('${r.email}')" style="background:#2196F3; color:white;">ğŸ‘ï¸ Ø§Ù„ØªÙØ§ØµÙŠÙ„</button>
          </td>
        </tr>`;
    });
}

// ---------------------------------------------------------
// 3. Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªÙŠ ØªØ´ØºÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø¬Ø¯ÙˆÙ„Ùƒ (Ø§Ù„ØªÙØ§ØµÙŠÙ„ + Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
// ---------------------------------------------------------

// Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„
function showMemberDetails(email){
    const regs = loadRegistrations();
    const m = regs.find(r => r.email === email);
    if(!m) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£: Ø§Ù„Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯"); return; }

    const detailsHTML = `
        <table style="width:100%; text-align:right;">
            <tr><td><b>Ø§Ù„Ø§Ø³Ù…:</b> ${m.fullName}</td><td><b>Ø§Ù„Ø±ØªØ¨Ø©:</b> ${m.rank}</td></tr>
            <tr><td><b>Ø§Ù„Ø£Ø¨:</b> ${m.fatherName || "-"}</td><td><b>Ø§Ù„Ø£Ù…:</b> ${m.motherName || "-"}</td></tr>
            <tr><td><b>Ø§Ù„Ù…ÙˆØ§Ù„ÙŠØ¯:</b> ${m.birthDate || "-"}</td><td><b>Ù…ÙƒØ§Ù† Ø§Ù„ÙˆÙ„Ø§Ø¯Ø©:</b> ${m.birthPlace || "-"}</td></tr>
            <tr><td><b>Ø§Ù„Ø¹Ù…Ø±:</b> ${m.age || "0"}</td><td><b>Ø§Ù„Ø¬Ù†Ø³:</b> ${m.gender}</td></tr>
            <tr><td colspan="2"><hr></td></tr>
            <tr><td><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${m.phone || "ØºÙŠØ± Ù…Ø³Ø¬Ù„"}</td><td><b>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</b> ${m.address || "-"}</td></tr>
            <tr><td><b>Ø§Ù„Ù…Ø¯Ø±Ø³Ø©:</b> ${m.school || "-"}</td><td><b>Ø§Ù„Ù…Ù‡Ù†Ø©:</b> ${m.gradeJob || "-"}</td></tr>
            <tr><td><b>Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙˆØ·Ù†ÙŠ:</b> ${m.nationalId || "-"}</td><td><b>Ø§Ù„Ø¬Ù†Ø³ÙŠØ©:</b> ${m.nationality || "-"}</td></tr>
            <tr><td colspan="2"><hr></td></tr>
            <tr><td><b>Ø§Ù„ÙØ±Ù‚Ø©:</b> ${m.team || "-"}</td><td><b>Ø§Ù„Ø­Ø§Ù„Ø©:</b> ${m.status}</td></tr>
            <tr><td colspan="2" style="color:red;"><b>${m.isLeaderOfTeam==="yes" ? "âš ï¸ Ù‚Ø§Ø¦Ø¯ Ø¹Ù„Ù‰: "+m.leaderTeam : ""}</b></td></tr>
        </table>
    `;

    document.getElementById("modalContent").innerHTML = detailsHTML;
    document.getElementById("detailsModal").classList.remove("hidden");
    document.getElementById("detailsModal").style.display = "flex";
      }
// Ø¯Ø§Ù„Ø© ØªØ´ØºÙŠÙ„ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø´Ø§Ù…Ù„
function editMember(id){
    const regs = loadRegistrations();
    const m = regs.find(r => r.id == id);
    if(!m) return;

    currentEditingId = id; // Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø±Ù Ù„Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø­ÙØ¸

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
    document.getElementById("ed_fullName").value = m.fullName || "";
    document.getElementById("ed_father").value = m.fatherName || "";
    document.getElementById("ed_mother").value = m.motherName || "";
    document.getElementById("ed_birthDate").value = m.birthDate || "";
    document.getElementById("ed_birthPlace").value = m.birthPlace || "";
    document.getElementById("ed_gender").value = m.gender || "Ø°ÙƒØ±";
    
    document.getElementById("ed_phone").value = m.phone || "";
    document.getElementById("ed_address").value = m.address || "";
    document.getElementById("ed_school").value = m.school || "";
    document.getElementById("ed_grade").value = m.gradeJob || "";
    document.getElementById("ed_nationalId").value = m.nationalId || "";

    document.getElementById("ed_rank").value = m.rank || "Ø¹Ù†ØµØ±";
    document.getElementById("ed_team").value = m.team || "";
    document.getElementById("ed_isLeader").value = m.isLeaderOfTeam || "no";
    document.getElementById("ed_leaderTeam").value = m.leaderTeam || "";

    document.getElementById("editFullModal").classList.remove("hidden");
document.getElementById("editFullModal").style.display = "flex"; // Ù„Ù„ØªØ£ÙƒÙŠØ¯
}

// Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª Ø§Ù„Ø´Ø§Ù…Ù„Ø© (Ù„Ø²Ø± Ø§Ù„Ø­ÙØ¸ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©)
async function saveFullEdit(){
    if(!currentEditingId) return;

    const updates = {
        fullName: document.getElementById("ed_fullName").value,
        fatherName: document.getElementById("ed_father").value,
        motherName: document.getElementById("ed_mother").value,
        birthDate: document.getElementById("ed_birthDate").value,
        birthPlace: document.getElementById("ed_birthPlace").value,
        gender: document.getElementById("ed_gender").value,
        phone: document.getElementById("ed_phone").value,
        address: document.getElementById("ed_address").value,
        school: document.getElementById("ed_school").value,
        gradeJob: document.getElementById("ed_grade").value,
        nationalId: document.getElementById("ed_nationalId").value,
        rank: document.getElementById("ed_rank").value,
        team: document.getElementById("ed_team").value,
        isLeaderOfTeam: document.getElementById("ed_isLeader").value,
        leaderTeam: document.getElementById("ed_leaderTeam").value
    };

    // Ø¥Ø¹Ø§Ø¯Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¹Ù…Ø±
    if(updates.birthDate) updates.age = calculateAge(updates.birthDate);

    // Ø§Ù„Ø­ÙØ¸ ÙÙŠ Supabase
    const { error } = await supabaseClient
        .from('registrations')
        .update(updates)
        .eq('id', currentEditingId);

    if(error){
        alert("ÙØ´Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
    } else {
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« ÙƒØ§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        
        // ØªØ­Ø¯ÙŠØ« Ù…Ø­Ù„ÙŠ
        const index = globalRegistrations.findIndex(r => r.id == currentEditingId);
        if(index !== -1) {
            globalRegistrations[index] = { ...globalRegistrations[index], ...updates };
        }
        
        // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„
        document.getElementById("editFullModal").style.display = "none";
        renderAdminTable(); 
    }
}

// Ø¯ÙˆØ§Ù„ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†ÙˆØ§ÙØ°
function closeDetailsModal(){ document.getElementById("detailsModal").style.display = "none"; }
function closeEditModal(){ document.getElementById("editFullModal").style.display = "none"; }


// 3. Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeEditModal() {
    document.getElementById("editFullModal").classList.add("hidden");
    
    // (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØµÙŠØ± Ù„Ø®Ø¨Ø·Ø© Ø¨Ø§Ù„Ù…Ø±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©
    currentEditingId = null;
}

// 4. Ø¨Ù†Ø§Ø¡ ÙƒÙˆØ¯ HTML Ù„Ù„Ù†Ø§ÙØ°Ø© (Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªØ´Ù…Ù„ Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„ ÙˆÙ…Ø³Ø§Ø¹Ø¯...)
function injectEditModalHTML() {
    const modalHTML = `
    <div id="editMemberModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:25px; border-radius:10px; width:90%; max-width:500px; direction:rtl; box-shadow: 0 4px 15px rgba(0,0,0,0.3);">
            
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:15px;">
                <h3 style="margin:0; color:#1976D2;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø±ØªØ¨Ø© ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                <span onclick="closeEditModal()" style="font-size:24px; cursor:pointer; font-weight:bold;">&times;</span>
            </div>
            
            <label style="font-weight:bold;">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
            <input type="text" id="editFullName" style="width:100%; padding:8px; margin-bottom:10px; border:1px solid #ccc; border-radius:4px;">

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <div>
                    <label style="font-weight:bold; color:#d84315;">Ø§Ù„Ø±ØªØ¨Ø© Ø§Ù„ÙƒØ´ÙÙŠØ©</label>
                    <select id="editRank" style="width:100%; padding:8px; border:1px solid #d84315; border-radius:4px; font-weight:bold;">
                        <option value="Ø¹Ù†ØµØ±">Ø¹Ù†ØµØ±</option>
                        <option value="Ø¹Ø±ÙŠÙ Ø·Ù„ÙŠØ¹Ø©">Ø¹Ø±ÙŠÙ Ø·Ù„ÙŠØ¹Ø©</option>
                        <option value="Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„">Ø¹Ø±ÙŠÙ Ø£ÙˆÙ„</option>
                        <option value="Ù…Ø³Ø§Ø¹Ø¯">Ù…Ø³Ø§Ø¹Ø¯ Ù‚Ø§Ø¦Ø¯</option>
                        <option value="Ù‚Ø§Ø¦Ø¯">Ù‚Ø§Ø¦Ø¯</option>
                        <option value="Ø£Ù…ÙŠÙ† Ø³Ø±">Ø£Ù…ÙŠÙ† Ø³Ø±</option>
                        <option value="Ù‚Ø§Ø¦Ø¯ ÙÙˆØ¬">Ù‚Ø§Ø¦Ø¯ ÙÙˆØ¬</option>
                    </select>
                </div>
                <div>
                    <label style="font-weight:bold;">Ø§Ù„ÙØ±Ù‚Ø© (Ù„Ù„Ø¹Ø¶Ùˆ)</label>
                    <select id="editTeam" style="width:100%; padding:8px; border:1px solid #ccc; border-radius:4px;">
                        <option value="">(Ø¨Ø¯ÙˆÙ†)</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                        <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
                        <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                    </select>
                </div>
            </div>

            <div style="background:#e3f2fd; padding:15px; border-radius:8px; border:1px solid #90caf9;">
                <label style="font-weight:bold; color:#0d47a1; display:block; margin-bottom:10px;">ğŸ” ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ù„Ù„Ù‚Ø§Ø¯Ø© ÙÙ‚Ø·)</label>
                
                <div style="margin-bottom:10px;">
                    <label>Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ù†Ø­Ù‡ ØµÙ„Ø§Ø­ÙŠØ© "Ù‚Ø§Ø¦Ø¯ ÙØ±Ù‚Ø©"ØŸ</label>
                    <select id="editIsLeader" style="width:100%; padding:8px; border:1px solid #2196f3; border-radius:4px;">
                        <option value="no">âŒ Ù„Ø§ (Ø¹Ø¶Ùˆ/Ø¹Ø±ÙŠÙ/Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ù„Ø§ ØµÙ„Ø§Ø­ÙŠØ©)</option>
                        <option value="yes">âœ… Ù†Ø¹Ù… (ÙŠÙØªØ­ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚Ø§Ø¦Ø¯)</option>
                    </select>
                </div>

                <div>
                    <label>Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„ØªÙŠ ÙŠÙ‚ÙˆØ¯Ù‡Ø§ (ÙÙŠ Ø­Ø§Ù„ Ù†Ø¹Ù…)</label>
                    <select id="editLeaderTeam" style="width:100%; padding:8px; border:1px solid #2196f3; border-radius:4px;">
                        <option value="">-- Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ù‚Ø© --</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„">ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø´Ø¨Ø§Ù„</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ø²Ù‡Ø±Ø§Øª</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Ù†</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª">ÙØ±Ù‚Ø© Ø§Ù„ÙØªÙŠØ§Øª</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…</option>
                        <option value="ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª">ÙØ±Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª</option>
                        <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¬ÙˆØ§Ù„Ø©</option>
                        <option value="Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª">Ø¹Ø´ÙŠØ±Ø© Ø§Ù„Ø¯Ù„ÙŠÙ„Ø§Øª</option>
                    </select>
                </div>
            </div>

            <div style="margin-top:20px; display:flex; gap:10px;">
                <button onclick="saveEditMember()" style="flex:2; background:#4CAF50; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                <button onclick="closeEditModal()" style="flex:1; background:#f44336; color:white; padding:12px; border:none; border-radius:5px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHTML);
}
// ============================================================
// ğŸ”´ Ø¯Ø§Ù„Ø© Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ (Ø§Ù†Ø³Ø®Ù‡Ø§ ÙˆØ¶Ø¹Ù‡Ø§ ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ù…Ù„Ù) ğŸ”´
// ============================================================

async function deleteMember(id){
    // 1. Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù (Ø£Ù…Ø§Ù†)
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶ÙˆØŸ\nâš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡!")) return;

    // 2. Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Supabase
    const { error } = await supabaseClient
        .from('registrations')
        .delete()
        .eq('id', id);

    if(error){
        alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù: " + error.message);
    } else {
        alert("ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†Ø¬Ø§Ø­ ğŸ—‘ï¸");
        
        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙˆØ±Ø§Ù‹ (Ø­Ø°Ù Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø­Ù„ÙŠØ©)
        globalRegistrations = globalRegistrations.filter(r => r.id !== id);
        renderAdminTable(); 
    }
}
// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ§Ù„Ø¨Ø§Ø³ÙˆØ±Ø¯ (Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰)
async function handleSignUpStep1() {
    const email = document.getElementById("newEmail").value.trim().toLowerCase();
    const pass = document.getElementById("newPassword").value;
    const confirm = document.getElementById("confirmPassword").value;
    const err = document.getElementById("signUpError");
    
    // 1. ÙØ­ÙˆØµØ§Øª Ø£Ø³Ø§Ø³ÙŠØ©
    if(!email || !pass || !confirm) {
        err.textContent = "ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„"; err.classList.remove("hidden"); return;
    }
    if(pass !== confirm) {
        err.textContent = "ÙƒÙ„Ù…ØªØ§ Ø§Ù„Ø³Ø± ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ØªÙŠÙ†"; err.classList.remove("hidden"); return;
    }
    if(pass.length < 6) {
        err.textContent = "ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø¶Ø¹ÙŠÙØ© (6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„)"; err.classList.remove("hidden"); return;
    }

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØªÙƒØ±Ø§Ø± ÙÙŠ Supabase
    err.textContent = "Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚..."; err.classList.remove("hidden");
    
    // Ù†Ø³ØªØ¹Ù„Ù… Ù‡Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…ÙˆØ¬ÙˆØ¯ØŸ
    const { data, error } = await supabaseClient
        .from('registrations')
        .select('email')
        .eq('email', email);
    
    if(data && data.length > 0) {
        err.textContent = "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¨Ù‚Ø§Ù‹!";
        return;
    }

    // 3. Ø§Ù„Ù†Ø¬Ø§Ø­: Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„
    err.classList.add("hidden");
    pendingUser = { email: email, password: pass }; // ØªØ®Ø²ÙŠÙ† Ù…Ø¤Ù‚Øª
    showScreen("screenRank"); // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø±ØªØ¨Ø©
}
// 1. Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡
function showAttendanceForm() {
    // 1. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù…Ø®ÙÙŠØ© ÙˆØªØºÙŠÙŠØ± Ø§Ù„Ø¹Ù†Ø§ÙˆÙŠÙ† (Ø§Ù„Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ù„ØªÙ†Ù‚Ù„)
    const area = document.getElementById("attendanceFormArea");
    const inputs = document.getElementById("activityInputs");
    const title = document.getElementById("formAreaTitle");
    const container = document.getElementById("attendanceListTable");

    if (area) area.classList.remove("hidden");
    if (inputs) inputs.style.display = "block";
    if (title) title.innerText = "ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯ ÙˆØªÙÙ‚Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ±";

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„Ù‚Ø§Ø¦Ø¯
    const regs = loadRegistrations(); // ØªØ£ÙƒØ¯ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø£ØµÙ„ÙŠ
    const me = regs.find(r => r.email === currentUser.email);
    const myTeam = (me && me.isLeaderOfTeam === "yes") ? me.leaderTeam : "";

    if(!myTeam) {
        alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙŠØ¬Ø¨ Ø£Ù† ØªÙƒÙˆÙ† Ù‚Ø§Ø¦Ø¯ ÙØ±Ù‚Ø© Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±.");
        return;
    }

    // 3. ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    const members = regs.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    
    if(members.length === 0) {
        container.innerHTML = "<p style='color:red;'>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ù†Ø§ØµØ± ÙÙŠ ÙØ±Ù‚ØªÙƒ Ø­Ø§Ù„ÙŠØ§Ù‹.</p>";
        return;
    }

    let html = `<table style="width:100%; border-collapse: collapse;">
                <thead><tr style="background:#1a237e; color:white;">
                    <th style="padding:10px;">Ø§Ù„Ø§Ø³Ù…</th>
                    <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                    <th>Ø§Ù„Ø¹Ø°Ø± (Ø¥Ù† ÙˆØ¬Ø¯)</th>
                </tr></thead><tbody>`;

    members.forEach(m => {
        html += `
            <tr style="border-bottom: 1px solid #ddd;">
                <td style="padding:10px;">${m.fullName}</td>
                <td>
                    <select id="status_${m.email}" onchange="toggleExcuseField('${m.email}')" style="padding:5px;">
                        <option value="Ø­Ø§Ø¶Ø±">âœ… Ø­Ø§Ø¶Ø±</option>
                        <option value="ØºØ§Ø¦Ø¨">âŒ ØºØ§Ø¦Ø¨</option>
                    </select>
                </td>
                <td>
                    <div id="excuse_container_${m.email}" class="hidden">
                        <select id="excused_${m.email}" style="padding:5px; font-size:12px;">
                            <option value="false">Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±</option>
                            <option value="true">Ø¨Ø¹Ø°Ø± Ù…Ø¨Ø±Ø±</option>
                        </select>
                        <input type="text" id="reason_${m.email}" placeholder="Ø§Ù„Ø³Ø¨Ø¨..." style="padding:5px; font-size:11px; width:80px;">
                    </div>
                </td>
            </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;

    // 4. Ø¥Ø¹Ø§Ø¯Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù„ÙˆØ¶Ø¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„
    const actionBtns = document.getElementById("formActionButtons");
    if (actionBtns) {
        actionBtns.innerHTML = `
            <button id="btnSaveRecord" onclick="submitAttendanceToDB()" style="background:#2e7d32; color:white; padding:10px 20px; border-radius:8px; border:none; flex:2; font-weight:bold; cursor:pointer;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            <button onclick="document.getElementById('attendanceFormArea').classList.add('hidden')" style="background:#555; color:white; padding:10px 20px; border-radius:8px; border:none; flex:1; cursor:pointer;">Ø¥ØºÙ„Ø§Ù‚</button>
        `;
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¹Ø°Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± "ØºØ§Ø¦Ø¨"
function toggleExcuseField(email) {
    const status = document.getElementById(`status_${email}`).value;
    const container = document.getElementById(`excuse_container_${email}`);
    if(status === "ØºØ§Ø¦Ø¨") container.classList.remove("hidden");
    else container.classList.add("hidden");
}

// 2. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† ÙÙŠ Supabase
async function submitAttendanceToDB() {
    const title = document.getElementById("att_title").value.trim();
    const type = document.getElementById("att_type").value;
    const desc = document.getElementById("att_desc").value.trim();
    
    if(!title) { alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ù„Ù„Ù†Ø´Ø§Ø·"); return; }

    const me = globalRegistrations.find(r => r.email === currentUser.email);
    const myTeam = me.leaderTeam;

    // Ø£. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· ÙÙŠ Ø¬Ø¯ÙˆÙ„ activities
    const { data: activityData, error: actError } = await supabaseClient
        .from('activities')
        .insert([{
            title: title,
            description: desc,
            type: type,
            team_name: myTeam,
            leader_email: currentUser.email
        }])
        .select();

    if(actError) { alert("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·: " + actError.message); return; }
    
    const activityId = activityData[0].id;

    // Ø¨. ØªØ¬Ù‡ÙŠØ² Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙƒÙ„ Ø§Ù„Ø¹Ù†Ø§ØµØ±
    const members = globalRegistrations.filter(r => r.rank === "Ø¹Ù†ØµØ±" && r.team === myTeam);
    const logs = members.map(m => {
        const status = document.getElementById(`status_${m.email}`).value;
        const isExcused = document.getElementById(`excused_${m.email}`).value === "true";
        const reason = document.getElementById(`reason_${m.email}`).value;
        
        return {
            activity_id: activityId,
            member_email: m.email,
            status: status,
            is_excused: isExcused,
            absence_reason: status === "ØºØ§Ø¦Ø¨" ? reason : ""
        };
    });

    // Ø¬. Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¬Ø¯ÙˆÙ„ attendance_logs
    const { error: logError } = await supabaseClient.from('attendance_logs').insert(logs);

    if(logError) {
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· ÙˆÙ„ÙƒÙ† ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡: " + logError.message);
    } else {
        alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù†Ø´Ø§Ø· ÙˆØªÙÙ‚Ø¯ Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        document.getElementById("attendanceFormArea").classList.add("hidden");
        // ÙŠÙ…ÙƒÙ†Ù†Ø§ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù„Ø§Ø­Ù‚Ø§Ù‹
    }
}
// 1. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
async function showActivitiesArchive() {
    const area = document.getElementById("attendanceFormArea");
    area.classList.remove("hidden"); // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    
    const container = document.getElementById("attendanceListTable");
    container.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ...</p>";

    // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù‚Ø§Ø¦Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ
    const { data: activities, error } = await supabaseClient
        .from('activities')
        .where('leader_email', '==', currentUser.email) // ØªØ£ÙƒØ¯ Ù…Ù† Ù…Ø·Ø§Ø¨Ù‚Ø© Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = "<p style='color:red;'>Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: " + error.message + "</p>";
        return;
    }

    if (activities.length === 0) {
        container.innerHTML = "<p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†Ø´Ø§Ø·Ø§Øª Ù…Ø³Ø¬Ù„Ø© Ø³Ø§Ø¨Ù‚Ø§Ù‹.</p>";
        return;
    }

    let html = `<table class='archive-table'>
                <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>ØªÙØ§ØµÙŠÙ„</th></tr></thead>
                <tbody>`;
    
    activities.forEach(act => {
        const date = new Date(act.created_at).toLocaleDateString('ar-EG');
        html += `
            <tr>
                <td>${date}</td>
                <td>${act.title}</td>
                <td>${act.type}</td>
                <td><button onclick="viewActivityDetails('${act.id}', '${act.title}')" style="padding:2px 10px; font-size:12px;">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ±</button></td>
            </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

// 2. Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù†Ø´Ø§Ø· Ù…Ø¹ÙŠÙ†
async function viewActivityDetails(activityId, title) {
    const container = document.getElementById("attendanceListTable");
    container.innerHTML = `<p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù†Ø´Ø§Ø·: ${title}...</p>`;

    const { data: logs, error } = await supabaseClient
        .from('attendance_logs')
        .select(`
            member_email,
            status,
            is_excused,
            absence_reason,
            registrations ( fullName )
        `)
        .eq('activity_id', activityId);

    if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„: " + error.message);
        return;
    }

    let html = `<h5>ØªÙØ§ØµÙŠÙ„ Ø­Ø¶ÙˆØ±: ${title}</h5>
                <button onclick="showActivitiesArchive()" style="background:#555; margin-bottom:10px;">â¬…ï¸ Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø±Ø´ÙŠÙ</button>
                <table>
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¹Ø°Ø±/Ø§Ù„Ø³Ø¨Ø¨</th></tr></thead>
                <tbody>`;

    logs.forEach(log => {
        const name = log.registrations ? log.registrations.fullName : log.member_email;
        const statusColor = log.status === 'Ø­Ø§Ø¶Ø±' ? 'green' : 'red';
        const excuse = log.is_excused ? `(Ø¨Ø¹Ø°Ø±: ${log.absence_reason})` : (log.status === 'ØºØ§Ø¦Ø¨' ? 'Ø¨Ø¯ÙˆÙ† Ø¹Ø°Ø±' : '-');
        
        html += `
            <tr>
                <td>${name}</td>
                <td style="color:${statusColor}; font-weight:bold;">${log.status}</td>
                <td style="font-size:12px;">${excuse}</td>
            </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}
// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
async function showActivitiesArchive() {
    const area = document.getElementById("attendanceFormArea");
    const title = document.getElementById("formAreaTitle");
    const inputs = document.getElementById("activityInputs");
    const container = document.getElementById("attendanceListTable");
    const actionBtns = document.getElementById("formActionButtons");

    area.classList.remove("hidden");
    title.innerText = "ğŸ“‚ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©";
    inputs.style.display = "none"; // Ø¥Ø®ÙØ§Ø¡ Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„Ø£Ù†Ù†Ø§ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø·
    container.innerHTML = "<p>Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>";

    const { data: activities, error } = await supabaseClient
        .from('activities')
        .select('*')
        .eq('leader_email', currentUser.email)
        .order('created_at', { ascending: false });

    if (error) {
        container.innerHTML = "Ø®Ø·Ø£: " + error.message;
        return;
    }

    if (activities.length === 0) {
        container.innerHTML = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø±Ø´ÙŠÙ Ø¨Ø¹Ø¯.";
        return;
    }

    let html = `<table style="width:100%; border-collapse: collapse;">
                <thead><tr style="background:#eee;"><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†</th><th>Ø§Ù„Ù†ÙˆØ¹</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead><tbody>`;
    
    activities.forEach(act => {
        const date = new Date(act.created_at).toLocaleDateString('ar-EG');
        html += `
            <tr style="border-bottom:1px solid #ddd;">
                <td>${date}</td>
                <td><b>${act.title}</b></td>
                <td>${act.type}</td>
                <td><button onclick="viewActivityLogs('${act.id}', '${act.title}')" style="background:#1a237e; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer;">Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ±</button></td>
            </tr>`;
    });
    html += "</tbody></table>";
    container.innerHTML = html;

    // ØªØºÙŠÙŠØ± Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ Ù„ØªÙ†Ø§Ø³Ø¨ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    actionBtns.innerHTML = `
        <button onclick="showAttendanceForm()" style="background:#2e7d32; color:white; padding:10px; border-radius:8px; border:none; flex:1;">â• ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</button>
        <button onclick="document.getElementById('attendanceFormArea').classList.add('hidden')" style="background:#555; color:white; padding:10px; border-radius:8px; border:none; flex:1;">Ø¥ØºÙ„Ø§Ù‚</button>
    `;
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø¯Ø§Ø®Ù„ Ù†Ø´Ø§Ø· Ù…Ø¹ÙŠÙ†
async function viewActivityLogs(id, title) {
    const container = document.getElementById("attendanceListTable");
    container.innerHTML = "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...";

    const { data: logs, error } = await supabaseClient
        .from('attendance_logs')
        .select('status, is_excused, absence_reason, member_email')
        .eq('activity_id', id);

    if(error) return;

    let html = `<h4>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ù€: ${title}</h4><table style="width:100%;">
                <thead><tr style="background:#f0f0f0;"><th>Ø§Ù„Ø¹Ø¶Ùˆ</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¹Ø°Ø±</th></tr></thead><tbody>`;
    
    logs.forEach(log => {
        const color = log.status === 'Ø­Ø§Ø¶Ø±' ? 'green' : 'red';
        html += `<tr>
            <td>${log.member_email}</td>
            <td style="color:${color}; font-weight:bold;">${log.status}</td>
            <td>${log.is_excused ? 'âœ… ' + log.absence_reason : '-'}</td>
        </tr>`;
    });
    html += "</tbody></table>";
    html += `<br><button onclick="showActivitiesArchive()" style="background:#1a237e; color:white; border:none; padding:10px; border-radius:5px;">â¬…ï¸ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ø±Ø´ÙŠÙ</button>`;
    container.innerHTML = html;
}
async function fetchMemberAttendanceStats() {
    // 1. Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø­Ø¶ÙˆØ± Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø· (Join)
    const { data: logs, error } = await supabaseClient
        .from('attendance_logs')
        .select(`
            status, is_excused, absence_reason,
            activities ( title, type, created_at )
        `)
        .eq('member_email', currentUser.email);

    if (error || !logs) return;

    let stats = {
        Ø§Ø¬ØªÙ…Ø§Ø¹: { attended: 0, total: 0 },
        Ù†Ø´Ø§Ø·: { attended: 0, total: 0 }
    };

    let timelineHTML = "";

    logs.forEach(log => {
        const act = log.activities;
        const type = act.type; // Ø§Ø¬ØªÙ…Ø§Ø¹ Ø£Ùˆ Ù†Ø´Ø§Ø·

        // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ù…Ù†ØµÙØ©: Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¹Ø°Ø± Ù…Ù† Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        if (log.status === "Ø­Ø§Ø¶Ø±") {
            stats[type].attended++;
            stats[type].total++;
        } else if (log.status === "ØºØ§Ø¦Ø¨" && !log.is_excused) {
            stats[type].total++;
        }

        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ØªØ§ÙŠÙ… Ù„Ø§ÙŠÙ†
        const date = new Date(act.created_at).toLocaleDateString('ar-EG', {month:'short', day:'numeric'});
        let statusIcon = log.status === 'Ø­Ø§Ø¶Ø±' ? 'âœ…' : (log.is_excused ? 'âš ï¸ Ù…Ø¨Ø±Ø±' : 'âŒ');
        let statusColor = log.status === 'Ø­Ø§Ø¶Ø±' ? '#2e7d32' : (log.is_excused ? '#f57c00' : '#d32f2f');

        timelineHTML += `
            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding:8px 0;">
                <div>
                    <span style="font-size:12px; color:#666;">${date}</span> - 
                    <strong style="font-size:14px;">${act.title}</strong>
                </div>
                <div style="color:${statusColor}; font-weight:bold; font-size:13px;">${statusIcon}</div>
            </div>`;
    });

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Ø³Ø¨ Ø§Ù„Ù…Ø¦ÙˆÙŠØ© ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const meetingRate = stats['Ø§Ø¬ØªÙ…Ø§Ø¹'].total > 0 ? Math.round((stats['Ø§Ø¬ØªÙ…Ø§Ø¹'].attended / stats['Ø§Ø¬ØªÙ…Ø§Ø¹'].total) * 100) : 0;
    const activityRate = stats['Ù†Ø´Ø§Ø·'].total > 0 ? Math.round((stats['Ù†Ø´Ø§Ø·'].attended / stats['Ù†Ø´Ø§Ø·'].total) * 100) : 0;

    document.getElementById("meetingRate").innerText = meetingRate + "%";
    document.getElementById("activityRate").innerText = activityRate + "%";
    document.getElementById("memberAttendanceTimeline").innerHTML = timelineHTML || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
}
async function buildWarehouseUI() {
    // âœ… Ø¶Ù…Ø§Ù† ÙˆØ¬ÙˆØ¯ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
  const container = document.getElementById('warehouseContent');
  if (!container) {
    console.error("buildWarehouseUI: #warehouseContent not found. ØªØ£ÙƒØ¯ Ø£Ù† screenWarehouse Ù…ÙˆØ¬ÙˆØ¯ ÙˆÙ…Ùˆ Ù…ØªØ³ÙƒØ±/Ù…Ù…Ø³ÙˆØ­.");
    return;
  }


    container.innerHTML = `
        <div style="direction: rtl; padding: 20px; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
            <h2 style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„ÙÙˆØ¬</h2>
            
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-top: 20px;">
                <div style="background: #ebf5fb; padding: 15px; border-radius: 10px; text-align: center; border-right: 5px solid #3498db;">
                    <small>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ØµÙ†Ø§Ù</small>
                    <h3 id="statTotalItems">0</h3>
                </div>
                <div style="background: #fef9e7; padding: 15px; border-radius: 10px; text-align: center; border-right: 5px solid #f1c40f;">
                    <small>Ù‚Ø·Ø¹ Ù…Ø¹Ø§Ø±Ø©</small>
                    <h3 id="statLoanedItems">0</h3>
                </div>
            </div>

            <div style="margin: 25px 0; display: flex; gap: 10px; flex-wrap: wrap;">
                <button onclick="openAddItemModal()" style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">â• Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù</button>
                <button onclick="showWarehouseArchive()" style="background: #7f8c8d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: bold;">ğŸ“œ Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 15px; width: 100%;">
    
                <input type="text" id="wsSearch" placeholder="ğŸ” Ø¨Ø­Ø« Ø¹Ù† ØºØ±Ø¶..." oninput="refreshWarehouseTable()"
                       style="flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px;">

                <select id="wsFilterCat" onchange="refreshWarehouseTable()"
                        style="flex: 1; padding: 12px; border: 1px solid #ccc; border-radius: 8px;">
                    <option value="Ø§Ù„ÙƒÙ„">ğŸ“‚ ÙƒÙ„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª</option>
                    <option value="ØªØ®ÙŠÙŠÙ…">â›º ØªØ®ÙŠÙŠÙ…</option>
                    <option value="Ù…Ø·Ø¨Ø®">ğŸ³ Ù…Ø·Ø¨Ø®</option>
                    <option value="ÙƒÙ‡Ø±Ø¨Ø§Ø¡">âš¡ ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                    <option value="Ø£Ø®Ø±Ù‰">ğŸ“¦ Ø£Ø®Ø±Ù‰</option>
                </select>

            </div>

            <div style="overflow-x: auto;">
                <table style="width: 100%; border-collapse: collapse; background: white;">
                    <thead>
                        <tr style="background: #34495e; color: white; text-align: right;">
                            <th style="padding: 12px;">Ø§Ù„ØºØ±Ø¶</th>
                            <th style="padding: 12px;">Ø§Ù„ØªØ¨ÙˆÙŠØ¨</th>
                            <th style="padding: 12px;">Ø§Ù„Ù…ØªÙˆÙØ±</th>
                            <th style="padding: 12px;">Ø§Ù„Ù…ÙƒØ§Ù†</th>
                            <th style="padding: 12px;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                            <th style="padding: 12px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="warehouseTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    `;

    async function checkOverdueItems() {
        const today = new Date().toISOString().split('T')[0];
        
        const { data, error } = await supabaseClient
            .from('warehouse_logs')
            .select('*, warehouse_inventory(item_name)')
            .eq('is_returned', false)
            .lt('expected_return_date', today);

        if (data && data.length > 0) {
            let message = "âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ù‡Ù†Ø§Ùƒ Ø£ØºØ±Ø§Ø¶ Ù…ØªØ£Ø®Ø±Ø© Ø¹Ù† Ù…ÙˆØ¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹:\n";
            data.forEach(log => {
                message += `- ${log.warehouse_inventory.item_name} Ù…Ø¹ (${log.person_name})\n`;
            });
            alert(message);
        }
    }

    // Ø§Ø³ØªØ¯Ø¹ÙŠÙ‡Ø§ Ø¯Ø§Ø®Ù„ Ø¯Ø§Ù„Ø© buildWarehouseUI
    loadWarehouseData(); // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙˆØ¨Ø§Ø¨ÙŠØ²
}

// 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙˆØ¨Ø§Ø¨ÙŠØ²
async function loadWarehouseData() {
    const { data, error } = await supabaseClient
        .from('warehouse_inventory')
        .select('*')
        .order('item_name', { ascending: true });

    if (error) {
        console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:", error);
        return;
    }

    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡:
    // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… + (|| []) Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙØ§Ø±ØºØ©
    window.allWarehouseItems = data || []; 
   
    refreshWarehouseTable(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„ÙÙ„ØªØ± Ù„Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    updateWarehouseStats(data || []); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ù„ÙˆÙŠØ©
}

// 2. Ø¯Ø§Ù„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª (Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„ØªÙŠ ØªØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰)
function updateWarehouseStats(data) {
    const total = data.length;
    const loaned = data.reduce((acc, item) => acc + (item.total_quantity - item.available_quantity), 0);
    
    if(document.getElementById('statTotalItems')) {
        document.getElementById('statTotalItems').textContent = total;
        document.getElementById('statLoanedItems').textContent = loaned;
    }
}

// 3. Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙÙ„ØªØ±Ø©
function refreshWarehouseTable() {
    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¨Ø­Ø« ÙˆØ§Ù„ÙÙ„ØªØ±
    // Ø§Ø³ØªØ®Ø¯Ø§Ù… ?.value ÙŠØ¶Ù…Ù† Ø¹Ø¯Ù… Ø­Ø¯ÙˆØ« Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù„Ù… ÙŠØ¬Ø¯ Ø§Ù„Ø¹Ù†ØµØ±
    const searchTerm = document.getElementById("wsSearch")?.value.toLowerCase() || "";
    const categoryFilter = document.getElementById("wsFilterCat")?.value || "Ø§Ù„ÙƒÙ„";
    
    // 2. Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØµÙÙŠØ© (Filtering)
    // (window.allWarehouseItems || []) ØªØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ù…ØµÙÙˆÙØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø¹Ø¯
    const filtered = (window.allWarehouseItems || []).filter(item => {
        const matchesName = item.item_name.toLowerCase().includes(searchTerm);
        const matchesCat = categoryFilter === "Ø§Ù„ÙƒÙ„" || item.category === categoryFilter;
        return matchesName && matchesCat;
    });

    const tbody = document.getElementById("warehouseTableBody");
    if(!tbody) return;
    
    tbody.innerHTML = "";

    // 3. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£ÙŠ Ù†ØªÙŠØ¬Ø© Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø©
    if (filtered.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«.</td></tr>";
        return;
    }

    // 4. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙÙ„ØªØ±Ø©
    filtered.forEach(item => {
        // Ø­Ø³Ø§Ø¨ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù‚Ø·Ø¹ Ù…Ø¹Ø§Ø±Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
        const hasLoanedItems = item.available_quantity < item.total_quantity;
        const returnBtn = hasLoanedItems 
            ? `<button onclick="openReturnModal('${item.id}')" title="Ø¥Ø±Ø¬Ø§Ø¹ ØºØ±Ø¶" style="cursor:pointer; background:none; border:none; font-size:1.2rem;">ğŸ“¥</button>` 
            : "";

        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid #eee;">
                <td style="padding: 12px; font-weight:bold; color:#1a237e;">${item.item_name}</td>
                <td style="padding: 12px;"><span style="background:#eee; padding:2px 8px; border-radius:4px; font-size:0.9rem;">${item.category}</span></td>
                <td style="padding: 12px; font-weight:bold;">${item.available_quantity} / ${item.total_quantity}</td>
                <td style="padding: 12px;">${item.storage_location}</td>
                <td style="padding: 12px;">${item.status}</td>
                <td style="padding: 12px;">
                    <button onclick="openLoanModal('${item.id}')" title="ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¹Ø§Ø±Ø©" style="cursor:pointer; background:none; border:none; font-size:1.2rem;">ğŸ“¤</button>
                    ${returnBtn}
                    <button onclick="editItem('${item.id}')" title="ØªØ¹Ø¯ÙŠÙ„" style="cursor:pointer; background:none; border:none; font-size:1.2rem;">âœï¸</button>
                </td>
            </tr>
        `;
    });
}

// ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
function openAddItemModal() {
    document.getElementById('modalAddItem').classList.remove('hidden');
}

// Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
function closeModal(id) {
    document.getElementById(id).classList.add('hidden');
}

// Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³ÙˆØ¨Ø§Ø¨ÙŠØ²
async function saveNewItem() {
    const name = document.getElementById('newItemName').value;
    const cat = document.getElementById('newItemCat').value;
    const status = document.getElementById('newItemStatus').value; // Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
    const qty = parseInt(document.getElementById('newItemQty').value);
    const loc = document.getElementById('newItemLocation').value;

    if(!name || isNaN(qty)) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶ ÙˆØ§Ù„ÙƒÙ…ÙŠØ©");
        return;
    }

    const { data, error } = await supabaseClient
        .from('warehouse_inventory')
        .insert([
            { 
                item_name: name, 
                category: cat, 
                total_quantity: qty, 
                available_quantity: qty, 
                storage_location: loc,
                status: status // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
            }
        ]);

    if (error) {
        alert("Ø®Ø·Ø£: " + error.message);
    } else {
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeModal('modalAddItem');
        loadWarehouseData();
        // Ù…Ø³Ø­ Ø§Ù„Ø®Ø§Ù†Ø§Øª Ø¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸
        document.getElementById('newItemName').value = "";
        document.getElementById('newItemQty').value = "1";
        document.getElementById('newItemLocation').value = "";
    }
}
// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ÙˆØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØºØ±Ø¶
function openLoanModal(itemId) {
    const item = window.allWarehouseItems.find(i => i.id === itemId);
    if (!item) return;

    if (item.available_quantity <= 0) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ ÙƒÙ…ÙŠØ© Ù…ØªÙˆÙØ±Ø© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø­Ø§Ù„ÙŠØ§Ù‹!");
        return;
    }

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.getElementById('loanItemId').value = item.id;
    document.getElementById('loanItemName').textContent = "Ø¥Ø¹Ø§Ø±Ø©: " + item.item_name;
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…ØªÙˆÙØ± Ù„ÙƒÙ„ Ø­Ø§Ù„Ø© Ø£Ù…Ø§Ù… Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„ (Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    if(document.getElementById('availEx')) document.getElementById('availEx').textContent = item.qty_excellent || 0;
    if(document.getElementById('availGood')) document.getElementById('availGood').textContent = item.qty_good || 0;
    if(document.getElementById('availBroken')) document.getElementById('availBroken').textContent = item.qty_broken || 0;

    // ØªØµÙÙŠØ± Ø®Ø§Ù†Ø§Øª Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­
    if(document.getElementById('loanQtyEx')) document.getElementById('loanQtyEx').value = 0;
    if(document.getElementById('loanQtyGood')) document.getElementById('loanQtyGood').value = 0;
    if(document.getElementById('loanQtyBroken')) document.getElementById('loanQtyBroken').value = 0;
    if(document.getElementById('loanTotalDisplay')) document.getElementById('loanTotalDisplay').textContent = "0";

    document.getElementById('modalLoanItem').classList.remove('hidden');
}
// 2. ØªØ£ÙƒÙŠØ¯ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© ÙˆØ§Ù„Ø­ÙØ¸

async function showWarehouseArchive() {
    showScreen('screenWarehouseArchive');
    const tbody = document.getElementById('archiveTableBody');
    tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px;'>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª...</td></tr>";

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù…Ø¹ Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶
    const { data, error } = await supabaseClient
        .from('warehouse_logs')
        .select(`
            *,
            warehouse_inventory (item_name)
        `)
        .order('action_date', { ascending: false });

    if (error) {
        alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ: " + error.message);
        return;
    }

    tbody.innerHTML = "";

    if (data.length === 0) {
        tbody.innerHTML = "<tr><td colspan='6' style='text-align:center; padding:20px; color:#777;'>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø­Ø±ÙƒØ© Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</td></tr>";
        return;
    }

    data.forEach(log => {
        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„ÙˆÙ‚Øª Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ Ù„Ø¬Ù…Ø§Ù„ÙŠØ© Ø£ÙƒØ«Ø±
        const dateObj = new Date(log.action_date);
        const dateStr = dateObj.toLocaleDateString('ar-EG');
        const timeStr = dateObj.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});

        const itemName = log.warehouse_inventory ? log.warehouse_inventory.item_name : "ØµÙ†Ù Ù…Ø­Ø°ÙˆÙ";
        
        // Ù…ØªØºÙŠØ±Ø§Øª Ù„Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„ÙˆÙ† ÙˆØ§Ù„Ø³ØªØ§ÙŠÙ„ Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø­Ø±ÙƒØ©
        let typeBadge = "";
        let rowStyle = ""; // Ø³ØªØ§ÙŠÙ„ Ù„Ù„ØµÙ ÙƒØ§Ù…Ù„

        if (log.action_type === 'Ø¥Ø¹Ø§Ø±Ø©') {
            // Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© (Ø®Ø±ÙˆØ¬) - Ø¨Ø±ØªÙ‚Ø§Ù„ÙŠ
            typeBadge = `<span style="background:#fff3e0; color:#ef6c00; padding:5px 10px; border-radius:8px; font-size: 0.8rem; border:1px solid #ffe0b2; font-weight:bold;">ğŸ“¤ Ø®Ø±ÙˆØ¬ (Ø¥Ø¹Ø§Ø±Ø©)</span>`;
        } else if (log.action_type === 'Ø¥Ø±Ø¬Ø§Ø¹') {
            // Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ (Ø¯Ø®ÙˆÙ„) - Ø£Ø®Ø¶Ø±
            typeBadge = `<span style="background:#e8f5e9; color:#2e7d32; padding:5px 10px; border-radius:8px; font-size: 0.8rem; border:1px solid #c8e6c9; font-weight:bold;">ğŸ“¥ Ø¯Ø®ÙˆÙ„ (Ø¥Ø±Ø¬Ø§Ø¹)</span>`;
            rowStyle = "background-color: #f1f8e9;"; // ØªÙ…ÙŠÙŠØ² ØµÙ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¨Ù„ÙˆÙ† Ø®Ù„ÙÙŠØ© Ø®ÙÙŠÙ Ø¬Ø¯Ø§Ù‹
        } else {
            // Ø£ÙŠ Ù†ÙˆØ¹ Ø¢Ø®Ø±
            typeBadge = `<span style="background:#eee; color:#333; padding:5px 10px; border-radius:8px; font-size: 0.8rem;">${log.action_type}</span>`;
        }

        tbody.innerHTML += `
            <tr style="border-bottom: 1px solid rgba(0,0,0,0.05); ${rowStyle}">
                <td style="padding: 15px;">
                    <div style="font-weight:bold; color:#333;">${dateStr}</div>
                    <div style="font-size:0.8rem; color:#888;">${timeStr}</div>
                </td>
                <td style="padding: 15px; font-weight: bold; color: #1a237e;">${itemName}</td>
                <td style="padding: 15px;">${typeBadge}</td>
                <td style="padding: 15px; font-weight:bold; font-size:1.1rem; color:#333;">${log.quantity}</td>
                <td style="padding: 15px; color:#444;">${log.person_name || '---'}</td>
                <td style="padding: 15px; font-size: 0.9rem; color: #666;">${log.notes || '-'}</td>
            </tr>
        `;
    });
}
// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± Ø£ÙŠ Ø­Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø©
// 1. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
function calculateEditTotal() {
    const ex = parseInt(document.getElementById('edit_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('edit_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('edit_qtyBroken').value) || 0;
    document.getElementById('edit_totalDisplay').innerText = ex + gd + bk;
}

// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function editItem(itemId) {
    const item = window.allWarehouseItems.find(i => i.id === itemId);
    if (!item) return;

    document.getElementById('edit_itemId').value = item.id;
    document.getElementById('edit_itemName').value = item.item_name;
    document.getElementById('edit_itemLoc').value = item.storage_location;
    
    document.getElementById('edit_qtyEx').value = item.qty_excellent || 0;
    document.getElementById('edit_qtyGood').value = item.qty_good || 0;
    document.getElementById('edit_qtyBroken').value = item.qty_broken || 0;

    calculateEditTotal(); // Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ ÙÙˆØ± Ø§Ù„ÙØªØ­
    document.getElementById('modalEditItem').classList.remove('hidden');
}

// 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø°ÙƒÙŠØ© (Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§Ø²Ù†)
async function saveEditItem() {
    const id = document.getElementById('edit_itemId').value;
    const item = window.allWarehouseItems.find(i => i.id === id);

    const name = document.getElementById('edit_itemName').value;
    const loc = document.getElementById('edit_itemLoc').value;
    
    const ex = parseInt(document.getElementById('edit_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('edit_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('edit_qtyBroken').value) || 0;
    
    const newInStock = ex + gd + bk; // Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
    
    // Ø­Ø³Ø§Ø¨ ÙƒÙ… Ù‚Ø·Ø¹Ø© "Ø¨Ø±Ø§" Ø­Ø§Ù„ÙŠØ§Ù‹ (Ø§Ù„Ù…Ø¹Ø§Ø± Ø§Ù„Ø°ÙŠ Ù„Ù… ÙŠØ¹Ø¯)
    const currentlyLoaned = (item.total_quantity || 0) - (item.available_quantity || 0);

    // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯ = (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯) + (Ø§Ù„Ù„ÙŠ Ù„Ø³Ø§ Ø¨Ø±Ø§)
    const newTotal = newInStock + currentlyLoaned;

    const { error } = await supabaseClient
        .from('warehouse_inventory')
        .update({ 
            item_name: name, 
            storage_location: loc,
            qty_excellent: ex,
            qty_good: gd,
            qty_broken: bk,
            available_quantity: newInStock, // Ø§Ù„Ù…ØªÙˆÙØ± Ù‡Ùˆ Ù…Ø§ Ø­Ø¯Ø¯ØªÙ‡ Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª
            total_quantity: newTotal        // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙŠØªØ¹Ø¯Ù„ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© + Ø§Ù„Ù…Ø¹Ø§Ø± Ø³Ø§Ø¨Ù‚Ø§Ù‹
        })
        .eq('id', id);

    if (error) {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message);
    } else {
        alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ù…ÙŠØ²Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeModal('modalEditItem');
        loadWarehouseData();
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø¶Ø¨Ø· Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø§Ù„ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„Ù†Ø§ÙØ°Ø©
function openGeneralLoan() {
    const selectContainer = document.getElementById('itemSelectContainer');
    const nameDisplay = document.getElementById('loanItemName');
    const selectEl = document.getElementById('loanItemSelect');
    
    selectContainer.classList.remove('hidden');
    nameDisplay.classList.add('hidden');
    
    // Ø¶Ø¨Ø· ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ… ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('loanDate').value = today;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù
    selectEl.innerHTML = '<option value="">-- Ø§Ø®ØªØ± Ø§Ù„ØµÙ†Ù --</option>';
    window.allWarehouseItems.filter(i => i.available_quantity > 0).forEach(item => {
        selectEl.innerHTML += `<option value="${item.id}">${item.item_name} (Ù…ØªÙˆÙØ±: ${item.available_quantity})</option>`;
    });

    document.getElementById('modalLoanItem').classList.remove('hidden');
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¯Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙÙŠ Supabase
async function confirmLoan() {
    const itemId = document.getElementById('loanItemId').value;
    const person = document.getElementById('loanPersonName').value;
    
    // Ø¬Ù„Ø¨ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† ÙƒÙ„ Ø­Ø§Ù„Ø© (Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©)
    const qEx = parseInt(document.getElementById('loanQtyEx').value) || 0;
    const qGd = parseInt(document.getElementById('loanQtyGood').value) || 0;
    const qBk = parseInt(document.getElementById('loanQtyBroken').value) || 0;
    
    // Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù‡Ùˆ Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø«Ù„Ø§Ø«
    const totalQty = qEx + qGd + qBk;
    
    const loanDate = document.getElementById('loanDate').value;
    const expectedReturn = document.getElementById('returnExpectedDate').value;

    // 1. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªØ­Ù‚Ù‚ Ù„ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹)
    if (!person || !loanDate || !expectedReturn || isNaN(totalQty) || totalQty <= 0) {
        alert("ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ø³ØªÙ„Ù… ÙˆØ§Ù„ØªÙˆØ§Ø±ÙŠØ® ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)");
        return;
    }

    const item = window.allWarehouseItems.find(i => i.id === itemId);

    // 2. Ø§Ù„ØªØ´ÙŠÙŠÙƒ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ Ø¹Ù„Ù‰ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ù„ÙƒÙ„ Ø­Ø§Ù„Ø© (Ù„Ù…Ù†Ø¹ "Ø§Ù„Ø±ÙˆÙƒØ¨Ø©" ÙˆØ§Ù„Ø³ÙˆØ§Ù„Ø¨)
    if (qEx > (item.qty_excellent || 0) || 
        qGd > (item.qty_good || 0) || 
        qBk > (item.qty_broken || 0)) {
        alert(`âŒ Ø®Ø·Ø£: Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù…Ù† Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø­Ø§Ù„Ø§Øª ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…ØªÙˆÙØ± Ø­Ø§Ù„ÙŠØ§Ù‹!`);
        return; 
    }
    
    // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: Ø®ØµÙ… Ù…Ù† ÙƒÙ„ Ø­Ø§Ù„Ø© ÙˆÙ…Ù† Ø§Ù„Ù…ØªÙˆÙØ± Ø§Ù„ÙƒÙ„ÙŠ
    const { error: updateError } = await supabaseClient
        .from('warehouse_inventory')
        .update({ 
            qty_excellent: (item.qty_excellent || 0) - qEx,
            qty_good: (item.qty_good || 0) - qGd,
            qty_broken: (item.qty_broken || 0) - qBk,
            available_quantity: item.available_quantity - totalQty 
        })
        .eq('id', itemId);

    // 4. ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù…Ø¹ "ØªÙØµÙŠÙ„" Ù…Ø§ Ø®Ø±Ø¬ (Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹)
    const { error: logError } = await supabaseClient
        .from('warehouse_logs')
        .insert([{
            item_id: itemId,
            action_type: 'Ø¥Ø¹Ø§Ø±Ø©',
            person_name: person,
            quantity: totalQty, // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„Ø¥Ø¹Ø§Ø±Ø©
            out_excellent: qEx, // ÙƒÙ… Ù…Ù…ØªØ§Ø² Ø®Ø±Ø¬
            out_good: qGd,      // ÙƒÙ… ÙˆØ³Ø· Ø®Ø±Ø¬
            out_broken: qBk,    // ÙƒÙ… ØµÙŠØ§Ù†Ø© Ø®Ø±Ø¬
            action_date: loanDate,
            expected_return_date: expectedReturn,
            is_returned: false
        }]);

    if (!updateError && !logError) {
        alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø¨Ø¯Ù‚Ø© ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±ØµØ¯Ø© âœ…");
        closeModal('modalLoanItem');
        loadWarehouseData();
    } else {
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
        console.error(updateError || logError);
    }
}


async function processReturn(logId, itemId, qty) {
    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³Ø¬Ù„
    await supabaseClient.from('warehouse_logs').update({ is_returned: true }).eq('id', logId);
    
    // 2. Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ù…Ø®Ø²Ù†
    const item = window.allWarehouseItems.find(i => i.id === itemId);
    const newQty = item.available_quantity + qty;
    
    const { error } = await supabaseClient
        .from('warehouse_inventory')
        .update({ available_quantity: newQty })
        .eq('id', itemId);

    if (!error) {
        alert("ØªÙ… Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ØºØ±Ø¶ Ø¨Ù†Ø¬Ø§Ø­ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªÙˆÙØ± âœ…");
        loadWarehouseData();
    }
}
// Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø°ÙƒÙŠØ©
// âœ… Ø§Ù„Ø­Ù„ Ø§Ù„ØµØ­ÙŠØ­: Ø¯Ø§Ù„Ø© Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¹Ù‡Ø¯Ø© Ø§Ù„ØªÙŠ ØªØ¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
async function openReturnModal(itemId) {
    console.log("Opening return modal for Item ID:", itemId);

    // 1. Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© (ØºÙŠØ± Ø§Ù„Ù…Ø±Ø¬Ø¹Ø©) Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù
    const { data: loans, error } = await supabaseClient
        .from('warehouse_logs')
        .select('*, warehouse_inventory(item_name)')
        .eq('item_id', itemId)
        .eq('is_returned', false);

    if (error) {
        console.error("Error fetching logs:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©.");
        return;
    }

    if (!loans || loans.length === 0) {
        alert("âš ï¸ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù‡Ø¯Ø© Ù…Ø³Ø¬Ù„Ø© (ØºÙŠØ± Ù…Ø±Ø¬Ø¹Ø©) Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ø­Ø§Ù„ÙŠØ§Ù‹.");
        return;
    }

    // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ (ÙÙŠ Ø­Ø§Ù„ Ø§Ø³ØªØ¹Ø§Ø± Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ø®Øµ Ù†ÙØ³ Ø§Ù„ØºØ±Ø¶)
    let selectedLoan = loans[0];

    if (loans.length > 1) {
        let msg = "ÙŠÙˆØ¬Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ø®Øµ Ø§Ø³ØªØ¹Ø§Ø± Ù‡Ø°Ø§ Ø§Ù„ØºØ±Ø¶ØŒ Ø­Ø¯Ø¯ Ø§Ù„Ø±Ù‚Ù… Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹:\n";
        loans.forEach((l, index) => {
            msg += `${index + 1}- Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${l.person_name} (Ø§Ù„ÙƒÙ…ÙŠØ©: ${l.quantity})\n`;
        });
        
        const choice = prompt(msg, "1");
        if (!choice) return; // Ø¶ØºØ· Ø¥Ù„ØºØ§Ø¡
        
        selectedLoan = loans[parseInt(choice) - 1];
        if (!selectedLoan) {
            alert("Ø®ÙŠØ§Ø± ØºÙŠØ± ØµØ­ÙŠØ­");
            return;
        }
    }

    // 3. ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø© (Modal)
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù‚Ø¨Ù„ ØªØ¹Ø¨Ø¦ØªÙ‡Ø§ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©
    if(document.getElementById('ret_logId')) document.getElementById('ret_logId').value = selectedLoan.id;
    if(document.getElementById('ret_itemId')) document.getElementById('ret_itemId').value = selectedLoan.item_id;
    
    if(document.getElementById('ret_personName')) document.getElementById('ret_personName').innerText = selectedLoan.person_name;
    
    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ø³Ù… Ø§Ù„ØºØ±Ø¶
    let itemName = "ØºØ±Ø¶";
    if (selectedLoan.warehouse_inventory && selectedLoan.warehouse_inventory.item_name) {
        itemName = selectedLoan.warehouse_inventory.item_name;
    }
    if(document.getElementById('ret_itemName')) document.getElementById('ret_itemName').innerText = itemName;
    
    if(document.getElementById('ret_totalQty')) document.getElementById('ret_totalQty').innerText = selectedLoan.quantity;

    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    if(document.getElementById('ret_qtyEx')) document.getElementById('ret_qtyEx').value = 0;
    if(document.getElementById('ret_qtyGood')) document.getElementById('ret_qtyGood').value = 0;
    if(document.getElementById('ret_qtyBroken')) document.getElementById('ret_qtyBroken').value = 0;
    if(document.getElementById('ret_totalDisplay')) document.getElementById('ret_totalDisplay').innerText = "0";
    if(document.getElementById('ret_notes')) document.getElementById('ret_notes').value = "";

    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    const modal = document.getElementById('modalReturnItem');
    if (modal) {
        modal.classList.remove('hidden');
    } else {
        console.error("Modal element 'modalReturnItem' not found in HTML");
    }
}
// Ø¯Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
async function confirmSmartReturn() {
    const logId = document.getElementById('retLogId').value;
    const itemId = document.getElementById('retItemId').value;
    const totalBorrowed = parseInt(document.getElementById('retTotalQty').value);

    const ex = parseInt(document.getElementById('retQtyEx').value) || 0;
    const gd = parseInt(document.getElementById('retQtyGood').value) || 0;
    const bk = parseInt(document.getElementById('retQtyBroken').value) || 0;

    // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…Ø¯Ø®Ù„ ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ø±Ø©
    if (ex + gd + bk !== totalBorrowed) {
        alert(`âŒ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ (${ex + gd + bk}) ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ø±Ø© (${totalBorrowed})`);
        return;
    }

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const item = window.allWarehouseItems.find(i => i.id === itemId);

    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹: Ù†Ø²ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø­Ø³Ø¨ Ù…Ø§ Ø±Ø¬Ø¹
    const { error: invErr } = await supabaseClient
        .from('warehouse_inventory')
        .update({ 
            available_quantity: item.available_quantity + totalBorrowed,
            qty_excellent: (item.qty_excellent || 0) + ex,
            qty_good: (item.qty_good || 0) + gd,
            qty_broken: (item.qty_broken || 0) + bk
        })
        .eq('id', itemId);

    // ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©
    const { error: logErr } = await supabaseClient
        .from('warehouse_logs')
        .update({ is_returned: true, notes: `Ø¹Ø§Ø¯Øª: ${ex} Ù…Ù…ØªØ§Ø²ØŒ ${gd} ÙˆØ³Ø·ØŒ ${bk} ØµÙŠØ§Ù†Ø©` })
        .eq('id', logId);

    if (!invErr && !logErr) {
        alert("ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø£ØºØ±Ø§Ø¶ ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ âœ…");
        closeModal('modalReturnDetail');
        loadWarehouseData();
    }
}
function calcLoanTotal() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©
    const ex = parseInt(document.getElementById('loanQtyEx').value) || 0;
    const gd = parseInt(document.getElementById('loanQtyGood').value) || 0;
    const bk = parseInt(document.getElementById('loanQtyBroken').value) || 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø±Ù‚Ù… "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©" ÙÙŠ Ø§Ù„Ù†Ø§ÙØ°Ø©
    const totalDisplay = document.getElementById('loanTotalDisplay');
    if (totalDisplay) {
        totalDisplay.textContent = ex + gd + bk;
    }
}
// 1. Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ÙƒØªØ§Ø¨Ø©
function calculateAddTotal() {
    const ex = parseInt(document.getElementById('add_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('add_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('add_qtyBroken').value) || 0;
    document.getElementById('add_totalDisplay').innerText = ex + gd + bk;
}

// 2. Ø¯Ø§Ù„Ø© Ø­ÙØ¸ Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙŠ Supabase
async function saveNewItem() {
    const name = document.getElementById('add_itemName').value;
    const category = document.getElementById('add_itemCategory').value;
    const loc = document.getElementById('add_itemLoc').value;
    
    const ex = parseInt(document.getElementById('add_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('add_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('add_qtyBroken').value) || 0;
    const total = ex + gd + bk;

    if (!name || total <= 0) {
        alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„ØµÙ†Ù ÙˆØªÙˆØ²ÙŠØ¹ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­");
        return;
    }

    const { data, error } = await supabaseClient
        .from('warehouse_inventory')
        .insert([{
            item_name: name,
            category: category,
            storage_location: loc,
            qty_excellent: ex,
            qty_good: gd,
            qty_broken: bk,
            total_quantity: total,        // Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø°ÙŠ Ø­Ø³Ø¨Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù…
            available_quantity: total    // ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ± ÙŠØ³Ø§ÙˆÙŠ Ø§Ù„ÙƒÙ„ÙŠ
        }]);

    if (error) {
        alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message);
    } else {
        alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØµÙ†Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeModal('modalAddItem');
        loadWarehouseData(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
    }
}
// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®ØªØ§Ø±
// âœ… Ø§Ø³ØªØ¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©
async function openReturnModal(itemId) {
    console.log("Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù„Ù„Ø¹Ù†ØµØ± Ø±Ù‚Ù…:", itemId);

    // 1. Ø¬Ù„Ø¨ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ù†Ø´Ø·Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± Ù…Ø¨Ø§Ø´Ø±Ø©
    const { data: loans, error } = await supabaseClient
        .from('warehouse_logs')
        .select('*, warehouse_inventory(item_name)')
        .eq('item_id', itemId)
        .eq('is_returned', false);

    if (error) {
        console.error(error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù‡Ø¯Ø©.");
        return;
    }

    if (!loans || loans.length === 0) {
        alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„ØµÙ†Ù Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙˆÙ„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ù…Ù„ÙŠØ§Øª Ø¥Ø¹Ø§Ø±Ø© Ù†Ø´Ø·Ø© Ø¹Ù„ÙŠÙ‡.");
        return;
    }

    // 2. ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø´Ø®Øµ Ø§Ø³ØªØ¹Ø§Ø± Ù†ÙØ³ Ø§Ù„ØºØ±Ø¶)
    let selectedLoan = loans[0];

    if (loans.length > 1) {
        let msg = "ÙŠÙˆØ¬Ø¯ Ø£ÙƒØ«Ø± Ù…Ù† Ø¹Ù…Ù„ÙŠØ© Ø¥Ø¹Ø§Ø±Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØµÙ†ÙØŒ Ø§Ø®ØªØ± Ø§Ù„Ø±Ù‚Ù…:\n";
        loans.forEach((l, i) => {
            msg += `${i + 1}- Ø§Ù„Ù…Ø³ØªÙ„Ù…: ${l.person_name} (Ø§Ù„Ø¹Ø¯Ø¯: ${l.quantity})\n`;
        });
        
        let choice = prompt(msg, "1");
        if (!choice) return; // Ø¥Ù„ØºØ§Ø¡
        selectedLoan = loans[parseInt(choice) - 1];
        
        if(!selectedLoan) { alert("Ø®ÙŠØ§Ø± Ø®Ø§Ø·Ø¦"); return; }
    }

    // 3. ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø© (Modal)
    document.getElementById('ret_logId').value = selectedLoan.id;
    document.getElementById('ret_itemId').value = selectedLoan.item_id;
    
    // Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ ÙˆØ§Ø³Ù… Ø§Ù„ØºØ±Ø¶
    if(document.getElementById('ret_personName')) 
        document.getElementById('ret_personName').innerText = selectedLoan.person_name;
    
    if(document.getElementById('ret_itemName')) 
        document.getElementById('ret_itemName').innerText = selectedLoan.warehouse_inventory?.item_name || "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ";
    
    if(document.getElementById('ret_totalQty')) 
        document.getElementById('ret_totalQty').innerText = selectedLoan.quantity;

    // ØªØµÙÙŠØ± Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„
    document.getElementById('ret_qtyEx').value = 0;
    document.getElementById('ret_qtyGood').value = 0;
    document.getElementById('ret_qtyBroken').value = 0;
    document.getElementById('ret_totalDisplay').innerText = "0";
    if(document.getElementById('ret_notes')) document.getElementById('ret_notes').value = "";

    // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø©
    document.getElementById('modalReturnItem').classList.remove('hidden');
}

// 2. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªÙˆØ²ÙŠØ¹
function calculateRetTotal() {
    const ex = parseInt(document.getElementById('ret_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('ret_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('ret_qtyBroken').value) || 0;
    document.getElementById('ret_totalDisplay').innerText = ex + gd + bk;
}

// 3. ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø°Ù…Ø©
async function confirmReturn() {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    const logId = document.getElementById('ret_logId').value;
    const itemId = document.getElementById('ret_itemId').value;
    const personName = document.getElementById('ret_personName').innerText;
    
    // Ø§Ù„ÙƒÙ…ÙŠØ§Øª
    const ex = parseInt(document.getElementById('ret_qtyEx').value) || 0;
    const gd = parseInt(document.getElementById('ret_qtyGood').value) || 0;
    const bk = parseInt(document.getElementById('ret_qtyBroken').value) || 0;
    const totalReturn = ex + gd + bk;

    const required = parseInt(document.getElementById('ret_totalQty').innerText);

    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¹Ø§Ø±Ø© Ù…Ø¹ Ø§Ù„Ù…Ø±Ø¬Ø¹Ø©
    if (totalReturn !== required) {
        alert("Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¯Ø®Ù„Ø© Ù„Ø§ ØªØ³Ø§ÙˆÙŠ Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±Ø©!");
        return;
    }

    const notes = document.getElementById('ret_notes').value;

    // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØµÙ†Ù Ø§Ù„Ø­Ø§Ù„ÙŠ
    const item = window.allWarehouseItems.find(i => i.id == itemId);

    // ğŸ›¡ï¸ (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) Ø­Ù…Ø§ÙŠØ© Ù„Ù…Ù†Ø¹ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ
    if ((item.available_quantity + totalReturn) > item.total_quantity) {
        alert(`â›” Ø®Ø·Ø£: Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹!\nÙ„Ø£Ù† Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø© (${item.available_quantity}) + Ø§Ù„Ù…Ø±ØªØ¬Ø¹Ø© (${totalReturn}) Ø³ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ Ù„Ù„ØµÙ†Ù (${item.total_quantity}).`);
        return;
    }

    // 1. ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø²ÙŠØ§Ø¯Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª)
    const { error: stockErr } = await supabaseClient
        .from('warehouse_inventory')
        .update({
            qty_excellent: (item.qty_excellent || 0) + ex,
            qty_good: (item.qty_good || 0) + gd,
            qty_broken: (item.qty_broken || 0) + bk,
            available_quantity: (item.available_quantity || 0) + totalReturn
        })
        .eq('id', itemId);

    if (stockErr) { alert("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: " + stockErr.message); return; }

    // 2. Ø¥ØºÙ„Ø§Ù‚ Ø³Ø¬Ù„ Ø§Ù„Ø¥Ø¹Ø§Ø±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ… (ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙ‚Ø·)
    await supabaseClient.from('warehouse_logs').update({ is_returned: true }).eq('id', logId);

    // 3. Ø¥Ø¶Ø§ÙØ© Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ ØªÙ…Ø§Ù…Ø§Ù‹ Ù„Ù„Ø£Ø±Ø´ÙŠÙ ÙŠÙˆØ«Ù‚ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ (Ø­Ø±ÙƒØ© Ø¯Ø®ÙˆÙ„)
    const { error: logErr } = await supabaseClient
        .from('warehouse_logs')
        .insert([{
            item_id: itemId,
            action_type: 'Ø¥Ø±Ø¬Ø§Ø¹', // ØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø­Ø±ÙƒØ© ÙƒØ¥Ø±Ø¬Ø§Ø¹
            person_name: personName,
            quantity: totalReturn,
            action_date: new Date().toISOString(), // ØªØ§Ø±ÙŠØ® Ø§Ù„Ù„Ø­Ø¸Ø©
            is_returned: true,
            notes: notes
        }]);

    if (!logErr) {
        alert("ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ ÙˆØ­Ø±ÙƒØ© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ù†Ø¬Ø§Ø­ âœ…");
        closeModal('modalReturnItem');
        loadWarehouseData();
    }
}
// Ø¯Ø§Ù„Ø© Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª ÙˆØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù„ÙƒÙŠ ØªØ¹Ù…Ù„ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹
async function loadLogsData() {
    const { data, error } = await supabaseClient
        .from('warehouse_logs')
        .select(`*, warehouse_inventory(item_name)`)
        .eq('is_returned', false); // Ù†Ø¬Ù„Ø¨ ÙÙ‚Ø· Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„ØªÙŠ Ù„Ù… ØªÙØ±Ø¬Ø¹ Ø¨Ø¹Ø¯

    if (!error) {
        window.allWarehouseLogs = data; // Ù‡Ù†Ø§ ÙŠØªÙ… ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø°ÙŠ Ø§Ø´ØªÙƒÙ‰ Ù…Ù†Ù‡ Ø§Ù„Ù…ØªØµÙØ­
    }
}
// ==========================================
// ğŸº Ø¯ÙˆØ§Ù„ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ© (Band Leader UI)
// ==========================================



// Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª (Ù…Ù‡Ù…Ø© Ø¬Ø¯Ø§Ù‹ Ù„Ø¹Ù…Ù„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
function switchBandTab(tabId, btnElement) {
    // 1. Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
    document.querySelectorAll('.band-tab-content').forEach(div => div.classList.add('hidden'));
    
    // 2. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
    const selectedTab = document.getElementById(tabId);
    if(selectedTab) {
        selectedTab.classList.remove('hidden');
    }

    // 3. ØªØ­Ø¯ÙŠØ« Ø³ØªØ§ÙŠÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    document.querySelectorAll('.band-tab-btn').forEach(btn => btn.classList.remove('active-band-tab'));
    if (btnElement) {
        btnElement.classList.add('active-band-tab');
    }

    // 4. âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
    if (tabId === 'tabRequests') {
        loadBandRequests(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø·Ù„Ø¨Ø§Øª
    } else if (tabId === 'tabMembers') {
        loadBandMembers(); // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ†
    } else if (tabId === 'tabInventory') {
        loadBandInventory(); // âœ… ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
    }
}

async function buildBandUI() {
    console.log("...Ø¬Ø§Ø±ÙŠ Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©"); 
    
    // 1. Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø­Ø§ÙˆÙŠØ©
    let container = document.getElementById('screenBand');
    
    // ğŸ” Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ (Auto-Fix Logic)
    if (!container) {
        console.log("Ø§Ù„Ø­Ø§ÙˆÙŠØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©ØŒ ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡Ø§ Ø§Ù„Ø¢Ù†...");
        container = document.createElement('div');
        container.id = 'screenBand';
        container.className = 'glass-panel hidden';
        container.style.maxWidth = '1200px';
        document.body.appendChild(container);
    } else {
        if (container.parentElement !== document.body) {
            console.log("ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ÙƒØ§Ù†ØŒ Ø¬Ø§Ø±ÙŠ Ù†Ù‚Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ù„Ù„Ù…ÙƒØ§Ù† Ø§Ù„ØµØ­ÙŠØ­...");
            document.body.appendChild(container);
        }
    }

    // 2. ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (HTML)
    // âœ… Ø¥ØµÙ„Ø§Ø­Ø§Øª: (1) Ø­Ø°Ù Ø§Ù„ØªÙƒØ±Ø§Ø± Ø¨Ø§Ù„Ù€ IDs  (2) Ø¥Ø²Ø§Ù„Ø© hidden ÙˆØ§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ù€ display:none Ù„ØªØ¹Ù…Ù„ Ù…Ø¹ switchBandTab
    container.innerHTML = `
        <div style="direction: rtl; padding: 20px;">
            <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 3px solid #d35400; padding-bottom: 15px; margin-bottom: 20px;">
                <div>
                    <h2 style="color: #d35400; margin: 0;">ğŸº Ù‚ÙŠØ§Ø¯Ø© Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©</h2>
                    <small style="color: #7f8c8d;">ÙÙˆØ¬ 77 Ø§Ù„Ø¨Ø­Ø±ÙŠ - Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙÙ†ÙŠØ©</small>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid #eee;">
                <button onclick="switchBandTab('tabRequests', this)" class="band-tab-btn active-band-tab" style="flex:1;">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨</button>
                <button onclick="switchBandTab('tabMembers', this);loadBandMembers();" class="band-tab-btn" style="flex:1;">ğŸ‘¥ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† ÙˆØ§Ù„Ø­Ø¶ÙˆØ±</button>
                <button onclick="switchBandTab('tabInventory', this); loadBandInventory();" class="band-tab-btn" style="flex:1;">ğŸ“¦ Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù†Ø­Ø§Ø³ÙŠ</button>
                <button onclick="switchBandTab('tabMusic', this); loadMusicLibrary();" class="band-tab-btn" style="flex:1;">ğŸ¼ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©</button>
            </div>

            <!-- âœ… ØªØ¨ÙˆÙŠØ¨Ø§Øª ÙØ¹Ù„ÙŠØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªÙƒØ±Ø§Ø± IDs) -->
            <div id="tabRequests" class="band-tab-content" style="display:block;">
                <h3 style="color: #2c3e50;">ğŸ“© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ Ø§Ù„ÙˆØ§Ø±Ø¯Ø©</h3>
                <div id="bandRequestsList" style="background: white; padding: 20px; border-radius: 10px; min-height: 200px; text-align: center; border: 1px solid #ddd;">
                    <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª... â³</p>
                </div>
            </div>

            <div id="tabMembers" class="band-tab-content" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #2c3e50;">ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ†</h3>
                    <button onclick="openBandAttendanceModal()" style="background: #27ae60; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">ğŸ“… Ø£Ø®Ø° Ø§Ù„ØªÙÙ‚Ø¯</button>
                </div>
                <div id="bandMembersTable" style="background: white; padding: 10px; border-radius: 10px; border: 1px solid #ddd;">
                    <p style="text-align: center; padding: 20px;">Ø§Ø¶ØºØ· "ğŸ‘¥ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† ÙˆØ§Ù„Ø­Ø¶ÙˆØ±" Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.</p>
                </div>
            </div>

            <div id="tabInventory" class="band-tab-content" style="display:none;">
                <h3 style="color: #2c3e50;">ğŸ“¦ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¢Ù„Ø§Øª ÙˆØ§Ù„Ù„Ø¨Ø§Ø³</h3>
                <div id="bandInventoryTable" style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; text-align:center;">
                    â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹...
                </div>
            </div>

            <div id="tabMusic" class="band-tab-content" style="display:none;">
                <h3 style="color: #2c3e50;">ğŸ¼ Ø§Ù„Ù†ÙˆØªØ§Øª ÙˆØ§Ù„Ù…Ø¹Ø²ÙˆÙØ§Øª</h3>
                <div style="background: white; padding: 20px; border-radius: 10px; border: 1px solid #ddd; text-align:center;">
                    â³ Ø¬Ø§Ø±ÙŠ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù…ÙƒØªØ¨Ø©...
                </div>
            </div>
        </div>
    `;

    // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø´Ø§Ø´Ø© (Ø¥Ø¬Ø¨Ø§Ø±)
    document.querySelectorAll('.glass-panel').forEach(el => el.classList.add('hidden'));
    container.classList.remove('hidden');
    container.style.display = 'block'; 
    
    console.log("ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠ Ø¨Ù†Ø¬Ø§Ø­ âœ…");

    // âœ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©
    loadBandRequests();

    // âœ… ØªØ¬Ù‡ÙŠØ² Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰ Ù…Ø³Ø¨Ù‚Ø§Ù‹ (Ù„ØªÙƒÙˆÙ† "Ø¬Ø§Ù‡Ø²Ø©" Ø¹Ù†Ø¯ Ø£ÙˆÙ„ ÙƒØ¨Ø³Ø©)
    try { if (typeof loadBandInventory === 'function') loadBandInventory(); } catch (e) { console.warn(e); }
    try { if (typeof loadMusicLibrary === 'function') loadMusicLibrary(); } catch (e) { console.warn(e); }
}


// ==========================================
// ğŸº Ù†Ø¸Ø§Ù… ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø·Ø±Ù Ø§Ù„Ø¹Ù†ØµØ±)
// ==========================================

// 1. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙ‚Ø¯ÙŠÙ…
function openBandJoinModal() {
    // Ù†ØªØ­Ù‚Ù‚ Ø£ÙˆÙ„Ø§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¹Ù†ØµØ± Ù‚Ø¯ Ù‚Ø¯Ù… Ø·Ù„Ø¨Ø§Ù‹ Ø³Ø§Ø¨Ù‚Ø§Ù‹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ ÙŠÙ…ÙƒÙ†Ù†Ø§ Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹)
    
    // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹
    let modal = document.getElementById('modalBandJoin');
    if(!modal) {
        modal = document.createElement('div');
        modal.id = 'modalBandJoin';
        modal.className = 'modal hidden';
        document.body.appendChild(modal);
    }

    modal.innerHTML = `
        <div class="glass-panel" style="max-width: 500px; margin: 5% auto; position: relative; animation: slideDown 0.4s;">
            <button onclick="closeBandJoinModal()" style="position: absolute; left: 15px; top: 15px; background: none; border: none; font-size: 1.5rem; color: #c0392b; cursor: pointer;">âœ–</button>
            
            <h2 style="color: #d35400; text-align: center;">ğŸº Ø·Ù„Ø¨ Ø§Ù†ØªØ³Ø§Ø¨ Ù„Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©</h2>
            <p style="text-align: center; color: #7f8c8d; font-size: 0.9rem;">"Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ù‡ÙŠ Ù„ØºØ© Ø§Ù„Ø±ÙˆØ­.. Ø§Ù†Ø¶Ù… Ø¥Ù„ÙŠÙ†Ø§ Ù„ØªÙƒÙˆÙ† Ø¬Ø²Ø¡Ø§Ù‹ Ù…Ù† Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹"</p>
            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="container">
                <label> Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (Ø§Ù„Ø¢Ù„Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©):</label>
                <select id="bandInst1">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø© --</option>
                    <option value="ØªØ±ÙˆÙ…Ø¨ÙŠØª">ØªØ±ÙˆÙ…Ø¨ÙŠØª </option>
                    <option value="Ø³Ø­Ø§Ø¨">Ø³Ø­Ø§Ø¨ </option>
                    <option value="Ø¨Ø§Ø±ÙŠØªÙˆÙ†">Ø¨Ø§Ø±ÙŠØªÙˆÙ† </option>
                    <option value="Ø¨Ø³ØªÙˆÙ†">Ø¨Ø³ØªÙˆÙ† </option>
                    <option value="Ø·Ø¨Ù„ ">Ø·Ø¨Ù„  </option>
                    <option value="Ø¨ØªÙƒÙŠØ³ ">Ø¨ØªÙƒÙŠØ³  </option>
                    <option value="Ù…Ø«Ù„Ø«">Ù…Ø«Ù„Ø« </option>
                    <option value="Ø£Ø®Ø±Ù‰">Ø¢Ù„Ø© Ø£Ø®Ø±Ù‰..</option>
                </select>

                <label> Ø§Ù„Ø±ØºØ¨Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ© (Ø§Ù„Ø¨Ø¯ÙŠÙ„):</label>
                <select id="bandInst2">
                    <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø§Ù„Ø¢Ù„Ø© --</option>
                   <option value="ØªØ±ÙˆÙ…Ø¨ÙŠØª">ØªØ±ÙˆÙ…Ø¨ÙŠØª </option>
                    <option value="Ø³Ø­Ø§Ø¨">Ø³Ø­Ø§Ø¨ </option>
                    <option value="Ø¨Ø§Ø±ÙŠØªÙˆÙ†">Ø¨Ø§Ø±ÙŠØªÙˆÙ† </option>
                    <option value="Ø¨Ø³ØªÙˆÙ†">Ø¨Ø³ØªÙˆÙ† </option>
                    <option value="Ø·Ø¨Ù„ ">Ø·Ø¨Ù„  </option>
                    <option value="Ø¨ØªÙƒÙŠØ³ ">Ø¨ØªÙƒÙŠØ³  </option>
                    <option value="Ù…Ø«Ù„Ø«">Ù…Ø«Ù„Ø« </option>
                   
                </select>

                <label>ğŸ¼ Ø§Ù„Ø®Ø¨Ø±Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©:</label>
                <select id="bandMusicLevel">
                    <option value="Ù…Ø¨ØªØ¯Ø¦">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø®Ø¨Ø±Ø© (Ø£Ø±ØºØ¨ Ø¨Ø§Ù„ØªØ¹Ù„Ù…)</option>
                    <option value="Ø³Ù…Ø§Ø¹ÙŠ">Ø¹Ø²Ù Ø³Ù…Ø§Ø¹ÙŠ (Ø¨Ø¯ÙˆÙ† Ù†ÙˆØªØ©)</option>
                    <option value="Ù†ÙˆØªØ©">Ø£Ø¬ÙŠØ¯ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù†ÙˆØªØ©</option>
                </select>

                <div style="background: #fff3e0; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #ffcc80;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: #e65100;">
                        <input type="checkbox" id="bandCommitCheck" style="width: 20px; height: 20px;">
                        Ø£ØªØ¹Ù‡Ø¯ Ø¨Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª ÙˆØ§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø¢Ù„Ø©.
                    </label>
                </div>

                <button onclick="submitBandRequest()" style="background: #d35400; margin-top: 20px;">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
            </div>
        </div>
    `;

    modal.classList.remove('hidden');
}

function closeBandJoinModal() {
    const modal = document.getElementById('modalBandJoin');
    if(modal) modal.classList.add('hidden');
}

// 2. Ø¯Ø§Ù„Ø© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function submitBandRequest() {
    const choice1 = document.getElementById('bandInst1').value;
    const choice2 = document.getElementById('bandInst2').value;
    const level = document.getElementById('bandMusicLevel').value;
    const isCommitted = document.getElementById('bandCommitCheck').checked;

    // ØªØ­Ù‚Ù‚Ø§Øª Ø£Ø³Ø§Ø³ÙŠØ©
    if(!choice1 || !choice2 || !level) {
        alert("âš ï¸ ÙŠØ±Ø¬Ù‰ ØªØ¹Ø¨Ø¦Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©!");
        return;
    }
    if(!isCommitted) {
        alert("âœ‹ ÙŠØ¬Ø¨ Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ¹Ù‡Ø¯ Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„.");
        return;
    }

    // âœ… ØªØ£ÙƒØ¯ ÙÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ (currentUser Ù…Ù† Ø¹Ù†Ø¯Ùƒ) + Ù…Ø³ØªØ®Ø¯Ù… Auth (Supabase)
    if (!window.currentUser?.email) {
        alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }

    const authUser = await getCurrentAuthUser(); // Ù„Ø§Ø²Ù… ØªÙƒÙˆÙ† Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ
    if (!authUser?.id) {
        alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
        return;
    }

    // --- ğŸ› ï¸ Ù‡ÙˆÙ† Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„Ø¥ØµÙ„Ø§Ø­ Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø§Ø³Ù… ---
    // âœ… Ø«Ø¨Ù‘Øª Ø§Ù„Ù…ØµØ¯Ø±: Ø®Ù„ÙŠ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„ Ù…Ù† window.currentUser (Ù…Ùˆ currentUser Ø¨Ø¯ÙˆÙ† window)
    const userEmail = window.currentUser.email;

    const regs = loadRegistrations(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ©
    const userProfile = regs.find(r => r.email === userEmail);

    // Ù…Ù†Ø·Ù‚ Ø°ÙƒÙŠ Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù…
    let userName = "Ø¹Ø¶Ùˆ ÙƒØ´ÙÙŠ"; // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©

    if (userProfile) {
        if (userProfile.name) {
            userName = userProfile.name; // Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø«Ø§Ù„ÙŠØ©
        } else if (userProfile.fullName) {
            userName = userProfile.fullName; // ÙÙŠ Ø­Ø§Ù„ ÙƒØ§Ù† Ø§Ù„Ø­Ù‚Ù„ Ø§Ø³Ù…Ù‡ fullName
        } else {
            userName = userEmail.split('@')[0];
        }
    } else {
        userName = userEmail.split('@')[0];
    }

    // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙØ±Ù‚Ø© (Ø¥Ù† ÙˆØ¬Ø¯Øª)
    const userUnit = (userProfile && userProfile.unit) ? userProfile.unit : "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";

    // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ: ØªØ®Ø²ÙŠÙ† user_id ÙÙ‚Ø·)
    // âŒ Ù„Ø§ ØªÙƒØªØ¨ user_email Ø¥Ø°Ø§ Ø¹Ù…ÙˆØ¯ user_email Ù…Ùˆ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø¯ÙˆÙ„ band_join_requests
    const { data, error } = await supabaseClient
        .from('band_join_requests')
        .insert([
            {
                user_id: authUser.id,   // âœ… Ø£Ø³Ø§Ø³ÙŠ
                user_name: userName,    // âœ… Ù…Ø§ Ø¹Ø§Ø¯ ÙŠØµÙŠØ± null
                current_unit: userUnit,
                choice_1: choice1,
                choice_2: choice2,
                music_level: level,
                status: 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±'
            }
        ]);

    if(error) {
        console.error("Error:", error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
    } else {
        alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!");
        closeBandJoinModal();
    }
}

// ==========================================
// ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ÙˆÙ…Ø¹Ø§Ù„Ø¬Ø© Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ (Ø·Ø±Ù Ø§Ù„Ù‚Ø§Ø¦Ø¯)
// ==========================================

// 1. Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª ÙˆØ¹Ø±Ø¶Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„
// ==========================================
// ğŸ“¥ Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ù…Ø¹ Ø®ÙŠØ§Ø±ÙŠÙ† Ù„Ù„Ù‚Ø¨ÙˆÙ„)
// ==========================================

async function loadBandRequests() {
    const container = document.getElementById('bandRequestsList');
    
    const { data, error } = await supabaseClient
        .from('band_join_requests')
        .select('*')
        .eq('status', 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±')
        .order('created_at', { ascending: false });

    if (error) { container.innerHTML = `<p style="color:red">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£</p>`; return; }
    if (!data || data.length === 0) {
        container.innerHTML = `<div style="padding: 40px; opacity: 0.7;"><p style="font-size: 3rem; margin: 0;">ğŸ“­</p><p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©</p></div>`;
        return;
    }

    let html = `
        <table style="width:100%; text-align:right; border-collapse: separate; border-spacing: 0 10px;">
            <thead><tr style="color:#7f8c8d;"><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø¢Ù„Ø©</th><th>Ø§Ù„Ø®Ø¨Ø±Ø©</th><th style="text-align:center;">Ø§Ù„Ù‚Ø±Ø§Ø±</th></tr></thead>
            <tbody>
    `;

    data.forEach(req => {
        html += `
            <tr style="background: #f8f9fa; box-shadow: 0 2px 5px rgba(0,0,0,0.05);">
                <td style="padding: 15px; font-weight:bold;">${req.user_name}</td>
                <td><span style="background:#e3f2fd; color:#1565c0; padding:3px 10px; border-radius:15px;">${req.choice_1}</span></td>
                <td>${req.music_level}</td>
                <td style="text-align:center; display:flex; gap:5px; justify-content:center; padding:10px;">
                    <button onclick="respondToRequest(${req.id}, '${req.user_name}', '${req.choice_1}', 'Ø£Ø³Ø§Ø³ÙŠØ©')" style="background:#d35400; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;">ğŸ¥‡ Ù†Ø­Ø§Ø³ÙŠØ©</button>
                    <button onclick="respondToRequest(${req.id}, '${req.user_name}', '${req.choice_1}', 'Ø±Ø¯ÙŠÙØ©')" style="background:#f39c12; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;">ğŸ¥ˆ Ø±Ø¯ÙŠÙØ©</button>
                    <button onclick="respondToRequest(${req.id}, '${req.user_name}', null, 'rejected')" style="background:#c0392b; color:white; border:none; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.8rem;">âŒ Ø±ÙØ¶</button>
                </td>
            </tr>`;
    });
    html += `</tbody></table>`;
    container.innerHTML = html;
}

// Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ù‚Ø±Ø§Ø± (Ø§Ù„Ù…Ø·ÙˆØ±Ø©)
async function respondToRequest(requestId, userName, instrument, action) {
    if (!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡ØŸ`)) return;

    // 0) Ø¬Ù„Ø¨ user_id Ù…Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‚Ø¨Ù„ Ø£ÙŠ Ø´ÙŠ (Ù„Ø±Ø¨Ø· Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø­Ø³Ø§Ø¨ Supabase Auth)
    const { data: reqRow, error: reqErr } = await supabaseClient
      .from('band_join_requests')
      .select('id, user_id')
      .eq('id', requestId)
      .maybeSingle();

    if (reqErr) {
        alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ (user_id): " + reqErr.message);
        loadBandRequests();
        return;
    }

    // 1) ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨
    const status = action === 'rejected' ? 'Ù…Ø±ÙÙˆØ¶' : 'Ù…Ù‚Ø¨ÙˆÙ„';
    const { error: updErr } = await supabaseClient
      .from('band_join_requests')
      .update({ status: status })
      .eq('id', requestId);

    if (updErr) {
        alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø·Ù„Ø¨: " + updErr.message);
        loadBandRequests();
        return;
    }

    // 2) Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‚Ø¨ÙˆÙ„)
    if (action !== 'rejected') {

        // âœ… Ø­Ù…Ø§ÙŠØ©: Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ user_id Ø¨Ø§Ù„Ø·Ù„Ø¨ØŒ Ù…Ø§ Ù…Ù†Ù‚Ø¯Ø± Ù†Ø«Ø¨Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© ØµØ­
        if (!reqRow?.user_id) {
            alert("âŒ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø§ ÙÙŠÙ‡ user_id. Ù„Ø§Ø²Ù… ØªØ®Ø²Ù‘Ù†Ù‡ ÙˆÙ‚Øª Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø­ØªÙ‰ Ù†Ø±Ø¨Ø· Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨.");
            loadBandRequests();
            return;
        }

        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ø± ÙˆØ§Ù„Ø¬Ù†Ø³ ÙˆØ§Ù„Ø±ØªØ¨Ø© Ù…Ù† Ø³Ø¬Ù„Ø§Øª Ø§Ù„ÙÙˆØ¬
        const regs = await loadRegistrations();
        const uname = (userName || '').trim();

        const profile = (regs || []).find(r => {
            const n1 = (r.name || '').trim();
            const n2 = (r.fullName || '').trim();
            return n1 === uname || n2 === uname;
        });

        // Ù‚ÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠØ© ÙÙŠ Ø­Ø§Ù„ Ø¹Ø¯Ù… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„ÙŠÙ‡Ø§
        let uGender = profile?.gender || 'Ø°ÙƒØ±';

        let uAge = 18;
        if (profile?.birthDate) {
            const bd = new Date(profile.birthDate);
            if (!isNaN(bd.getTime())) {
                uAge = new Date().getFullYear() - bd.getFullYear();
            }
        }

        // âœ… Ø§Ù„Ø±ØªØ¨Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ registrations (Ù…Ø«Ù„ Ù…Ø§ Ø¨Ø¯Ùƒ)
        const uRank = (profile?.rank || 'Ø¹Ù†ØµØ±');

        // âœ… (Ø¥ØµÙ„Ø§Ø­ Ø­Ù‚ÙŠÙ‚ÙŠ) Ø¨Ø¯Ù„ upsert: Ø§Ø¹Ù…Ù„ "Ø§Ø¨Ø­Ø« Ø«Ù… Ø­Ø¯Ù‘Ø« Ø£Ùˆ Ø£Ø¯Ø±Ø¬"
        // Ù„Ø£Ù† upsert ÙŠØªØ·Ù„Ø¨ UNIQUE Ø¹Ù„Ù‰ user_id ÙˆØ§Ù†Øª Ù…Ø§ Ø¹Ù†Ø¯Ùƒ
        const { data: existing, error: findErr } = await supabaseClient
          .from('band_members')
          .select('id, user_id, joined_at')
          .eq('user_id', reqRow.user_id)
          .maybeSingle();

        if (findErr) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ø£ÙƒØ«Ø± Ù…Ù† Ø³Ø¬Ù„ Ø¨Ù†ÙØ³ user_id Ù…Ù…ÙƒÙ† maybeSingle ÙŠØ¹Ø·ÙŠ Ø®Ø·Ø£
            alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ø¶Ùˆ Ù…Ø³Ø¨Ù‚Ø§Ù‹: " + findErr.message);
            loadBandRequests();
            return;
        }

        const payload = {
            user_id: reqRow.user_id,              // âœ… Ø§Ù„Ø±Ø¨Ø· Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
            name: userName,
            main_instrument: instrument,
            rank: uRank,
            band_category: action,                // Ø£Ø³Ø§Ø³ÙŠØ© Ø£Ùˆ Ø±Ø¯ÙŠÙØ©
            gender: uGender,
            age: uAge
        };

        // joined_at: Ø¥Ø°Ø§ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¯Ùƒ ØªØ­Ø§ÙØ¸ Ø¹Ù„ÙŠÙ‡
        // Ø¥Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ Ø¬Ø¯ÙŠØ¯: Ù†Ø­Ø·Ù‡ Ø§Ù„Ø¢Ù†
        // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯: Ù…Ø§ Ù†ØºÙŠØ±Ù‡ (Ù†Ø®Ù„ÙŠÙ‡ Ù…Ø«Ù„ Ù…Ø§ Ù‡Ùˆ)
        if (!existing?.id) {
            payload.joined_at = new Date().toISOString();
        }

        let saveErr = null;

        if (existing?.id) {
            // ØªØ­Ø¯ÙŠØ«
            const { error: updateErr } = await supabaseClient
              .from('band_members')
              .update(payload)
              .eq('id', existing.id);

            saveErr = updateErr || null;
        } else {
            // Ø¥Ø¯Ø±Ø§Ø¬ Ø¬Ø¯ÙŠØ¯
            const { error: insertErr } = await supabaseClient
              .from('band_members')
              .insert([payload]);

            saveErr = insertErr || null;
        }

        if (!saveErr) alert(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ù„ÙØ±Ù‚Ø©: ${action}`);
        else alert("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ: " + saveErr.message);

    } else {
        alert("ØªÙ… Ø±ÙØ¶ Ø§Ù„Ø·Ù„Ø¨");
    }

    loadBandRequests(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
}



// ==========================================
// ğŸ‘¥ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† (Ø¹Ø±Ø¶ ÙˆØ­Ø°Ù)
// ==========================================

// ==========================================
// ğŸ‘¥ Ø¹Ø±Ø¶ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† (Ù…Ø¹ ÙÙ„Ø§ØªØ± ÙˆØ¬Ø¯ÙˆÙ„ÙŠÙ†)
// ==========================================

// Ù…ØªØºÙŠØ±Ø§Øª Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªÙ…ÙƒÙŠÙ† Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„ÙÙˆØ±ÙŠØ©
let allBandMembersData = [];
let allAttendanceData = [];

async function loadBandMembers() {
    // âœ… Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¨Ø³ Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„ÙƒÙˆÙ†ØªÙŠÙ†Ø± ÙŠÙ„ÙŠ Ø¨ÙŠØ±Ø³Ù… ÙÙŠÙ‡ renderBandTables
    const container = document.getElementById('tabMembers');
    if (!container) {
        console.warn("loadBandMembers: #tabMembers not found");
        return;
    }

    container.innerHTML = `<p style="text-align:center;">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø­ØªØ³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨... â³</p>`;

    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ†
    const { data: members, error: errMembers } = await supabaseClient
        .from('band_members')
        .select('*')
        .order('name', { ascending: true });

    // 2. Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ (ÙƒÙ…Ø§ ÙÙŠ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    const { data: attendance, error: errAtt } = await supabaseClient
        .from('band_attendance')
        .select('*');

    if (errMembers || errAtt) {
        console.error("loadBandMembers errors:", errMembers, errAtt);
        container.innerHTML = `<p style="color:red; text-align:center;">âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>`;
        return;
    }

    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    allBandMembersData = members || [];
    allAttendanceData = attendance || [];

    // âœ… ØªØ´Ø®ÙŠØµ Ø³Ø±ÙŠØ¹ (Ù…Ø§ Ø¨ÙŠØ£Ø«Ø± Ø¹Ù„Ù‰ UI)
    console.log("band_members:", allBandMembersData.length, "band_attendance:", allAttendanceData.length);

    // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù…
    renderBandTables();
}


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… ÙˆØ§Ù„ÙÙ„ØªØ±Ø© (ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ ÙƒÙˆØ¯Ùƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
function renderBandTables() {
    const container = document.getElementById('bandMembersTable');

    // 1. Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ÙÙ„Ø§ØªØ±
    const rawFilterName = document.getElementById('filterName')?.value || '';
    const filterName = rawFilterName.toLowerCase();
    const filterInst = document.getElementById('filterInst')?.value || '';
    const filterGender = document.getElementById('filterGender')?.value || '';
    const filterAge = document.getElementById('filterAge')?.value || '';

    // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ±Ø©
    const filteredMembers = allBandMembersData.filter(m => {
        const memberName = (m.name || '').toLowerCase();
        const matchName = memberName.includes(filterName);
        const matchInst = filterInst === '' || m.main_instrument === filterInst;
        const matchGender = filterGender === '' || m.gender === filterGender;
        const matchAge = filterAge === '' || m.age == filterAge;
        return matchName && matchInst && matchGender && matchAge;
    });

    // 3. ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… (trim + ØºÙŠØ± Ø§Ù„Ù…ØµÙ†Ù‘ÙÙŠÙ† Ø¶Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©)
    const mainBand = filteredMembers.filter(m => {
        const cat = (m.band_category || '').trim();
        return cat === '' || cat === 'Ø£Ø³Ø§Ø³ÙŠØ©';
    });
    const reserveBand = filteredMembers.filter(m => (m.band_category || '').trim() === 'Ø±Ø¯ÙŠÙØ©');

    // 4. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ§Øª
    const totalTrainings = new Set(allAttendanceData.filter(r => r.activity_type === 'ØªØ¯Ø±ÙŠØ¨').map(r => r.attendance_date)).size;
    const totalShows = new Set(allAttendanceData.filter(r => r.activity_type === 'Ø¹Ø±Ø¶').map(r => r.attendance_date)).size;

    // 5. Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙÙ„Ø§ØªØ± ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    let html = `
        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 20px;">
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="text" id="filterName" placeholder="ğŸ” Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…..." onkeyup="renderBandTables()" value="${rawFilterName}" style="flex:2; padding:8px; border:1px solid #ccc; border-radius:5px;">
                
                <select id="filterInst" onchange="renderBandTables()" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:5px;">
                    <option value="">ğŸ¹ ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª</option>
                    <option value="ØªØ±ÙˆÙ…Ø¨ÙŠØª" ${filterInst=='ØªØ±ÙˆÙ…Ø¨ÙŠØª'?'selected':''}>ØªØ±ÙˆÙ…Ø¨ÙŠØª</option>
                    <option value="Ø³Ø­Ø§Ø¨" ${filterInst=='Ø³Ø­Ø§Ø¨'?'selected':''}>Ø³Ø­Ø§Ø¨</option>
                    <option value="Ø¨Ø±ÙŠØªÙˆÙ†" ${filterInst=='Ø¨Ø±ÙŠØªÙˆÙ†'?'selected':''}>Ø¨Ø±ÙŠØªÙˆÙ†</option>
                    <option value="Ø¨Ø³ØªÙˆÙ†" ${filterInst=='Ø¨Ø³ØªÙˆÙ†'?'selected':''}>Ø¨Ø³ØªÙˆÙ†</option>
                    <option value="Ø¨ØªÙƒÙŠØ³" ${filterInst=='Ø¨ØªÙƒÙŠØ³'?'selected':''}>Ø¨ØªÙƒÙŠØ³</option>
                    <option value="Ø·Ø¨Ù„" ${filterInst=='Ø·Ø¨Ù„'?'selected':''}>Ø·Ø¨Ù„</option>
                    <option value="Ù…Ø«Ù„Ø«" ${filterInst=='Ù…Ø«Ù„Ø«'?'selected':''}>Ù…Ø«Ù„Ø«</option>
                </select>

                <select id="filterGender" onchange="renderBandTables()" style="flex:1; padding:8px; border:1px solid #ccc; border-radius:5px;">
                    <option value="">Ø§Ù„Ø¬Ù†Ø³</option>
                    <option value="Ø°ÙƒØ±" ${filterGender=='Ø°ÙƒØ±'?'selected':''}>Ø°ÙƒØ±</option>
                    <option value="Ø£Ù†Ø«Ù‰" ${filterGender=='Ø£Ù†Ø«Ù‰'?'selected':''}>Ø£Ù†Ø«Ù‰</option>
                </select>

                <input type="number" id="filterAge" placeholder="Ø§Ù„Ø¹Ù…Ø±" onchange="renderBandTables()" value="${filterAge}" style="flex:0.5; min-width:60px; padding:8px; border:1px solid #ccc; border-radius:5px;">
            </div>
        </div>

        <div style="margin-bottom: 15px; display: flex; gap: 15px; font-size: 0.9rem; color: #555; background: #fff3e0; padding: 10px; border-radius: 8px;">
            <span>ğŸ» Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØªØ¯Ø±ÙŠØ¨Ø§Øª: <b>${totalTrainings}</b></span>
            <span>ğŸº Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø±ÙˆØ¶: <b>${totalShows}</b></span>
        </div>
    `;

    // 6. Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ÙŠÙ† (Ø§Ù„Ø±Ø¯ÙŠÙØ© Ø¯Ø§Ø¦Ù…Ø§Ù‹)
    html += `<h3 style="color:#d35400; border-bottom:2px solid #d35400; display:inline-block;">ğŸ¥‡ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (${mainBand.length})</h3>`;
    html += generateHTMLTable(mainBand, totalTrainings, totalShows);

    html += `<br><h3 style="color:#7f8c8d; border-bottom:2px solid #7f8c8d; display:inline-block; margin-top:30px;">ğŸ¥ˆ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø±Ø¯ÙŠÙØ© (${reserveBand.length})</h3>`;
    html += generateHTMLTable(reserveBand, totalTrainings, totalShows);

    container.innerHTML = html;
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² Ø¹Ù„Ù‰ Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¨Ø­Ø«
    const inputField = document.getElementById('filterName');
    if(inputField) {
        inputField.focus();
        const val = inputField.value; inputField.value = ''; inputField.value = val;
    }
}

// ==========================================
// ğŸ“… Ù†Ø¸Ø§Ù… Ø§Ù„ØªÙÙ‚Ø¯ (Attendance)
// ==========================================

let currentAttendanceList = []; // Ù„ØªØ®Ø²ÙŠÙ† Ø­Ø§Ù„Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¤Ù‚ØªØ§Ù‹


function calcAttendancePercent(present, absent, excused) {
  const denom = present + absent; // âœ… Ø¨Ø¹Ø°Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù‚Ø§Ù…
  if (denom <= 0) return 0;
  const pct = (present / denom) * 100;
  return Math.max(0, Math.min(100, Math.round(pct))); // âœ… 0..100
}

function aggregateAttendance(rows) {
  let present = 0, absent = 0, excused = 0;

  rows.forEach(r => {
    if (r.status === "Ø­Ø¶ÙˆØ±") present++;
    else if (r.status === "ØºÙŠØ§Ø¨") absent++;
    else if (r.status === "Ø¨Ø¹Ø°Ø±") excused++;
  });

  const denom = present + absent;     // âœ… Ù‡Ø°Ø§ Ù‡Ùˆ â€œØ§Ù„Ù…Ù‚Ø§Ù…â€ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
  const percent = calcAttendancePercent(present, absent, excused);

  // âœ… counted Ù‡Ùˆ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù„ÙŠ Ù„Ø§Ø²Ù… ÙŠØ·Ù„Ø¹ Ø¨ÙŠÙ† Ø§Ù„Ù‚ÙˆØ³ÙŠÙ†
  return { present, absent, excused, denom, counted: denom, percent };
}

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙÙ‚Ø¯
// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙÙ‚Ø¯ (Ù†Ø³Ø®Ø© Ù…Ø·ÙˆØ±Ø© Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ÙˆØ¹)
async function openBandAttendanceModal() {
    // Ø¬Ù„Ø¨ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ†
    const { data: members, error } = await supabaseClient
        .from('band_members')
        .select('name, band_category')
        .order('name', { ascending: true });

    if(error || !members) {
        alert("âŒ ÙØ´Ù„ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ†.");
        return;
    }

    // âœ… ØªÙ‚Ø³ÙŠÙ… Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ (Ø£Ø³Ø§Ø³ÙŠØ©/Ø±Ø¯ÙŠÙØ©) Ù…Ø¹ fallback
    const mainMembers = (members || []).filter(m => (m.band_category || '').trim() === 'Ø£Ø³Ø§Ø³ÙŠØ©');
    const reserveMembers = (members || []).filter(m => (m.band_category || '').trim() === 'Ø±Ø¯ÙŠÙØ©');
    const otherMembers = (members || []).filter(m => {
        const c = (m.band_category || '').trim();
        return c !== 'Ø£Ø³Ø§Ø³ÙŠØ©' && c !== 'Ø±Ø¯ÙŠÙØ©';
    });

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ù…ØªØºÙŠØ±)
    // âœ… Ø¶ÙÙ†Ø§ band_category ÙÙ‚Ø· Ø­ØªÙ‰ Ù†Ø¹Ø±Ù Ù†Ø¹Ø±Ø¶ Ø¶Ù…Ù† Ø£ÙŠ Ù‚Ø³Ù… (Ù…Ø§ ØºÙŠÙ‘Ø±Ù†Ø§ Ø§Ù„Ø­ÙØ¸)
    currentAttendanceList = (members || []).map(m => ({
        name: m.name,
        status: 'Ø­Ø¶ÙˆØ±',
        note: '',
        band_category: (m.band_category || '').trim()
    }));

    let modal = document.getElementById('modalBandAttendance');
    if(!modal) {
        modal = document.createElement('div');
        modal.id = 'modalBandAttendance';
        modal.className = 'modal hidden';
        document.body.appendChild(modal);
    }

    // âœ…âœ… Ø£Ù‡Ù… ØªØ¹Ø¯ÙŠÙ„: Ø®Ù„ÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Overlay Ø«Ø§Ø¨Øª ÙÙˆÙ‚ Ø§Ù„ØµÙØ­Ø© (Ù…Ùˆ ÙŠÙ†Ø­Ø· ØªØ­Øª)
    // (Ù…Ø§ Ø´Ù„Ù†Ø§ class modal ÙˆÙ„Ø§ hiddenØŒ Ø¨Ø³ Ø¶ÙÙ†Ø§ Ø³ØªØ§ÙŠÙ„ overlay Ù„Ù„Ù…ÙˆØ¯Ø§Ù„ Ù†ÙØ³Ù‡)
    modal.style.position = 'fixed';
    modal.style.inset = '0';
    modal.style.background = 'rgba(0,0,0,0.55)';
    modal.style.backdropFilter = 'blur(4px)';
    modal.style.webkitBackdropFilter = 'blur(4px)';
    modal.style.zIndex = '99999';
    modal.style.padding = '20px';
    modal.style.alignItems = 'center';
    modal.style.justifyContent = 'center';
    modal.style.overflow = 'auto';
    modal.style.display = 'none'; // Ø±Ø­ Ù†Ø®Ù„ÙŠÙ‡ flex ÙˆÙ‚Øª Ø§Ù„ÙØªØ­

    // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù‡Ù†Ø§: ØªÙÙ‚Ø¯ ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ† ÙÙŠÙ‡ ØªÙ‚Ø³ÙŠÙ… ÙˆØ§Ø¶Ø­ (Ø£Ø³Ø§Ø³ÙŠØ©/Ø±Ø¯ÙŠÙØ©)
    const today = new Date().toISOString().split('T')[0];

    // Ø¯Ø§Ù„Ø© Ø¯Ø§Ø®Ù„ÙŠØ© Ù„Ø¨Ù†Ø§Ø¡ ØµÙÙˆÙ Ø¬Ø¯ÙˆÙ„ Ù„Ù‚Ø³Ù… Ù…Ø¹ÙŠÙ‘Ù† Ù…Ø¹ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ index Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    function buildRowsFor(categoryLabel, list, headerColor, headerIcon) {
        if (!list || list.length === 0) {
            return `
                <tr>
                  <td colspan="3" style="padding:12px; color:#888; text-align:center; background:#fafafa;">
                    Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¶Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø­Ø§Ù„ÙŠØ§Ù‹
                  </td>
                </tr>
            `;
        }

        return list.map(m => {
            const idx = currentAttendanceList.findIndex(x => x.name === m.name);
            const row = currentAttendanceList[idx];
            // Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ "Ø­Ø¶ÙˆØ±" active
            return `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 10px; font-weight: bold;">${row.name}</td>
                    <td style="padding: 10px; text-align: center;">
                        <div style="display: flex; gap: 5px; justify-content: center;">
                            <button onclick="setAttStatus(${idx}, 'Ø­Ø¶ÙˆØ±', this)" class="btn-att btn-att-present active">âœ…</button>
                            <button onclick="setAttStatus(${idx}, 'ØºÙŠØ§Ø¨', this)" class="btn-att btn-att-absent">âŒ</button>
                            <button onclick="setAttStatus(${idx}, 'Ø¨Ø¹Ø°Ø±', this)" class="btn-att btn-att-excused">âš ï¸</button>
                        </div>
                    </td>
                    <td style="padding: 10px;">
                        <input type="text" placeholder="..." onchange="currentAttendanceList[${idx}].note = this.value"
                               style="width: 160px; max-width:100%; padding: 8px; border: 1px solid #ddd; border-radius: 8px;">
                    </td>
                </tr>
            `;
        }).join('');
    }

    modal.innerHTML = `
  <div class="glass-panel" style="
      width: 900px;
      max-width: 98%;
      position: relative;
      max-height: 90vh;
      overflow: auto;
      margin: 0 auto;
      border-radius: 18px;
  ">

   <div style="
  position: sticky;
  top: 0;
  background: #fff;
  z-index: 5;
  padding: 12px 16px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: center;
  justify-content: center;
  position: sticky;
">
  <button
  onclick="(function(){
    const m=document.getElementById('modalBandAttendance');
    if(m){ m.classList.add('hidden'); m.style.display='none'; }
  })()"
  aria-label="Ø¥ØºÙ„Ø§Ù‚"
  style="
    position:absolute;
    left:14px;
    top:50%;
    transform:translateY(-50%);
    width:40px;
    height:40px;
    border-radius:12px;
    background:#fff;
    border:1px solid #e5e7eb;
    box-shadow:0 6px 18px rgba(0,0,0,.12);
    display:flex;
    align-items:center;
    justify-content:center;
    cursor:pointer;
    color:#c0392b;
    font-size:22px;
    line-height:1;
    transition:.15s;
  "
  onmouseenter="this.style.transform='translateY(-50%) scale(1.06)'; this.style.boxShadow='0 10px 24px rgba(0,0,0,.16)'"
  onmouseleave="this.style.transform='translateY(-50%) scale(1)'; this.style.boxShadow='0 6px 18px rgba(0,0,0,.12)'"
>âœ–</button>


  <h2 style="margin:0; color:#2c3e50; font-weight:900; text-align:center;">
    ğŸ“… Ø³Ø¬Ù„ ØªÙÙ‚Ø¯ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©
  </h2>
</div>


    <!-- Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ù‡ÙˆÙ† ÙƒÙ…Ø§ Ù‡Ùˆ ... -->






            <div class="container" style="margin-bottom: 16px; display: flex; gap: 10px; flex-wrap:wrap;">
                <div style="flex: 1; min-width:220px;">
                    <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø§Ø·:</label>
                    <input type="date" id="attDate" value="${today}">
                </div>

                <div style="flex: 1; min-width:220px;">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·:</label>
                    <select id="attType" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Cairo';">
                        <option value="ØªØ¯Ø±ÙŠØ¨">ğŸ» ØªØ¯Ø±ÙŠØ¨ Ø¹Ø§Ø¯ÙŠ</option>
                        <option value="Ø¹Ø±Ø¶">ğŸº Ø¹Ø±Ø¶ / Ù†Ø´Ø§Ø· Ø±Ø³Ù…ÙŠ</option>
                    </select>
                </div>

                <!-- âœ…âœ… Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (Ø§Ù„Ø¹Ø§Ù…ÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯) -->
                <div style="flex: 1; min-width:220px;">
                    <label>Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©:</label>
                    <select id="attTargetBand" onchange="applyAttTarget()" style="width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 10px; font-family: 'Cairo';">
                        <option value="Ø§Ù„Ø§Ø«Ù†ÙŠÙ†">ğŸ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© + Ø§Ù„Ø±Ø¯ÙŠÙØ©</option>
                        <option value="Ø£Ø³Ø§Ø³ÙŠØ©">ğŸ¥‡ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙÙ‚Ø·</option>
                        <option value="Ø±Ø¯ÙŠÙØ©">ğŸ¥ˆ Ø§Ù„Ø±Ø¯ÙŠÙØ© ÙÙ‚Ø·</option>
                    </select>
                </div>
            </div>

            <!-- âœ… ØªÙ‚Ø³ÙŠÙ… ÙˆØ§Ø¶Ø­ Ø¯Ø§Ø®Ù„ Ù†ÙØ³ Ø§Ù„ØªÙÙ‚Ø¯ -->
            <div style="display:grid; grid-template-columns:1fr; gap:14px;">
                
                <!-- Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© -->
                <div id="attSectionMain" style="background:#fff; border:1px solid #eee; border-radius:14px; overflow:hidden;">
                    <div style="padding:12px 14px; background:#fff3e0; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:900; color:#d35400;">ğŸ¥‡ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>
                        <div style="color:#555; font-weight:700; font-size:.9rem;">Ø¹Ø¯Ø¯: ${mainMembers.length}</div>
                    </div>
                    <div style="overflow:auto;">
                        <table style="width:100%; text-align: right; border-collapse: collapse;">
                            <thead style="background: #fff8ef;">
                                <tr>
                                    <th style="padding: 10px;">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th style="padding: 10px; text-align: center;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th style="padding: 10px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildRowsFor('Ø£Ø³Ø§Ø³ÙŠØ©', mainMembers, '#fff3e0', 'ğŸ¥‡')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Ø§Ù„Ø±Ø¯ÙŠÙØ© -->
                <div id="attSectionReserve" style="background:#fff; border:1px solid #eee; border-radius:14px; overflow:hidden;">
                    <div style="padding:12px 14px; background:#f3f4f6; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:900; color:#555;">ğŸ¥ˆ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø±Ø¯ÙŠÙØ©</div>
                        <div style="color:#555; font-weight:700; font-size:.9rem;">Ø¹Ø¯Ø¯: ${reserveMembers.length}</div>
                    </div>
                    <div style="overflow:auto;">
                        <table style="width:100%; text-align: right; border-collapse: collapse;">
                            <thead style="background: #fafafa;">
                                <tr>
                                    <th style="padding: 10px;">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th style="padding: 10px; text-align: center;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th style="padding: 10px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildRowsFor('Ø±Ø¯ÙŠÙØ©', reserveMembers, '#f3f4f6', 'ğŸ¥ˆ')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ØºÙŠØ± Ù…ØµÙ†Ù‘Ù Ø¥Ø°Ø§ ÙˆØ¬Ø¯ -->
                ${otherMembers.length > 0 ? `
                <div style="background:#fff; border:1px solid #eee; border-radius:14px; overflow:hidden;">
                    <div style="padding:12px 14px; background:#e3f2fd; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight:900; color:#1565c0;">ğŸ“‹ ØºÙŠØ± Ù…ØµÙ†Ù‘Ù</div>
                        <div style="color:#1565c0; font-weight:700; font-size:.9rem;">Ø¹Ø¯Ø¯: ${otherMembers.length}</div>
                    </div>
                    <div style="overflow:auto;">
                        <table style="width:100%; text-align: right; border-collapse: collapse;">
                            <thead style="background: #eef6ff;">
                                <tr>
                                    <th style="padding: 10px;">Ø§Ù„Ø§Ø³Ù…</th>
                                    <th style="padding: 10px; text-align: center;">Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                    <th style="padding: 10px;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${buildRowsFor('other', otherMembers, '#e3f2fd', 'ğŸ“‹')}
                            </tbody>
                        </table>
                    </div>
                </div>
                ` : ''}
            </div>

            <button onclick="saveAttendance()" style="background: #27ae60; margin-top: 16px; font-size: 1.1rem; width:100%;">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
        
        <style>
            .btn-att { padding: 6px 10px; border: 1px solid #ddd; background: white; cursor: pointer; border-radius: 8px; transition: 0.15s; }
            .btn-att:hover { transform: scale(1.06); }
            .btn-att-present.active { background: #dcedc8; border-color: #33691e; }
            .btn-att-absent.active { background: #ffcdd2; border-color: #b71c1c; }
            .btn-att-excused.active { background: #fff9c4; border-color: #fbc02d; }
        </style>
    `;

    // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙØ¹Ù„ÙŠØ§Ù‹ ÙƒÙ€ flex overlay
    modal.classList.remove('hidden');
    modal.style.display = 'flex';
    applyAttTarget();

}

// 2. ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ©
function setAttStatus(index, status, btn) {
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ©
    currentAttendanceList[index].status = status;

    // ØªØ­Ø¯ÙŠØ« Ø´ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const parent = btn.parentElement;
    parent.querySelectorAll('.btn-att').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}

// 3. Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Supabase
async function saveAttendance() {
    const dateVal = document.getElementById('attDate').value;
    const typeVal = document.getElementById('attType').value; // âœ… Ø¬Ù„Ø¨ Ø§Ù„Ù†ÙˆØ¹
    const targetBand = document.getElementById('attTargetBand')?.value || 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†'; // âœ… Ø§Ù„Ø®Ø§Ù†Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©

    if(!dateVal) { alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ®"); return; }

    // âœ… ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ© (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª)
    let listToSave = currentAttendanceList;

    if (targetBand === 'Ø£Ø³Ø§Ø³ÙŠØ©') {
        listToSave = currentAttendanceList.filter(x => (x.band_category || '').trim() === 'Ø£Ø³Ø§Ø³ÙŠØ©');
    } else if (targetBand === 'Ø±Ø¯ÙŠÙØ©') {
        listToSave = currentAttendanceList.filter(x => (x.band_category || '').trim() === 'Ø±Ø¯ÙŠÙØ©');
    } else {
        // 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†' => Ø§Ù„ÙƒÙ„
        listToSave = currentAttendanceList;
    }

    // Ø­Ù…Ø§ÙŠØ©: Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙØ§Ø¶ÙŠ
    if (!listToSave || listToSave.length === 0) {
        alert("âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ø¶Ù…Ù† Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„Ø­ÙØ¸ Ø§Ù„ØªÙÙ‚Ø¯.");
        return;
    }

    // âœ…âœ… (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ù†ÙØ³ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù†ÙˆØ¹
    // Ù†Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ù†ÙØ³ (Ø§Ù„ØªØ§Ø±ÙŠØ® + Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø· + Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø­ÙÙˆØ¸ÙŠÙ†) Ø«Ù… Ù†Ø¶ÙŠÙ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    const namesToSave = listToSave.map(x => x.name);

    const { error: delErr } = await supabaseClient
        .from('band_attendance')
        .delete()
        .eq('attendance_date', dateVal)
        .eq('activity_type', typeVal)
        .in('member_name', namesToSave);

    if (delErr) {
        console.error(delErr);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø­ÙØ¸ (Ø­Ø°Ù Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…):\n" + delErr.message);
        return;
    }

    // ØªØ¬Ù‡ÙŠØ² Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const records = listToSave.map(item => ({
        attendance_date: dateVal,
        activity_type: typeVal, // âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù†ÙˆØ¹ (ØªØ¯Ø±ÙŠØ¨ Ø£Ùˆ Ø¹Ø±Ø¶)
        member_name: item.name,
        status: item.status,
        note: item.note
    }));

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const { error } = await supabaseClient
        .from('band_attendance')
        .insert(records);

    if(error) {
        console.error(error);
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸:\n" + error.message);
    } else {
        alert(`âœ… ØªÙ… Ø­ÙØ¸ Ø³Ø¬Ù„ Ø§Ù„Ù€ (${typeVal}) Ø¨Ù†Ø¬Ø§Ø­!`);
        const m = document.getElementById('modalBandAttendance');
        if (m) { m.classList.add('hidden'); m.style.display = 'none'; }
    }
}


// ==========================================
// ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙØ±Ù‚Ø© (Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¹Ù†ØµØ±)
// ==========================================

async function fetchMyBandStats() {
    const section = document.getElementById('bandStatsSection');

    // âœ… (Ø¬Ø¯ÙŠØ¯) Ø®Ø° Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Supabase Auth
    const authUser = (typeof getCurrentAuthUser === 'function') ? await getCurrentAuthUser() : null;

    // 1. ØªØ­Ø¯ÙŠØ¯ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const regs = loadRegistrations();

    // âœ… (ØªØµØ­ÙŠØ­ Ø¨Ø³ÙŠØ·) Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ currentUser Ø¥Ø°Ø§ Ù…Ø´ Ù…Ø¶Ù…ÙˆÙ†ØŒ Ø§Ø³ØªØ®Ø¯Ù… authUser ÙƒØ£ÙˆÙ„ÙˆÙŠØ©
    const emailToMatch =
        (authUser?.email) ||
        (window.currentUser?.email) ||
        (typeof currentUser !== 'undefined' ? currentUser?.email : null) ||
        "";

    const userProfile = regs.find(r => (r.email || "").toLowerCase() === (emailToMatch || "").toLowerCase());

    let myName = "";
    if (userProfile) {
        myName = userProfile.name || userProfile.fullName || (emailToMatch ? emailToMatch.split('@')[0] : "");
    } else {
        myName = emailToMatch ? emailToMatch.split('@')[0] : "";
    }

    // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    // âœ… (Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡) Ø§ÙØ­Øµ Ø£ÙˆÙ„Ø§Ù‹ Ø¹Ø¨Ø± user_id (Ø§Ù„Ø£ØµØ­)
    let bandMember = null;

    if (authUser?.id) {
        const { data: byUid, error: errUid } = await supabaseClient
            .from('band_members')
            .select('*')
            .eq('user_id', authUser.id)
            .maybeSingle(); // Ø¨Ø¯Ù„ single Ù„Ø­ØªÙ‰ Ù…Ø§ ÙŠØ±Ù…ÙŠ Ø®Ø·Ø£ Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚Ù‰

        if (!errUid && byUid) {
            bandMember = byUid;
        }
    }

    // âœ… fallback: Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚ÙŠØªÙ‡ Ø¨Ù€ user_id Ø¬Ø±Ù‘Ø¨ Ø¨Ø§Ù„Ø§Ø³Ù… (Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
    if (!bandMember) {
        const { data: byName, error: errName } = await supabaseClient
            .from('band_members')
            .select('*')
            .eq('name', myName)
            .maybeSingle();

        if (!errName && byName) {
            bandMember = byName;

            // âœ… (Ø¬Ø¯ÙŠØ¯) Ø¥Ø°Ø§ Ø§Ù„Ø³Ø¬Ù„ Ù‚Ø¯ÙŠÙ… Ùˆ user_id ÙØ§Ø¶ÙŠâ€¦ Ø§Ø±Ø¨Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ (Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
            if (authUser?.id && (!byName.user_id || String(byName.user_id).trim() === "")) {
                await supabaseClient
                    .from('band_members')
                    .update({ user_id: authUser.id })
                    .eq('id', byName.id);
            }
        }
    }

    // Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ: Ø¥Ø°Ø§ Ù…Ùˆ Ø¹Ø¶Ùˆ Ø£Ø®ÙÙŠ Ø§Ù„Ù‚Ø³Ù…
    if (!bandMember) {
        section.classList.add('hidden');
        return;
    }

    section.classList.remove('hidden');

    // 3. Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨ (Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ­Ø­)
    const { data: attendance } = await supabaseClient
        .from('band_attendance')
        .select('*');

    if (!attendance) return;

    // âœ… Ø§Ù„ØªØµØ­ÙŠØ­: Ù†Ø³ØªØ®Ø¯Ù… Set Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ÙØ±ÙŠØ¯Ø© ÙÙ‚Ø· (Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø±)

    // Ø£. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù… (Ù„Ù„Ù…Ù‚Ø§Ù…)
    const totalTrainings = new Set(attendance.filter(r => r.activity_type === 'ØªØ¯Ø±ÙŠØ¨').map(r => r.attendance_date)).size;
    const totalShows = new Set(attendance.filter(r => r.activity_type === 'Ø¹Ø±Ø¶').map(r => r.attendance_date)).size;

    // âœ… (Ø¬Ø¯ÙŠØ¯) ØªÙØ¶ÙŠÙ„ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø© Ø¨Ø§Ù„Ù€ user_id Ø¥Ù† ÙˆØ¬Ø¯ Ø¨Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±ØŒ ÙˆØ¥Ù„Ø§ Ø¨Ø§Ù„Ø§Ø³Ù… (Ù…Ø«Ù„ ÙƒÙˆØ¯Ùƒ)
    const myKeyUserId = authUser?.id || bandMember?.user_id || null;

    const myTrainings = new Set(
        attendance
            .filter(r => {
                const matchByUid = myKeyUserId && (r.member_user_id === myKeyUserId);
                const matchByName = (r.member_name === myName);
                return (matchByUid || matchByName) && r.activity_type === 'ØªØ¯Ø±ÙŠØ¨' && r.status === 'Ø­Ø¶ÙˆØ±';
            })
            .map(r => r.attendance_date)
    ).size;

    const myShows = new Set(
        attendance
            .filter(r => {
                const matchByUid = myKeyUserId && (r.member_user_id === myKeyUserId);
                const matchByName = (r.member_name === myName);
                return (matchByUid || matchByName) && r.activity_type === 'Ø¹Ø±Ø¶' && r.status === 'Ø­Ø¶ÙˆØ±';
            })
            .map(r => r.attendance_date)
    ).size;

    // Ø¬. Ø­Ø³Ø§Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©
    const trainRate = totalTrainings > 0 ? Math.round((myTrainings / totalTrainings) * 100) : 0;
    const showRate = totalShows > 0 ? Math.round((myShows / totalShows) * 100) : 0;

    // 4. Ø§Ù„Ø¹Ø±Ø¶
    const elTrain = document.getElementById('myBandTrainRate');
    const elShow = document.getElementById('myBandShowRate');

    elTrain.innerText = trainRate + "%";
    elShow.innerText = showRate + "%";

    // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø³Ø¨Ø©
    elTrain.style.color = trainRate >= 75 ? '#2e7d32' : (trainRate >= 50 ? '#f57f17' : '#c62828');
    elShow.style.color = showRate >= 75 ? '#2e7d32' : (showRate >= 50 ? '#f57f17' : '#c62828');
}

// ==========================================
// ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ + Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ø±Ø´ÙØ© Ø§Ù„Ø¢Ù„ÙŠ
// ==========================================

// ==========================================
// ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù†ÙØµÙ„Ø©)
// ==========================================

// ==========================================
// ğŸ“¦ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø¹ØªÙ…Ø¯: 3 Ø£Ù‚Ø³Ø§Ù… + Ø£Ø±Ø´ÙŠÙ)
// ==========================================

async function loadBandInventory() {
    console.log("Loading Inventory System...");

    let targetDiv = document.getElementById('tabInventory');
    if (targetDiv) {
        // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©: 3 Ø£Ù‚Ø³Ø§Ù… Ù…Ù†ÙØµÙ„Ø© ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
        targetDiv.innerHTML = `
            <div style="text-align:left; margin-bottom:20px;">
<button onclick="openArchiveModal()" style="background: #607d8b; color: white; border: none; padding: 12px 25px; border-radius: 8px; font-weight: bold; cursor: pointer; display:flex; align-items:center; gap:8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
    ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ
</button>
            </div>

            <div class="section-box" style="margin-bottom:40px; border-top: 5px solid #27ae60; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:#2c3e50;">ğŸ‘• Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù„Ø¨Ø§Ø³</h3>
                    <button onclick="openAddItemModal('Ù„Ø¨Ø§Ø³')" style="background:#27ae60; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø¨Ø§Ø³</button>
                </div>
                <div id="tableUniforms">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>

            <div class="section-box" style="margin-bottom:40px; border-top: 5px solid #e67e22; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:#2c3e50;">ğŸº Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¢Ù„Ø§Øª</h3>
                    <button onclick="openAddItemModal('Ø¢Ù„Ø§Øª')" style="background:#e67e22; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">â• Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø©</button>
                </div>
                <div id="tableInstruments">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>

            <div class="section-box" style="margin-bottom:40px; border-top: 5px solid #7f8c8d; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:#2c3e50;">ğŸ› ï¸ Ø£Ø¯ÙˆØ§Øª ÙˆÙ…Ø¹Ø¯Ø§Øª</h3>
                    <button onclick="openAddItemModal('Ø£Ø¯ÙˆØ§Øª')" style="background:#7f8c8d; color:white; border:none; padding:8px 15px; border-radius:5px; cursor:pointer; font-weight:bold;">â• Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø©</button>
                </div>
                <div id="tableTools">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        `;
        
        // Ø­Ù‚Ù† ÙƒÙˆØ¯ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©
        injectModals();
    }
    
    // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø«Ù„Ø§Ø«Ø©
    fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
    fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
    fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
}

// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù€ window Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¹Ù…Ù„)
// Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ ÙˆØ±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø¨ØªØµÙ…ÙŠÙ… Ø£Ø²Ø±Ø§Ø± ØµØºÙŠØ±Ø© ÙˆØ£Ù†ÙŠÙ‚Ø©)

// Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© ÙˆØ§Ù„Ù…ØµØ­Ø­Ø©)
window.fetchCategoryTable = async function(category, divId) {
    const container = document.getElementById(divId);
    if (!container) return;

    const { data, error } = await supabaseClient
        .from('band_inventory')
        .select('*')
        .eq('category', category)
        .order('item_name');

    if (error) { container.innerHTML = `<p style="color:red">Ø®Ø·Ø£: ${error.message}</p>`; return; }
    if (!data || data.length === 0) { container.innerHTML = `<p style="text-align:center; color:#999; padding:20px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯ Ù…Ø¶Ø§ÙØ©.</p>`; return; }

    let html = `
        <table style="width:100%; border-collapse: separate; border-spacing: 0 10px;">
            <thead>
                <tr style="color:#607d8b; text-align:right; font-size:0.9rem;">
                    <th style="padding:10px; font-weight:600;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th style="padding:10px; font-weight:600;">Ø§Ù„Ù…ÙˆØ§ØµÙØ§Øª</th>
                    <th style="padding:10px; text-align:center; font-weight:600;">Ø§Ù„Ø±ØµÙŠØ¯ (Ø§Ù„ÙƒÙ„ÙŠ / Ø§Ù„Ù…ØªÙˆÙØ±)</th>
                    <th style="padding:10px; text-align:center; font-weight:600;">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(item => {
        const total = item.quantity;
        const loaned = item.loaned_quantity || 0;
        const available = total - loaned;

        // Ø²Ø± Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
        let returnBtnHtml = '';
        if (loaned > 0) {
            returnBtnHtml = `
                <button onclick="openReturnList(${item.id}, '${item.item_name}')" 
                        title="Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ¹ÙŠØ±ÙŠÙ† (${loaned})" 
                        style="width:35px; height:35px; background:#f3e5f5; color:#8e24aa; border:1px solid #e1bee7; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:0.2s;">
                    ğŸ“¥
                </button>
            `;
        }

        html += `
            <tr style="background:white; box-shadow: 0 4px 6px rgba(0,0,0,0.02); border:1px solid #eee; border-radius:10px;">
                
                <td style="padding:15px; font-weight:bold; color:#2c3e50; border-radius:0 10px 10px 0; vertical-align:middle;">
                    ${item.item_name}
                </td>
                
                <td style="padding:15px; vertical-align:middle;">
                    <div style="display:flex; flex-direction:column; gap:5px;">
                        <span style="font-size:0.8rem; background:#e0f2f1; color:#00695c; padding:3px 8px; border-radius:12px; width:fit-content;">${item.item_status}</span>
                        <span style="font-size:0.8rem; color:#78909c;">ğŸ“ ${item.storage_location || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</span>
                    </div>
                </td>

                <td style="padding:15px; text-align:center; vertical-align:middle;">
                    <div style="font-family: 'Segoe UI', sans-serif; font-weight:bold; font-size:1.2rem; color:#37474f;">
                        ${total} <span style="color:#b0bec5; font-weight:300;">|</span> <span style="color:#00c853;">${available}</span>
                    </div>
                    ${loaned > 0 ? `<div style="font-size:0.75rem; color:#ff9800; font-weight:bold; margin-top:5px;">âš ï¸ Ø¨Ø§Ù„Ø®Ø§Ø±Ø¬: ${loaned}</div>` : ''}
                </td>

                <td style="padding:15px; text-align:center; border-radius:10px 0 0 10px; vertical-align:middle;">
                    <div style="display:flex; justify-content:center; gap:6px; background:#f8f9fa; padding:8px; border-radius:12px; width:fit-content; margin:0 auto;">
                        
                        <button onclick="openEditModal(${item.id}, '${item.item_name}', '${item.storage_location}', '${item.item_status}', ${total})" 
                                title="ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø§Ø¯Ø©" 
                                style="width:35px; height:35px; background:white; color:#455a64; border:1px solid #cfd8dc; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 2px rgba(0,0,0,0.05);">
                            âœï¸
                        </button>

                        <div style="width:1px; background:#e0e0e0; margin:0 2px;"></div> <button onclick="openActionModal('loan', ${item.id}, '${item.item_name}', ${available})" 
                                title="ØªØ³Ø¬ÙŠÙ„ Ø¥Ø¹Ø§Ø±Ø©" style="width:35px; height:35px; background:white; color:#1976d2; border:1px solid #bbdefb; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 2px rgba(0,0,0,0.05);">
                            ğŸ“¤
                        </button>
                        
                        ${returnBtnHtml}

                        <button onclick="openActionModal('sell', ${item.id}, '${item.item_name}', ${available})" 
                                title="Ø¨ÙŠØ¹" style="width:35px; height:35px; background:white; color:#2e7d32; border:1px solid #c8e6c9; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 2px 2px rgba(0,0,0,0.05);">
                            ğŸ’°
                        </button>

                        <div style="width:1px; background:#e0e0e0; margin:0 2px;"></div> <button onclick="deleteItem(${item.id})" 
                                title="Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ" style="width:35px; height:35px; background:#ffebee; color:#c62828; border:1px solid #ffcdd2; border-radius:8px; cursor:pointer; display:flex; align-items:center; justify-content:center;">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </td>
            </tr>
        `;
    });
    container.innerHTML = html + `</tbody></table>`;
}
// 2. Ø­ÙØ¸ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
window.saveNewItem = async function() {
    const name = document.getElementById('inName').value;
    const cat = document.getElementById('inCat').value;
    const loc = document.getElementById('inLoc').value;
    const status = document.getElementById('inStatus').value;
    const qty = document.getElementById('inQty').value;

    if(!name) { alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…!"); return; }

    const { error } = await supabaseClient.from('band_inventory').insert([{
        item_name: name, category: cat, storage_location: loc, item_status: status, quantity: parseInt(qty)
    }]);
    
    if(error) alert("Ø®Ø·Ø£: " + error.message);
    else {
        document.getElementById('addItemModal').style.display='none';
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ ÙÙ‚Ø·
        if(cat === 'Ù„Ø¨Ø§Ø³') fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
        else if(cat === 'Ø¢Ù„Ø§Øª') fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
        else fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
    }
}

// 3. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¹Ø§Ø±Ø©/Ø¨ÙŠØ¹/Ø¥Ø±Ø¬Ø§Ø¹)


// 4. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (ÙˆØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ)


// ==========================================
// âš™ï¸ Ù†Ø¸Ø§Ù… Ø§Ù„Ù†ÙˆØ§ÙØ° ÙˆØ§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø¥Ø¶Ø§ÙØ© + Ø¨ÙŠØ¹/Ø¥Ø¹Ø§Ø±Ø©)
// ==========================================

// 1. Ø­Ù‚Ù† Ø§Ù„Ù†ÙˆØ§ÙØ° (Ø§Ù„Ø¥Ø¶Ø§ÙØ© + Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª) ÙÙŠ Ø§Ù„ØµÙØ­Ø©
window.injectModals = function() {
    // Ø­Ø°Ù Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
    ['addItemModal', 'actionModal', 'returnListModal', 'editItemModal', 'archiveModal'].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.remove();
    });

    const html = `
    <div id="addItemModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; width:90%; max-width:450px; border-top: 6px solid #27ae60; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h3 id="modalTitleAdd" style="margin-top:0; text-align:center; color:#2c3e50;">Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h3>
            <input type="hidden" id="inCat"> 
            <label style="font-weight:bold; color:#555;">Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
            <input type="text" id="inName" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label style="font-weight:bold; color:#555;">Ø§Ù„Ù…ÙƒØ§Ù†:</label><input type="text" id="inLoc" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;"></div>
                <div style="flex:1;"><label style="font-weight:bold; color:#555;">Ø§Ù„Ø¹Ø¯Ø¯:</label><input type="number" id="inQty" value="1" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;"></div>
            </div>
            <label style="font-weight:bold; color:#555;">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            <select id="inStatus" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px; background:white;">
                <option value="Ø¬Ø¯ÙŠØ¯">âœ¨ Ø¬Ø¯ÙŠØ¯</option><option value="Ø¬ÙŠØ¯">âœ… Ø¬ÙŠØ¯</option><option value="ØµÙŠØ§Ù†Ø©">ğŸ› ï¸ ØµÙŠØ§Ù†Ø©</option><option value="ØªØ§Ù„Ù">âŒ ØªØ§Ù„Ù</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="saveNewItem()" style="flex:2; padding:12px; background:#27ae60; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸</button>
                <button onclick="document.getElementById('addItemModal').style.display='none'" style="flex:1; padding:12px; background:#eceff1; color:#333; border:none; border-radius:8px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="editItemModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; width:90%; max-width:450px; border-top: 6px solid #607d8b; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h3 style="margin-top:0; text-align:center; color:#455a64;">âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª</h3>
            <label style="font-weight:bold; color:#555;">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label>
            <input type="text" id="editName" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;">
            <div style="display:flex; gap:10px;">
                <div style="flex:1;"><label style="font-weight:bold; color:#555;">Ø§Ù„Ù…ÙƒØ§Ù†:</label><input type="text" id="editLoc" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;"></div>
                <div style="flex:1;"><label style="font-weight:bold; color:#555;">Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ:</label><input type="number" id="editQty" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:10px;"></div>
            </div>
            <label style="font-weight:bold; color:#555;">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
            <select id="editStatus" style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:20px; background:white;">
                <option value="Ø¬Ø¯ÙŠØ¯">âœ¨ Ø¬Ø¯ÙŠØ¯</option><option value="Ø¬ÙŠØ¯">âœ… Ø¬ÙŠØ¯</option><option value="ØµÙŠØ§Ù†Ø©">ğŸ› ï¸ ØµÙŠØ§Ù†Ø©</option><option value="ØªØ§Ù„Ù">âŒ ØªØ§Ù„Ù</option>
            </select>
            <div style="display:flex; gap:10px;">
                <button onclick="saveEditItem()" style="flex:2; padding:12px; background:#607d8b; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
                <button onclick="document.getElementById('editItemModal').style.display='none'" style="flex:1; padding:12px; background:#eceff1; color:#333; border:none; border-radius:8px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="actionModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; width:90%; max-width:400px; border-top: 6px solid #1976d2; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <h3 id="actionTitle" style="margin-top:0; text-align:center;"></h3>
            <input type="text" id="actMember" placeholder="Ø§Ù„Ø§Ø³Ù… (Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø«Ø§Ù†ÙŠ)" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <input type="number" id="actQty" placeholder="Ø§Ù„Ø¹Ø¯Ø¯" value="1" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;">
            <div id="fieldPrice" style="display:none;"><input type="number" id="actPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;"></div>
            <div style="display:flex; gap:10px; margin-top:15px;">
                <button id="btnActionExecute" onclick="executeAction()" style="flex:2; padding:12px; background:#1976d2; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">ØªÙ†ÙÙŠØ°</button>
                <button onclick="document.getElementById('actionModal').style.display='none'" style="flex:1; padding:12px; background:#eceff1; color:#333; border:none; border-radius:8px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>

    <div id="returnListModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:15px; width:90%; max-width:500px; border-top: 6px solid #8e24aa;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="returnListTitle" style="margin:0; color:#4a148c;"></h3>
                <button onclick="document.getElementById('returnListModal').style.display='none'" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#888;">&times;</button>
            </div>
            <div id="returnListBody" style="max-height:350px; overflow-y:auto; background:#f9f9f9; padding:10px; border-radius:8px;"></div>
        </div>
    </div>

    <div id="archiveModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:15px; width:95%; max-width:700px; height:80%; display:flex; flex-direction:column; box-shadow: 0 10px 25px rgba(0,0,0,0.2);">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px; border-bottom:1px solid #eee; padding-bottom:10px;">
                <h3 style="margin:0; color:#37474f;">ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ø­Ø±ÙƒØ© ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</h3>
                <button onclick="document.getElementById('archiveModal').style.display='none'" style="background:#eceff1; border:none; padding:8px 15px; border-radius:6px; cursor:pointer; font-weight:bold;">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
            </div>
            <div id="archiveBody" style="flex:1; overflow-y:auto; background:#fff;"></div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}
// 2. Ø¯Ø§Ù„Ø© ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª
let currentAction = {}; 
window.openActionModal = function(type, id, name, maxQty) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ø§ÙØ°Ø©
    let modal = document.getElementById('actionModal');
    if(!modal) { injectModals(); modal = document.getElementById('actionModal'); }

    currentAction = { type, id, name, maxQty };
    
    // ØªØ®ØµÙŠØµ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
    let title = '', color = '';
    if(type === 'loan') { title = 'ğŸ“¤ Ø¥Ø¹Ø§Ø±Ø©: ' + name; color = '#3498db'; }
    else if(type === 'sell') { title = 'ğŸ’° Ø¨ÙŠØ¹: ' + name; color = '#27ae60'; }
    else if(type === 'return') { title = 'ğŸ“¥ Ø¥Ø±Ø¬Ø§Ø¹: ' + name; color = '#9b59b6'; }

    document.getElementById('actionTitle').innerText = title;
    document.getElementById('actionModal').style.borderTopColor = color;
    document.getElementById('btnActionExecute').style.background = color;
    
    // Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø· Ù„Ù„Ø¨ÙŠØ¹
    document.getElementById('fieldPrice').style.display = (type === 'sell') ? 'block' : 'none';
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('actQty').value = 1;
    document.getElementById('actMember').value = '';
    document.getElementById('actPrice').value = '';

    modal.style.display = 'flex';
}

// 3. Ø¯Ø§Ù„Ø© ØªÙ†ÙÙŠØ° Ø§Ù„Ø¹Ù…Ù„ÙŠØ©
window.executeAction = async function() {
    const qty = parseInt(document.getElementById('actQty').value);
    const member = document.getElementById('actMember').value;
    const price = document.getElementById('actPrice').value || 0;
    const type = currentAction.type;

    if(!member || qty < 1) { alert("âš ï¸ Ø¨ÙŠØ§Ù†Ø§Øª Ù†Ø§Ù‚ØµØ©!"); return; }

    // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const { data: itemData } = await supabaseClient
        .from('band_inventory')
        .select('quantity, loaned_quantity')
        .eq('id', currentAction.id)
        .single();

    const totalQty = itemData.quantity;          
    const loanedQty = itemData.loaned_quantity || 0; 
    const availableQty = totalQty - loanedQty;   

    let updateData = {};

    // 2. ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ù†Ø·Ù‚ (Ù…Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯)
    if (type === 'loan') {
        // Ø´Ø±Ø· Ø§Ù„Ø¥Ø¹Ø§Ø±Ø©
        if (qty > availableQty) { alert(`âŒ Ø§Ù„Ù…ØªÙˆÙØ± ÙÙ‚Ø· ${availableQty}`); return; }
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
        updateData = { loaned_quantity: loanedQty + qty };

        // âœ…âœ…âœ… Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©: Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ù‡Ø¯ Ø§Ù„Ù†Ø´Ø·Ø© âœ…âœ…âœ…
        const { error: loanError } = await supabaseClient.from('band_active_loans').insert([{
            item_id: currentAction.id,
            item_name: currentAction.name,
            member_name: member,
            quantity: qty
        }]);
        
        if(loanError) {
            console.error("ÙØ´Ù„ Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù…:", loanError); 
            alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ¹ÙŠØ±ØŒ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙÙŠ SQL");
            return; 
        }
    
    } else if (type === 'return') {
        // â›” Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ù† Ù‡Ù†Ø§ (Ù„Ø£Ù†Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¢Ù†)
        alert("âš ï¸ Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø²Ø± (ğŸ“¥) Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ø§Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø§Ø³Ù….");
        return; 
    
    } else if (type === 'sell') {
        // Ø´Ø±Ø· Ø§Ù„Ø¨ÙŠØ¹
        if (qty > availableQty) { alert(`âŒ Ø§Ù„Ù…ØªÙˆÙØ± ÙÙ‚Ø· ${availableQty}`); return; }
        updateData = { quantity: totalQty - qty };
    }

    // 3. Ø§Ù„ØªØ­Ø¯ÙŠØ« ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)
    const { error } = await supabaseClient.from('band_inventory').update(updateData).eq('id', currentAction.id);
    if(error) { alert("Ø­Ø¯Ø« Ø®Ø·Ø£: " + error.message); return; }

    // 4. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø³Ø¬Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ®)
    let actionLabel = (type === 'loan') ? 'Ø¥Ø¹Ø§Ø±Ø©' : 'Ø¨ÙŠØ¹';
    await supabaseClient.from('band_archive').insert([{
        item_name: currentAction.name,
        action_type: actionLabel,
        quantity: qty,
        member_name: member,
        price: (type === 'sell') ? price : null,
        notes: `Ø§Ù„ØªØ§Ø±ÙŠØ®: ${new Date().toLocaleDateString('ar-EG')}`
    }]);

    document.getElementById('actionModal').style.display = 'none';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    if(document.getElementById('tableUniforms')) fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
    if(document.getElementById('tableInstruments')) fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
    if(document.getElementById('tableTools')) fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
}
// ==========================================
// ğŸ“¥ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø°ÙƒÙŠ (Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ¹ÙŠØ±ÙŠÙ†)
// ==========================================

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
window.openReturnList = async function(itemId, itemName) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ÙˆØ­Ù‚Ù†Ù‡Ø§ Ø¥Ù† Ù„Ù… ØªÙˆØ¬Ø¯)
    let listModal = document.getElementById('returnListModal');
    if(!listModal) { injectReturnListModal(); listModal = document.getElementById('returnListModal'); }

    document.getElementById('returnListTitle').innerText = `Ø¥Ø±Ø¬Ø§Ø¹: ${itemName}`;
    const listContainer = document.getElementById('returnListBody');
    listContainer.innerHTML = '<p style="text-align:center;">â³ Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡...</p>';
    
    listModal.style.display = 'flex';

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ¹ÙŠØ±ÙŠÙ† Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const { data: loans, error } = await supabaseClient
        .from('band_active_loans')
        .select('*')
        .eq('item_id', itemId);

    if(error) { listContainer.innerHTML = `<p style="color:red">${error.message}</p>`; return; }
    if(!loans || loans.length === 0) { 
        listContainer.innerHTML = '<p style="text-align:center; color:#777;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ø¹Ø§Ø±Ø© Ù…Ø³Ø¬Ù„Ø© (Ù‚Ø¯ ØªÙƒÙˆÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø¯ÙŠÙ…Ø©).</p>'; 
        return; 
    }

    // Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
    let html = `
        <table style="width:100%; border-collapse: collapse;">
            <tr style="background:#f5f5f5; color:#555; font-size:0.9rem;">
                <td style="padding:10px;">Ø§Ù„Ø§Ø³Ù…</td>
                <td style="padding:10px; text-align:center;">Ø§Ù„ÙƒÙ…ÙŠØ©</td>
                <td style="padding:10px; text-align:center;">Ø§Ù„ØªØ§Ø±ÙŠØ®</td>
                <td style="padding:10px; text-align:center;">Ø¥Ø¬Ø±Ø§Ø¡</td>
            </tr>
    `;

    loans.forEach(loan => {
        html += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px; font-weight:bold;">${loan.member_name}</td>
                <td style="padding:10px; text-align:center; color:#e67e22; font-weight:bold;">${loan.quantity}</td>
                <td style="padding:10px; text-align:center; font-size:0.8rem; color:#999;">${loan.loan_date}</td>
                <td style="padding:10px; text-align:center;">
                    <button onclick="processReturn(${loan.id}, ${loan.item_id}, ${loan.quantity}, '${loan.member_name}', '${loan.item_name}')" 
                            style="background:#f3e5f5; color:#8e24aa; border:1px solid #e1bee7; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:0.85rem;">
                        Ø§Ø³ØªÙ„Ø§Ù… â†©ï¸
                    </button>
                </td>
            </tr>
        `;
    });
    listContainer.innerHTML = html + '</table>';
}

// 2. ØªÙ†ÙÙŠØ° Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„ÙØ¹Ù„ÙŠ (Ø¹Ù†Ø¯ Ø¶ØºØ· Ø²Ø± Ø§Ø³ØªÙ„Ø§Ù…)
window.processReturn = async function(loanId, itemId, loanQty, memberName, itemName) {
    const returnQtyStr = prompt(`ÙƒÙ… Ù‚Ø·Ø¹Ø© ØªØ±ÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù…Ù‡Ø§ Ù…Ù† "${memberName}"ØŸ (Ø§Ù„Ø¹Ù‡Ø¯Ø©: ${loanQty})`, loanQty);
    if(returnQtyStr === null) return; // Ø¥Ù„ØºØ§Ø¡
    const returnQty = parseInt(returnQtyStr);

    if(isNaN(returnQty) || returnQty < 1 || returnQty > loanQty) {
        alert("âš ï¸ ÙƒÙ…ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©!"); return;
    }

    if(!confirm(`ØªØ£ÙƒÙŠØ¯ Ø§Ø³ØªÙ„Ø§Ù… ${returnQty} Ù‚Ø·Ø¹Ø© Ù…Ù† ${memberName}ØŸ`)) return;

    // 1. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ø¥Ù†Ù‚Ø§Øµ Ø§Ù„Ù…Ø¹Ø§Ø±)
    // Ù†Ø¬Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹ Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø¯Ù‚Ø©
    const { data: invItem } = await supabaseClient.from('band_inventory').select('loaned_quantity').eq('id', itemId).single();
    const newLoanedQty = (invItem.loaned_quantity || 0) - returnQty;

    await supabaseClient.from('band_inventory').update({ loaned_quantity: newLoanedQty }).eq('id', itemId);

    // 2. ØªØ­Ø¯ÙŠØ« Ø³Ø¬Ù„ Ø§Ù„Ø¹Ù‡Ø¯Ø© (Active Loans)
    if(returnQty === loanQty) {
        // Ø¥Ø°Ø§ Ø±Ø¬Ø¹ ÙƒÙ„ Ø´ÙŠ -> Ø§Ø­Ø°Ù Ø§Ù„Ø³Ø·Ø±
        await supabaseClient.from('band_active_loans').delete().eq('id', loanId);
    } else {
        // Ø¥Ø°Ø§ Ø±Ø¬Ø¹ Ø¬Ø²Ø¡ -> Ù†Ù‚Øµ Ø§Ù„ÙƒÙ…ÙŠØ©
        await supabaseClient.from('band_active_loans').update({ quantity: loanQty - returnQty }).eq('id', loanId);
    }

    // 3. Ø§Ù„Ø£Ø±Ø´ÙØ©
    await supabaseClient.from('band_archive').insert([{
        item_name: itemName, action_type: 'Ø¥Ø±Ø¬Ø§Ø¹', quantity: returnQty, member_name: memberName,
        notes: `Ø§Ø³ØªÙ„Ø§Ù… Ø¹Ù‡Ø¯Ø© Ù…Ù† ${memberName} Ø¨ØªØ§Ø±ÙŠØ® ${new Date().toLocaleDateString('ar-EG')}`
    }]);

    alert("âœ… ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù… Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById('returnListModal').style.display = 'none'; // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
    fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
    fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
}

// 3. Ø­Ù‚Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (HTML)
function injectReturnListModal() {
    if(document.getElementById('returnListModal')) return;
    const html = `
    <div id="returnListModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:20px; border-radius:10px; width:90%; max-width:500px; border-top: 5px solid #8e24aa;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h3 id="returnListTitle" style="margin:0; color:#2c3e50;"></h3>
                <button onclick="document.getElementById('returnListModal').style.display='none'" style="background:none; border:none; font-size:1.2rem; cursor:pointer;">âœ–</button>
            </div>
            <div id="returnListBody" style="max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}
// ==========================================
// âœï¸ Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ (Edit System)
// ==========================================

let currentEditId = null; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ø±Ù Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø¬Ø§Ø±ÙŠ ØªØ¹Ø¯ÙŠÙ„Ù‡

// 1. ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
window.openEditModal = function(id, name, location, status, totalQty) {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ø§ÙØ°Ø©
    let modal = document.getElementById('editItemModal');
    if(!modal) { injectModals(); modal = document.getElementById('editItemModal'); }

    currentEditId = id;

    // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    document.getElementById('editName').value = name;
    document.getElementById('editLoc').value = location === 'null' ? '' : location;
    document.getElementById('editStatus').value = status;
    document.getElementById('editQty').value = totalQty;

    document.getElementById('editItemModal').style.display = 'flex';
}

// 2. Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
window.saveEditItem = async function() {
    const newName = document.getElementById('editName').value;
    const newLoc = document.getElementById('editLoc').value;
    const newStatus = document.getElementById('editStatus').value;
    const newQty = parseInt(document.getElementById('editQty').value);

    if(!newName || newQty < 0) { alert("Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }

    const { error } = await supabaseClient
        .from('band_inventory')
        .update({
            item_name: newName,
            storage_location: newLoc,
            item_status: newStatus,
            quantity: newQty // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„ÙŠ
        })
        .eq('id', currentEditId);

    if(error) { alert("Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: " + error.message); return; }

    alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
    document.getElementById('editItemModal').style.display = 'none';
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„
    fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
    fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
    fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
}
// ==========================================
// ğŸ—‘ï¸ Ø¯Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù (Ø§Ù„Ù…ÙÙ‚ÙˆØ¯Ø©)
// ==========================================
window.deleteItem = async function(id) {
    // Ø±Ø³Ø§Ù„Ø© ØªØ£ÙƒÙŠØ¯ Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø°Ù Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„Ø®Ø·Ø£
    if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ\n(Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø®Ø·ÙˆØ©)")) {
        
        // ØªÙ†ÙÙŠØ° Ø§Ù„Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const { error } = await supabaseClient
            .from('band_inventory')
            .delete()
            .eq('id', id);
        
        if(error) {
            // ØªÙ†Ø¨ÙŠÙ‡ ÙÙŠ Ø­Ø§Ù„ ÙˆØ¬ÙˆØ¯ Ù…Ø´ÙƒÙ„Ø© (Ù…Ø«Ù„Ø§Ù‹ Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ø¹Ù‡Ø¯Ø©)
            alert("âŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø­Ø°Ù: " + error.message + "\n(Ù‚Ø¯ ØªÙƒÙˆÙ† Ø§Ù„Ù…Ø§Ø¯Ø© Ù…Ø¹Ø§Ø±Ø© Ù„Ø´Ø®ØµØŒ ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªÙ„Ø§Ù…Ù‡Ø§ Ø£ÙˆÙ„Ø§Ù‹)");
        } else {
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù…Ø­Ø°ÙˆÙ
            if(document.getElementById('tableUniforms')) fetchCategoryTable('Ù„Ø¨Ø§Ø³', 'tableUniforms');
            if(document.getElementById('tableInstruments')) fetchCategoryTable('Ø¢Ù„Ø§Øª', 'tableInstruments');
            if(document.getElementById('tableTools')) fetchCategoryTable('Ø£Ø¯ÙˆØ§Øª', 'tableTools');
        }
    }
}
// ==========================================
// ğŸ“œ Ù†Ø¸Ø§Ù… Ø³Ø¬Ù„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Archive System)
// ==========================================

window.openArchiveModal = async function() {
    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù†Ø§ÙØ°Ø©
    let modal = document.getElementById('archiveModal');
    if(!modal) { injectModals(); modal = document.getElementById('archiveModal'); }

    // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© ÙˆØ¹Ø±Ø¶ Ø±Ø³Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„
    const container = document.getElementById('archiveBody');
    container.innerHTML = '<p style="text-align:center; padding:20px;">â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„...</p>';
    modal.style.display = 'flex';

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const { data: logs, error } = await supabaseClient
        .from('band_archive')
        .select('*')
        .order('created_at', { ascending: false }) // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙÙˆÙ‚)
        .limit(50); // Ø¬Ù„Ø¨ Ø¢Ø®Ø± 50 Ø¹Ù…Ù„ÙŠØ© ÙÙ‚Ø· Ù„ØªØ³Ø±ÙŠØ¹ Ø§Ù„Ø¹Ø±Ø¶

    if (error) { container.innerHTML = `<p style="color:red; text-align:center;">Ø®Ø·Ø£: ${error.message}</p>`; return; }
    if (!logs || logs.length === 0) { container.innerHTML = `<p style="text-align:center; color:#777; padding:20px;">Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</p>`; return; }

    // Ø±Ø³Ù… Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    let html = `
        <table style="width:100%; border-collapse: collapse; font-size:0.9rem;">
            <thead>
                <tr style="background:#f8f9fa; color:#455a64; text-align:right;">
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ø§Ù„Ø§Ø³Ù…</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ø§Ù„Ø¹Ù…Ù„ÙŠØ©</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ø§Ù„Ù…Ø§Ø¯Ø©</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ø§Ù„Ø¹Ø¯Ø¯</th>
                    <th style="padding:10px; border-bottom:2px solid #ddd;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                </tr>
            </thead>
            <tbody>
    `;

    logs.forEach(log => {
        // ØªÙ†Ø³ÙŠÙ‚ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ù…Ù„ÙŠØ© (Ø£Ù„ÙˆØ§Ù†)
        let badgeColor = '#777';
        if (log.action_type === 'Ø¥Ø¹Ø§Ø±Ø©') badgeColor = '#1976d2'; // Ø£Ø²Ø±Ù‚
        else if (log.action_type === 'Ø¥Ø±Ø¬Ø§Ø¹') badgeColor = '#8e24aa'; // Ø¨Ù†ÙØ³Ø¬ÙŠ
        else if (log.action_type === 'Ø¨ÙŠØ¹') badgeColor = '#2e7d32'; // Ø£Ø®Ø¶Ø±

        // ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ®
        let dateObj = new Date(log.created_at);
        let dateStr = dateObj.toLocaleDateString('ar-EG') + ' ' + dateObj.toLocaleTimeString('ar-EG', {hour: '2-digit', minute:'2-digit'});

        html += `
            <tr style="border-bottom:1px solid #eee;">
                <td style="padding:10px; color:#555; direction:ltr; text-align:right;">${dateStr}</td>
                <td style="padding:10px; font-weight:bold; color:#2c3e50;">${log.member_name || '-'}</td>
                <td style="padding:10px;"><span style="background:${badgeColor}; color:white; padding:3px 8px; border-radius:4px; font-size:0.8rem;">${log.action_type}</span></td>
                <td style="padding:10px; color:#37474f;">${log.item_name}</td>
                <td style="padding:10px; font-weight:bold; text-align:center;">${log.quantity}</td>
                <td style="padding:10px; color:#78909c; font-size:0.85rem;">${log.notes || (log.price ? 'Ø³Ø¹Ø±: ' + log.price : '-')}</td>
            </tr>
        `;
    });

    container.innerHTML = html + `</tbody></table>`;
}
// ==========================================
// ğŸ¼ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ© (Music Library)
// ==========================================

// 1. Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ù…ÙƒØªØ¨Ø©


// 2. Ø¬Ù„Ø¨ ÙˆØ¹Ø±Ø¶ Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ§Øª
async function fetchMusicLibrary() {
    const container = document.getElementById('musicGrid');
    const { data, error } = await supabaseClient
        .from('band_music_library')
        .select('*')
        .order('created_at', { ascending: false });

    if(error) { container.innerHTML = `<p style="color:red">Ø®Ø·Ø£: ${error.message}</p>`; return; }
    if(!data || data.length === 0) { container.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#999; padding:40px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø¹Ø²ÙˆÙØ©! ğŸµ</p>`; return; }

    let html = '';
    data.forEach(track => {
        // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ùˆ Ù…Ø§ Ø­Ø· ØµÙˆØ±Ø©
        const img = track.image_url || 'https://via.placeholder.com/300x150?text=Music+Score';
        
        html += `
            <div style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.05); transition:transform 0.2s; border:1px solid #f0f0f0;">
                
                <div style="height:140px; background:#eee; overflow:hidden; position:relative;">
                    <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                    <span style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:4px 10px; border-radius:20px; font-size:0.75rem;">${track.category || 'Ø¹Ø§Ù…'}</span>
                </div>

                <div style="padding:15px;">
                    <h3 style="margin:0 0 5px; color:#2c3e50; font-size:1.1rem;">${track.title}</h3>
                    
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        ${track.sheet_url ? `<a href="${track.sheet_url}" target="_blank" style="flex:1; text-align:center; background:#fff3e0; color:#ef6c00; padding:8px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:0.9rem;">ğŸ“„ Ø§Ù„Ù†ÙˆØªØ©</a>` : ''}
                        ${track.audio_url ? `<a href="${track.audio_url}" target="_blank" style="flex:1; text-align:center; background:#e3f2fd; color:#1565c0; padding:8px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:0.9rem;">â–¶ï¸ ØªØ´ØºÙŠÙ„</a>` : ''}
                    </div>

                    <button onclick="deleteMusic(${track.id})" style="width:100%; margin-top:10px; background:none; border:none; color:#e57373; cursor:pointer; font-size:0.8rem;">Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©</button>
                </div>
            </div>
        `;
    });
    container.innerHTML = html;
}

// 3. Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© ÙˆØ§Ù„Ø­ÙØ¸
window.openAddMusicModal = function() {
    let modal = document.getElementById('musicModal');
    if(!modal) { injectMusicModals(); modal = document.getElementById('musicModal'); }
    
    // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
    document.getElementById('mTitle').value = '';
    document.getElementById('mCat').value = 'Ù…Ø§Ø±Ø´';
    document.getElementById('mImg').value = '';
    document.getElementById('mSheet').value = '';
    document.getElementById('mAudio').value = '';
    
    modal.style.display = 'flex';
}

window.saveNewMusic = async function() {
    const title = document.getElementById('mTitle').value;
    const cat = document.getElementById('mCat').value;
    const img = document.getElementById('mImg').value;
    const sheet = document.getElementById('mSheet').value;
    const audio = document.getElementById('mAudio').value;

    if(!title) { alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©"); return; }

    const { error } = await supabaseClient.from('band_music_library').insert([{
        title: title,
        category: cat,
        image_url: img,
        sheet_url: sheet,
        audio_url: audio
    }]);

    if(error) alert("Ø®Ø·Ø£: " + error.message);
    else {
        document.getElementById('musicModal').style.display = 'none';
        fetchMusicLibrary();
    }
}

window.deleteMusic = async function(id) {
    if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©ØŸ")) {
        await supabaseClient.from('band_music_library').delete().eq('id', id);
        fetchMusicLibrary();
    }
}

// 4. Ø­Ù‚Ù† Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰
function injectMusicModals() {
    if(document.getElementById('musicModal')) return;
    const html = `
    <div id="musicModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:15px; width:90%; max-width:450px; border-top: 6px solid #5e35b1;">
            <h3 style="margin-top:0; text-align:center; color:#5e35b1;">ğŸ¼ Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø²ÙˆÙØ©</h3>
            
            <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©:</label>
            <input type="text" id="mTitle" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">

            <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø§Ù„ØªØµÙ†ÙŠÙ:</label>
            <select id="mCat" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:6px; background:white;">
                <option value="Ù…Ø§Ø±Ø´">Ù…Ø§Ø±Ø´</option>
                <option value="ÙˆØ·Ù†ÙŠ">ÙˆØ·Ù†ÙŠ</option>
                <option value="ÙƒØ´ÙÙŠ">ÙƒØ´ÙÙŠ</option>
                <option value="Ù…Ø¹Ø²ÙˆÙØ© Ø¹Ø§Ù„Ù…ÙŠØ©">Ù…Ø¹Ø²ÙˆÙØ© Ø¹Ø§Ù„Ù…ÙŠØ©</option>
            </select>

            <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label>
            <input type="text" id="mImg" placeholder="https://..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">

            <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø±Ø§Ø¨Ø· Ø§Ù„Ù†ÙˆØªØ© (PDF/Drive):</label>
            <input type="text" id="mSheet" placeholder="https://..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">

            <label style="font-weight:bold; display:block; margin-bottom:5px;">Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØª (Youtube/MP3):</label>
            <input type="text" id="mAudio" placeholder="https://..." style="width:100%; padding:10px; margin-bottom:20px; border:1px solid #ddd; border-radius:6px;">

            <div style="display:flex; gap:10px;">
                <button onclick="saveNewMusic()" style="flex:2; padding:12px; background:#5e35b1; color:white; border:none; border-radius:8px; cursor:pointer; font-weight:bold;">Ø­ÙØ¸</button>
                <button onclick="document.getElementById('musicModal').style.display='none'" style="flex:1; padding:12px; background:#f0f0f0; border:none; border-radius:8px; cursor:pointer;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </div>
    </div>
    `;
    document.body.insertAdjacentHTML('beforeend', html);
}
// ==========================================
// ğŸ¼ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ (Ø§Ù„Ø¢Ù…Ù†Ø©)
// ==========================================
function showMusicTab() {
    // 1. Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹ (Ù„Ø¶Ù…Ø§Ù† Ø¹Ø¯Ù… Ø§Ù„ØªØ¯Ø§Ø®Ù„)
    if(document.getElementById('tabRequests')) document.getElementById('tabRequests').style.display = 'none';
    if(document.getElementById('tabMembers')) document.getElementById('tabMembers').style.display = 'none';
    if(document.getElementById('tabInventory')) document.getElementById('tabInventory').style.display = 'none';
    
    // 2. Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ù†Ø´Ø· Ù…Ù† ÙƒÙ„ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
    const btns = document.querySelectorAll('.band-tab-btn');
    btns.forEach(btn => btn.classList.remove('active-band-tab'));

    // 3. Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ ÙˆØªØ´ØºÙŠÙ„ Ø§Ù„Ø¯Ø§Ù„Ø©
    const musicTab = document.getElementById('tabMusic');
    if(musicTab) {
        musicTab.style.display = 'block';
        loadMusicLibrary(); // Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø¯Ø§Ù„Ø© Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…ÙƒØªØ¨Ø©
    }
}

// ØªØ¹Ø¯ÙŠÙ„ Ø¨Ø³ÙŠØ· Ø¹Ù„Ù‰ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (switchBandTab) Ù„Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ Ø¹Ù†Ø¯ Ø§Ù„Ø¹ÙˆØ¯Ø©
// Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¯Ø§Ù„ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© switchBandTab ÙˆØ£Ø¶Ù Ù‡Ø°Ø§ Ø§Ù„Ø³Ø·Ø± ÙÙŠ Ø¨Ø¯Ø§ÙŠØªÙ‡Ø§:
// if(document.getElementById('tabMusic')) document.getElementById('tabMusic').style.display = 'none';
// ==========================================
// ğŸ¼ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©
// ==========================================

// ==========================================
// ğŸ¼ Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ© (Music Library) - Ù…ÙØ­Ø¯Ù‘Ø«
// ==========================================

// 1) Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙƒØªØ¨Ø©
async function loadMusicLibrary() {
    const container = document.getElementById('tabMusic');
    if (!container) return;

    container.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; background:#fff; padding:15px; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.05);">
            <h3 style="margin:0; color:#5e35b1;">ğŸ¼ Ø£Ø±Ø´ÙŠÙ Ø§Ù„Ù†ÙˆØªØ§Øª</h3>
            <button onclick="openAddMusicModal()" style="background:#673ab7; color:white; border:none; padding:8px 15px; border-radius:6px; cursor:pointer;">â• Ø¥Ø¶Ø§ÙØ©</button>
        </div>

        <div id="musicGrid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap:15px;">
            <p style="grid-column:1/-1; text-align:center; color:#999;">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    `;

    injectMusicModal();         // ØªØ¬Ù‡ÙŠØ² Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
    injectMusicDetailsModal();  // ØªØ¬Ù‡ÙŠØ² Ù†Ø§ÙØ°Ø© Ø§Ù„ØªÙØ§ØµÙŠÙ„

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const { data, error } = await supabaseClient
        .from('band_music_library')
        .select('*')
        .order('created_at', { ascending: false });

    const grid = document.getElementById('musicGrid');

    if (error) {
        grid.innerHTML = `<p style="grid-column:1/-1; color:red; text-align:center;">${error.message}</p>`;
        return;
    }

    if (!data || data.length === 0) {
        grid.innerHTML = `<p style="grid-column:1/-1; text-align:center; color:#999; padding:40px;">Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙØ§Ø±ØºØ©. Ø£Ø¶Ù Ø£ÙˆÙ„ Ù…Ø¹Ø²ÙˆÙØ© ğŸµ</p>`;
        return;
    }

    // âœ… Ø­ÙØ¸ Ø§Ù„Ø¹Ù†Ø§ØµØ± Ù„Ù„ÙˆØµÙˆÙ„ Ù„Ù„ØªÙØ§ØµÙŠÙ„ Ø¨Ø§Ù„Ù€ id
    window.musicItemsById = {};
    data.forEach(t => window.musicItemsById[t.id] = t);

    // Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª
    let html = '';
    data.forEach(track => {
        const type = (track.category || '').trim(); // "Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©" Ø£Ùˆ "Ù…Ø§Ø±Ø´"
        const isMarch = type === 'Ù…Ø§Ø±Ø´';

        // ØµÙˆØ±Ø©: Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØŒ ÙˆÙ‚Ø¯ ØªÙƒÙˆÙ† ÙØ§Ø¶ÙŠØ© Ø¨Ø§Ù„Ù…Ù€Ø§Ø±Ø´
        const fallbackCover = "data:image/svg+xml;utf8," + encodeURIComponent(`
<svg xmlns='http://www.w3.org/2000/svg' width='800' height='400'>
  <defs>
    <linearGradient id='g' x1='0' x2='1'>
      <stop offset='0' stop-color='#ede7f6'/>
      <stop offset='1' stop-color='#fff'/>
    </linearGradient>
  </defs>
  <rect width='100%' height='100%' fill='url(#g)'/>
  <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
        font-family='Arial' font-size='36' fill='#5e35b1'>Music Score</text>
</svg>
`);
        const img = (track.image_url && track.image_url.trim()) ? track.image_url : fallbackCover;

        // - Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©: sheet_url = Ø±Ø§Ø¨Ø· Ø§Ù„Ù†ÙˆØªØ©
        // - Ù…Ø§Ø±Ø´: sheet_url = Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ
        const sheetOrVideoUrl = (track.sheet_url || '').trim();

        // Ø£ØµÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©: ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¨Ø³Ø·Ø±
        const audioRaw = (track.audio_url || '').trim();
        const audioLinks = audioRaw
            ? audioRaw.split('\n').map(s => s.trim()).filter(Boolean)
            : [];

        const sheetBtnLabel = isMarch ? 'ğŸ¥ ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ“„ Ø§Ù„Ù†ÙˆØªØ©';
        const sheetBtnStyle = isMarch
            ? 'background:#ede7f6; color:#5e35b1;'
            : 'background:#fff3e0; color:#ef6c00;';

        const sheetBtnHtml = sheetOrVideoUrl
            ? `<a href="${sheetOrVideoUrl}" target="_blank"
                 onclick="event.stopPropagation();"
                 style="flex:1; text-align:center; ${sheetBtnStyle} padding:8px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:0.9rem;">
                 ${sheetBtnLabel}
               </a>`
            : '';

        let audioBtnsHtml = '';
        if (audioLinks.length > 0) {
            const shown = audioLinks.slice(0, 3);
            shown.forEach((url, idx) => {
                audioBtnsHtml += `
                    <a href="${url}" target="_blank"
                       onclick="event.stopPropagation();"
                       style="flex:1; text-align:center; background:#e3f2fd; color:#1565c0; padding:8px; border-radius:6px; text-decoration:none; font-weight:bold; font-size:0.9rem;">
                       â–¶ï¸ ØµÙˆØª ${shown.length > 1 ? (idx + 1) : ''}
                    </a>
                `;
            });
        }

        html += `
            <div onclick="openMusicDetailsById(${track.id})"
                 style="background:white; border-radius:12px; overflow:hidden; box-shadow:0 4px 15px rgba(0,0,0,0.05); transition:transform 0.2s; border:1px solid #f0f0f0; cursor:pointer;">
                <div style="height:140px; background:#eee; overflow:hidden; position:relative;">
                    <img src="${img}" style="width:100%; height:100%; object-fit:cover;">
                    <span style="position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:white; padding:4px 10px; border-radius:20px; font-size:0.75rem;">
                        ${type || 'ØºÙŠØ± Ù…ØµÙ†Ù‘Ù'}
                    </span>
                </div>

                <div style="padding:15px;">
                    <h3 style="margin:0 0 5px; color:#2c3e50; font-size:1.1rem;">${track.title || '-'}</h3>

                    <div style="display:flex; gap:10px; margin-top:15px; flex-wrap:wrap;">
                        ${sheetBtnHtml}
                        ${audioBtnsHtml}
                    </div>

                    <button onclick="event.stopPropagation(); deleteMusic(${track.id})"
                        style="width:100%; margin-top:10px; background:none; border:none; color:#e57373; cursor:pointer; font-size:0.8rem;">
                        Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©
                    </button>
                </div>
            </div>
        `;
    });

    grid.innerHTML = html;
}


// 2) Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© (Ù…ÙØ­Ø¯Ù‘Ø«Ø© Ø¨Ù†ÙˆØ¹ÙŠÙ† + Ø­Ù‚ÙˆÙ„ Ø´Ø±Ø·ÙŠØ©)
function injectMusicModal() {
  const existing = document.getElementById('musicModal');

  const modalInner = `
    <div id="musicModal" class="music-modal-overlay" style="display:none;">
      <div class="music-modal-card">
        <div class="music-modal-header">
          <h3>â• Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙƒØªØ¨Ø© Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚ÙŠØ©</h3>
          <button class="icon-close" onclick="document.getElementById('musicModal').style.display='none'">âœ•</button>
        </div>

        <div class="music-modal-body">
          <div class="music-grid">

            <div>
              <label class="music-label">Ø§Ù„Ù†ÙˆØ¹</label>
              <select id="mType" class="music-select" onchange="updateMusicModalFields()">
                <option value="Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©">Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ© (ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª)</option>
                <option value="Ù…Ø§Ø±Ø´">Ù…Ø§Ø±Ø´ (Ø¥ÙŠÙ‚Ø§Ø¹ ÙÙ‚Ø·)</option>
              </select>
            </div>

            <div>
              <label class="music-label">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©</label>
              <input type="text" id="mTitle" class="music-input" placeholder="Ù…Ø«Ø§Ù„: March 77 / Sunrise...">
            </div>

            <!-- ===== Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ© ===== -->
            <div id="brassFields" class="music-grid">
              <div>
                <label class="music-label">Ø±ÙØ¹ Ø§Ù„Ù†ÙˆØªØ© PDF</label>
                <input type="file" id="mSheetFile" class="music-input" accept="application/pdf">
                <div class="music-hint">Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„Ù†ÙˆØªØ© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙƒØ¨Ø¯ÙŠÙ„):</div>
                <input type="text" id="mSheet" class="music-input" placeholder="https://...">
              </div>

              <div>
                <label class="music-label">Ø±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù</label>
                <input type="file" id="mImgFile" class="music-input" accept="image/*">
                <div class="music-hint">Ø£Ùˆ Ø¶Ø¹ Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙƒØ¨Ø¯ÙŠÙ„):</div>
                <input type="text" id="mImg" class="music-input" placeholder="https://...">
              </div>
            </div>

            <!-- ===== Ù…Ø§Ø±Ø´ ===== -->
            <div id="marchFields" class="music-grid" style="display:none;">
              <div>
                <label class="music-label">Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ (YouTube/Drive)</label>
                <input type="text" id="mVideo" class="music-input" placeholder="https://...">
              </div>
            </div>

            <!-- ===== Ø§Ù„ØµÙˆØª (Ù…Ø´ØªØ±Ùƒ) ===== -->
            <div>
              <label id="audioLabel" class="music-label">Ø±ÙØ¹ ØªØ³Ø¬ÙŠÙ„Ø§Øª ØµÙˆØªÙŠØ© (ÙŠÙ…ÙƒÙ† Ø£ÙƒØ«Ø± Ù…Ù† Ù…Ù„Ù)</label>
              <input type="file" id="mAudioFiles" class="music-input" accept="audio/*" multiple>
              <div class="music-hint">Ø£Ùˆ Ø¶Ø¹ Ø±ÙˆØ§Ø¨Ø· ØµÙˆØª (Ø§Ø®ØªÙŠØ§Ø±ÙŠ ÙƒØ¨Ø¯ÙŠÙ„) â€” ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¨Ø³Ø·Ø±:</div>
              <textarea id="mAudio" class="music-textarea" placeholder="https://...&#10;https://..."></textarea>
            </div>

            <div class="music-actions">
              <button class="btn-secondary" onclick="document.getElementById('musicModal').style.display='none'">Ø¥Ù„ØºØ§Ø¡</button>
              <button class="btn-primary" onclick="saveMusic()">Ø­ÙØ¸</button>
            </div>

          </div>
        </div>
      </div>
    </div>
  `;

  if (existing) existing.outerHTML = modalInner;
  else document.body.insertAdjacentHTML('beforeend', modalInner);
}


// 3) ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹
window.updateMusicModalFields = function () {
    const type = document.getElementById('mType')?.value || 'Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©';

    const brass = document.getElementById('brassFields');
    const march = document.getElementById('marchFields');
    const audioLabel = document.getElementById('audioLabel');

    if (!brass || !march) return;

    if (type === 'Ù…Ø§Ø±Ø´') {
        brass.style.display = 'none';
        march.style.display = 'block';
        if (audioLabel) audioLabel.textContent = 'Ø±Ø§Ø¨Ø·/Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ØµÙˆØªÙŠ (Ù„Ù„Ø¥ÙŠÙ‚Ø§Ø¹):';
    } else {
        brass.style.display = 'block';
        march.style.display = 'none';
        if (audioLabel) audioLabel.textContent = 'Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØªØ³Ø¬ÙŠÙ„Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ© (ÙŠÙ…ÙƒÙ† Ø¹Ø¯Ø© Ø±ÙˆØ§Ø¨Ø·):';
    }
};

// 4) ÙØªØ­ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ©
window.openAddMusicModal = function () {
  if (!document.getElementById('musicModal')) injectMusicModal();

  document.getElementById('mType').value = 'Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©';
  document.getElementById('mTitle').value = '';

  const sheetEl = document.getElementById('mSheet'); if (sheetEl) sheetEl.value = '';
  const imgEl   = document.getElementById('mImg');   if (imgEl) imgEl.value = '';
  const vidEl   = document.getElementById('mVideo'); if (vidEl) vidEl.value = '';
  document.getElementById('mAudio').value = '';

  const sheetFile = document.getElementById('mSheetFile'); if (sheetFile) sheetFile.value = '';
  const imgFile   = document.getElementById('mImgFile');   if (imgFile) imgFile.value = '';
  const audFiles  = document.getElementById('mAudioFiles');if (audFiles) audFiles.value = '';

  updateMusicModalFields();
  document.getElementById('musicModal').style.display = 'flex';
};


// 5) Ø­ÙØ¸ Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ© (Ø¨Ù†ÙØ³ Ø¬Ø¯ÙˆÙ„ band_music_library)
window.saveMusic = async function () {
    const type  = (document.getElementById('mType').value || '').trim();   // Ù†Ø®Ø²Ù†Ù‡ ÙÙŠ category
    const title = (document.getElementById('mTitle').value || '').trim();

    // Ø±ÙˆØ§Ø¨Ø· Ø§Ø­ØªÙŠØ§Ø·ÙŠØ© (Ø¥Ø°Ø§ Ù…Ø§ Ø±ÙØ¹ Ù…Ù„Ù)
    const sheet = (document.getElementById('mSheet')?.value || '').trim();
    const img   = (document.getElementById('mImg')?.value || '').trim();
    const video = (document.getElementById('mVideo')?.value || '').trim();

    // Ù…Ù„ÙØ§Øª Ù…Ø±ÙÙˆØ¹Ø© (Ø­Ø³Ø¨ Ø®ÙŠØ§Ø± 2)
    const sheetFile = document.getElementById('mSheetFile')?.files?.[0] || null;   // PDF
    const imgFile   = document.getElementById('mImgFile')?.files?.[0] || null;     // Image
    const audioFiles = Array.from(document.getElementById('mAudioFiles')?.files || []); // Audio[]

    // Ø£ØµÙˆØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø©: ÙŠØ§ Ù…Ù„ÙØ§Øª (Ø£ÙØ¶Ù„) Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· (ÙƒÙ„ Ø±Ø§Ø¨Ø· Ø¨Ø³Ø·Ø±)
    const audioRaw = (document.getElementById('mAudio').value || '').trim();
    const audioLinks = audioRaw
        ? audioRaw.split('\n').map(s => s.trim()).filter(Boolean)
        : [];

    if (!title) return alert("Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨");

    // =========================
    // Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©)
    // =========================
    let sheetUrl = '';
    let imgUrl = '';
    let audioUrls = [];

    try {
        // Ø±ÙØ¹ Ø§Ù„ØµÙˆØª (Ø¥Ù† ÙˆØ¬Ø¯ Ù…Ù„ÙØ§Øª) ÙˆØ¥Ù„Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
        if (audioFiles.length > 0) {
            for (const f of audioFiles) {
                const url = await uploadMusicFile(f, `audio/${type === 'Ù…Ø§Ø±Ø´' ? 'march' : 'brass'}`);
                if (url) audioUrls.push(url);
            }
        } else {
            audioUrls = audioLinks;
        }

        // Ø±ÙØ¹ Ø§Ù„Ù†ÙˆØªØ© ÙˆØ§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù…Ø¹Ø²ÙˆÙØ© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ© (Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø±ÙˆØ§Ø¨Ø·)
        if (type === 'Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©') {
            if (sheetFile) sheetUrl = await uploadMusicFile(sheetFile, 'sheets');
            else sheetUrl = sheet;

            if (imgFile) imgUrl = await uploadMusicFile(imgFile, 'covers');
            else imgUrl = img;
        }

    } catch (e) {
        return alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª: " + (e?.message || e));
    }

    // ØªØ­Ù‚Ù‚ Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ (âœ… Ø­Ø³Ø¨ Ø§Ù„Ø§ØªÙØ§Ù‚: Ù†Ø­Ø§Ø³ÙŠ = PDF + ØµÙˆØ±Ø© + ØµÙˆØªØŒ Ù…Ø§Ø±Ø´ = ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØª)
    if (type === 'Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©') {
        if (!sheetUrl) return alert("Ù„Ø§Ø²Ù… ØªØ±ÙØ¹ Ø§Ù„Ù†ÙˆØªØ© PDF Ø£Ùˆ ØªØ¶Ø¹ Ø±Ø§Ø¨Ø·Ù‡Ø§ Ù„Ù„Ù…Ø¹Ø²ÙˆÙØ© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©");
        if (!imgUrl)   return alert("Ù„Ø§Ø²Ù… ØªØ±ÙØ¹ ØµÙˆØ±Ø© Ø§Ù„ØºÙ„Ø§Ù Ø£Ùˆ ØªØ¶Ø¹ Ø±Ø§Ø¨Ø·Ù‡Ø§ Ù„Ù„Ù…Ø¹Ø²ÙˆÙØ© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©");
        if (!audioUrls || audioUrls.length === 0) return alert("Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø¹Ø²ÙˆÙØ© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ© (Ù…Ù„Ù Ø£Ùˆ Ø±Ø§Ø¨Ø·)");
    } else if (type === 'Ù…Ø§Ø±Ø´') {
        if (!video) return alert("Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ù…Ø§Ø±Ø´");
        if (!audioUrls || audioUrls.length === 0) return alert("Ù„Ø§Ø²Ù… ØªØ¶ÙŠÙ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù„Ù„Ù…Ø§Ø±Ø´ (Ù…Ù„Ù Ø£Ùˆ Ø±Ø§Ø¨Ø·)");
    } else {
        return alert("Ø§Ø®ØªØ± Ù†ÙˆØ¹ ØµØ­ÙŠØ­");
    }

    // Ø§Ù„ØªØ®Ø²ÙŠÙ†:
    // - category = Ø§Ù„Ù†ÙˆØ¹
    // - Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©: sheet_url = Ø±Ø§Ø¨Ø· PDF (Ù…Ø±ÙÙˆØ¹ Ø£Ùˆ Ø±Ø§Ø¨Ø·), image_url = Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© (Ù…Ø±ÙÙˆØ¹Ø© Ø£Ùˆ Ø±Ø§Ø¨Ø·)
    // - Ù…Ø§Ø±Ø´: sheet_url = Ø±Ø§Ø¨Ø· Ø§Ù„ÙÙŠØ¯ÙŠÙˆ, image_url = (ÙØ§Ø±Øº)
    // - audio_url: Ù†Ø®Ø²Ù† ÙƒÙ„ Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙƒØ³Ø·ÙˆØ± (Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø±ÙˆØ§Ø¨Ø· Ø®Ø§Ø±Ø¬ÙŠØ©)
    const payload = {
        title,
        category: type,
        sheet_url: (type === 'Ù…Ø§Ø±Ø´') ? video : sheetUrl,
        audio_url: (audioUrls || []).join('\n'),
        image_url: (type === 'Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ©') ? imgUrl : null
    };

    const { error } = await supabaseClient
        .from('band_music_library')
        .insert([payload]);

    if (error) {
        alert("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­ÙØ¸: " + error.message);
        return;
    }

    document.getElementById('musicModal').style.display = 'none';
    loadMusicLibrary();
};

// 6) Ø­Ø°Ù
window.deleteMusic = async function (id) {
    if (!confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©ØŸ")) return;

    const { error } = await supabaseClient
        .from('band_music_library')
        .delete()
        .eq('id', id);

    if (error) {
        alert("Ø®Ø·Ø£ Ø¨Ø§Ù„Ø­Ø°Ù: " + error.message);
        return;
    }

    loadMusicLibrary();
};


window.switchBandTab = function(tabId, btnElement) {
    // 1. Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù†ÙˆØ§ÙØ° (ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù‡Ù†Ø§ ØªØ·Ø§Ø¨Ù‚ HTML)
    const allTabs = ['tabRequests', 'tabMembers', 'tabInventory', 'tabMusic'];

    // 2. Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¬Ù…ÙŠØ¹ (ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø´Ø§Ø´Ø©)
    allTabs.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.style.display = 'none';
    });

    // 3. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·
    const target = document.getElementById(tabId);
    if (target) {
        target.style.display = 'block';
    } else {
        console.error("Ø§Ù„Ù†Ø§ÙØ°Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©: " + tabId);
    }

    // 4. ØªØ­Ø¯ÙŠØ« Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© (ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ø²Ø± Ø§Ù„Ù†Ø´Ø·)
    document.querySelectorAll('.band-tab-btn').forEach(btn => btn.classList.remove('active-band-tab'));
    if (btnElement) btnElement.classList.add('active-band-tab');
}

// ==========================================
// ğŸ‘¥ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† (Band Members)
// ==========================================
// ==========================================
// ğŸ‘¥ Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† (Ù…ØµØ­Ø­Ø© Ù„ØªÙ‚Ø±Ø£ Ù…Ù† band_members)
// ==========================================

// ==========================================
// ğŸ» Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø¯)
// ==========================================

// Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø¹Ø´Ø§Ù† Ø§Ù„ÙÙ„ØªØ±Ø© ØªÙƒÙˆÙ† Ø³Ø±ÙŠØ¹Ø©)


// Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… (Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø¹Ù† Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ø­Ù„Ùˆ ÙˆØ§Ù„ÙÙ„Ø§ØªØ±)
window.renderBandTables = function() {
    // âœ… Ø­Ù…Ø§ÙŠØ©: Ø¥Ø°Ø§ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù…Ùˆ Ø¬Ø§Ù‡Ø²
const attendanceDataSafe = Array.isArray(allAttendanceData) ? allAttendanceData : [];

const container =
  document.getElementById('bandMembersTable') ||
  document.getElementById('tabMembers');
    
    // Ø¬Ù„Ø¨ Ù‚ÙŠÙ… Ø§Ù„ÙÙ„Ø§ØªØ± (Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©)
    const rawFilterName = document.getElementById('filterName')?.value || '';
    const filterName = rawFilterName.toLowerCase();

    // âœ… ØªØ¹Ø¯ÙŠÙ„ ØµØºÙŠØ±: Ø¥Ø°Ø§ Ø§Ù„Ù‚ÙŠÙ…Ø© "ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª" Ø§Ø¹ØªØ¨Ø±Ù‡Ø§ Ù…Ø«Ù„ Ø§Ù„ÙØ§Ø¶ÙŠ
    let filterInst = (document.getElementById('filterInst')?.value || '').trim();
    if (filterInst === 'ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª') filterInst = '';

    // ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const filteredMembers = allBandMembersData.filter(m => {
        const matchName = (m.name || '').toLowerCase().includes(filterName);
        const inst = (m.main_instrument || '').trim();
        const matchInst = filterInst === '' || inst === filterInst;
        return matchName && matchInst;
    });

    // ... (Ø®Ù„ÙŠ Ø¨Ø§Ù‚ÙŠ ÙƒÙˆØ¯Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ Ø¨Ø¯ÙˆÙ† Ø£ÙŠ ØªØºÙŠÙŠØ±)

    // ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙØ±Ù‚Ø© (Ø£Ø³Ø§Ø³ÙŠØ© / Ø±Ø¯ÙŠÙØ© / Ù…Ø³ØªØ¬Ø¯)
    // âœ… ØªØ¹Ø¯ÙŠÙ„: trim Ù„Ù„ØªØµÙ†ÙŠÙ + ØºÙŠØ± Ø§Ù„Ù…ØµÙ†Ù‘ÙÙŠÙ† Ø¶Ù…Ù† "Ù…Ø³ØªØ¬Ø¯/ØºÙŠØ± Ù…ØµÙ†Ù" ÙƒÙ…Ø§ Ù‡Ùˆ
    const mainBand = filteredMembers.filter(m => (m.band_category || '').trim() === 'Ø£Ø³Ø§Ø³ÙŠØ©');
    const reserveBand = filteredMembers.filter(m => (m.band_category || '').trim() === 'Ø±Ø¯ÙŠÙØ©');
    const others = filteredMembers.filter(m => {
        const cat = (m.band_category || '').trim();
        return cat !== 'Ø£Ø³Ø§Ø³ÙŠØ©' && cat !== 'Ø±Ø¯ÙŠÙØ©';
    });

    // Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù†Ø´Ø§Ø·Ø§Øª (Ù„Ù„Ù…Ù‚Ø§Ù… ÙÙŠ Ø§Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø¦ÙˆÙŠØ©)
    const totalTrainings = new Set(attendanceDataSafe.filter(r => r.activity_type === 'ØªØ¯Ø±ÙŠØ¨').map(r => r.attendance_date)).size;
    const totalShows = new Set(attendanceDataSafe.filter(r => r.activity_type === 'Ø¹Ø±Ø¶').map(r => r.attendance_date)).size;

    // Ø¨Ù†Ø§Ø¡ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© (HTML)
    let html = `
        <div style="background:white; padding:20px; border-radius:15px; box-shadow:0 4px 15px rgba(0,0,0,0.05);">
            
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; flex-wrap:wrap; gap:10px;">
                <h3 style="margin:0; color:#2c3e50;">ğŸ‘¥ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ø²ÙÙŠÙ† Ø§Ù„Ù…ÙˆØ­Ø¯</h3>
                <div style="display:flex; gap:10px;">
                    <button onclick="openBandAttendanceModal()" style="background:#27ae60; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold;">ğŸ“… Ø£Ø®Ø° Ø§Ù„ØªÙÙ‚Ø¯</button>
                    <button onclick="loadBandMembers()" style="background:#1a237e; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer;">ğŸ”„ ØªØ­Ø¯ÙŠØ«</button>
                </div>
            </div>

           <div class="band-filters" style="
  background:#f8f9fa;
  padding:15px;
  border-radius:10px;
  border:1px solid #eee;
  margin-bottom:25px;
  display:flex;
  gap:10px;
  flex-wrap:wrap;     /* âœ… Ù…Ù‡Ù… Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ */
  align-items:stretch;
">
  <input
    type="text"
    id="filterName"
    placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ø³Ù…..."
    onkeyup="renderBandTables()"
    value="${rawFilterName}"
    style="
      flex: 2 1 260px;     /* âœ… Ø¨ÙŠØ§Ø®Ø¯ Ù…Ø³Ø§Ø­Ø© Ø¨Ø³ Ø¨ÙŠÙ†Ø²Ù„ Ø³Ø·Ø± Ø¥Ø°Ø§ Ø¶Ø§Ù‚ */
      min-width: 200px;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
    "
  >

  <select
    id="filterInst"
    onchange="renderBandTables()"
    style="
      flex: 1 1 160px;
      min-width: 160px;
      padding:10px;
      border:1px solid #ccc;
      border-radius:6px;
    "
  >
    <option value="">ğŸ¹ ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª</option>
    <option value="ØªØ±ÙˆÙ…Ø¨ÙŠØª" ${filterInst==='ØªØ±ÙˆÙ…Ø¨ÙŠØª'?'selected':''}>ØªØ±ÙˆÙ…Ø¨ÙŠØª</option>
    <option value="Ø³Ø­Ø§Ø¨" ${filterInst==='Ø³Ø­Ø§Ø¨'?'selected':''}>Ø³Ø­Ø§Ø¨</option>
    <option value="Ø¨Ø±ÙŠØªÙˆÙ†" ${filterInst==='Ø¨Ø±ÙŠØªÙˆÙ†'?'selected':''}>Ø¨Ø±ÙŠØªÙˆÙ†</option>
    <option value="Ø¨Ø³ØªÙˆÙ†" ${filterInst==='Ø¨Ø³ØªÙˆÙ†'?'selected':''}>Ø¨Ø³ØªÙˆÙ†</option>
    <option value="Ø¨ØªÙƒÙŠØ³" ${filterInst==='Ø¨ØªÙƒÙŠØ³'?'selected':''}>Ø¨ØªÙƒÙŠØ³</option>
    <option value="Ø·Ø¨Ù„" ${filterInst==='Ø·Ø¨Ù„'?'selected':''}>Ø·Ø¨Ù„</option>
    <option value="Ù…Ø«Ù„Ø«" ${filterInst==='Ù…Ø«Ù„Ø«'?'selected':''}>Ù…Ø«Ù„Ø«</option>
  </select>
</div>

<div class="band-stats" style="
  margin-bottom:20px;
  color:#555;
  background:#e3f2fd;
  padding:10px;
  border-radius:8px;
  display:block;       /* âœ… Ø¨Ø¯Ù„ inline-block */
  width:100%;
  text-align:center;
">
  ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ÙÙˆØ¬: <b>${totalTrainings}</b> ØªØ¯Ø±ÙŠØ¨ | <b>${totalShows}</b> Ø¹Ø±Ø¶ Ø±Ø³Ù…ÙŠ.
</div>

    `;

    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ù…Ù‚Ø³Ù…Ø©
    // âœ… ØªØ¹Ø¯ÙŠÙ„: Ø¹Ø±Ø¶ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¯Ø§Ø¦Ù…Ø§Ù‹ Ø­ØªÙ‰ Ù„Ùˆ 0 (Ø­ØªÙ‰ "Ø§Ù„Ø±Ø¯ÙŠÙØ©" ØªØ¸Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹)
    html += `<h4 style="color:#d35400; border-bottom:3px solid #d35400; display:inline-block; margin-top:10px; padding-bottom:5px;">ğŸ¥‡ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (${mainBand.length})</h4>`;
    html += generateHTMLTable(mainBand, totalTrainings, totalShows);

    html += `<br><h4 style="color:#7f8c8d; border-bottom:3px solid #7f8c8d; display:inline-block; margin-top:30px; padding-bottom:5px;">ğŸ¥ˆ Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ø±Ø¯ÙŠÙØ© (${reserveBand.length})</h4>`;
    html += generateHTMLTable(reserveBand, totalTrainings, totalShows);

    // âœ… Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ others ÙƒÙ…Ø§ Ù‡Ùˆ: ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙÙŠÙ‡ Ø¹Ù†Ø§ØµØ±
    if(others.length > 0) {
        html += `<br><h4 style="color:#333; border-bottom:3px solid #333; display:inline-block; margin-top:30px; padding-bottom:5px;">ğŸ“‹ Ù…Ø³ØªØ¬Ø¯ÙŠÙ† / ØºÙŠØ± Ù…ØµÙ†Ù (${others.length})</h4>`;
        html += generateHTMLTable(others, totalTrainings, totalShows);
    }

    container.innerHTML = html + `</div>`;
    
    // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ÙƒÙŠØ² (Focus) Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø¤Ø´Ø± Ù…Ø§ ÙŠØ¶ÙŠØ¹ ÙˆÙ‚Øª Ø§Ù„ÙƒØªØ§Ø¨Ø©
    const inputField = document.getElementById('filterName');
    if(inputField) {
        inputField.focus();
        const val = inputField.value; inputField.value = ''; inputField.value = val;
    }
}


// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø±Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙˆØ§Ø­Ø¯
function generateHTMLTable(membersList, totalTrainings, totalShows) {
    let tableHtml = `
        <table style="width:100%; border-collapse: collapse; text-align: right; margin-top:10px; background:white;">
            <thead style="background: #fff3e0; color: #e65100;">
                <tr>
                    <th style="padding:12px;">Ø§Ù„Ø§Ø³Ù…</th>
                    <th style="padding:12px;">Ø§Ù„Ø¢Ù„Ø©</th>
                    <th style="padding:12px; text-align:center;">ğŸ» Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨</th>
                    <th style="padding:12px; text-align:center;">ğŸº Ø§Ù„ØªØ²Ø§Ù… Ø§Ù„Ø¹Ø±ÙˆØ¶</th>
                    <th style="padding:12px;">Ø§Ù„Ø±ØªØ¨Ø©</th>
                </tr>
            </thead>
            <tbody>
    `;

    membersList.forEach(member => {
        // âœ…âœ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† ØªØºÙŠÙŠØ± Ø´ÙƒÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„)
        // Ù†Ø´ØªØºÙ„ Ø¹Ù„Ù‰ "ØªÙˆØ§Ø±ÙŠØ® ÙØ±ÙŠØ¯Ø©" Ø­ØªÙ‰ Ù…Ø§ ØªØªØ¶Ø®Ù… Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ù„Ùˆ ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ù…ÙƒØ±Ø±Ø©

        // --- ØªØ¯Ø±ÙŠØ¨ ---
        const trainRows = allAttendanceData.filter(r =>
            r.member_name === member.name &&
            r.activity_type === 'ØªØ¯Ø±ÙŠØ¨'
        );

        const trainPresentDates = new Set(trainRows.filter(r => r.status === 'Ø­Ø¶ÙˆØ±').map(r => r.attendance_date));
        const trainAbsentDates  = new Set(trainRows.filter(r => r.status === 'ØºÙŠØ§Ø¨').map(r => r.attendance_date));
        const trainExcusedDates = new Set(trainRows.filter(r => r.status === 'Ø¨Ø¹Ø°Ø±').map(r => r.attendance_date));

        // âœ… Ø¨Ø¹Ø°Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ù‚Ø§Ù…
        const trainDenomDates = new Set([...trainPresentDates, ...trainAbsentDates]);
        const myTrainings = trainPresentDates.size;      // Ù‡Ø°Ø§ Ù‡Ùˆ "Ø­Ø¶ÙˆØ±" Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
        const trainDenom = trainDenomDates.size;         // Ø§Ù„Ù…Ù‚Ø§Ù… (Ø­Ø¶ÙˆØ± + ØºÙŠØ§Ø¨)
        const trainRate = trainDenom > 0 ? Math.round((myTrainings / trainDenom) * 100) : 0;

        // --- Ø¹Ø±ÙˆØ¶ ---
        const showRows = allAttendanceData.filter(r =>
            r.member_name === member.name &&
            r.activity_type === 'Ø¹Ø±Ø¶'
        );

        const showPresentDates = new Set(showRows.filter(r => r.status === 'Ø­Ø¶ÙˆØ±').map(r => r.attendance_date));
        const showAbsentDates  = new Set(showRows.filter(r => r.status === 'ØºÙŠØ§Ø¨').map(r => r.attendance_date));
        const showExcusedDates = new Set(showRows.filter(r => r.status === 'Ø¨Ø¹Ø°Ø±').map(r => r.attendance_date));

        const showDenomDates = new Set([...showPresentDates, ...showAbsentDates]);
        const myShows = showPresentDates.size;
        const showDenom = showDenomDates.size;
        const showRate = showDenom > 0 ? Math.round((myShows / showDenom) * 100) : 0;

        // ØªÙ„ÙˆÙŠÙ† Ø§Ù„Ù†Ø³Ø¨ (Ø£Ø®Ø¶Ø± Ù„Ù„Ù…Ù…ØªØ§Ø²ØŒ Ø£Ø­Ù…Ø± Ù„Ù„Ø¶Ø¹ÙŠÙ)
        const trainColor = trainRate >= 75 ? '#2e7d32' : (trainRate >= 50 ? '#f57f17' : '#c62828');
        const showColor  = showRate  >= 75 ? '#2e7d32' : (showRate  >= 50 ? '#f57f17' : '#c62828');

        tableHtml += `
            <tr style="border-bottom: 1px solid #eee; transition:0.2s;" onmouseover="this.style.background='#fafafa'" onmouseout="this.style.background='white'">
                <td style="padding:12px; font-weight:bold;">${member.name}</td>
                <td style="padding:12px;">
                    <span style="background: #e1f5fe; color: #0277bd; padding: 4px 10px; border-radius: 15px; font-size: 0.85rem;">
                        ${member.main_instrument || '-'}
                    </span>
                </td>

                <td style="padding:12px; text-align:center;">
                    <span style="color:${trainColor}; font-weight:bold; font-size:1.1rem;">${trainRate}%</span>
                    <!-- âœ… Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ØµØºÙŠØ± ØµØ§Ø± ÙŠØ¨ÙŠÙ† (Ø­Ø¶ÙˆØ±/Ø§Ù„Ù…Ù‚Ø§Ù…) Ù„ÙŠØªØºÙŠØ± Ù…Ø¹ Ø§Ù„ØºÙŠØ§Ø¨ -->
                    <span style="font-size:0.8rem; color:#888;">(${myTrainings}/${trainDenom})</span>
                </td>

                <td style="padding:12px; text-align:center;">
                    <span style="color:${showColor}; font-weight:bold; font-size:1.1rem;">${showRate}%</span>
                    <span style="font-size:0.8rem; color:#888;">(${myShows}/${showDenom})</span>
                </td>

                <td style="padding:12px; font-size:0.9rem;">${member.rank || 'Ù…Ø¨ØªØ¯Ø¦'}</td>
            </tr>
        `;
    });

    tableHtml += `</tbody></table>`;
    return tableHtml;
}




// âœ… Fix: Ø­Ù„ ØªØ¹Ø§Ø±Ø¶ openAddItemModal Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¹Ø§Ù… ÙˆØ§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù†Ø­Ø§Ø³ÙŠ
(function () {
  const oldOpenAddItemModal = window.openAddItemModal;

  window.openAddItemModal = function (category) {
    // Ø¥Ø°Ø§ ÙÙŠ Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± => Ù‡Ø°Ø§ Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ù†Ø­Ø§Ø³ÙŠ
    if (typeof category === "string" && category.trim() !== "") {
      // ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ù…Ø­Ù‚ÙˆÙ†Ø©
      let modal = document.getElementById("addItemModal");
      if (!modal) {
        if (typeof window.injectModals === "function") window.injectModals();
        modal = document.getElementById("addItemModal");
      }
      if (!modal) {
        alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¥Ø¶Ø§ÙØ© addItemModal. ØªØ£ÙƒØ¯ Ø£Ù† injectModals ØªØ¹Ù…Ù„.");
        return;
      }

      // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      const cat = category.trim();
      const titleEl = document.getElementById("modalTitleAdd");
      const inCat = document.getElementById("inCat");
      const inName = document.getElementById("inName");
      const inLoc = document.getElementById("inLoc");
      const inQty = document.getElementById("inQty");
      const inStatus = document.getElementById("inStatus");

      if (inCat) inCat.value = cat;

      if (titleEl) {
        if (cat === "Ù„Ø¨Ø§Ø³") titleEl.innerText = "â• Ø¥Ø¶Ø§ÙØ© Ù„Ø¨Ø§Ø³ Ø¬Ø¯ÙŠØ¯";
        else if (cat === "Ø¢Ù„Ø§Øª") titleEl.innerText = "â• Ø¥Ø¶Ø§ÙØ© Ø¢Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        else if (cat === "Ø£Ø¯ÙˆØ§Øª") titleEl.innerText = "â• Ø¥Ø¶Ø§ÙØ© Ø£Ø¯Ø§Ø© Ø¬Ø¯ÙŠØ¯Ø©";
        else titleEl.innerText = "â• Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©";
      }

      // ØªØµÙÙŠØ± Ø§Ù„Ø­Ù‚ÙˆÙ„
      if (inName) inName.value = "";
      if (inLoc) inLoc.value = "";
      if (inQty) inQty.value = 1;

      // Ù‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ø§Ù„Ø© (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©)
      if (inStatus) {
        // Ø¬Ø±Ù‘Ø¨ "Ø¬ÙŠØ¯" Ø£ÙˆÙ„Ø§Ù‹ØŒ ÙˆØ¥Ø°Ø§ Ù…Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø© Ø®Ù„Ù‘Ù‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ
        const hasGood = Array.from(inStatus.options || []).some(o => o.value === "Ø¬ÙŠØ¯");
        if (hasGood) inStatus.value = "Ø¬ÙŠØ¯";
      }

      // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­ (Ù„Ø§Ø²Ù… flex Ø­ØªÙ‰ ÙŠØ´ØªØºÙ„ Ø§Ù„ØªÙˆØ³ÙŠØ·)
      modal.style.display = "flex";
      modal.style.zIndex = "99999"; // Ø§Ø­ØªÙŠØ§Ø·Ø§Ù‹ Ù„Ùˆ ÙÙŠ Ø·Ø¨Ù‚Ø§Øª ÙÙˆÙ‚Ù‡

      return;
    }

    // Ø¨Ø¯ÙˆÙ† Ø¨Ø§Ø±Ø§Ù…ÙŠØªØ± => Ø±Ø¬Ù‘Ø¹ Ù„Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø§Ù„Ø¹Ø§Ù… Ù…Ø«Ù„Ø§Ù‹)
    if (typeof oldOpenAddItemModal === "function") {
      return oldOpenAddItemModal();
    }
  };
})();

// ===== Supabase Storage Upload Helper (band-music) =====
const MUSIC_BUCKET = 'band-music';

function safeFileName(name) {
  return (name || 'file')
    .toString()
    .trim()
    .replace(/\s+/g, '_')
    .replace(/[^\w.\-]+/g, '');
}

async function uploadMusicFile(file, folder) {
  if (!file) return null;

  const ext = (file.name.split('.').pop() || '').toLowerCase();
  const base = safeFileName(file.name.replace(/\.[^/.]+$/, ''));
  const path = `${folder}/${Date.now()}_${Math.random().toString(16).slice(2)}_${base}.${ext}`;

  const { error } = await supabaseClient
    .storage
    .from(MUSIC_BUCKET)
    .upload(path, file, { upsert: true });

  if (error) throw error;

  const { data } = supabaseClient
    .storage
    .from(MUSIC_BUCKET)
    .getPublicUrl(path);

  return data?.publicUrl || null;
}

// ===== Music Details Modal Logic =====
function injectMusicDetailsModal() {
  if (document.getElementById('musicDetailsModal')) return;

  const html = `
<div id="musicDetailsModal" class="music-modal-overlay hidden" style="display:none; position:fixed; inset:0; z-index:999999;">
      <div class="music-modal-card">
        <div class="music-modal-header">
          <h3 style="margin:0; font-size:1.05rem; font-weight:800;">ğŸ¼ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©</h3>
          <button class="icon-close" onclick="closeMusicDetailsModal()">âœ•</button>
        </div>

        <div class="music-modal-body" id="musicDetailsBody">
          <!-- ÙŠÙÙ…Ù„Ø£ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
        </div>
      </div>
    </div>
  `;
  document.body.insertAdjacentHTML('beforeend', html);
}

window.closeMusicDetailsModal = function () {
  const m = document.getElementById('musicDetailsModal');
  if (m) m.style.display = 'none';
};

window.openMusicDetailsById = function (id) {
    console.log("openMusicDetailsById called with:", id);

  try {
    injectMusicDetailsModal();
    const track = window.musicItemsById?.[id];
    if (!track) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©");

    const type = (track.category || 'ØºÙŠØ± Ù…ØµÙ†Ù‘Ù').trim();
    const isMarch = type === 'Ù…Ø§Ø±Ø´';

    // Ø±ÙˆØ§Ø¨Ø· Ø§Ù„ØµÙˆØª (Ù…Ø®Ø²Ù†Ø© ÙƒØ³Ø·ÙˆØ±)
    const audioRaw = (track.audio_url || '').trim();
    const audioLinks = audioRaw ? audioRaw.split('\n').map(s => s.trim()).filter(Boolean) : [];

    // sheet_url: Ù„Ù„Ù†Ø­Ø§Ø³ÙŠ = Ù†ÙˆØªØ©ØŒ Ù„Ù„Ù…Ø§Ø±Ø´ = ÙÙŠØ¯ÙŠÙˆ (Ø­Ø³Ø¨ Ù†Ø¸Ø§Ù…Ùƒ)
    const mainUrl = (track.sheet_url || '').trim();

    // ØµÙˆØ±Ø©: Ø¥Ø°Ø§ Ù…ÙÙ‚ÙˆØ¯Ø© Ø§Ø¹Ø±Ø¶ placeholder Ø¯Ø§Ø®Ù„ÙŠ (Ø¨Ø¯ÙˆÙ† Ø¥Ù†ØªØ±Ù†Øª)
    const fallbackCover = "data:image/svg+xml;utf8," + encodeURIComponent(`
      <svg xmlns='http://www.w3.org/2000/svg' width='800' height='400'>
        <defs>
          <linearGradient id='g' x1='0' x2='1'>
            <stop offset='0' stop-color='#ede7f6'/>
            <stop offset='1' stop-color='#fff'/>
          </linearGradient>
        </defs>
        <rect width='100%' height='100%' fill='url(#g)'/>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'
              font-family='Arial' font-size='36' fill='#5e35b1'>Music Cover</text>
      </svg>
    `);

    const cover = (track.image_url && track.image_url.trim()) ? track.image_url.trim() : fallbackCover;

    // Ø¨Ù†Ø§Ø¡ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø±ÙˆØ§Ø¨Ø·
    let actions = '';

    if (mainUrl) {
      actions += isMarch
        ? `<a class="link-btn video" href="${mainUrl}" target="_blank">ğŸ¥ ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø§Ø±Ø´</a>`
        : `<a class="link-btn sheet" href="${mainUrl}" target="_blank">ğŸ“„ Ø§Ù„Ù†ÙˆØªØ©</a>`;
    }

    if (audioLinks.length > 0) {
      audioLinks.forEach((u, idx) => {
        actions += `<a class="link-btn audio" href="${u}" target="_blank">â–¶ï¸ ØªØ³Ø¬ÙŠÙ„ ${audioLinks.length > 1 ? (idx + 1) : ''}</a>`;
      });

      // âœ… Ø§Ù„Ø¥ØµÙ„Ø§Ø­ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡ ÙÙ‚Ø·: Ø¥Ø¶Ø§ÙØ© Ù…Ø´ØºÙ‘Ù„ ØµÙˆØª Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø§ÙØ°Ø© (Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù Ø§Ù„Ø£Ø²Ø±Ø§Ø±)
      actions += `<div style="width:100%; margin-top:10px;"></div>`;
      audioLinks.forEach((u, idx) => {
        actions += `
          <div style="width:100%; margin-top:8px; padding:10px; border:1px solid #e5e7eb; border-radius:12px; background:#f9fafb;">
            <div style="font-weight:800; color:#374151; margin-bottom:6px;">ğŸ§ ØªØ´ØºÙŠÙ„ Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ${audioLinks.length > 1 ? (idx + 1) : ''}</div>
            <audio controls style="width:100%;">
              <source src="${u}">
            </audio>
          </div>
        `;
      });

    } else {
      actions += `<div style="color:#9ca3af; font-weight:700; margin-top:6px;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ÙˆØ§Ø¨Ø· ØµÙˆØª Ù…Ø³Ø¬Ù„Ø©</div>`;
    }

    const body = document.getElementById('musicDetailsBody');
    body.innerHTML = `
      <div class="details-cover">
        <img src="${cover}" alt="cover">
      </div>

      <div class="badge">${type}</div>
      <h2 class="details-title">${track.title || '-'}</h2>

      <div style="color:#6b7280; font-weight:700; font-size:.9rem; margin-bottom:10px;">
        ${isMarch ? "Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹ Ù…Ø®ØµØµ Ù„Ù„Ø¢Ù„Ø§Øª Ø§Ù„Ø¥ÙŠÙ‚Ø§Ø¹ÙŠØ© (Ù…Ø§Ø±Ø´)." : "Ù‡Ø°Ù‡ Ù…Ø¹Ø²ÙˆÙØ© Ù†Ø­Ø§Ø³ÙŠØ© (ØªØ´ØªØ±Ùƒ ÙÙŠÙ‡Ø§ ÙƒÙ„ Ø§Ù„Ø¢Ù„Ø§Øª)."}
      </div>

      <div class="details-actions">
        ${actions}
      </div>

      <button class="danger-btn" onclick="deleteMusic(${track.id}); closeMusicDetailsModal();">
        ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ø¹Ø²ÙˆÙØ©
      </button>
    `;

const modal = document.getElementById('musicDetailsModal');
if (!modal) return alert("âŒ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯");

modal.classList.remove('hidden');                 // âœ… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø®ÙÙŠ Ø¨ÙƒÙ„Ø§Ø³ hidden
modal.style.cssText += `
  display: flex !important;                       /* âœ… Ø¥Ø°Ø§ ÙÙŠ display:none !important */
  position: fixed;
  inset: 0;
  z-index: 999999;
`;
  } catch (e) {
    alert("Ø®Ø·Ø£ Ø¨ÙØªØ­ Ø§Ù„ØªÙØ§ØµÙŠÙ„: " + (e?.message || e));
  }
};

function hardResetOverlays() {
  // Ø³ÙƒÙ‘Ø± Ø£ÙŠ Ù…ÙˆØ¯Ø§Ù„Ø§Øª
  document.querySelectorAll('.modal').forEach(m => {
    m.classList.add('hidden');
    m.style.removeProperty('display');
  });

  // Ø³ÙƒÙ‘Ø± overlay ØªØ¨Ø¹ Ø§Ù„Ù…ÙˆØ³ÙŠÙ‚Ù‰ (Ù…Ø«Ù„ Ù…Ø§ Ø¹Ù†Ø¯Ùƒ)
  document.querySelectorAll('.music-modal-overlay').forEach(o => {
    o.style.display = 'none';
  });

  // Ø£Ù‡Ù… Ù†Ù‚Ø·Ø©: Ø´ÙŠÙ„ Ø£ÙŠ blur/lock Ù…Ø¹Ù…ÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  document.body.classList.remove('modal-open', 'blur', 'blurred', 'no-scroll', 'stop-scroll');
  document.documentElement.classList.remove('no-scroll', 'stop-scroll');

  // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ø³ØªØ§ÙŠÙ„ inline Ø¹Ø§Ù…Ù„ Ù‚ÙÙ„ scroll
  document.body.style.removeProperty('overflow');
}

function resetUIToLogin() {
  // 1) Ø¥Ø®ÙØ§Ø¡ ÙƒÙ„ Ø§Ù„Ø´Ø§Ø´Ø§Øª/Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„Ø§Øª Ø§Ù„Ù…ÙØªÙˆØ­Ø©
  document.querySelectorAll('.glass-panel').forEach(el => {
    el.classList.add('hidden');
    el.style.removeProperty('display'); // Ø£Ùˆ: el.style.display = '';
  });

  // 2) Ø¥ØºÙ„Ø§Ù‚ Ø£ÙŠ Ù…ÙˆØ¯Ø§Ù„Ø§Øª/overlayØ§Øª Ù…ÙØªÙˆØ­Ø© (Ø¨Ø¯ÙˆÙ† ØªØ®Ø±ÙŠØ¨ display Ø§Ù„Ø£ØµÙ„ÙŠ)

  // âœ… Ø§Ù„Ù…ÙˆØ¯Ø§Ù„Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©: Ø®Ø¨ÙŠÙ‡Ø§ Ø¨Ù€ hidden + Ø§Ø­Ø°Ù override ØªØ¨Ø¹ display
  document.querySelectorAll('.modal').forEach(m => {
    m.classList.add('hidden');          // ÙŠØ®ÙÙŠÙ‡Ø§ Ø¹Ø¨Ø± CSS
    m.style.removeProperty('display');  // ÙŠÙ„ØºÙŠ Ø£ÙŠ display override
  });

  // âœ… overlays (Ø³Ø¨Ø¨ Ø§Ù„ØªØºØ¨ÙŠØ´ ØºØ§Ù„Ø¨Ø§Ù‹): Ø³ÙƒÙ‘Ø±Ù‡Ø§ Ø¨Ù€ display:none
  // (Ø¶ÙŠÙØª Ù‡Ù†Ø§ selectors Ø²ÙŠØ§Ø¯Ø© Ø­ØªÙ‰ ÙŠØ´Ù…Ù„ Ø£ÙŠ Overlay Ø¹Ù†Ø¯Ùƒ)
  document.querySelectorAll(
    '.music-modal-overlay, .modal-overlay, .overlay, #modalOverlay, #overlay, .backdrop'
  ).forEach(o => {
    o.style.display = 'none';
    o.classList.add('hidden');          // Ø§Ø­ØªÙŠØ§Ø· Ø¥Ø°Ø§ overlay Ù…Ø®ÙÙŠ Ø¨Ù€ class
  });

  // âœ…âœ… ØªÙ†Ø¸ÙŠÙ Ø£ÙŠ â€œÙ‚ÙÙ„â€ Ø¹Ø§Ù… Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© (Ù…Ù‡Ù… Ù„Ù…Ø´ÙƒÙ„Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ù…Ø§ Ø¹Ù… ØªÙ†ÙƒØ¨Ø³)
  document.body.classList.remove(
    'modal-open', 'blur', 'blurred', 'no-scroll', 'stop-scroll', 'lock-scroll'
  );
  document.documentElement.classList.remove(
    'no-scroll', 'stop-scroll', 'lock-scroll'
  );
  document.body.style.removeProperty('overflow');
  document.body.style.removeProperty('pointer-events');
  document.documentElement.style.removeProperty('overflow');

  // âœ…âœ… ÙƒÙ…Ø§Ù† Ø§Ø­ØªÙŠØ§Ø·: Ø¥Ø°Ø§ ÙÙŠ overlay Ø¹Ù„ÙŠÙ‡ pointer-events Ø´ØºØ§Ù„
  document.querySelectorAll(
    '.modal, .music-modal-overlay, .modal-overlay, .overlay, #modalOverlay, #overlay, .backdrop'
  ).forEach(o => {
    o.style.removeProperty('pointer-events');
  });

  // 3) ØªÙØ±ÙŠØº Ø§Ù„Ø´Ø§Ø´Ø§Øª Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ© Ø§Ù„ØªÙŠ ØªÙØ¨Ù†Ù‰ Ø¨Ø§Ù„Ù€ innerHTML (Ø§Ø®ØªÙŠØ§Ø±ÙŠ Ù„ÙƒÙ† ÙŠØ±ÙŠØ­)
  const idsToClear = [
    'screenBand',
    'tabMembers',
    'tabInventory',
    'tabMusic',
    'tabRequests',

    // âœ… Ø¥Ø¶Ø§ÙØ© Ø¢Ù…Ù†Ø© Ù„Ù„Ù…Ø³ØªÙˆØ¯Ø¹ (Ù„Ø£Ù† ÙˆØ§Ø¬Ù‡ØªÙ‡ Ù…Ø¨Ù†ÙŠØ© Ø¨Ù€ innerHTML)
    'warehouseContent'
  ];
  idsToClear.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.innerHTML = '';
  });

  // âœ… Ø¥Ø¶Ø§ÙØ© Ø¢Ù…Ù†Ø©: Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¥Ù† ÙƒØ§Ù†Øª Ù…ÙØªÙˆØ­Ø©
  const whArchive = document.getElementById('screenWarehouseArchive');
  if (whArchive) whArchive.classList.add('hidden');

  // 4) ØªØµÙÙŠØ± Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ)
  window.currentUser = null;
  window.currentProfile = null;
  window.allBandMembersData = [];
  window.allAttendanceData = [];
  window.musicItemsById = {};

  // âœ… Ø¥Ø¶Ø§ÙØ© Ø¢Ù…Ù†Ø©: ØªØµÙÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹
  window.allWarehouseItems = [];

  // 5) Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù… Ø­Ø³Ø¨ Ø´Ø§Ø´ØªÙƒ)
  const login = document.getElementById('screenLogin');
  if (login) {
    login.classList.remove('hidden');
    login.style.display = 'block';
  }
}


// âœ… helper: Ø¬Ù„Ø¨ user Ø§Ù„Ø­Ø§Ù„ÙŠ (Auth)
async function getCurrentAuthUser() {
  // 1) Ø®Ø° Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ø§Ù„Ù€ session (Ø£Ø³Ø±Ø¹ ÙˆØ£Ø«Ø¨Øª) + Ø®Ø²Ù‘Ù†Ù‡ Ø¨Ø§Ù„ÙƒØ§Ø´
  const { data: sData } = await supabaseClient.auth.getSession();
  const sessionUser = sData?.session?.user;

  if (sessionUser?.id) {
    window.currentUser = sessionUser; // âœ… Ø­Ø§ÙØ¸Ù†Ø§ Ø¹Ù„Ù‰ Ø§Ù„ÙƒØ§Ø´
    return sessionUser;
  }

  // 0) Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ session (Ù…Ø«Ù„Ø§Ù‹ Ù„Ø³Ø§ Ù…Ø§ ØªÙ‡ÙŠØ£ Ø£Ùˆ Ø§Ù„Ù…ØªØµÙØ­ Ù…Ù†Ø¹ Ø§Ù„ØªØ®Ø²ÙŠÙ†)
  // Ø¬Ø±Ù‘Ø¨ Ø§Ù„ÙƒØ§Ø´ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªÙˆÙØ± (bootstrapAuth/onAuthStateChange)
  if (window.currentUser?.id) return window.currentUser;

  // 2) fallback: getUser (Ø¨Ø³ Ø¥Ø°Ø§ ÙÙŠ session Ø£ØµÙ„Ø§Ù‹)
  // Ø¥Ø°Ø§ Ù…Ø§ ÙÙŠ sessionØŒ getUser ØºØ§Ù„Ø¨Ø§Ù‹ Ø±Ø­ ÙŠØ¹Ø·ÙŠ AuthSessionMissingError
  if (!sData?.session) return null;

  const { data, error } = await supabaseClient.auth.getUser();
  if (error) return null;

  const user = data?.user || null;
  if (user?.id) window.currentUser = user; // âœ… Ø®Ø²Ù‘Ù†Ù‡ Ø¨Ø§Ù„ÙƒØ§Ø´
  return user;
}

async function submitBandJoinRequest(payloadFromForm) {
  const user = await getCurrentAuthUser();
  if (!user?.id) { alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹"); return; }

  const row = {
    ...payloadFromForm,
    user_id: user.id,
    user_email: user.email,
    status: 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©'
  };

  const { error } = await supabaseClient.from('band_join_requests').insert([row]);
  if (error) alert("âŒ Ø®Ø·Ø£ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
  else alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­");
}


// âœ… 1) Ø§ÙØªØ­ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ "Ø¨Ø£Ù…Ø§Ù†": Ø¥Ø°Ø§ Ø¹Ø¶Ùˆ -> Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
// âœ… 1) Ø§ÙØªØ­ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ "Ø¨Ø£Ù…Ø§Ù†": Ø¥Ø°Ø§ Ø¹Ø¶Ùˆ -> Ø±Ø³Ø§Ù„Ø© ÙÙ‚Ø·
window.openBandJoinSafely = async function () {
  const user = await getCurrentAuthUser();
  if (!user?.id) {
    alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  // (A) ÙØ­Øµ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ø¹Ø¨Ø± user_id
  const { data: memberByUid, error: errUid } = await supabaseClient
    .from('band_members')
    .select('id, user_id, name')
    .eq('user_id', user.id)
    .maybeSingle();

  if (errUid) {
    alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: " + errUid.message);
    return;
  }

  if (memberByUid) {
    alert("âœ… Ø£Ù†Øª Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©");
    return;
  }

  // (B) Ø¥Ø°Ø§ Ù…Ø§ Ù„Ù‚ÙŠØªÙ‡ Ø¨Ù€ user_id (Ù„Ø£Ù† user_id ÙØ§Ø¶ÙŠ)ØŒ Ø¬Ø±Ù‘Ø¨ Ø§Ø±Ø¨Ø·Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø§Ù„Ø§Ø³Ù…
  // âœ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØªÙÙ‚ Ø¹Ù„ÙŠÙ‡: Ø§Ù„Ø§Ø³Ù… ÙŠØ¤Ø®Ø° Ù…Ù† currentProfile (Ù…Ùˆ Ù…Ù† user)
  const possibleName =
    (window.currentProfile?.name || '').trim() ||               // âœ… Ø§Ù„Ø£ØµØ­ Ø¹Ù†Ø¯Ùƒ
    (document.getElementById('memberName')?.textContent || '').trim() ||
    ''; // Ø¥Ø°Ø§ Ø¹Ù†Ø¯Ùƒ Ù…ÙƒØ§Ù† ØªØ§Ù†ÙŠ Ù„Ù„Ø§Ø³Ù… Ù‚ÙˆÙ„ÙŠ ÙˆÙŠÙ†

  if (possibleName) {
    // Ø¯ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ù†ÙØ³ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù€ user_id ÙØ§Ø¶ÙŠ
    const { data: memberByName, error: errName } = await supabaseClient
      .from('band_members')
      .select('id, user_id, name')
      .eq('name', possibleName)
      .maybeSingle();

    if (!errName && memberByName && !memberByName.user_id) {
      // Ø§Ø±Ø¨Ø· Ø§Ù„Ø¹Ø¶Ùˆ Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
      const { error: errUpdate } = await supabaseClient
        .from('band_members')
        .update({ user_id: user.id })
        .eq('id', memberByName.id);

      if (!errUpdate) {
        alert("âœ… Ø£Ù†Øª Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©");
        return;
      }
    }

    // Ø¥Ø°Ø§ Ù„Ù‚Ù‰ Ø§Ù„Ø§Ø³Ù… Ø¨Ø³ ÙƒØ§Ù† Ù…Ø±Ø¨ÙˆØ· Ù„ÙŠÙˆØ²Ø± ØªØ§Ù†ÙŠ (Ø£Ùˆ ÙØ´Ù„ Ø§Ù„ØªØ­Ø¯ÙŠØ«)
    if (!errName && memberByName && memberByName.user_id && memberByName.user_id !== user.id) {
      alert("âš ï¸ Ù‡Ø°Ø§ Ø§Ù„Ø§Ø³Ù… Ù…Ø±Ø¨ÙˆØ· Ø¨Ø­Ø³Ø§Ø¨ Ø¢Ø®Ø±. ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ø±Ø¨Ø·.");
      return;
    }
  }

  // (C) Ø¥Ø°Ø§ Ù…Ùˆ Ø¹Ø¶ÙˆØŒ Ø§ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¹Ù†Ø¯Ùƒ:
  if (typeof window.openBandJoinModal === 'function') {
    window.openBandJoinModal();
    return;
  }

  const modal = document.getElementById('bandJoinModal');
  if (modal) {
    modal.style.display = 'flex';
    return;
  }

  alert("Ù…Ø§ Ù„Ù‚ÙŠØª Ø¯Ø§Ù„Ø©/Ø¹Ù†ØµØ± Ù„ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨. Ø§Ø±Ø¨Ø·Ù‡Ø§ Ø¨Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø© Ø¹Ù†Ø¯Ùƒ.");
};



// âœ… 2) Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù†ØªØ³Ø§Ø¨ Ù…Ø¹ user_id (ØªØ³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¨Ø¯Ù„ Ø§Ù„Ø¯Ø§Ù„Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ø¥Ø°Ø§ Ø¨Ø¯Ùƒ)
window.submitBandJoinRequestWithUserId = async function (payloadFromForm) {
  const user = await getCurrentAuthUser();
  if (!user?.id) {
    alert("Ù„Ø§Ø²Ù… ØªØ³Ø¬Ù‘Ù„ Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹");
    return;
  }

  const payload = {
    ...payloadFromForm,
    user_id: user.id,
    status: payloadFromForm?.status || 'pending',
    created_at: payloadFromForm?.created_at || new Date().toISOString(),
  };

  const { error } = await supabaseClient
    .from('band_join_requests')
    .insert([payload]);

  if (error) {
    // Ù…Ù† trigger Ø§Ù„Ù„ÙŠ Ø¹Ù…Ù„ØªÙ‡ Ø¨Ø§Ù„Ù€ SQL
    if ((error.message || '').includes('USER_IS_ALREADY_MEMBER')) {
      alert("âœ… Ø£Ù†Øª Ø¹Ø¶Ùˆ Ø¨Ø§Ù„ÙØ±Ù‚Ø© Ø§Ù„Ù†Ø­Ø§Ø³ÙŠØ©");
      return;
    }
    alert("Ø®Ø·Ø£ Ø¨Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨: " + error.message);
    return;
  }

  alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨");
};

// âœ… Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ø¨Ø´ÙƒÙ„ Ø«Ø§Ø¨Øª (Ø­ØªÙ‰ Ø¨Ø¹Ø¯ logout/login Ø¨Ø¯ÙˆÙ† refresh)
(function bindWarehouseDelegationOnce() {
  if (window.__warehouseDelegationBound) return;
  window.__warehouseDelegationBound = true;

  document.addEventListener("click", function (e) {
    // Ø§Ø´ØªØºÙ„ ÙÙ‚Ø· Ø¥Ø°Ø§ Ø´Ø§Ø´Ø© Ø§Ù„Ù…Ø³ØªÙˆØ¯Ø¹ Ù…ÙˆØ¬ÙˆØ¯Ø© ÙˆÙ…Ùˆ Ù…Ø®ÙÙŠØ©
    const whScreen = document.getElementById("screenWarehouse");
    if (!whScreen || whScreen.classList.contains("hidden")) return;

    // Ø²Ø± Ø¥Ø¶Ø§ÙØ© ØµÙ†Ù
    if (e.target.closest("#whBtnAddItem")) {
      e.preventDefault();
      if (typeof window.openAddItemModal === "function") window.openAddItemModal();
      return;
    }

    // Ø²Ø± Ø§Ù„Ø£Ø±Ø´ÙŠÙ
    if (e.target.closest("#whBtnArchive")) {
      e.preventDefault();
      if (typeof window.showWarehouseArchive === "function") window.showWarehouseArchive();
      return;
    }
  });
})();

function openAttendanceModal() {
  const overlay = document.getElementById('attendanceModalOverlay');
  if (!overlay) return;

  // Ù…Ù‡Ù…: Ø¥Ø°Ø§ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ ÙƒØ§Ù† Ù…Ø¹Ù…ÙˆÙ„ Ø¯Ø§Ø®Ù„ container ØºØ±ÙŠØ¨
  // Ù…Ù† Ø§Ù„Ø£ÙØ¶Ù„ Ù†Ø®Ù„ÙŠÙ‡ Ø¢Ø®Ø± Ø§Ù„Ù€ body
  if (overlay.parentElement !== document.body) {
    document.body.appendChild(overlay);
  }

  overlay.classList.add('show');
  document.body.classList.add('modal-lock');
}

function closeAttendanceModal() {
  const overlay = document.getElementById('attendanceModalOverlay');
  if (!overlay) return;

  overlay.classList.remove('show');
  document.body.classList.remove('modal-lock');
}

// Ø¥ØºÙ„Ø§Ù‚ Ø¨Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø®Ù„ÙÙŠØ©
document.addEventListener('click', (e) => {
  const overlay = document.getElementById('attendanceModalOverlay');
  if (!overlay) return;
  if (overlay.classList.contains('show') && e.target === overlay) {
    closeAttendanceModal();
  }
});

function renderAttendanceLists(mainMembers, reserveMembers) {
  const mainBox = document.getElementById('attendanceMainList');
  const reserveBox = document.getElementById('attendanceReserveList');

  mainBox.innerHTML = mainMembers.map(m => `
    <label style="display:flex; align-items:center; gap:10px; padding:8px; background:#fff; border:1px solid #eee; border-radius:10px; margin-bottom:8px;">
      <input type="checkbox" class="att-main" data-id="${m.id}">
      <span style="font-weight:700;">${m.name}</span>
    </label>
  `).join('');

  reserveBox.innerHTML = reserveMembers.map(m => `
    <label style="display:flex; align-items:center; gap:10px; padding:8px; background:#fff; border:1px solid #eee; border-radius:10px; margin-bottom:8px;">
      <input type="checkbox" class="att-reserve" data-id="${m.id}">
      <span style="font-weight:700;">${m.name}</span>
    </label>
  `).join('');
}

function markAll(type, checked) {
  const cls = type === 'main' ? '.att-main' : '.att-reserve';
  document.querySelectorAll(cls).forEach(cb => cb.checked = checked);
}
function applyAttTarget(){
  const t = document.getElementById('attTarget')?.value || 'Ø§Ù„ÙƒÙ„';
  const main = document.getElementById('attSectionMain');
  const reserve = document.getElementById('attSectionReserve');

  if(!main || !reserve) return;

  // Ø§ÙØªØ±Ø§Ø¶ÙŠ: Ø§Ù„ÙƒÙ„ Ø´ØºØ§Ù„
  main.classList.remove('att-disabled');
  reserve.classList.remove('att-disabled');

  // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø£Ø³Ø§Ø³ÙŠØ©: Ù‚ÙÙ„ Ø§Ù„Ø±Ø¯ÙŠÙØ©
  if (t === 'Ø£Ø³Ø§Ø³ÙŠØ©') {
    reserve.classList.add('att-disabled');
  }

  // Ø¥Ø°Ø§ Ø§Ø®ØªØ§Ø± Ø±Ø¯ÙŠÙØ©: Ù‚ÙÙ„ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
  if (t === 'Ø±Ø¯ÙŠÙØ©') {
    main.classList.add('att-disabled');
  }
}

</script>

</body>
</html>




